# РћРїРµСЂР°С†РёРѕРЅРЅС‹Рµ РїСЂРѕС†РµРґСѓСЂС‹

> Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Рµ РґРѕРєСѓРјРµРЅС‚С‹: [С‡РµРє-Р»РёСЃС‚ СЂРµР»РёР·Р°](release_checklist.md), [РјРѕРЅРёС‚РѕСЂРёРЅРі](monitoring.md), [Р¶СѓСЂРЅР°Р» РѕРїРµСЂР°С†РёР№](incident_log.md), [РїСЂРѕРіСЂР°РјРјР° Р±Р°Рі-Р±Р°СѓРЅС‚Рё](bug_bounty.md), [РїСЂРѕС†РµРґСѓСЂР° СЂРµС„Р°РЅРґР°](refund.md), [РїРѕСЃС‚СЂРµР»РёР·РЅР°СЏ РїРѕРґРґРµСЂР¶РєР°](post_release_support.md), [С€Р°Р±Р»РѕРЅ РїРѕСЃС‚РјРѕСЂС‚РµРјР°](postmortems.md), [Supra CLI Рё Move-С‚РµСЃС‚С‹](supra_cli.md).
> Р”Р»СЏ С„РёРєСЃР°С†РёРё СЃРѕР±С‹С‚РёР№ РёСЃРїРѕР»СЊР·СѓР№С‚Рµ `SupraLottery/supra/scripts/incident_log.sh`, РєРѕС‚РѕСЂС‹Р№ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РґРѕР±Р°РІР»СЏРµС‚ Р·Р°РїРёСЃРё РІ Р¶СѓСЂРЅР°Р».

## РњСѓР»СЊС‚РёСЃРёРі Рё СѓС‚РІРµСЂР¶РґРµРЅРёСЏ СЂРѕР»РµР№
- Р’СЃРµ РѕРїРµСЂР°С†РёРё, СЃРІСЏР·Р°РЅРЅС‹Рµ СЃ РІС‹РґР°С‡РµР№/РѕС‚Р·С‹РІРѕРј capability, РІС‹РїРѕР»РЅСЏСЋС‚СЃСЏ С‡РµСЂРµР· СЃРѕРіР»Р°СЃРѕРІР°РЅРЅС‹Рµ РјСѓР»СЊС‚РёСЃРёРі-РєРѕС€РµР»СЊРєРё (`RootAdmin`, `OperationalAdmin`). РџРµСЂРµРґ РїРѕРґРїРёСЃСЊСЋ С‚СЂР°РЅР·Р°РєС†РёРё РЅРµРѕР±С…РѕРґРёРјРѕ СЃРѕР·РґР°С‚СЊ Р·Р°РґР°С‡Сѓ РІ ticketing-СЃРёСЃС‚РµРјРµ Рё РїСЂРёР»РѕР¶РёС‚СЊ СЃСЃС‹Р»РєСѓ РЅР° Р·Р°РїРёСЃСЊ РІ [incident_log.md](incident_log.md).
- Р”Р»СЏ РґРµР№СЃС‚РІРёР№, С‚СЂРµР±СѓСЋС‰РёС… РґРІРѕР№РЅРѕРіРѕ РєРѕРЅС‚СЂРѕР»СЏ (РѕС‚РјРµРЅР° С‚РёСЂР°Р¶Р°, РІС‹РїР»Р°С‚С‹, unpause), С„РёРєСЃРёСЂСѓР№С‚Рµ РїРѕРґС‚РІРµСЂР¶РґРµРЅРёСЏ РѕР±РѕРёС… РѕРїРµСЂР°С‚РѕСЂРѕРІ РјСѓР»СЊС‚РёСЃРёРі-РїСѓР»Р° Рё СѓРєР°Р·С‹РІР°Р№С‚Рµ `tx_hash` РІ Р¶СѓСЂРЅР°Р»Рµ. РџСЂРё РЅРµСЃРѕРІРїР°РґРµРЅРёРё СѓС‡Р°СЃС‚РЅРёРєРѕРІ РѕР±РЅРѕРІРёС‚Рµ РјР°С‚СЂРёС†Сѓ РІ [governance/roles.md](../governance/roles.md).

## РђРґРјРёРЅРёСЃС‚СЂР°С‚РѕСЂ (Root/Operational)
1. РџСЂРѕРІРµСЂРёС‚СЊ СЃС‚Р°С‚СѓСЃ VRF-РґРµРїРѕР·РёС‚Р° С‡РµСЂРµР· `views::get_vrf_deposit_status` (РёР»Рё Supra CLI) Рё РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё Р·Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ СЃРЅР°РїС€РѕС‚ С„СѓРЅРєС†РёРµР№ `vrf_deposit::record_snapshot_admin`; СЂРµР·СѓР»СЊС‚Р°С‚ Р·Р°РЅРµСЃС‚Рё РІ [Р¶СѓСЂРЅР°Р»Рµ РѕРїРµСЂР°С†РёР№](incident_log.md) С‡РµСЂРµР· `SupraLottery/supra/scripts/incident_log.sh --type "VRF-РїРѕРїРѕР»РЅРµРЅРёРµ" ...`.
2. РџРѕР»СѓС‡РёС‚СЊ РєРѕРЅС„РёРіСѓСЂР°С†РёСЋ С‡РµСЂРЅРѕРІРёРєР° `views::get_lottery` / `get_lottery_status`, СѓР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ СЃС‚Р°С‚СѓСЃ `Draft` Рё `snapshot_frozen = false`.
3. РЎРѕР·РґР°С‚СЊ Р»РѕС‚РµСЂРµСЋ РІ СЃРѕСЃС‚РѕСЏРЅРёРё `Draft` Рё Р·Р°РїРѕР»РЅРёС‚СЊ РєРѕРЅС„РёРіСѓСЂР°С†РёСЋ, СѓРєР°Р·Р°РІ `primary_type`, `tags_mask`, СЂР°СЃРїСЂРµРґРµР»РµРЅРёРµ РїСЂРѕРґР°Р¶ (`economics::assert_distribution`). РџРµСЂРµРґ СЃРѕС…СЂР°РЅРµРЅРёРµРј СЃРІРµСЂРёС‚СЊСЃСЏ СЃ [РїРѕР»РёС‚РёРєРѕР№ С‚РµРіРѕРІ](../contracts/tags_policy.md), С‡С‚РѕР±С‹ РёР·Р±РµР¶Р°С‚СЊ Р·Р°РїСЂРµС‰С‘РЅРЅС‹С… РєРѕРјР±РёРЅР°С†РёР№ Рё СЃРѕР±Р»СЋСЃС‚Рё С‚Р°Р№РјР»РѕРєРё РїР°СЂС‚РЅС‘СЂСЃРєРёС… whitelists.
4. Р—Р°РїСѓСЃС‚РёС‚СЊ `views::validate_config` Рё СѓР±РµРґРёС‚СЊСЃСЏ РІ РѕС‚СЃСѓС‚СЃС‚РІРёРё РѕС€РёР±РѕРє.
5. РџРµСЂРµРІРµСЃС‚Рё Р»РѕС‚РµСЂРµСЋ РІ `Active`, РѕС‚РєСЂС‹С‚СЊ РїСЂРѕРґР°Р¶Рё.
6. РњРѕРЅРёС‚РѕСЂРёС‚СЊ РїСЂРѕРґР°Р¶Рё С‡РµСЂРµР· `views::list_active`, `views::accounting_snapshot` Рё СЃРѕР±С‹С‚РёСЏ `TicketPurchaseEvent`; РїСЂРё СЃСЂР°Р±Р°С‚С‹РІР°РЅРёРё `PurchaseRateLimitHit` РѕС†РµРЅРёС‚СЊ DoS-Р°РєС‚РёРІРЅРѕСЃС‚СЊ. Р”Р»СЏ СЃРІРµСЂРєРё Р°РіСЂРµРіР°С‚РѕРІ РёСЃРїРѕР»СЊР·СѓР№С‚Рµ `./SupraLottery/supra/scripts/accounting_check.sh [--dry-run] <config> snapshot|compare <lottery_id>` вЂ” РєРѕРјР°РЅРґР° `compare` РІС‹РІРѕРґРёС‚ JSON-РѕС‚С‡С‘С‚ Рѕ СЃРѕРІРїР°РґРµРЅРёРё `total_*` РјРµР¶РґСѓ СѓС‡С‘С‚РѕРј РїСЂРѕРґР°Р¶ Рё `LotterySummary`.
7. РџРѕ РѕРєРѕРЅС‡Р°РЅРёРё `sales_end` РІС‹Р·РІР°С‚СЊ `draw::request_draw_admin` (РїРµСЂРµРґ СЌС‚РёРј `vrf_deposit::ensure_requests_allowed`).
   - РџРѕРІС‚РѕСЂРЅС‹Р№ РІС‹Р·РѕРІ РїРѕСЃР»Рµ РєР°Р¶РґРѕР№ РЅРµСѓРґР°С‡РЅРѕР№ РїРѕРїС‹С‚РєРё СѓРІРµР»РёС‡РёРІР°РµС‚ СЃС‡С‘С‚С‡РёРє `attempt`; РїСЂРё РґРѕСЃС‚РёР¶РµРЅРёРё `MAX_VRF_ATTEMPTS = 5` С„СѓРЅРєС†РёСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РѕС‚РјРµРЅСЏРµС‚ С‚РёСЂР°Р¶ (`STATUS_CANCELED`, `CANCEL_REASON_VRF_FAILURE`) Рё РІРєР»СЋС‡Р°РµС‚ СЂРµС„Р°РЅРґ, РїРѕСЌС‚РѕРјСѓ РЅР° 6-Р№ РїРѕРїС‹С‚РєРµ AutomationBot РґРѕР»Р¶РµРЅ Р·Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ РёРЅС†РёРґРµРЅС‚ Рё РїРµСЂРµР№С‚Рё Рє runbook СЂРµС„Р°РЅРґР°.
8. Р”РѕР¶РґР°С‚СЊСЃСЏ СЃРѕР±С‹С‚РёСЏ `VrfFulfilled` Рё РІС‹РїРѕР»РЅРёС‚СЊ Р±Р°С‚С‡Рё `payouts::compute_winners_admin` в†’ `payouts::record_payout_batch_admin`, РїСЂРµРґРІР°СЂРёС‚РµР»СЊРЅРѕ РїСЂРѕРІРµСЂРёРІ С‡РµСЂРµР· `roles::borrow_payout_batch_cap`/`roles::has_payout_batch_cap` РѕСЃС‚Р°С‚РѕРє РѕРїРµСЂР°С†РёР№ (`roles::consume_payout_batch` РІС‹Р±СЂР°СЃС‹РІР°РµС‚ `E_PAYOUT_BATCH_TOO_LARGE`/`E_PAYOUT_OPERATIONS_BUDGET`/`E_PAYOUT_BATCH_COOLDOWN`/`E_PAYOUT_BATCH_NONCE`). РџРѕСЃР»Рµ СѓСЃРїРµС€РЅРѕРіРѕ Р±Р°С‚С‡Р° РєРѕРЅС‚СЂРѕР»РёСЂРѕРІР°С‚СЊ С‡РµСЂРµР· `sales::accounting_snapshot`, С‡С‚Рѕ `total_prize_paid` Рё `total_operations_paid` РЅРµ РїСЂРµРІС‹С€Р°СЋС‚ СЂРµР·РµСЂРІ `total_allocated`; РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РІС‹РїРѕР»РЅРёС‚Рµ `./SupraLottery/supra/scripts/accounting_check.sh <config> compare <lottery_id>` РґР»СЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРѕРіРѕ РѕС‚С‡С‘С‚Р° РїРѕ СЃРѕРІРїР°РґРµРЅРёСЋ `total_allocated`/`total_prize_paid`/`total_operations_paid`, Р·Р°С‚РµРј РІС‹Р·РІР°С‚СЊ `payouts::finalize_lottery_admin` РїРѕ Р·Р°РІРµСЂС€РµРЅРёРё С†РёРєР»Р°. РЎРІРµСЂСЏР№С‚Рµ РјРµС‚СЂРёРєРё СЃ [monitoring.md](monitoring.md) Рё РїСЂРё РѕС‚РєР»РѕРЅРµРЅРёСЏС… РґРѕРєСѓРјРµРЅС‚РёСЂСѓР№С‚Рµ РІ [incident_log.md](incident_log.md) (СЂРµРєРѕРјРµРЅРґСѓРµРјС‹Р№ С„РѕСЂРјР°С‚ Р·Р°РїРёСЃРё вЂ” `SupraLottery/supra/scripts/incident_log.sh --type "РРЅС†РёРґРµРЅС‚"|"Dry-run" ...`). РџРµСЂРµРґ СЂРµР»РёР·РѕРј СѓР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ `aptos` CLI РґРѕСЃС‚СѓРїРµРЅ (`./SupraLottery/supra/scripts/run_move_tests.sh --help`) Рё С„РёРЅР°Р»СЊРЅС‹Рµ Р±Р°С‚С‡Рё РїРѕРєСЂС‹С‚С‹ `aptos move test` (СЃРј. [supra_cli.md](supra_cli.md)).
9. РџСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РѕС‚РјРµРЅС‹ РІС‹Р·РІР°С‚СЊ `registry::cancel_lottery_admin(lottery_id, reason_code, now_ts)`, РїСЂРѕРІРµСЂРёС‚СЊ `views::get_cancellation` Рё Р·Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ СЂРµС€РµРЅРёРµ РІ [Р¶СѓСЂРЅР°Р»Рµ](incident_log.md) (`SupraLottery/supra/scripts/incident_log.sh --type "Cancellation" ...`). РЎРєСЂРёРїС‚ `./SupraLottery/supra/scripts/refund_control.sh` РїРѕРґРґРµСЂР¶РёРІР°РµС‚ С„Р»Р°Рі `--dry-run` вЂ” РёСЃРїРѕР»СЊР·СѓР№С‚Рµ РµРіРѕ РґР»СЏ РїСЂРµРґРІР°СЂРёС‚РµР»СЊРЅРѕР№ РїСЂРѕРІРµСЂРєРё РєРѕРјР°РЅРґ (`cancel`, `batch`, `archive`) РІ СЃСЂРµРґР°С… Р±РµР· Supra CLI. РџРѕСЃР»Рµ Р·Р°РІРµСЂС€РµРЅРёСЏ on-chain СЂРµС„Р°РЅРґРѕРІ РѕР±СЏР·Р°С‚РµР»СЊРЅРѕ РІС‹Р·РІР°С‚СЊ `payouts::archive_canceled_lottery_admin(lottery_id, finalized_ts)`, С‡С‚РѕР±С‹ Р·Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ `LotterySummary` СЃРѕ СЃС‚Р°С‚СѓСЃРѕРј `STATUS_CANCELED`. РЎРїСЂР°РІРѕС‡РЅРёРє РїСЂРёС‡РёРЅ Рё С‡РµРє-Р»РёСЃС‚ РІРѕР·РІСЂР°С‚РѕРІ СЃРј. РІ [refund.md](refund.md); РѕС‚РєР°Р· СЃ РїСѓСЃС‚С‹Рј РєРѕРґРѕРј РїСЂРёРІРѕРґРёС‚ Рє `E_CANCEL_REASON_INVALID`.
10. РџСЂРё РїР°СЂС‚РЅС‘СЂСЃРєРёС… РІС‹РїР»Р°С‚Р°С… РІС‹Р·РІР°С‚СЊ `payouts::record_partner_payout_admin`, РїСЂРµРґРІР°СЂРёС‚РµР»СЊРЅРѕ СЃРІРµСЂРёРІ РѕСЃС‚Р°С‚РѕРє `PartnerPayoutCap` С‡РµСЂРµР· `roles::list_partner_caps`/`roles::has_partner_payout_cap` (`roles::consume_partner_payout` Р·Р°С‰РёС‰Р°РµС‚ РѕС‚ РїРµСЂРµСЂР°СЃС…РѕРґР°, РЅР°СЂСѓС€РµРЅРёР№ cooldown/nonce Рё expiry, РІС‹Р±СЂР°СЃС‹РІР°СЏ `E_PARTNER_PAYOUT_BUDGET_EXCEEDED`/`E_PARTNER_PAYOUT_COOLDOWN`/`E_PARTNER_PAYOUT_NONCE`/`E_PARTNER_PAYOUT_EXPIRED`) Рё РѕСЃС‚Р°С‚РѕРє РѕРїРµСЂР°С†РёР№ РїРѕ `sales::accounting_snapshot`, Р·Р°С‚РµРј Р·Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ СЃРѕР±С‹С‚РёРµ `PartnerPayoutEvent`.
11. РџРѕСЃР»Рµ Р·Р°РІРµСЂС€РµРЅРёСЏ РїР°СЂС‚РЅС‘СЂСЃРєРёС… РІС‹РїР»Р°С‚ РїСЂРѕРІРµСЂРёС‚СЊ `roles::list_premium_caps` РґР»СЏ РїСЂРµРјРёР°Р»СЊРЅС‹С… РїРѕРґРїРёСЃРѕРє (Р°РєС‚СѓР°Р»РµРЅ РїРѕРєР°Р·Р°С‚РµР»СЊ `expires_at` Рё `referrer`), РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РІС‹Р·РІР°С‚СЊ `roles::cleanup_expired_admin <now>` Рё СѓР±РµРґРёС‚СЊСЃСЏ РІ РїСѓР±Р»РёРєР°С†РёРё `PartnerPayoutCapRevokedEvent`/`PremiumAccessRevokedEvent`; СЂРµР·СѓР»СЊС‚Р°С‚С‹ Р·Р°РЅРµСЃС‚Рё РІ [Р¶СѓСЂРЅР°Р»](incident_log.md) С‡РµСЂРµР· `SupraLottery/supra/scripts/incident_log.sh`.
12. РџСЂРѕРІРµСЂРёС‚СЊ, С‡С‚Рѕ `history::get_summary` РІРѕР·РІСЂР°С‰Р°РµС‚ Р·Р°РїРёСЃСЊ Рё dual-write РїСЂРѕС€С‘Р» Р±РµР· РѕС€РёР±РѕРє (РґР»СЏ РѕС‚РјРµРЅС‘РЅРЅС‹С… С‚РёСЂР°Р¶РµР№ вЂ” РїРѕСЃР»Рµ `payouts::archive_canceled_lottery_admin`).
13. РЎРЅСЏС‚СЊ Р°РіСЂРµРіРёСЂРѕРІР°РЅРЅСѓСЋ СЃРІРѕРґРєСѓ `views::status_overview(now_ts)` Рё РѕР±РЅРѕРІРёС‚СЊ [СЃС‚Р°С‚СѓСЃРЅСѓСЋ СЃС‚СЂР°РЅРёС†Сѓ](status_page.md); РїСЂРё РЅР°Р»РёС‡РёРё `vrf_retry_blocked` РёР»Рё `payout_backlog` Р·Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ РёРЅС†РёРґРµРЅС‚ Рё СЃР»РµРґРѕРІР°С‚СЊ РїРѕСЂРѕРіР°Рј РёР· [monitoring.md](monitoring.md).

## РџСЂР°Р№СЃ-С„РёРґ
1. РњРѕРЅРёС‚РѕСЂРёС‚СЊ `price_feed::get_price_view(asset_id)` Рё РјРµС‚СЂРёРєРё `price_feed_updates_total`, `price_feed_clamp_active`, `price_feed_fallback_active` (СЃРј. [monitoring.md](monitoring.md)).
2. РџСЂРё СЂРµР·РєРѕРј СЃРєР°С‡РєРµ С†РµРЅС‹ РІС‹Р·РІР°С‚СЊ `price_feed::set_fallback(<cap>, asset_id, true, reason)` Рё Р·Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ СЃРѕР±С‹С‚РёРµ `PriceFeedFallbackEvent` РІ [incident_log.md](incident_log.md).
3. РџРѕСЃР»Рµ РїРѕРґС‚РІРµСЂР¶РґРµРЅРёСЏ РїРѕСЃС‚Р°РІС‰РёРєР° С†РµРЅС‹ РІС‹РїРѕР»РЅРёС‚СЊ `price_feed::clear_clamp(<cap>, asset_id, cleared_ts)` вЂ” СЃРѕР±С‹С‚РёРµ `PriceFeedClampClearedEvent` С„РёРєСЃРёСЂСѓРµС‚ СЂСѓС‡РЅРѕРµ СЂРµС€РµРЅРёРµ; РґРѕР±Р°РІСЊС‚Рµ Р·Р°РїРёСЃСЊ РІ Р¶СѓСЂРЅР°Р» (`SupraLottery/supra/scripts/incident_log.sh --type "РРЅС†РёРґРµРЅС‚" ...`).
4. РћРїСѓР±Р»РёРєРѕРІР°С‚СЊ РЅРѕРІСѓСЋ РєРѕС‚РёСЂРѕРІРєСѓ С‡РµСЂРµР· `price_feed::update_price(<cap>, asset_id, price, updated_ts)`, СѓР±РµРґРёРІС€РёСЃСЊ, С‡С‚Рѕ РёР·РјРµРЅРµРЅРёРµ СѓРєР»Р°РґС‹РІР°РµС‚СЃСЏ РІ `clamp_threshold_bps`; РїСЂРё СѓСЃРїРµС€РЅРѕРј РѕР±РЅРѕРІР»РµРЅРёРё fallback СЃР±СЂР°СЃС‹РІР°РµС‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё.
5. Р’ release checklist РґРѕР±Р°РІРёС‚СЊ СЃСЃС‹Р»РєСѓ РЅР° СЃРѕР±С‹С‚РёРµ `PriceFeedClampClearedEvent` Рё РѕР±РЅРѕРІР»С‘РЅРЅС‹Р№ `last_updated_ts` РґР»СЏ РєР°Р¶РґРѕРіРѕ Р°РєС‚РёРІРЅРѕРіРѕ `asset_id`.

## РџР°СЂС‚РЅС‘СЂ
1. РћС‚РєСЂС‹С‚СЊ РїР°СЂС‚РЅС‘СЂСЃРєСѓСЋ РїР°РЅРµР»СЊ С„СЂРѕРЅС‚РµРЅРґР° Рё РІС‹Р±СЂР°С‚СЊ РґРѕСЃС‚СѓРїРЅС‹Р№ С€Р°Р±Р»РѕРЅ.
2. РЈР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ `primary_type`/`tags_mask` РІС…РѕРґСЏС‚ РІ СЂР°Р·СЂРµС€С‘РЅРЅС‹Рµ СЃРїРёСЃРєРё capability Рё СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‚ [РїРѕР»РёС‚РёРєРµ С‚РµРіРѕРІ](../contracts/tags_policy.md#2-РґРѕРїСѓСЃС‚РёРјС‹Рµ-РєРѕРјР±РёРЅР°С†РёРё-С‚РµРіРѕРІ).
3. РџРµСЂРµРґ СЃРѕР·РґР°РЅРёРµРј Р·Р°РїСѓСЃС‚РёС‚СЊ `views::validate_config`; РїРѕРїС‹С‚РєРё СѓСЃС‚Р°РЅРѕРІРёС‚СЊ Р·Р°РїСЂРµС‰С‘РЅРЅС‹Рµ С‚РµРіРё РїСЂРёРІРµРґСѓС‚ Рє `abort`.
4. РџРѕРґРїРёСЃР°С‚СЊ С‚СЂР°РЅР·Р°РєС†РёСЋ СЃРѕР·РґР°РЅРёСЏ, РїСЂРѕРІРµСЂРёРІ Р»РёРјРёС‚С‹ Р±СЋРґР¶РµС‚Р° Рё cooldown РІС‹РїР»Р°С‚.
5. РљРѕРЅС‚СЂРѕР»РёСЂРѕРІР°С‚СЊ `PartnerVault` Рё СЃРІРѕРµРІСЂРµРјРµРЅРЅРѕ РїРѕРїРѕР»РЅСЏС‚СЊ РЅР°РіСЂР°РґС‹.

## AutomationBot
- Р’С‹РїРѕР»РЅСЏРµС‚ dry-run С‡РµСЂРµР· `automation::announce_dry_run`, РїСѓР±Р»РёРєСѓСЏ digest РІ СЃРѕР±С‹С‚РёРё `AutomationDryRunPlanned`; РїРѕРІС‚РѕСЂРЅС‹Р№ РІС‹Р·РѕРІ СЃ РґСЂСѓРіРёРј digest РґРѕ Р·Р°РІРµСЂС€РµРЅРёСЏ Р±СѓРґРµС‚ РѕС‚РєР»РѕРЅС‘РЅ (`E_AUTOBOT_PENDING_EXISTS`).
- РџСЂРѕРІРµСЂСЏРµС‚ С‚Р°Р№РјР»РѕРєРё РїРµСЂРµРґ `execute`: РїСЂРё `timelock_secs > 0` С‚СЂРµР±СѓРµС‚СЃСЏ РґРѕР¶РґР°С‚СЊСЃСЏ `pending_execute_after`, РёРЅР°С‡Рµ `record_success`/`record_failure` Р·Р°РІРµСЂС€Р°С‚СЃСЏ `E_AUTOBOT_TIMELOCK`. РџРѕСЃР»Рµ СѓСЃРїРµС€РЅРѕРіРѕ dry-run РІРЅРµСЃС‚Рё Р·Р°РїРёСЃСЊ РІ [incident_log.md](incident_log.md).
- Р”Р»СЏ РґРµР№СЃС‚РІРёР№ `ACTION_UNPAUSE`, `ACTION_PAYOUT_BATCH`, `ACTION_CANCEL` С‚Р°Р№РјР»РѕРє РЅРµ РјРѕР¶РµС‚ Р±С‹С‚СЊ РјРµРЅСЊС€Рµ 900 СЃРµРєСѓРЅРґ (15 РјРёРЅСѓС‚); С‚СЂРµР±РѕРІР°РЅРёРµ Р·Р°С„РёРєСЃРёСЂРѕРІР°РЅРѕ Move-С‚РµСЃС‚Р°РјРё `automation_tests::register_enforces_sensitive_timelock` Рё `automation_tests::rotate_enforces_sensitive_timelock` Рё РїСЂРѕРІРµСЂСЏРµС‚СЃСЏ РІ CI.
- РџРµСЂРµРґ С„Р°РєС‚РёС‡РµСЃРєРёРј РІС‹Р·РѕРІРѕРј on-chain РґРµР№СЃС‚РІРёСЏ РІС‹РїРѕР»РЅСЏРµС‚ `automation::ensure_action` РґР»СЏ РєРѕРЅС‚СЂРѕР»СЏ Р»РёРјРёС‚РѕРІ `max_failures` Рё СЃСЂРѕРєР° РґРµР№СЃС‚РІРёСЏ РєР°РїР°Р±РёР»РёС‚Рё; РїРѕСЃР»Рµ РґРѕСЃС‚РёР¶РµРЅРёСЏ РїРѕСЂРѕРіР° С„СѓРЅРєС†РёСЏ Р·Р°РІРµСЂС€Р°РµС‚СЃСЏ СЃ `E_AUTOBOT_FAILURE_LIMIT`.
- РџСЂРё РѕС€РёР±РєРµ РІС‹Р·С‹РІР°РµС‚ `automation::record_failure`, С‡С‚Рѕ РїСѓР±Р»РёРєСѓРµС‚ `AutomationTick` Рё `AutomationError`, СѓРІРµР»РёС‡РёРІР°РµС‚ `failure_count` Рё РѕС‡РёС‰Р°РµС‚ pending; РїСЂРё СѓСЃРїРµС…Рµ `record_success` СЃР±СЂР°СЃС‹РІР°РµС‚ `failure_count` Рё РїРѕР·РІРѕР»СЏРµС‚ РїСѓР±Р»РёРєРѕРІР°С‚СЊ РЅРѕРІС‹Р№ dry-run. РњРµС‚СЂРёРєРё РґРѕСЃС‚СѓРїРЅС‹ РІ [monitoring.md](monitoring.md).
- РћРїРµСЂР°С‚РѕСЂС‹ РѕР±СЏР·Р°РЅС‹ РјРѕРЅРёС‚РѕСЂРёС‚СЊ `failure_count` Рё РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РІСЂР°С‰Р°С‚СЊ РєР»СЋС‡ РёР»Рё РїРѕРІС‹С€Р°С‚СЊ `max_failures` С‡РµСЂРµР· `rotate_bot`; Р»СЋР±С‹Рµ РёР·РјРµРЅРµРЅРёСЏ cron-СЃРїРµРєР° Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё СЃР±СЂР°СЃС‹РІР°СЋС‚ pending Рё digest РїСЂРµРґС‹РґСѓС‰РµР№ РїРѕРїС‹С‚РєРё.
- Р”Р»СЏ РєРѕРЅС‚СЂРѕР»СЏ pending-РґРµР№СЃС‚РІРёР№ Рё С‚Р°Р№РјР»РѕРєРѕРІ РёСЃРїРѕР»СЊР·СѓР№С‚Рµ РїСѓР±Р»РёС‡РЅС‹Рµ view `views::list_automation_bots`/`views::get_automation_bot` (СЃРј. [architecture/json/lottery_multi_views.schema.json](../architecture/json/lottery_multi_views.schema.json)); РґР°РЅРЅС‹Рµ РѕС‚РѕР±СЂР°Р¶Р°СЋС‚СЃСЏ С‚Р°РєР¶Рµ РЅР° СЃС‚Р°С‚СѓСЃРЅРѕР№ СЃС‚СЂР°РЅРёС†Рµ. Р”Р»СЏ РѕРїРµСЂР°С‚РёРІРЅРѕРіРѕ РґРѕСЃС‚СѓРїР° Рё Р¶СѓСЂРЅР°Р»РёСЂРѕРІР°РЅРёСЏ СЃРЅРёРјРєРѕРІ РёСЃРїРѕР»СЊР·СѓР№С‚Рµ CLI `./SupraLottery/supra/scripts/automation_status.sh <config> list|get`, РєРѕС‚РѕСЂС‹Р№ РїСЂРѕРєСЃРёСЂСѓРµС‚ СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РёРµ view С‡РµСЂРµР· Supra CLI.
- РЎС†РµРЅР°СЂРёР№ VRF-СЃРЅР°РїС€РѕС‚Р°: РїРѕРґРіРѕС‚РѕРІРёС‚СЊ `snapshot_hash = sha3-256(bcs::to_bytes(total, minimum, effective, timestamp))`, РІС‹РїРѕР»РЅРёС‚СЊ dry-run СЃ `ACTION_TOPUP_VRF_DEPOSIT`, РґРѕР¶РґР°С‚СЊСЃСЏ `pending_execute_after` Рё Р·Р°С‚РµРј РІС‹Р·РІР°С‚СЊ `vrf_deposit::record_snapshot_automation(..., snapshot_hash)` вЂ” С„СѓРЅРєС†РёСЏ СЃР°РјР° РІС‹Р·С‹РІР°РµС‚ `automation::record_success` Рё РѕС‡РёС‰Р°РµС‚ pending.

## Dual-write РјРёРіСЂР°С†РёСЏ
1. Р—Р°РїСѓСЃС‚РёС‚СЊ `./SupraLottery/supra/scripts/dual_write_control.sh init <abort_on_mismatch> <abort_on_missing>` (РёР»Рё `update-flags`) РІ РІС‹Р±СЂР°РЅРЅРѕРј РѕРєСЂСѓР¶РµРЅРёРё (`--backend local|docker|podman`, `--profile/--config` РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё) Рё РІРєР»СЋС‡РёС‚СЊ Р·РµСЂРєР°Р»СЊРЅСѓСЋ Р·Р°РїРёСЃСЊ РєРѕРјР°РЅРґРѕР№ `enable-mirror`. РЎРєСЂРёРїС‚ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё РѕРїСЂРµРґРµР»СЏРµС‚ Supra CLI РёР»Рё РєРѕРЅС‚РµР№РЅРµСЂ Рё РїСѓР±Р»РёРєСѓРµС‚ `ArchiveDualWriteStarted` РїСЂРё СѓСЃС‚Р°РЅРѕРІРєРµ РѕР¶РёРґР°РЅРёР№.
2. Р”Р»СЏ РєР°Р¶РґРѕР№ Р»РѕС‚РµСЂРµРё РґРѕР±Р°РІРёС‚СЊ СЌС‚Р°Р»РѕРЅРЅС‹Р№ С…СЌС€: `./SupraLottery/supra/scripts/dual_write_control.sh set <lottery_id> <hash_hex>`; РєРѕРЅС‚СЂРѕР»РёСЂРѕРІР°С‚СЊ СЂРµР·СѓР»СЊС‚Р°С‚С‹ С‡РµСЂРµР· `dual_write_control.sh status <lottery_id>` (РІРѕР·РІСЂР°С‰Р°РµС‚ `DualWriteStatus`) Рё СЃРѕР±С‹С‚РёСЏ `ArchiveDualWriteStarted`. Р”Р»СЏ СЃРІРѕРґРЅРѕРіРѕ РєРѕРЅС‚СЂРѕР»СЏ РёСЃРїРѕР»СЊР·СѓР№С‚Рµ `dual_write_control.sh pending`, С‡С‚РѕР±С‹ РїРѕР»СѓС‡РёС‚СЊ СЃРїРёСЃРѕРє РІСЃРµС… Р»РѕС‚РµСЂРµР№ СЃ Р°РєС‚РёРІРЅС‹Рј РѕР¶РёРґР°РЅРёРµРј С…СЌС€Р°, Р° РґР»СЏ РїСЂРѕРІРµСЂРєРё РіР»РѕР±Р°Р»СЊРЅС‹С… РїРµСЂРµРєР»СЋС‡Р°С‚РµР»РµР№ вЂ” `dual_write_control.sh flags` (РґРµР»Р°РµС‚ `view` Рє `legacy_bridge::dual_write_flags`). РџСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РІС‹РєР»СЋС‡РёС‚СЊ Р·РµСЂРєР°Р»Рѕ (`disable-mirror`) РїРµСЂРµРґ РѕР±СЃР»СѓР¶РёРІР°РЅРёРµРј.
3. РџРѕСЃР»Рµ С„РёРЅР°Р»РёР·Р°С†РёРё Р»РѕС‚РµСЂРµРё СѓР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ `history::record_summary` (РґР»СЏ РѕС‚РјРµРЅС‘РЅРЅС‹С… вЂ” `payouts::archive_canceled_lottery_admin`) СЃСЂР°Р±РѕС‚Р°Р»: СЃРѕР±С‹С‚РёРµ `ArchiveDualWriteCompleted`, Р·Р°РїРёСЃСЊ `LegacySummaryEvent` Рё СЃС‚Р°С‚СѓСЃ `expected_hash = None`. РџСЂРё СЂР°СЃС…РѕР¶РґРµРЅРёРё Р·Р°РїСѓСЃС‚РёС‚СЊ `dual_write_control.sh mirror <lottery_id>`, РїРѕРІС‚РѕСЂРЅРѕ СѓСЃС‚Р°РЅРѕРІРёС‚СЊ РѕР¶РёРґР°РЅРёРµ (`set`) Рё РёРЅРёС†РёРёСЂРѕРІР°С‚СЊ РѕР±РЅРѕРІР»РµРЅРёРµ СЃРІРѕРґРєРё; Р¶СѓСЂРЅР°Р» `history_bridge::get_summary` РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РґР»СЏ СЃРІРµСЂРєРё BCS.
4. Р”Р»СЏ РёРјРїРѕСЂС‚РёСЂРѕРІР°РЅРЅС‹С… СЂРѕР·С‹РіСЂС‹С€РµР№ РёСЃРїРѕР»СЊР·СѓР№С‚Рµ `./SupraLottery/supra/scripts/history_backfill.sh`:
   - `dry-run <summary_path> [--lottery-id <id>] [--hex-output path] [--hash-output path] [--json] [--json-output path] [--quiet]` вЂ” СЂР°СЃСЃС‡РёС‚С‹РІР°РµС‚ sha3-256 С…СЌС€ С„Р°Р№Р»Р° BCS (РїРѕРґРґРµСЂР¶РёРІР°СЋС‚СЃСЏ Р±РёРЅР°СЂРЅС‹Рµ Рё hex-РїСЂРµРґСЃС‚Р°РІР»РµРЅРёСЏ), С„РѕСЂРјРёСЂСѓРµС‚ РіРѕС‚РѕРІСѓСЋ РєРѕРјР°РЅРґСѓ `import` Рё РјРѕР¶РµС‚ РѕС‚РґР°С‚СЊ JSON-СЃС‚СЂСѓРєС‚СѓСЂСѓ РґР»СЏ РІРЅРµС€РЅРёС… РїР°Р№РїР»Р°Р№РЅРѕРІ; РѕРїС†РёРё `--json --quiet` РїРµС‡Р°С‚Р°СЋС‚ С‚РѕР»СЊРєРѕ JSON, `--json-output` СЃРѕС…СЂР°РЅСЏРµС‚ С„Р°Р№Р» РґР»СЏ Р°СЂС‚РµС„Р°РєС‚РѕРІ CI.
   - JSON РІС‹РІРѕРґ СЃРѕРґРµСЂР¶РёС‚ `summary_hex`, `expected_hash`, `size_bytes`, `suggested_command` Рё Р°Р±СЃРѕР»СЋС‚РЅС‹Р№ РїСѓС‚СЊ Рє СЃРІРѕРґРєРµ; СЃРѕС…СЂР°РЅСЏР№С‚Рµ С„Р°Р№Р» Рё РїСЂРёРєР»Р°РґС‹РІР°Р№С‚Рµ РµРіРѕ Рє Р·Р°РїРёСЃРё РІ Р¶СѓСЂРЅР°Р» С‡РµСЂРµР· `SupraLottery/supra/scripts/incident_log.sh --type "Backfill" ...`.
   - РџРѕСЃР»Рµ РёРјРїРѕСЂС‚Р° Р·Р°РїСѓСЃРєР°Р№С‚Рµ `dual_write_control.sh status <lottery_id>` Рё РїСЂРёРєР»Р°РґС‹РІР°Р№С‚Рµ РІС‹РІРѕРґ Рє С‚РѕР№ Р¶Рµ Р·Р°РїРёСЃРё Р¶СѓСЂРЅР°Р»Р°, С‡С‚РѕР±С‹ Р·Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ РѕС‡РёСЃС‚РєСѓ РѕР¶РёРґР°РЅРёР№ dual-write.
   - `import <lottery_id> 0x<summary_bcs_hex> 0x<sha3_hash>` вЂ” РїРµСЂРµРЅРѕСЃРёС‚ BCS-СЃРІРѕРґРєСѓ РІ `ArchiveLedger`, РїСѓР±Р»РёРєСѓРµС‚ `LegacySummaryImportedEvent` Рё Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё Р·РµСЂРєР°Р»РёСЂСѓРµС‚ РґР°РЅРЅС‹Рµ РІ `lottery_support::history_bridge`.
   - `rollback <lottery_id>` вЂ” СѓРґР°Р»СЏРµС‚ РёРјРїРѕСЂС‚РёСЂРѕРІР°РЅРЅСѓСЋ СЃРІРѕРґРєСѓ Рё С„РёРєСЃРёСЂСѓРµС‚ `LegacySummaryRolledBackEvent` (РїСЂРёРјРµРЅРёРјРѕ С‚РѕР»СЊРєРѕ Рє Р·Р°РїРёСЃСЏРј, РѕС‚РјРµС‡РµРЅРЅС‹Рј РєР°Рє legacy).
   - `classify <lottery_id> <primary_type> <tags_mask>` вЂ” РѕР±РЅРѕРІР»СЏРµС‚ РєР»Р°СЃСЃРёС„РёРєР°С‚РѕСЂС‹ Рё СЌРјРёС‚РёСЂСѓРµС‚ `LegacySummaryClassificationUpdatedEvent`; РїРѕСЃР»Рµ РєРѕРјР°РЅРґС‹ РЅРµРѕР±С…РѕРґРёРјРѕ СЃРёРЅС…СЂРѕРЅРёР·РёСЂРѕРІР°С‚СЊ С„СЂРѕРЅС‚РµРЅРґ Р±РµР№РґР¶РµР№.
   - `status <lottery_id>`/`list [from] [limit]` вЂ” РїСЂРѕРІРµСЂРєР° С„Р»Р°РіР° legacy Рё РёС‚РѕРіРѕРІРѕРіРѕ СЃРїРёСЃРєР° `history::list_finalized`.

## РњРѕРЅРёС‚РѕСЂРёРЅРі VRF-РґРµРїРѕР·РёС‚Р°
- Р РµРіСѓР»СЏСЂРЅРѕ РІС‹РїРѕР»РЅСЏС‚СЊ dry-run Рё `vrf_deposit::record_snapshot_automation` С‡РµСЂРµР· Р±РѕС‚Р° (РёСЃРїРѕР»СЊР·СѓСЏ СЃРѕРіР»Р°СЃРѕРІР°РЅРЅС‹Р№ `snapshot_hash`).
- РџСЂРё `requests_paused = true` РїРѕРїРѕР»РЅСЏС‚СЊ РґРµРїРѕР·РёС‚ Рё РІС‹Р·С‹РІР°С‚СЊ `vrf_deposit::resume_requests`.
- РЎРѕР±С‹С‚РёСЏ `VrfDepositAlert` Рё `VrfRequestsPaused` РґРѕР»Р¶РЅС‹ РїРѕРїР°РґР°С‚СЊ РІ Р¶СѓСЂРЅР°Р» СЌРєСЃРїР»СѓР°С‚Р°С†РёРё.

## Р­РєСЃС‚СЂРµРЅРЅС‹Р№ СЂРµС„Р°РЅРґ
- РџРµСЂРµРґ РЅР°С‡Р°Р»РѕРј РІС‹РїРѕР»РЅРёС‚Рµ `./SupraLottery/supra/scripts/refund_control.sh --dry-run <config> status <lottery_id>`, С‡С‚РѕР±С‹ СѓР±РµРґРёС‚СЊСЃСЏ РІ РєРѕСЂСЂРµРєС‚РЅРѕСЃС‚Рё Р°СЂРіСѓРјРµРЅС‚РѕРІ Рё РїРѕРґРіРѕС‚РѕРІР»РµРЅРЅС‹С… РєРѕРјР°РЅРґ. Dry-run РІС‹РІРѕРґРёС‚ РїСЂРµРґРїРѕР»Р°РіР°РµРјС‹Р№ РІС‹Р·РѕРІ Supra CLI Рё РїРѕР·РІРѕР»СЏРµС‚ РїСЂРѕРІРµСЂРёС‚СЊ РїР°Р№РїР»Р°Р№РЅ Р±РµР· РґРѕСЃС‚СѓРїР° Рє Р±РёРЅР°СЂСЋ.
- РђРєС‚РёРІРёСЂРѕРІР°С‚СЊ `emergency_stop`.
- РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ `./SupraLottery/supra/scripts/refund_control.sh [--dry-run] <config> cancel <lottery_id> <reason_code> <timestamp>` РґР»СЏ РїРµСЂРµРІРѕРґР° СЃС‚Р°С‚СѓСЃР° Рё С„РёРєСЃР°С†РёРё `CancellationRecord`.
- Р—Р°РїСѓСЃРєР°С‚СЊ Р±Р°С‚С‡Рё РІРѕР·РІСЂР°С‚РѕРІ С‡РµСЂРµР· `./SupraLottery/supra/scripts/refund_control.sh [--dry-run] <config> batch <lottery_id> <round> <tickets> <prize_refund> <operations_refund> <timestamp>`.
- РџРѕСЃР»Рµ РєР°Р¶РґРѕРіРѕ Р±Р°С‚С‡Р° РїСЂРѕРІРµСЂРёС‚СЊ `./SupraLottery/supra/scripts/refund_control.sh <config> cancellation <lottery_id>` Рё `./SupraLottery/supra/scripts/refund_control.sh <config> progress <lottery_id>` (Р°РіСЂРµРіР°С‚С‹ РІРѕР·РІСЂР°С‚Р°), СЂРµР·СѓР»СЊС‚Р°С‚С‹ Р·Р°РЅРµСЃС‚Рё РІ Р¶СѓСЂРЅР°Р».
- РџРѕ Р·Р°РІРµСЂС€РµРЅРёРё РІС‹Р·РІР°С‚СЊ `./SupraLottery/supra/scripts/refund_control.sh [--dry-run] <config> archive <lottery_id> <finalized_ts>` Рё СѓР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ `summary` СЃРѕРґРµСЂР¶РёС‚ СЃС‚Р°С‚СѓСЃ `STATUS_CANCELED`.
- РЎРЅСЏС‚СЊ С„Р»Р°Рі РїРѕСЃР»Рµ Р·Р°РІРµСЂС€РµРЅРёСЏ Рё РѕРїСѓР±Р»РёРєРѕРІР°С‚СЊ РѕС‚С‡С‘С‚ РІ СЂР°Р·РґРµР»Рµ РїРѕРґРґРµСЂР¶РєРё.

Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Рµ РїСЂРѕС†РµРґСѓСЂС‹ СЃРј. РІ [support/sla.md](../support/sla.md), [vrf_deposit.md](vrf_deposit.md), [post_release_support.md](post_release_support.md) Рё runbook Supra CLI. РћС‚С‡С‘С‚С‹ РїРѕ РёРЅС†РёРґРµРЅС‚Р°Рј Рё СЂРµС‚СЂРѕСЃРїРµРєС‚РёРІР°Рј РІРµРґСѓС‚СЃСЏ СЃРѕРіР»Р°СЃРЅРѕ [postmortems.md](postmortems.md).

