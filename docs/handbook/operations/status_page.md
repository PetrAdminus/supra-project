# Статусная страница Lottery Multi

Этот документ описывает минимальную конфигурацию публичной статусной страницы для `lottery_multi` и связывает ончейн-метрики с операционными индикаторами. Основой служат view-функции [`lottery_multi::views::status_overview`](../architecture/json/lottery_multi_views.schema.json), возвращающая агрегированные счётчики по статусам лотерей, VRF и бэклогу выплат, и [`lottery_multi::views::list_automation_bots`](../architecture/json/lottery_multi_views.schema.json), раскрывающая текущее состояние AutomationBot (таймлоки, pending-действия, лимиты `max_failures`).

## Цели

- Показать пользователям и партнёрам текущий прогресс розыгрышей (сколько активных, сколько в выплатах и финализировано).
- Сигнализировать об операционных рисках: зависшие VRF-запросы, ожидание перерасчёта победителей, невыплаченные батчи.
- Обеспечить единый источник данных для мониторинга, уведомлений и ручных проверок во время релизных окон.

## Источники данных

| Поле `status_overview` | Назначение | Порог/алерт | Действия |
|------------------------|------------|-------------|----------|
| `total`, `draft`, `active`, `closing`, `draw_requested`, `drawn`, `payout`, `finalized`, `canceled` | Распределение лотерей по статусам жизненного цикла. | Нет, используется для отображения. | Отражать на дашборде и в статусной странице. |
| `vrf_requested` | Число активных VRF-запросов. | >3 в течение 30 минут — предупредительный алерт. | Проверить `automation::ensure_action`, состояние VRF-депозита и журнал бота. |
| `vrf_fulfilled_pending` | VRF выполнен, но результаты не потреблены (`consumed=false`). | >0 более 10 минут. | Запустить `automation::compute_winners` вручную, сверить dry-run. |
| `vrf_retry_blocked` | Лотереи, заблокированные `retry_after_ts > now`. | >0 в течение 1 часа. | Проверить причину отказа (события `VrfReplayDetected`, инциденты VRF). |
| `winners_pending` | Расчёт победителей ещё не завершён. | >0 более 30 минут в рабочее время. | Выяснить причину остановки батчей (`automation::failure_count`, события `WinnersComputed`). |
| `payout_backlog` | Существуют невыплаченные батчи (`payout_round < next_winner_batch_no`). | >0 более 1 часа. | Проверить очередь выплат, наличие `PayoutBatchCap`, события `PayoutBatch`. |
| `canceled` | Количество отменённых лотерей (включая авто-отмены после `MAX_VRF_ATTEMPTS`). | >0 без записи в [refund.md](../operations/refund.md) | Подтвердить, что процедура рефанда активна, обновить коммуникации и указать причину (например, исчерпаны попытки VRF). |
| `refund_active` | Количество отменённых лотерей с активным рефандом. | >0 без запущенной процедуры. | Проверить, что для каждой отмены заведён план возврата и обновлены коммуникации. |
| `refund_batch_pending` | Количество оставшихся билетов к возврату по всем активным рефандам. | >0 более 4 часов. | Следовать чек-листу [refund.md](../operations/refund.md), эскалировать Treasury. |
| `refund_sla_breach` | Флаг нарушения SLA рефанда (первый батч > 12 часов или завершение > 24 часов). | `true`. | Срочное уведомление поддержки, обновление баннеров и отправка уведомлений. |

| Поле `list_automation_bots` | Назначение | Порог/алерт | Действия |
|-----------------------------|------------|-------------|----------|
| `operator` | Адрес оператора бота, отображается в статусной странице. | Нет. | Использовать для ссылок на журнал dry-run. |
| `has_pending` | Есть ли активное pending-действие. | `true` более таймлока + 15 минут. | Проверить, что dry-run опубликован, либо отменить через `rotate_bot`. |
| `pending_execute_after` | Момент, когда действие можно выполнять. | Значение < текущего времени, но `has_pending = true`. | Напомнить оператору завершить действие или отменить. |
| `failure_count`/`max_failures` | Сколько ошибок подряд и лимит. | `failure_count == max_failures`. | Срочная эскалация, блокируются новые действия. |
| `timelock_secs` | Таймлок для dry-run. | <900 при наличии `ACTION_UNPAUSE`/`ACTION_PAYOUT_BATCH`/`ACTION_CANCEL` — критический алерт; >600 для остальных действий требует ручного подтверждения. | Отразить в заметке статусной страницы и runbook. |

## Обновление данных

1. Вызвать view со сводкой статусов:
   ```bash
   supra move view \
     --config $CONFIG \
     --function lottery_multi::views::status_overview \
     --args u64:$(date +%s)
   ```
2. Получить состояние AutomationBot (при ручном запуске можно использовать обёртку `./supra/scripts/automation_status.sh`):
   ```bash
   ./supra/scripts/automation_status.sh $CONFIG list
   ```
   При необходимости точечного запроса:
   ```bash
   ./supra/scripts/automation_status.sh $CONFIG get 0x<operator>
   ```
3. Преобразовать ответы в JSON и передать в виджеты статусной страницы (`status_overview` → блоки со счётчиками, `list_automation_bots` → таблица бота).
4. Для внутренних панелей допускается опрос каждые 60 секунд; публичный сайт может кешировать ответ 2–3 минуты.

## Интеграция с мониторингом

- Добавить дашборд Grafana «Lottery Multi Status» с визуализациями по каждому полю `status_overview` и таблицей `list_automation_bots` (оператор, pending, лимит ошибок).
- Настроить алерты (PagerDuty / Opsgenie) согласно таблице выше.
- Ссылаться на этот документ из [monitoring.md](monitoring.md) и [runbooks.md](runbooks.md) при описании реакций на инциденты.

## Релизный чек-лист

- Перед запуском новой версии убедиться, что `status_overview` и `list_automation_bots` возвращают корректные значения на devnet/staging.
- Зафиксировать скриншот статусной страницы в [release_checklist.md](release_checklist.md) перед продакшен-деплоем.
- Проверить, что `docs/handbook/architecture/json/examples/lottery_multi_view_samples.json` обновлён и проходит валидацию `pytest SupraLottery/tests/test_view_schema_examples.py`.

## Инциденты и ретроспективы

- При увеличении `vrf_retry_blocked` или `payout_backlog` создавать запись в [incident_log.md](incident_log.md) с ссылкой на конкретную лотерею.
- Добавлять итоги разборов в статусной странице (например, «VRF-delays resolved») после закрытия инцидента и ссылаться на отчёты из [postmortems.md](postmortems.md).
- Еженедельно сверять содержимое раздела со списком активностей в [post_release_support.md](post_release_support.md).

## Ответственные

- **Product/Ops**: поддерживают содержание статусной страницы и коммуникации.
- **DevOps**: настраивают опрос view и публикацию на CDN.
- **On-chain команда**: реагирует на алерты, если счётчики выходят за пределы порогов.
