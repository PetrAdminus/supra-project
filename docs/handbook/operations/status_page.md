# РЎС‚Р°С‚СѓСЃРЅР°СЏ СЃС‚СЂР°РЅРёС†Р° Lottery Multi

Этот документ описывает минимальную конфигурацию публичной статусной страницы для `lottery_multi` и связывает ончейн-метрики с операционными индикаторами. Основой служат view-функции [`lottery_multi::views::status_overview`](../architecture/json/lottery_multi_views.schema.json), возвращающая агрегированные счётчики по статусам лотерей, VRF и бэклогу выплат, и [`lottery_engine::automation::registry_snapshot`](../../SupraLottery/supra/move_workspace/lottery_engine/sources/Automation.move), предоставляющая `AutomationRegistrySnapshot` с полным списком AutomationBot (таймлоки, pending-действия, лимиты `max_failures`). Для точечных проверок операторов используйте view `lottery_engine::automation::bot_status`, возвращающую `option<AutomationBotStatus>`.

## Р¦РµР»Рё

- РџРѕРєР°Р·Р°С‚СЊ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏРј Рё РїР°СЂС‚РЅС‘СЂР°Рј С‚РµРєСѓС‰РёР№ РїСЂРѕРіСЂРµСЃСЃ СЂРѕР·С‹РіСЂС‹С€РµР№ (СЃРєРѕР»СЊРєРѕ Р°РєС‚РёРІРЅС‹С…, СЃРєРѕР»СЊРєРѕ РІ РІС‹РїР»Р°С‚Р°С… Рё С„РёРЅР°Р»РёР·РёСЂРѕРІР°РЅРѕ).
- РЎРёРіРЅР°Р»РёР·РёСЂРѕРІР°С‚СЊ РѕР± РѕРїРµСЂР°С†РёРѕРЅРЅС‹С… СЂРёСЃРєР°С…: Р·Р°РІРёСЃС€РёРµ VRF-Р·Р°РїСЂРѕСЃС‹, РѕР¶РёРґР°РЅРёРµ РїРµСЂРµСЂР°СЃС‡С‘С‚Р° РїРѕР±РµРґРёС‚РµР»РµР№, РЅРµРІС‹РїР»Р°С‡РµРЅРЅС‹Рµ Р±Р°С‚С‡Рё.
- РћР±РµСЃРїРµС‡РёС‚СЊ РµРґРёРЅС‹Р№ РёСЃС‚РѕС‡РЅРёРє РґР°РЅРЅС‹С… РґР»СЏ РјРѕРЅРёС‚РѕСЂРёРЅРіР°, СѓРІРµРґРѕРјР»РµРЅРёР№ Рё СЂСѓС‡РЅС‹С… РїСЂРѕРІРµСЂРѕРє РІРѕ РІСЂРµРјСЏ СЂРµР»РёР·РЅС‹С… РѕРєРѕРЅ.

## РСЃС‚РѕС‡РЅРёРєРё РґР°РЅРЅС‹С…

| РџРѕР»Рµ `status_overview` | РќР°Р·РЅР°С‡РµРЅРёРµ | РџРѕСЂРѕРі/Р°Р»РµСЂС‚ | Р”РµР№СЃС‚РІРёСЏ |
|------------------------|------------|-------------|----------|
| `total`, `draft`, `active`, `closing`, `draw_requested`, `drawn`, `payout`, `finalized`, `canceled` | Р Р°СЃРїСЂРµРґРµР»РµРЅРёРµ Р»РѕС‚РµСЂРµР№ РїРѕ СЃС‚Р°С‚СѓСЃР°Рј Р¶РёР·РЅРµРЅРЅРѕРіРѕ С†РёРєР»Р°. | РќРµС‚, РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РґР»СЏ РѕС‚РѕР±СЂР°Р¶РµРЅРёСЏ. | РћС‚СЂР°Р¶Р°С‚СЊ РЅР° РґР°С€Р±РѕСЂРґРµ Рё РІ СЃС‚Р°С‚СѓСЃРЅРѕР№ СЃС‚СЂР°РЅРёС†Рµ. |
| `vrf_requested` | Р§РёСЃР»Рѕ Р°РєС‚РёРІРЅС‹С… VRF-Р·Р°РїСЂРѕСЃРѕРІ. | >3 РІ С‚РµС‡РµРЅРёРµ 30 РјРёРЅСѓС‚ вЂ” РїСЂРµРґСѓРїСЂРµРґРёС‚РµР»СЊРЅС‹Р№ Р°Р»РµСЂС‚. | РџСЂРѕРІРµСЂРёС‚СЊ `automation::ensure_action`, СЃРѕСЃС‚РѕСЏРЅРёРµ VRF-РґРµРїРѕР·РёС‚Р° Рё Р¶СѓСЂРЅР°Р» Р±РѕС‚Р°. |
| `vrf_fulfilled_pending` | VRF РІС‹РїРѕР»РЅРµРЅ, РЅРѕ СЂРµР·СѓР»СЊС‚Р°С‚С‹ РЅРµ РїРѕС‚СЂРµР±Р»РµРЅС‹ (`consumed=false`). | >0 Р±РѕР»РµРµ 10 РјРёРЅСѓС‚. | Р—Р°РїСѓСЃС‚РёС‚СЊ `automation::compute_winners` РІСЂСѓС‡РЅСѓСЋ, СЃРІРµСЂРёС‚СЊ dry-run. |
| `vrf_retry_blocked` | Р›РѕС‚РµСЂРµРё, Р·Р°Р±Р»РѕРєРёСЂРѕРІР°РЅРЅС‹Рµ `retry_after_ts > now`. | >0 РІ С‚РµС‡РµРЅРёРµ 1 С‡Р°СЃР°. | РџСЂРѕРІРµСЂРёС‚СЊ РїСЂРёС‡РёРЅСѓ РѕС‚РєР°Р·Р° (СЃРѕР±С‹С‚РёСЏ `VrfReplayDetected`, РёРЅС†РёРґРµРЅС‚С‹ VRF). |
| `winners_pending` | Р Р°СЃС‡С‘С‚ РїРѕР±РµРґРёС‚РµР»РµР№ РµС‰С‘ РЅРµ Р·Р°РІРµСЂС€С‘РЅ. | >0 Р±РѕР»РµРµ 30 РјРёРЅСѓС‚ РІ СЂР°Р±РѕС‡РµРµ РІСЂРµРјСЏ. | Р’С‹СЏСЃРЅРёС‚СЊ РїСЂРёС‡РёРЅСѓ РѕСЃС‚Р°РЅРѕРІРєРё Р±Р°С‚С‡РµР№ (`automation::failure_count`, СЃРѕР±С‹С‚РёСЏ `WinnersComputed`). |
| `payout_backlog` | РЎСѓС‰РµСЃС‚РІСѓСЋС‚ РЅРµРІС‹РїР»Р°С‡РµРЅРЅС‹Рµ Р±Р°С‚С‡Рё (`payout_round < next_winner_batch_no`). | >0 Р±РѕР»РµРµ 1 С‡Р°СЃР°. | РџСЂРѕРІРµСЂРёС‚СЊ РѕС‡РµСЂРµРґСЊ РІС‹РїР»Р°С‚, РЅР°Р»РёС‡РёРµ `PayoutBatchCap`, СЃРѕР±С‹С‚РёСЏ `PayoutBatch`. |
| `canceled` | РљРѕР»РёС‡РµСЃС‚РІРѕ РѕС‚РјРµРЅС‘РЅРЅС‹С… Р»РѕС‚РµСЂРµР№ (РІРєР»СЋС‡Р°СЏ Р°РІС‚Рѕ-РѕС‚РјРµРЅС‹ РїРѕСЃР»Рµ `MAX_VRF_ATTEMPTS`). | >0 Р±РµР· Р·Р°РїРёСЃРё РІ [refund.md](../operations/refund.md) | РџРѕРґС‚РІРµСЂРґРёС‚СЊ, С‡С‚Рѕ РїСЂРѕС†РµРґСѓСЂР° СЂРµС„Р°РЅРґР° Р°РєС‚РёРІРЅР°, РѕР±РЅРѕРІРёС‚СЊ РєРѕРјРјСѓРЅРёРєР°С†РёРё Рё СѓРєР°Р·Р°С‚СЊ РїСЂРёС‡РёРЅСѓ (РЅР°РїСЂРёРјРµСЂ, РёСЃС‡РµСЂРїР°РЅС‹ РїРѕРїС‹С‚РєРё VRF). |
| `refund_active` | РљРѕР»РёС‡РµСЃС‚РІРѕ РѕС‚РјРµРЅС‘РЅРЅС‹С… Р»РѕС‚РµСЂРµР№ СЃ Р°РєС‚РёРІРЅС‹Рј СЂРµС„Р°РЅРґРѕРј. | >0 Р±РµР· Р·Р°РїСѓС‰РµРЅРЅРѕР№ РїСЂРѕС†РµРґСѓСЂС‹. | РџСЂРѕРІРµСЂРёС‚СЊ, С‡С‚Рѕ РґР»СЏ РєР°Р¶РґРѕР№ РѕС‚РјРµРЅС‹ Р·Р°РІРµРґС‘РЅ РїР»Р°РЅ РІРѕР·РІСЂР°С‚Р° Рё РѕР±РЅРѕРІР»РµРЅС‹ РєРѕРјРјСѓРЅРёРєР°С†РёРё. |
| `refund_batch_pending` | РљРѕР»РёС‡РµСЃС‚РІРѕ РѕСЃС‚Р°РІС€РёС…СЃСЏ Р±РёР»РµС‚РѕРІ Рє РІРѕР·РІСЂР°С‚Сѓ РїРѕ РІСЃРµРј Р°РєС‚РёРІРЅС‹Рј СЂРµС„Р°РЅРґР°Рј. | >0 Р±РѕР»РµРµ 4 С‡Р°СЃРѕРІ. | РЎР»РµРґРѕРІР°С‚СЊ С‡РµРє-Р»РёСЃС‚Сѓ [refund.md](../operations/refund.md), СЌСЃРєР°Р»РёСЂРѕРІР°С‚СЊ Treasury. |
| `refund_sla_breach` | Р¤Р»Р°Рі РЅР°СЂСѓС€РµРЅРёСЏ SLA СЂРµС„Р°РЅРґР° (РїРµСЂРІС‹Р№ Р±Р°С‚С‡ > 12 С‡Р°СЃРѕРІ РёР»Рё Р·Р°РІРµСЂС€РµРЅРёРµ > 24 С‡Р°СЃРѕРІ). | `true`. | РЎСЂРѕС‡РЅРѕРµ СѓРІРµРґРѕРјР»РµРЅРёРµ РїРѕРґРґРµСЂР¶РєРё, РѕР±РЅРѕРІР»РµРЅРёРµ Р±Р°РЅРЅРµСЂРѕРІ Рё РѕС‚РїСЂР°РІРєР° СѓРІРµРґРѕРјР»РµРЅРёР№. |

| Поле `registry_snapshot.bots` | Назначение | Порог/алерт | Действия |
|-----------------------------|------------|-------------|----------|
| `operator` | РђРґСЂРµСЃ РѕРїРµСЂР°С‚РѕСЂР° Р±РѕС‚Р°, РѕС‚РѕР±СЂР°Р¶Р°РµС‚СЃСЏ РІ СЃС‚Р°С‚СѓСЃРЅРѕР№ СЃС‚СЂР°РЅРёС†Рµ. | РќРµС‚. | РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РґР»СЏ СЃСЃС‹Р»РѕРє РЅР° Р¶СѓСЂРЅР°Р» dry-run. |
| `has_pending` | Р•СЃС‚СЊ Р»Рё Р°РєС‚РёРІРЅРѕРµ pending-РґРµР№СЃС‚РІРёРµ. | `true` Р±РѕР»РµРµ С‚Р°Р№РјР»РѕРєР° + 15 РјРёРЅСѓС‚. | РџСЂРѕРІРµСЂРёС‚СЊ, С‡С‚Рѕ dry-run РѕРїСѓР±Р»РёРєРѕРІР°РЅ, Р»РёР±Рѕ РѕС‚РјРµРЅРёС‚СЊ С‡РµСЂРµР· `rotate_bot`. |
| `pending_execute_after` | РњРѕРјРµРЅС‚, РєРѕРіРґР° РґРµР№СЃС‚РІРёРµ РјРѕР¶РЅРѕ РІС‹РїРѕР»РЅСЏС‚СЊ. | Р—РЅР°С‡РµРЅРёРµ < С‚РµРєСѓС‰РµРіРѕ РІСЂРµРјРµРЅРё, РЅРѕ `has_pending = true`. | РќР°РїРѕРјРЅРёС‚СЊ РѕРїРµСЂР°С‚РѕСЂСѓ Р·Р°РІРµСЂС€РёС‚СЊ РґРµР№СЃС‚РІРёРµ РёР»Рё РѕС‚РјРµРЅРёС‚СЊ. |
| `failure_count`/`max_failures` | РЎРєРѕР»СЊРєРѕ РѕС€РёР±РѕРє РїРѕРґСЂСЏРґ Рё Р»РёРјРёС‚. | `failure_count == max_failures`. | РЎСЂРѕС‡РЅР°СЏ СЌСЃРєР°Р»Р°С†РёСЏ, Р±Р»РѕРєРёСЂСѓСЋС‚СЃСЏ РЅРѕРІС‹Рµ РґРµР№СЃС‚РІРёСЏ. |
| `timelock_secs` | РўР°Р№РјР»РѕРє РґР»СЏ dry-run. | <900 РїСЂРё РЅР°Р»РёС‡РёРё `ACTION_UNPAUSE`/`ACTION_PAYOUT_BATCH`/`ACTION_CANCEL` вЂ” РєСЂРёС‚РёС‡РµСЃРєРёР№ Р°Р»РµСЂС‚; >600 РґР»СЏ РѕСЃС‚Р°Р»СЊРЅС‹С… РґРµР№СЃС‚РІРёР№ С‚СЂРµР±СѓРµС‚ СЂСѓС‡РЅРѕРіРѕ РїРѕРґС‚РІРµСЂР¶РґРµРЅРёСЏ. | РћС‚СЂР°Р·РёС‚СЊ РІ Р·Р°РјРµС‚РєРµ СЃС‚Р°С‚СѓСЃРЅРѕР№ СЃС‚СЂР°РЅРёС†С‹ Рё runbook. |

## РћР±РЅРѕРІР»РµРЅРёРµ РґР°РЅРЅС‹С…

1. Р’С‹Р·РІР°С‚СЊ view СЃРѕ СЃРІРѕРґРєРѕР№ СЃС‚Р°С‚СѓСЃРѕРІ:
   ```bash
   supra move view \
     --config $CONFIG \
     --function lottery_multi::views::status_overview \
     --args u64:$(date +%s)
   ```
2. Получить состояние AutomationBot (при ручном запуске можно использовать обёртку `./SupraLottery/supra/scripts/automation_status.sh`, которая проксирует view `lottery_engine::automation::registry_snapshot` и `lottery_engine::automation::bot_status`):
   ```bash
   ./SupraLottery/supra/scripts/automation_status.sh $CONFIG list
   ```
   РџСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё С‚РѕС‡РµС‡РЅРѕРіРѕ Р·Р°РїСЂРѕСЃР°:
   ```bash
   ./SupraLottery/supra/scripts/automation_status.sh $CONFIG get 0x<operator>
   ```
3. РџСЂРµРѕР±СЂР°Р·РѕРІР°С‚СЊ РѕС‚РІРµС‚С‹ РІ JSON Рё РїРµСЂРµРґР°С‚СЊ РІ РІРёРґР¶РµС‚С‹ СЃС‚Р°С‚СѓСЃРЅРѕР№ СЃС‚СЂР°РЅРёС†С‹ (`status_overview` в†’ Р±Р»РѕРєРё СЃРѕ СЃС‡С‘С‚С‡РёРєР°РјРё, `lottery_engine::automation::registry_snapshot` в†’ С‚Р°Р±Р»РёС†Р° Р±РѕС‚Р°).
4. Р”Р»СЏ РІРЅСѓС‚СЂРµРЅРЅРёС… РїР°РЅРµР»РµР№ РґРѕРїСѓСЃРєР°РµС‚СЃСЏ РѕРїСЂРѕСЃ РєР°Р¶РґС‹Рµ 60 СЃРµРєСѓРЅРґ; РїСѓР±Р»РёС‡РЅС‹Р№ СЃР°Р№С‚ РјРѕР¶РµС‚ РєРµС€РёСЂРѕРІР°С‚СЊ РѕС‚РІРµС‚ 2вЂ“3 РјРёРЅСѓС‚С‹.

## РРЅС‚РµРіСЂР°С†РёСЏ СЃ РјРѕРЅРёС‚РѕСЂРёРЅРіРѕРј

- Р”РѕР±Р°РІРёС‚СЊ РґР°С€Р±РѕСЂРґ Grafana В«Lottery Multi StatusВ» СЃ РІРёР·СѓР°Р»РёР·Р°С†РёСЏРјРё РїРѕ РєР°Р¶РґРѕРјСѓ РїРѕР»СЋ `status_overview` Рё С‚Р°Р±Р»РёС†РµР№ `lottery_engine::automation::registry_snapshot` (РѕРїРµСЂР°С‚РѕСЂ, pending, Р»РёРјРёС‚ РѕС€РёР±РѕРє).
- РќР°СЃС‚СЂРѕРёС‚СЊ Р°Р»РµСЂС‚С‹ (PagerDuty / Opsgenie) СЃРѕРіР»Р°СЃРЅРѕ С‚Р°Р±Р»РёС†Рµ РІС‹С€Рµ.
- РЎСЃС‹Р»Р°С‚СЊСЃСЏ РЅР° СЌС‚РѕС‚ РґРѕРєСѓРјРµРЅС‚ РёР· [monitoring.md](monitoring.md) Рё [runbooks.md](runbooks.md) РїСЂРё РѕРїРёСЃР°РЅРёРё СЂРµР°РєС†РёР№ РЅР° РёРЅС†РёРґРµРЅС‚С‹.

## Р РµР»РёР·РЅС‹Р№ С‡РµРє-Р»РёСЃС‚

- РџРµСЂРµРґ Р·Р°РїСѓСЃРєРѕРј РЅРѕРІРѕР№ РІРµСЂСЃРёРё СѓР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ `status_overview` Рё `lottery_engine::automation::registry_snapshot` РІРѕР·РІСЂР°С‰Р°СЋС‚ РєРѕСЂСЂРµРєС‚РЅС‹Рµ Р·РЅР°С‡РµРЅРёСЏ РЅР° devnet/staging.
- Р—Р°С„РёРєСЃРёСЂРѕРІР°С‚СЊ СЃРєСЂРёРЅС€РѕС‚ СЃС‚Р°С‚СѓСЃРЅРѕР№ СЃС‚СЂР°РЅРёС†С‹ РІ [release_checklist.md](release_checklist.md) РїРµСЂРµРґ РїСЂРѕРґР°РєС€РµРЅ-РґРµРїР»РѕРµРј.
- РџСЂРѕРІРµСЂРёС‚СЊ, С‡С‚Рѕ `docs/handbook/architecture/json/examples/lottery_multi_view_samples.json` РѕР±РЅРѕРІР»С‘РЅ Рё РїСЂРѕС…РѕРґРёС‚ РІР°Р»РёРґР°С†РёСЋ `pytest SupraLottery/tests/test_view_schema_examples.py`.

## РРЅС†РёРґРµРЅС‚С‹ Рё СЂРµС‚СЂРѕСЃРїРµРєС‚РёРІС‹

- РџСЂРё СѓРІРµР»РёС‡РµРЅРёРё `vrf_retry_blocked` РёР»Рё `payout_backlog` СЃРѕР·РґР°РІР°С‚СЊ Р·Р°РїРёСЃСЊ РІ [incident_log.md](incident_log.md) СЃ СЃСЃС‹Р»РєРѕР№ РЅР° РєРѕРЅРєСЂРµС‚РЅСѓСЋ Р»РѕС‚РµСЂРµСЋ.
- Р”РѕР±Р°РІР»СЏС‚СЊ РёС‚РѕРіРё СЂР°Р·Р±РѕСЂРѕРІ РІ СЃС‚Р°С‚СѓСЃРЅРѕР№ СЃС‚СЂР°РЅРёС†Рµ (РЅР°РїСЂРёРјРµСЂ, В«VRF-delays resolvedВ») РїРѕСЃР»Рµ Р·Р°РєСЂС‹С‚РёСЏ РёРЅС†РёРґРµРЅС‚Р° Рё СЃСЃС‹Р»Р°С‚СЊСЃСЏ РЅР° РѕС‚С‡С‘С‚С‹ РёР· [postmortems.md](postmortems.md).
- Р•Р¶РµРЅРµРґРµР»СЊРЅРѕ СЃРІРµСЂСЏС‚СЊ СЃРѕРґРµСЂР¶РёРјРѕРµ СЂР°Р·РґРµР»Р° СЃРѕ СЃРїРёСЃРєРѕРј Р°РєС‚РёРІРЅРѕСЃС‚РµР№ РІ [post_release_support.md](post_release_support.md).

## РћС‚РІРµС‚СЃС‚РІРµРЅРЅС‹Рµ

- **Product/Ops**: РїРѕРґРґРµСЂР¶РёРІР°СЋС‚ СЃРѕРґРµСЂР¶Р°РЅРёРµ СЃС‚Р°С‚СѓСЃРЅРѕР№ СЃС‚СЂР°РЅРёС†С‹ Рё РєРѕРјРјСѓРЅРёРєР°С†РёРё.
- **DevOps**: РЅР°СЃС‚СЂР°РёРІР°СЋС‚ РѕРїСЂРѕСЃ view Рё РїСѓР±Р»РёРєР°С†РёСЋ РЅР° CDN.
- **On-chain РєРѕРјР°РЅРґР°**: СЂРµР°РіРёСЂСѓРµС‚ РЅР° Р°Р»РµСЂС‚С‹, РµСЃР»Рё СЃС‡С‘С‚С‡РёРєРё РІС‹С…РѕРґСЏС‚ Р·Р° РїСЂРµРґРµР»С‹ РїРѕСЂРѕРіРѕРІ.

