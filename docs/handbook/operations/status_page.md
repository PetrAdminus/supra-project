# Статусная страница Lottery Multi

Этот документ описывает минимальную конфигурацию публичной статусной страницы для `lottery_multi` и связывает ончейн-метрики с операционными индикаторами. Основой служит новая view-функция [`lottery_multi::views::status_overview`](../architecture/json/lottery_multi_views.schema.json), возвращающая агрегированные счётчики по статусам лотерей, VRF и бэклогу выплат.

## Цели

- Показать пользователям и партнёрам текущий прогресс розыгрышей (сколько активных, сколько в выплатах и финализировано).
- Сигнализировать об операционных рисках: зависшие VRF-запросы, ожидание перерасчёта победителей, невыплаченные батчи.
- Обеспечить единый источник данных для мониторинга, уведомлений и ручных проверок во время релизных окон.

## Источники данных

| Поле `status_overview` | Назначение | Порог/алерт | Действия |
|------------------------|------------|-------------|----------|
| `total`, `draft`, `active`, `closing`, `draw_requested`, `drawn`, `payout`, `finalized`, `canceled` | Распределение лотерей по статусам жизненного цикла. | Нет, используется для отображения. | Отражать на дашборде и в статусной странице. |
| `vrf_requested` | Число активных VRF-запросов. | >3 в течение 30 минут — предупредительный алерт. | Проверить `automation::ensure_action`, состояние VRF-депозита и журнал бота. |
| `vrf_fulfilled_pending` | VRF выполнен, но результаты не потреблены (`consumed=false`). | >0 более 10 минут. | Запустить `automation::compute_winners` вручную, сверить dry-run. |
| `vrf_retry_blocked` | Лотереи, заблокированные `retry_after_ts > now`. | >0 в течение 1 часа. | Проверить причину отказа (события `VrfReplayDetected`, инциденты VRF). |
| `winners_pending` | Расчёт победителей ещё не завершён. | >0 более 30 минут в рабочее время. | Выяснить причину остановки батчей (`automation::failure_count`, события `WinnersComputed`). |
| `payout_backlog` | Существуют невыплаченные батчи (`payout_round < next_winner_batch_no`). | >0 более 1 часа. | Проверить очередь выплат, наличие `PayoutBatchCap`, события `PayoutBatch`. |

## Обновление данных

1. Вызвать view:
   ```bash
   supra move view \
     --config $CONFIG \
     --function lottery_multi::views::status_overview \
     --args u64:$(date +%s)
   ```
2. Преобразовать ответ в JSON и передать в виджет статусной страницы.
3. Для внутренних панелей допускается опрос каждые 60 секунд; публичный сайт может кешировать ответ 2–3 минуты.

## Интеграция с мониторингом

- Добавить дашборд Grafana «Lottery Multi Status» с визуализациями по каждому полю `status_overview`.
- Настроить алерты (PagerDuty / Opsgenie) согласно таблице выше.
- Ссылаться на этот документ из [monitoring.md](monitoring.md) и [runbooks.md](runbooks.md) при описании реакций на инциденты.

## Релизный чек-лист

- Перед запуском новой версии убедиться, что `status_overview` возвращает корректные значения на devnet/staging.
- Зафиксировать скриншот статусной страницы в [release_checklist.md](release_checklist.md) перед продакшен-деплоем.
- Проверить, что `docs/handbook/architecture/json/examples/lottery_multi_view_samples.json` обновлён и проходит валидацию `pytest SupraLottery/tests/test_view_schema_examples.py`.

## Инциденты и ретроспективы

- При увеличении `vrf_retry_blocked` или `payout_backlog` создавать запись в [incident_log.md](incident_log.md) с ссылкой на конкретную лотерею.
- Добавлять итоги разборов в статусной странице (например, «VRF-delays resolved») после закрытия инцидента.

## Ответственные

- **Product/Ops**: поддерживают содержание статусной страницы и коммуникации.
- **DevOps**: настраивают опрос view и публикацию на CDN.
- **On-chain команда**: реагирует на алерты, если счётчики выходят за пределы порогов.
