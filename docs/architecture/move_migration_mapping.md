# Карта миграции on-chain структур SupraLottery

> Последнее обновление: 2026-02-15 (UTC)

Документ фиксирует сопоставление текущих on-chain ресурсов старой архитектуры SupraLottery и целевых сущностей новой модульной схемы (`lottery_data`, `lottery_engine`, `lottery_gateway`, `lottery_rewards_engine`, `lottery_utils`, `lottery_vrf_gateway`, `lottery_factory`). Таблица служит рабочим источником правды для подготовки миграционных транзакций и контроля статуса переноса. Пакет `lottery_gateway` продолжает текущий `lottery_hub`, а `lottery_vrf_gateway` строится на базе существующего `vrf_hub`; оба переименования будут выполнены после выравнивания интерфейсов.

## 1. Как пользоваться документом
- Каждая строка таблицы описывает ресурс, требующий миграции или явного вывода из эксплуатации.
- Колонка «Действия миграции» фиксирует обязательные шаги: транзакции, проверки инвариантов, зависимость от других переносов.
- Статус используется для отслеживания прогресса:
  - `Запланировано` — миграция пока не начата, действия описаны.
  - `В работе` — идёт разработка или тестирование миграционного скрипта.
  - `Готово` — миграция выполнена и подтверждена тестами.
  - `Не требуется` — ресурс выводится из эксплуатации без переноса.
- При изменении структуры ресурса или действий миграции обязательно обновляйте строку и журнал изменений в конце документа.
- Для быстрой валидации таблицы и сверки целевых пакетов с текущей Move-инвентаризацией используйте скрипт `docs/architecture/tools/check_migration_mapping.py`. Пример:
  - `python docs/architecture/tools/export_move_inventory.py --json-output /tmp/inventory.json`
  - `python docs/architecture/tools/check_migration_mapping.py --inventory-json /tmp/inventory.json --json-output /tmp/migration_status.json`
  Скрипт сформирует сводку статусов, подсветит незнакомые значения статуса, сверит численную сводку в разделе «Сводка статусов» с реальной таблицей и предупредит, если в таблице указаны пакеты, отсутствующие в текущей инвентаризации. Для строгой проверки без расхождений используйте флаг `--strict`.
- Для быстрой проверки готовности on-chain стораджей и сервисных модулей перед миграционными транзакциями можно вызвать view `lottery_gateway::health::{storage_ready, queues_ready, treasury_ready, rewards_ready, autopurchase_ready, utils_ready, history_ready, gateway_ready, access_ready, cancellations_ready, automation_ready, vrf_ready, engine_ready, snapshot}` и убедиться, что все флаги возвращают `true`. Дополнительно `rewards_ready` теперь использует `lottery_data::payouts::ready`, который сверяет публикацию `PayoutLedger`, состав `lottery_ids`, таблицы `payout_index` и наличие записей в каждой очереди выплат, и `lottery_data::jackpot::ready`, который проверяет публикацию регистра джекпотов, совпадение списка `lottery_ids` с таблицей и консистентность pending-заявок VRF (payload и request_id), `queues_ready` опирается на `lottery_data::rounds::ready`, проверяя публикацию `RoundRegistry`, наличие капабилити, очередей истории/покупок и валидность pending-записей, `autopurchase_ready` опирается на `lottery_rewards_engine::autopurchase::ready`, который требует опубликованных очередей `rounds`, контролей `treasury` и их капабилити, `utils_ready` проверяет публикацию вспомогательных реестров (`lottery_utils::{feature_flags, metadata, migration}`) вместе с готовностью истории (`lottery_utils::history::ready` контролирует инициализацию и выдачу капабилити писателя истории), `gateway_ready` подтверждает инициализацию фасада и реестра лотерей (`lottery_gateway::{gateway, registry}`) с опубликованным `lottery_data::instances`, `access_ready` возвращает `true`, когда опубликован новый `lottery_data::access`, `cancellations_ready` использует `lottery_data::cancellations::ready` и позволяет убедиться, что ресурс отмен опубликован перед dry-run переносом, `automation_ready` использует `lottery_data::automation::caps_ready`, чтобы убедиться в наличии capability у всех зарегистрированных ботов, а `vrf_ready` включает проверку `lottery_vrf_gateway::hub::is_initialized` для dry-run валидации миграции VRF-хаба вместе с депозитом и сервисным модулем VRF.

## 2. Сводка статусов
- **0** ресурсов со статусом `Готово` (ожидается после реализации миграционных скриптов).
- **51** ресурс в статусе `В работе` — развернуты каркасы хранения (`lottery_data`), продажи поддерживают батчевые покупки (`lottery_engine::sales`), настройка и депозит VRF (`lottery_engine::vrf_config`, `lottery_engine::vrf`), стартовая логика розыгрыша (`lottery_engine::draw`), управление владельцами/операторами (`lottery_engine::operators`), административный цикл паузы/возврата (`lottery_engine::lifecycle`), поток выплат (`lottery_data::payouts`, `lottery_engine::payouts`), админская отмена (`lottery_data::cancellations`, `lottery_engine::cancellation`), автоматизация с ботами (`lottery_data::automation`, `lottery_engine::automation`), фасад `lottery_gateway::gateway`, распределение выручки через `lottery_rewards_engine::treasury`, поток VRF-джекпотов (`lottery_data::jackpot`, `lottery_rewards_engine::jackpot`), новая система автопокупок (`lottery_rewards_engine::autopurchase`, `lottery_data::rounds`, `lottery_data::treasury`), VIP-подписки (`lottery_rewards_engine::vip`), магазин призов (`lottery_rewards_engine::store`), on-chain история розыгрышей и архивы (`lottery_utils::history`), история фасада (`lottery_gateway::history`), реестр метаданных (`lottery_utils::metadata`), миграционный слой (`lottery_utils::migration`), контроль фичей (`lottery_utils::feature_flags`), реестр ролей (`lottery_data::access`), NFT-награды (`lottery_rewards_engine::nft`), миграция фабрики (`lottery_factory::registry`) и обновленный VRF-гейтвей (`lottery_vrf_gateway::hub`).
- **0** ресурсов помечено как `Запланировано` и требует реализации миграционных транзакций.
- **1** ресурс отмечен как `Не требуется` (будет выведен после валидации отсутствия зависимостей).

## 3. Таблица соответствий

### 3.1. `lottery_core`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `core_main_v2` | `LotteryData` | Текущий статус лотереи: билеты, VRF-конфигурация, whitelists, gas-лимиты. | `lottery_data` | `lottery_state::LotteryState` (resource) | 1. Развернуть `lottery_data::lottery_state`.<br>2. Запустить админскую транзакцию `migrate_lottery_state` для каждой лотереи.<br>3. Сверить счётчики билетов с `lottery_multi::sales::SalesLedger` (через интеграционный скрипт).<br>4. Для восстановления исторических данных использовать payload `LegacyLotteryRuntime` и entry `import_existing_lottery`/`import_existing_lotteries`, чтобы развернуть тикеты, VRF и whitelists без повторных продаж и переэмитить события `LotterySnapshotUpdatedEvent`/`Vrf*Updated`.<br>5. Для dry-run аудита состояния пользоваться view `runtime_snapshot`/`state_snapshot`, проверяя тикеты, whitelist и pending VRF. | В работе | Схема хранения развернута (`lottery_data::lottery_state`), импортные entry задокументированы; требуется миграционный скрипт и синхронизация с `SalesLedger`. |
| `core_main_v2` | `LotteryData` (VRF-config функции) | Настройка gas-бюджета, whitelists и client seed VRF. | `lottery_engine` | `vrf_config` (модуль управления VRF) | 1. Перенести функции конфигурации в `lottery_engine::vrf_config`.<br>2. Во время миграции зафиксировать события `VrfGasBudgetUpdated`, `VrfWhitelistUpdated`, `VrfRequestConfigUpdated` в новом `lottery_data`.<br>3. Подготовить сценарий переноса последних client seed и whitelists перед финальной миграцией.<br>4. Для dry-run аудита газовых лимитов, whitelist и pending-заявок использовать view `vrf_config_snapshot`/`vrf_config_snapshots` из `lottery_engine::vrf_config`.<br>5. Перед вызовом snapshot-функций использовать `vrf_config::is_initialized` для быстрой проверки публикации `instances` и `lottery_state`. | В работе | Модуль `vrf_config` создан, события опубликованы; доступны snapshot-view для сверок VRF-конфигурации и быстрая проверка инициализации, требуется миграция фактических параметров и dry-run цепочки с `lottery_vrf_gateway`. |
| `core_instances` | `LotteryCollection` | Реестр инстансов: владельцы, цены, доли джекпота, event handles. | `lottery_data` | `instances::InstanceRegistry` (resource) | 1. Создать `lottery_data::instances` с новой схемой.<br>2. Выполнить `migrate_instance_registry` единым батчем.<br>3. Провести сверку `lottery_ids`, активных флагов и владельцев через CLI.<br>4. Для восстановления проданных билетов и накопленного джекпота использовать payload `LegacyInstanceRecord` и admin-entry `import_existing_instance`/`import_existing_instances`.<br>5. Для dry-run аудита использовать view `registry_snapshot`/`instance_snapshot`, сверяя admin/hub, список лотерей и значения полей записей.<br>6. Для проверки соответствия blueprint (владелец, цена билета, авто-дро) использовать view `ticketing::blueprint_snapshot(s)` перед выравниванием с sales/rounds и предварительно убедиться через `ticketing::is_initialized`, что storage готово.<br>7. Для сверки состояния паузы/расписания draw между storage и движком использовать `lifecycle::lifecycle_snapshot(s)` (active-флаги, scheduled draw, pending VRF), проверяя публикацию ресурсов через `lifecycle::is_initialized`. | В работе | Модуль `lottery_data::instances` реализован, добавлены события смены владельца и методы `set_owner`/`set_active`; административная пауза/возврат реализована в `lottery_engine::lifecycle`, импортные entry переэмитят снапшоты `LotteryInstancesSnapshotUpdatedEvent`, а view дают полную сверку реестра. |
| `core_instances` | `CoreControl` | Хранит capability экспорта инстансов. | `lottery_data` | `instances::InstanceControl` (resource) | 1. Вызвать `claim_instance_control_cap` для переноса `InstancesExportCap`.<br>2. Записать новый cap в `instances::InstanceControl`.<br>3. Подтвердить отсутствие «висячих» capability в старом модуле. | В работе | Контрольный ресурс создан (`lottery_data::instances`), ожидает миграции capability. |
| `core_rounds` | `RoundCollection` | Таблица раундов, event handles для покупок и VRF-запросов. | `lottery_data` | `rounds::RoundRegistry` (resource) | 1. Добавить модуль `lottery_data::rounds`.<br>2. Использовать payload `LegacyRoundRecord` и admin-entry `import_existing_round`/`import_existing_rounds`, чтобы разворачивать билеты, флаги расписания и pending-запросы с переэмитом `RoundSnapshotUpdatedEvent`.<br>3. Сверить идентификаторы раундов и состояния с `lottery_multi::draw::DrawLedger`.<br>4. Для dry-run аудита использовать view `rounds::registry_snapshot`/`round_snapshot`, проверяя admin, список лотерей, билеты, флаги draw и pending-запросы.<br>5. Перед переносом очередей убедиться, что view `rounds::ready` возвращает `true`, подтверждая публикацию `RoundRegistry`, `RoundControl`, очередей истории/покупок, наличие капабилити и валидность pending-записей. | В работе | Модуль `lottery_data::rounds` опубликован, импортные entry позволяют переносить раунды батчами и переэмитить события; добавлены view-сверки реестра и отдельных раундов, view `rounds::ready` проверяет целостность реестра и очередей, требуется dry-run миграции и выравнивание событий с `lottery_engine`. |
| `core_rounds` | `HistoryQueue` | Очередь незаписанных историй для внешнего экспорта. | `lottery_data` | `rounds::PendingHistoryQueue` (resource) | 1. На время миграции приостановить продюсеров истории.<br>2. Вызвать admin-entry `import_pending_history_records`, передав подготовленный список `PendingHistoryRecord` (devnet/testnet архивы, dry-run отчёты или ручные константы), чтобы заменить очередь без обращения к legacy-пакетам.<br>3. Перезапустить записи истории уже из `lottery_engine` и использовать view `pending_history_snapshot` для dry-run сверки содержимого очереди. | В работе | Очередь развернута в `lottery_data::rounds`, импортная entry принимает батч записей и используется `lottery_utils::history` при sync; добавлена view для аудита содержимого перед миграцией, требуется dry-run сверка с `support_history`. |
| `core_rounds` | `PurchaseQueue` | Очередь незавершённых покупок билетов. | `lottery_data` | `rounds::PendingPurchaseQueue` (resource) | 1. Перед миграцией завершить или отменить активные покупки.<br>2. Вызвать admin-entry `import_pending_purchase_records`, чтобы записать подготовленный список `PendingPurchaseRecord` (devnet/testnet архивы, dry-run отчёты или ручные данные) в новую очередь.<br>3. Обновить обработчики в новом `lottery_engine::ticketing` и использовать view `pending_purchase_snapshot` для dry-run сверки перед переносом. | В работе | Очередь реализована в `lottery_data::rounds`, импортная entry восстанавливает pending-записи и используется `lottery_rewards_engine::rounds_sync`; добавлена view для аудита состояния очереди перед миграцией. |
| `core_rounds` | `CoreControl` | Capabilities для записи истории и автопокупок. | `lottery_data` | `rounds::RoundControl` (resource) | 1. Перенести `HistoryWriterCap` и `AutopurchaseRoundCap` в новый ресурс.<br>2. Зафиксировать событие миграции в `lottery_utils::audit`.<br>3. Для dry-run аудита использовать view `caps_ready`/`control_snapshot`, сверяя наличие капабилити и администратора перед переносом. | В работе | Ресурс `lottery_data::rounds::RoundControl` создан, добавлены snapshot-view для проверки готовности капабилити; требуется миграция cap и интеграция с `lottery_rewards_engine`. |
| `core_operators` | `LotteryOperators` | Таблица операторов, event handles выдачи/отзыва. | `lottery_data` | `operators::OperatorRegistry` (resource) | 1. Сформировать ресурс `OperatorRegistry` с индексом `lottery_ids` и событиями.<br>2. Использовать payload `LegacyOperatorRecord` и admin-entry `import_existing_operator_record(s)` для восстановления владельцев и списков операторов с переэмитом owner/grant/snapshot событий.<br>3. Проверить роли операторов в интеграционных тестах и выстроить вызовы через `lottery_engine::operators`/`lottery_gateway`.<br>4. Перед финальной валидацией сверять готовность реестра через view `ready`/`is_initialized` и per-lottery state через view `operator_snapshot` или полный `registry_snapshot` (`lottery_data` или alias `lottery_engine::operators`). | В работе | Реестр операторов реализован, доступен payload `LegacyOperatorRecord` для батчевого импорта из devnet/testnet архивов или dry-run отчётов; добавлены view `ready` и per-lottery `operator_snapshot`, требуется прогнать миграционный скрипт и связать фасад. |
| `core_treasury_v1` | `Vaults` | Конфигурация распределения средств и получателей. | `lottery_data` | `treasury::Vaults` (resource) | 1. Создать модуль `lottery_data::treasury`.<br>2. Использовать payload `LegacyVaultState` (с `LegacyVaultConfig`/`LegacyVaultRecipients`) и admin-entry `import_existing_vaults`, чтобы восстановить конфигурацию и получателей без повторных переводов.<br>3. Провести сверку получателей с бухгалтерией. | В работе | Структура `lottery_data::treasury::Vaults` создана, импортные entry переэмитят события `ConfigUpdated`/`RecipientsUpdated`, требуется dry-run миграции. |
| `core_treasury_v1` | `TokenState` | Доступ к capability токена (mint/burn/transfer). | `lottery_data` | `treasury::TokenState` (resource) | 1. Перед миграцией выгрузить состояние capability.<br>2. Перезаписать ссылки в новом модуле.<br>3. Обновить вызовы в автопокупках и выплатах.<br>4. Для dry-run аудита токена использовать view `token_state_snapshot`, сверяя адрес metadata и наличие ref. | В работе | Хранилище capability подготовлено (`lottery_data::treasury`), добавлен snapshot токен-состояния для проверки перед переносом объектов и ссылок. |
| `core_treasury_v1` | `CoreControl` | Capabilities автопокупок и legacy-трежери. | `lottery_data` | `treasury::TreasuryV1Control` (resource) | 1. Перенести `AutopurchaseTreasuryCap` и `LegacyTreasuryCap`.<br>2. Обновить скрипты автопокупки на новый ресурс.<br>3. Для dry-run аудита готовности cap использовать view `caps_ready`/`control_snapshot`, проверяя наличие обеих capability перед миграцией. | В работе | Ресурс `lottery_data::treasury::TreasuryV1Control` подготовлен, добавлены snapshot-view для проверки доступности капабилити и готовности миграции. |
| `core_treasury_multi` | `TreasuryState` | Балансы джекпота/операций, конфигурация долей и event handles. | `lottery_data` | `treasury_multi::TreasuryState` (resource) | 1. Создать `lottery_data::treasury_multi` с новой схемой.<br>2. Выполнить `migrate_multi_treasury` и использовать payload'ы `LegacyMultiTreasuryState`/`LegacyMultiTreasuryLottery` через admin-entry `import_existing_state`, `import_existing_lottery(ies)` для восстановления получателей, долей BPS и локальных балансов без повторного движения средств.<br>3. Проверить суммы и event handles через тестовый сценарий.<br>4. Для dry-run сверок конфигурации и получателей использовать view `lottery_rewards_engine::treasury::{state_snapshot, lottery_config, recipients}` и быструю проверку `treasury_multi::is_initialized` перед импортом. | В работе | Хранилище `lottery_data::treasury_multi::TreasuryState` реализовано; модуль `lottery_rewards_engine::treasury` уже распределяет платежи и эмитит события на каждой покупке, а импортные entry переиспользуют события конфигурации/распределения для миграции. |
| `core_treasury_multi` | `CoreControl` | Capability на разные пулы (jackpot/vip/store/referrals). | `lottery_data` | `treasury_multi::TreasuryMultiControl` (resource) | 1. Передать capability в новый ресурс через `claim_multi_treasury_caps`.<br>2. Обновить потребителей (rewards, store, vip). | В работе | Контроллер `lottery_data::treasury_multi` готов, необходимо перенести capability и обновить потребителей. |

### 3.2. `lottery_multi`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `factory` | `FactoryState` | Реестр планируемых лотерей, capability администратора. | `lottery_factory` | `registry::FactoryRegistry` (resource) | 1. Использовать admin-entry `migrate_factory_state`/`import_existing_registry` для переноса admin, `next_lottery_id` и записей с переэмиссией событий планирования/активации.<br>2. Верифицировать совпадение счётчика с VRF и gateway, затем снять старый ресурс. | В работе | Модуль `registry` обновлён, добавлен alias `migrate_factory_state` под миграционный сценарий; требуется dry-run сверки с gateway/VRF. |
| `lottery_registry` | `Registry` | Список лотерей, причины отмен и история. | `lottery_gateway` | `registry::LotteryRegistry` (resource) | 1. Реализовать `registry::LotteryRegistry`, который копирует владельцев, адреса, цены билетов, доли джекпота и статусы/причины отмен из `instances` и `cancellations`.<br>2. Выполнить `migrate_lottery_registry`, используя entry-функции `record_existing_cancellation`/`record_existing_cancellations` (структура `LegacyCancellationImport`) для конвертации причин отмен и выравнивания ordered-списка лотерей.<br>3. Запустить интеграционный тест сценария создания/отмены и сверку view-функций `registry_snapshot`/`lottery_entry`. | В работе | Модуль `lottery_gateway::registry` опубликован, фасад `gateway` синхронизирует записи при создании, импорте, смене владельца и отмене лотерей; требуется миграция данных из legacy и dry-run сверка снапшотов. |
| `lottery_registry` | `Registry` | Список лотерей, причины отмен и история. | `lottery_gateway` | `gateway::GatewayRegistry` (resource) | 1. Развернуть `lottery_gateway::gateway` с генерацией идентификаторов и индексом владельцев.<br>2. Реализовать миграцию `migrate_lottery_registry`, которая переносит владельцев и статусы в `GatewayRegistry` и выравнивает события.<br>3. Подготовить view/скрипты для проверки состава лотерей по владельцам после миграции. | В работе | Пакет `lottery_gateway` создан, события фасада синхронизированы с `lottery_data`, добавлены view-функции списка лотерей/владельцев и snapshot, а также entry `register_existing_lottery`/`register_existing_lotteries` и `align_next_lottery_id` для импорта легаси-ID перед запуском миграционного скрипта. |
| `lottery_registry` | `CancellationRecord` | Причины отмен, суммы продаж и снапшот статуса. | `lottery_data` | `cancellations::CancellationLedger` (resource) | 1. Развернуть `lottery_data::cancellations` и поток `lottery_engine::cancellation`.<br>2. Подготовить payload'ы `LegacyCancellationRecord` (devnet/testnet архивы, dry-run отчёты или ручные константы) и вызвать `import_existing_cancellation`/`import_existing_cancellations`, чтобы батчево перенести исторические записи и события.<br>3. Использовать view `ready` для dry-run проверки публикации ресурса и актуальности администратора перед миграционными транзакциями.<br>4. Использовать view `ledger_snapshot` (`lottery_data::cancellations` или alias `lottery_engine::cancellation`) и точечные `record_snapshot` для сверки записей, сумм продаж и блокировок джекпота перед финальной валидацией сценария `lottery_gateway::cancel_lottery`. | В работе | Ledger и события отмен развёрнуты; import-entry позволяют переносить историю без повторного вызова `lottery_engine::cancellation`, добавлены snapshot-view для аудита миграции и точечной сверки записей. |
| `automation` | `AutomationRegistry` | Таблица ботов и event handles dry-run/ошибок. | `lottery_data` | `automation::AutomationRegistry` (resource) | 1. Развернуть `lottery_data::automation` и сконфигурировать события.<br>2. Выполнить `migrate_automation_registry` через `import_existing_bot(s)` (структура `LegacyAutomationBot`).<br>3. Перепривязать ботов в dev-утилитах и сверить pending-статусы через view `lottery_engine::automation::{registry_snapshot, bot_status, operators}`.<br>4. Для dry-run проверять публикацию ресурса через `is_initialized` (data/engine), прежде чем вызывать snapshot/view. | В работе | В `lottery_data::automation` опубликованы `LegacyAutomationBot` и admin-entry для импорта ботов, `lottery_engine::automation` обрабатывает cron/события и предоставляет view для dry-run аудита; требуется dry-run миграции и проверка cron. |
| `automation` | `AutomationCap` | Capability с расписанием cron. | `lottery_data` | `automation::AutomationCap` (resource) | 1. Перенести capability через `claim_automation_cap`.<br>2. Обновить авторизацию cron-задач. | В работе | Capability хранится в `lottery_data::automation`, новые entry-функции управления ботами реализованы в `lottery_engine::automation`. |
| `draw` | `DrawLedger` | Состояние VRF-запросов и соответствие nonce ↔ lottery. | `lottery_engine` | `draw` (модули запросов и обработки результатов) | 1. Реализовать `lottery_engine::draw` с планированием розыгрыша, запросом VRF и фиксацией победителя.<br>2. Подготовить скрипт `migrate_draw_ledger` для переноса pending-запросов и истории.<br>3. Сравнить события VRF с `lottery_vrf_gateway::hub::HubState` и обновлённым чек-листом.<br>4. Для dry-run аудита использовать view `draw_snapshot`/`draw_snapshots`, сверяя pending-запросы, хэши payload и счётчики VRF с данными `rounds`/`lottery_state`.<br>5. Для точечной сверки pending-заявки с хабом использовать view `draw::pending_request_alignment`, проверяя совпадение идентификатора/хэша payload и признака pending с `hub::request_snapshot`. | В работе | Модуль `draw` опубликован, доступна alignment-view с VRF-хабом; требуется миграция данных и интеграционные тесты VRF. |
| `feature_switch` | `FeatureSwitchRegistry` | Переключатели функционала, включая devnet-флаги. | `lottery_utils` | `feature_flags::FeatureRegistry` (resource) | 1. Создать модуль `lottery_utils::feature_flags`.<br>2. Выполнить `migrate_feature_flags`.<br>3. Обновить фронтовые проверки через CLI. | В работе | Модуль `lottery_utils::feature_flags` опубликован, реализованы события и режимы; остаётся миграция данных и обновление CLI. |
| `feature_switch` | `FeatureSwitchAdminCap` | Capability, выдаваемый старой системой переключателей для изменения режимов. | `lottery_utils` | `feature_flags::FeatureRegistry` (администрирование через `@lottery`) | 1. При инициализации `lottery_utils::feature_flags` зафиксировать администратора и вручную перенести состояние режимов, после чего извлечь `FeatureSwitchAdminCap` из `lottery_multi`.<br>2. Задокументировать процедуру уничтожения/возврата capability в `lottery_utils::migration` и убедиться, что новые entry (`set_mode`, `set_force_enable`) работают только через `@lottery`.<br>3. Обновить скрипты DevOps, чтобы они больше не полагались на кап из legacy и подписывали транзакции админским адресом. | В работе | Старый capability не переносится как отдельный ресурс, а выводится из эксплуатации после активации `feature_flags`; требуется зафиксировать шаги возврата cap и отказа от него в миграционном чек-листе. |
| `history` | `ArchiveLedger` | Архивированные резюме лотерей и события dual-write. | `lottery_utils` | `history::ArchiveLedger` (resource) | 1. Развёрнут `ArchiveLedger` с событиями финализации и импортов, admin-entry `init_archive`, `record_archive_summary`, `import_legacy_summary`, `rollback_legacy_summary`, `update_legacy_classification` и view `list_finalized`.<br>2. В миграции вызвать `import_legacy_summary` для всех архивных BCS с проверкой хэшей и ожиданий dual-write (`notify_summary_written`).<br>3. Подтвердить хэшами, что `rollback`/`classification` работают на legacy-записях, и зафиксировать снапшоты для аудита. | В работе | Совместный контроль с `lottery_support::LegacyArchive`; зеркалирование ведётся через `mirror_summary_to_legacy` и события `LegacySummary*`. |
| `legacy_bridge` | `DualWriteControl` | Настройки двойной записи и контроль хэшей между новым и legacy-архивом. | `lottery_utils` | `history::DualWriteControl` (resource) | 1. Использовать entry `history::init_dual_write` и payload `LegacyDualWriteState` для импорта флагов/ожиданий без обращения к legacy.<br>2. Переносить pending `expected_hashes` через `import_existing_dual_write_state` либо batched `set_expected_hash`, фиксируя события `ArchiveDualWriteStarted`.<br>3. Во время миграции запускать dry-run `notify_summary_written`/view `pending_expected_hashes` для подтверждения совпадения хэшей и очищения очереди до включения dual-write в прод. | В работе | Новый ресурс, события и view (`dual_write_status`, `dual_write_flags`) реализованы; остаётся подготовить оффчейн экспорт ожиданий и синхронизацию с `history_bridge`. |
| `legacy_bridge` | `MirrorConfig` | Флаг зеркалирования архивов. | — | — | 1. Подтвердить, что новая архитектура не требует зеркала.<br>2. Документировать вывод ресурса.<br>3. Удалить модуль после успешной миграции. | Не требуется | Проверить отсутствие ссылок в скриптах поддержки. |
| `history` | `Registry` | История лотерей и отмен. | `lottery_gateway` | `history::LotteryHistory` (resource) | 1. Реализовать модуль `lottery_gateway::history` с событиями записи/снапшотов, admin-entry `init` и импортом `record_existing_history`/`record_existing_histories` (payload `LegacyHistoryImport`).<br>2. Подключить фасад `gateway` к созданию и отмене лотерей через `record_created`/`record_canceled`, задокументировать шаг `migrate_lottery_history` и dry-run сверку количества записей с `history::ArchiveLedger`/`LegacyArchive`.<br>3. Использовать view `is_initialized`/`history_snapshot`/`history_records` для проверки публикации и содержимого после миграции. | В работе | Модуль опубликован, фасад пишет события при создании/отмене; остаётся подготовить миграционный скрипт и сверку с архивом. |
| `payouts` | `PayoutLedger` | Состояние выплат и событий победителей/возвратов. | `lottery_data` / `lottery_engine` / `lottery_rewards_engine` | `payouts::PayoutLedger` (resource) + `lottery_engine::payouts` (статусы/вью) + `lottery_rewards_engine::payouts` (выплаты) | 1. Реализовать хранение `lottery_data::payouts`, административные entry `lottery_engine::payouts` и сервисные выплаты `lottery_rewards_engine::payouts`.<br>2. Для миграции использовать payload `LegacyPayoutRecord` и admin-entry `import_existing_payout`/`import_existing_payouts`, которые восстанавливают счётчики pending/paid/refunded и переэмитят события без повторных выплат.<br>3. Подготовить скрипт `migrate_payout_ledger`, сверить остатки невыплаченных сумм и события `WinnerRecorded`/`PayoutStatusUpdated`, а также `JackpotPaidEvent`/`Operations*` из мульти-трежери, используя view `ready`/`ledger_snapshot`/`lottery_snapshot`/`payout_record_snapshot` из `lottery_data::payouts` (их также проксируют `lottery_engine::payouts` и `lottery_rewards_engine::payouts`) для dry-run аудита: `ready` дополнительно проверяет целостность `lottery_ids`, `payout_index` и таблиц выплат перед миграцией. | В работе | Хранилище, статусы, выдача джекпотов/операционных движений, import-entry и view-снимки реализованы; требуется миграция данных и dry-run сверка с мульти-трежери. |
| `price_feed` | `PriceFeedRegistry` | Курсы активов и события обновлений. | `lottery_utils` | `price_feed::PriceFeedRegistry` (resource) | 1. Реализовать модуль `lottery_utils::price_feed`.<br>2. Выполнить `migrate_price_feeds`.<br>3. Настроить тесты на актуальность данных.<br>4. Для dry-run проверки миграций использовать view `registry_snapshot`, чтобы сверять админа, версию и все записи feed. | В работе | Новый модуль управляет регистрацией курсов, fallback и clamp событиями; добавлен снапшот реестра для аудита миграции, требуется перенос существующих записей и тестовые сценарии. |
| `roles` | `RoleStore` | Роли партнёров, премиум доступ и события. | `lottery_data` | `access::RoleStore` (resource) | 1. Развернуть `lottery_data::access` с payload'ами `LegacyPayoutBatchCap`/`LegacyPartnerPayoutCap`/`LegacyPremiumAccessCap` и admin-entry `import_existing_role_store`, `import_partner_cap(s)`, `import_premium_cap(s)`. <br>2. Выполнить миграцию `migrate_role_store`, восстанавливая payout/partner/premium cap и снапшоты через события `RoleSnapshotUpdatedEvent`. <br>3. Сверить индексы и view `partner_caps`/`premium_caps` после dry-run. | В работе | Новый ресурс хранит капы и события обновлений; требуется миграционный скрипт и проверка индексов. |
| `sales` | `SalesLedger` | Учёт продаж, лимитов и распределения. | `lottery_engine` | `sales::SalesLedger` (resource) | 1. Реализовать модуль `lottery_engine::sales` поверх `lottery_data` с поддержкой батчевых покупок и авто-планирования розыгрыша (готово).<br>2. Подготовить миграцию `SalesLedger` (конвертация счётчиков продаж, билетов и истории платежей).<br>3. Для dry-run сверок использовать view `lottery_engine::sales::{sales_snapshot, sales_snapshots}` (показывают билетные и draw-параметры), сверяя суммы с трежери и `LotteryData`. | В работе | Модуль обрабатывает батчевые покупки и вызывает `lottery_rewards_engine::treasury::record_sale_allocation`; новые snapshot-view позволяют без legacy сверить цену билета, проданные билеты, next_ticket_id и авто-дров. | 
| `vrf_deposit` | `VrfDepositLedger` | Баланс депозита VRF, статусы и события. | `lottery_data` / `lottery_engine` | `vrf_deposit::VrfDepositLedger` (resource) + `lottery_engine::vrf` (логика) | 1. Реализовать хранение `lottery_data::vrf_deposit` и логику `lottery_engine::vrf`.<br>2. Использовать payload `LegacyVrfDepositLedger` и admin-entry `lottery_data::vrf_deposit::import_existing_ledger`, чтобы восстановить конфигурацию, баланс и флаги паузы без обращения к legacy-пакетам (допускаются devnet/testnet архивы, dry-run отчёты или ручные константы).<br>3. Подтвердить балансы и паузы через CLI и dry-run цепочку `schedule → request → fulfill` с `lottery_vrf_gateway::hub::HubState`.<br>4. Для аудита миграции использовать view `vrf_deposit::ledger_snapshot`/`is_initialized` или алиасы `lottery_engine::vrf::ledger_snapshot`/`is_initialized`, чтобы сверять конфиг/статус без чтения из legacy. | В работе | Ledger и события развернуты, добавлен payload для импорта состояния; доступны snapshot-view для dry-run аудита, требуется миграционный скрипт и сверка с VRF-хабом. |

### 3.3. `lottery_rewards`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `rewards_autopurchase` | `AutopurchaseState` | Планы автопокупки по лотереям, события депозитов и возвратов. | `lottery_rewards_engine` | `autopurchase::AutopurchaseState` (resource) | 1. Развернуть пакет `lottery_rewards_engine` с модулем `autopurchase`.<br>2. Сконвертировать легаси-записи в `LegacyAutopurchasePlan` и вызвать `autopurchase::import_existing_plan`/`import_existing_plans` для восстановления балансов без повторных депозитов.<br>3. Согласовать конфиги с новым `lottery_engine::ticketing` и проверить `execute`/`refund`, используя view `snapshot` и `is_initialized` для dry-run сверок. | В работе | Модуль `lottery_rewards_engine::autopurchase` развернут, события и снапшоты публикуются; импортные entry и view-снимок доступны для миграционных скриптов, добавлен быстрый чек наличия состояния через `is_initialized`. |
| `rewards_autopurchase` | `AutopurchaseAccess` | Capability для раундов и трежери. | `lottery_rewards_engine` | `autopurchase::AutopurchaseAccess` (resource) | 1. Перенести capability через `claim_autopurchase_caps`.<br>2. Обновить вызовы расписаний.<br>3. Для dry-run аудита использовать view `autopurchase::access_snapshot`/`caps_ready`. | В работе | Ресурс `AutopurchaseAccess` создаётся через `init_access`, капы извлекаются из `lottery_data::rounds` и `treasury`; снапшот отражает готовность capability для миграции. |
| `rewards_jackpot` | `JackpotState` | Состояние джекпота, билеты и события VRF. | `lottery_data` | `jackpot::JackpotRegistry` (resource) + логика `lottery_rewards_engine::jackpot` | 1. Развернуть `lottery_data::jackpot` с регистрами и событиями.<br>2. Перенести состояния через `migrate_jackpot_state`, используя payload `LegacyJackpotRuntime` и admin-entry `import_existing_jackpot`/`import_existing_jackpots`, и зафиксировать снапшоты.<br>3. Перед импортом сверить публикацию ресурса через view `jackpot::is_initialized` или алиас `lottery_rewards_engine::jackpot::is_initialized`, а затем вызвать `jackpot::ready` (или `lottery_rewards_engine::jackpot::ready`), чтобы подтвердить совпадение `lottery_ids` с таблицей и корректность pending-заявок (payload и request_id).<br>4. Запустить dry-run `lottery_rewards_engine::jackpot::request_randomness/fulfill_draw` и сверить события с легаси, используя snapshot-view `jackpot::registry_snapshot`/`lottery_snapshot`/`runtime_view`/`runtime_views` в новом движке. | В работе | Модуль хранения, import-entry и логика VRF-джекпотов реализованы; добавлена readiness-проверка, требуется миграционный скрипт и dry-run с мульти-трежери. |
| `rewards_jackpot` | `JackpotAccess` | Capability к мульти-трежери. | `lottery_rewards_engine` | `jackpot::JackpotAccess` (resource) | 1. Реализовать `jackpot::JackpotAccess` в новом движке с admin-entry `init_access`/`release_access`, которые извлекают и возвращают `MultiTreasuryCap` из `lottery_data::treasury_multi` без обращения к legacy.<br>2. Использовать payload или прямое чтение `rewards_jackpot::JackpotAccess` в миграции, dry-run транзакцию переноса capability с верификацией строк в `treasury_multi::TreasuryMultiControl` и проверкой view `caps_ready`.<br>3. Обновить `lottery_rewards_engine::jackpot::fulfill_draw`/`drain_jackpot_balance` на использование нового access и задокументировать освобождение legacy-capability (`release_caps`). | В работе | Модуль расширен ресурсом `JackpotAccess`, кодами ошибок и view `caps_ready`; fulfil/withdraw пути требуют импортированного cap. |
| `rewards_nft` | `BadgeAuthority` | Управление NFT-наградами, снапшотами владельцев и событиями mint/burn. | `lottery_rewards_engine` | `nft::BadgeAuthority` (resource) | 1. Развернуть `lottery_rewards_engine::nft` с admin-entry `init`, `set_admin`, `mint_badge`, `burn_badge` и импортом `LegacyBadgeAuthority`/`LegacyBadgeOwner`/`LegacyBadge`.<br>2. Для миграции вызвать `import_existing_badge_authority(ies)` на подготовленном payload (архивы devnet/testnet, dry-run отчёты или ручные константы), убедившись в корректности снапшотов и событий `NftRewardsSnapshotUpdatedEvent`.<br>3. После dry-run подтвердить отсутствие зависимости от legacy-модуля и обновить фронтенд наград. | В работе | Требует проверки фронтендом после миграции. |
| `rewards_referrals` | `ReferralState` | Конфиги и статистика реферальной программы. | `lottery_rewards_engine` | `referrals::ReferralState` (resource) | 1. Реализовать модуль `lottery_rewards_engine::referrals` и связанный сервис `rounds_sync`.<br>2. Сформировать payloadы `LegacyReferralLottery`/`LegacyReferralRegistration` (допускаются devnet/testnet архивы, dry-run отчёты или ручные константы) и вызвать admin-entry `import_existing_lottery`/`import_existing_lotteries` вместе с `import_existing_registration`/`import_existing_registrations` для восстановления конфигов, статистики и регистраций без повторных списаний.<br>3. Проверить таблицы `referrers` и `stats`, а также снапшоты после импорта, используя view `get_referral_snapshot` и `is_initialized` для dry-run сверки наличия состояния. | В работе | Модуль `lottery_rewards_engine::referrals` реализован, импортные entry опубликованы, события и снапшоты доступны; view-снимок позволяет dry-run сверку с легаси, добавлена быстрая проверка публикации ресурса. |
| `rewards_referrals` | `ReferralsControl` | Capability на пул рефералов. | `lottery_rewards_engine` | `referrals::ReferralsControl` (resource) | 1. Перенести cap через `claim_referrals_cap`.<br>2. Обновить вызовы выплат. | В работе | Capability извлекается через `init_access`, платежи проводят `referrals::record_reward` и `rounds_sync::sync_purchases_from_rounds`. |
| `rewards_store` | `StoreState` | Магазин призов, события покупок и конфигов. | `lottery_rewards_engine` | `store::StoreState` (resource) | 1. Модуль `lottery_rewards_engine::store` развёрнут, фиксирует товары, остатки и события покупок.<br>2. Сформировать payloadы `LegacyStoreItem` и вызвать admin-entry `import_existing_item`/`import_existing_items` для переноса каталога, остатков и счётчиков продаж без повторных оплат.<br>3. Сверить события `ItemConfigured`/`ItemPurchased` и view `get_store_snapshot` на тестнете. | В работе | Требуется миграция данных и dry-run фасада с покупкой; снапшот используется для dry-run аудита. |
| `rewards_store` | `StoreAccess` | Capability на магазин. | `lottery_rewards_engine` | `store::StoreAccess` (resource) | 1. Вызвать `store::ensure_caps_initialized` для переноса капов из мульти-трежери.<br>2. Описать миграцию `claim_store_cap`/`release_caps` в чек-листе. | В работе | Зависит от `TreasuryMultiControl`; capability ожидает фактического переноса. |
| `rewards_vip` | `VipState` | VIP-подписки, события бонусов и отмен. | `lottery_rewards_engine` | `vip::VipState` (resource) | 1. Создать модуль `lottery_rewards_engine::vip`.<br>2. Сформировать payloadы `LegacyVipLottery` (допускаются devnet/testnet архивы, dry-run снапшоты или ручные константы) и вызвать admin-entry `import_existing_lottery`/`import_existing_lotteries` для восстановления конфигов, подписчиков и статистики без повторных платежей.<br>3. Проверить индексы лотерей и подписчиков в интеграционных тестах фасада и через view `get_vip_snapshot`. | В работе | Модуль `vip` реализован, импортные entry позволяют переносить данные; view-снимки помогают dry-run проверке, требуется миграционный скрипт и dry-run на testnet. |
| `rewards_vip` | `VipAccess` | Capability на VIP-пул. | `lottery_rewards_engine` | `vip::VipAccess` (resource) | 1. Перенести cap через `claim_vip_cap`.<br>2. Обновить сценарии подписки, чтобы использовать новый `VipAccess` и подтверждать возврат capability при миграции. | В работе | Публикуется ресурс `VipAccess`, реализованы функции `ensure_caps_initialized`/`release_caps`. Ожидает миграции фактического cap. |

### 3.4. `lottery_support`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `support_history` | `HistoryCollection` | История розыгрышей и снапшоты. | `lottery_utils` | `history::HistoryCollection` (resource) | 1. Развернуть `lottery_utils::history` (`init`, события, снапшоты).<br>2. Подготовить `migrate_history_collection` для переноса записей и сверки счётчиков, используя `LegacyHistoryRecord` и entry-функции `import_existing_history_record`/`import_existing_history_batch`.<br>3. Настроить `sync_draws_from_rounds` и dry-run очистки/обновления истории. | В работе | Модуль истории реализован, события и снапшоты публикуются; добавлены импорт-helpers для legacy, требуется миграционный скрипт и сравнение с legacy. |
| `support_history` | `HistoryWarden` | Capability записи истории. | `lottery_utils` | `history::HistoryWarden` (resource) | 1. Перенести `HistoryWriterCap` через `rounds::extract_history_cap` и `history::init_caps`.<br>2. Подтвердить работу `sync_draws_from_rounds` и возврат capability при откате. | В работе | Ресурс `HistoryWarden` публикуется, история синхронизируется через очередь `rounds::PendingHistoryQueue`; требуется dry-run переноса cap. |
| `history_bridge` | `LegacyArchive` | Архив легаси-снапшотов. | `lottery_utils` | `history::LegacyArchive` (resource) | 1. Развёрнут `LegacyArchive` с admin-entry `init_legacy_archive` и записью BCS-сводок через `mirror_summary_to_legacy`.<br>2. В миграции использовать `import_legacy_summary`/`record_archive_summary`, чтобы заполнить архив и сэмитить `LegacySummaryEvent` с контрольными суммами.<br>3. Сверить итоговые хэши с архивом `lottery_support::history_bridge` и зафиксировать их в отчёте. | В работе | Используется для аудита после миграции. |
| `support_metadata` | `MetadataRegistry` | Метаданные лотерей. | `lottery_utils` | `metadata::MetadataRegistry` (resource) | 1. Развернуть `lottery_utils::metadata` с событиями `LotteryMetadataUpsertedEvent`/`MetadataSnapshotUpdatedEvent` и рекурсивными обходами вместо циклов.<br>2. Подготовить скрипт `migrate_metadata_registry`, используя `LegacyMetadataImport` и entry-функции `import_existing_metadata`/`import_existing_metadata_batch` для переноса записей и индексов владельцев.<br>3. Для dry-run аудита и сверки с фасадом использовать view `registry_snapshot`, чтобы экспортировать полный срез даже при отсутствии опубликованного состояния.<br>4. Сверить снапшоты и выдачу через фасад/фронтенд после миграции. | В работе | Модуль `lottery_utils::metadata` опубликован, добавлены admin-entry для импорта исторических записей и view `registry_snapshot` для безопасного аудита состояния; требуется миграционный скрипт и dry-run сверка снапшотов. |
| `support_migration` | `MigrationLedger` | Снимки прогресса миграции. | `lottery_utils` | `migration::MigrationLedger` (resource) | 1. Реализовать `lottery_utils::migration::record_snapshot` и события.<br>2. Подготовить скрипт `migrate_migration_ledger`.<br>3. Перенести снапшоты и сверить лотереи.<br>4. Для dry-run аудита использовать view `migration::is_initialized`/`migration::ledger_snapshot`, чтобы сравнить список лотерей и значения полей. | В работе | Модуль `lottery_utils::migration` публикует `MigrationLedger` и события; добавлены view для сверок и проверки публикации, требуется миграционный скрипт и dry-run сверка записей. |
| `support_migration` | `MigrationSession` | Capability миграции (инстансы, legacy-трежери). | `lottery_utils` | `migration::MigrationSession` (resource) | 1. Перенести capability через `claim_migration_caps`.<br>2. Обновить скрипты управления миграцией с учётом `instances::extract_export_cap` и `treasury::extract_legacy_cap`.<br>3. Для dry-run аудита готовности капабилити использовать view `session_initialized`/`session_snapshot`, сверяя наличие капабилити перед миграцией. | В работе | Сессия и функции извлечения/возврата capability реализованы (`lottery_data::instances`, `lottery_data::treasury`); добавлены view для проверки готовности, остались скрипты миграции. |

### 3.5. `lottery_factory`, `lottery_gateway`, `lottery_vrf_gateway`

| Старый пакет / модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `lottery_factory::registry` | `FactoryState` | Администратор фабрики, таблица лотерей и события (повтор записи). | `lottery_factory` | `registry::FactoryRegistry` (resource) | 1. Совместить перенос с таблицей из `lottery_multi::factory` (см. раздел 3.2).<br>2. Выполнить миграцию единым скриптом `migrate_factory_state`/`import_existing_registry` и сверить `next_lottery_id`/owner/blueprint.<br>3. Провести smoke-тесты создания лотерей. | В работе | Импорт/alias реализованы, фабрика использует `lottery_vrf_gateway::hub` для регистрации лотерей; требуется выравнивание данных с gateway и VRF. |
| `lottery_gateway::registry` | `Registry` | Простая заглушка реестра для прототипа. | `lottery_gateway` | `registry::LotteryRegistry` (resource) | 1. Реализовать полноценный ресурс с таблицей записей, snapshot-событиями и view-функциями.<br>2. Подключить `gateway::gateway` ко всем операциям (создание, импорт, смена владельца, пауза/отмена).<br>3. Использовать новый ресурс как целевой при миграции `lottery_multi::lottery_registry`. | В работе | Новый модуль создан, снапшоты `LotteryRegistrySnapshotUpdatedEvent` публикуются, фасад обновляет записи и причины отмен; следующими шагами остаётся миграция legacy-данных и dry-run проверки. |
| `lottery_vrf_gateway::hub` | `HubState` | Регистрация лотерей в VRF, pending-запросы и события. | `lottery_vrf_gateway` | `hub::HubState` (resource) | 1. Обновить схему без изменения адреса.<br>2. Выполнить `migrate_lottery_vrf_gateway_state`/`import_existing_state` для переноса админа, registries, pending-запросов и callback sender.<br>3. Сверить pending-запросы с `lottery_engine::draw::DrawLedger`.<br>4. Для точечных dry-run сверок регистраций и payload VRF-заявок использовать view `hub::lottery_snapshot` и `hub::request_snapshot`, проверяя metadata/active-флаг и соответствие хэшам payload плюс признак нахождения в pending. | В работе | Импорт состояний добавлен, доступны per-item snapshot-view для сверки с draw-реестром и миграционными скриптами. |

## 4. Следующие шаги
1. Подготовить миграцию `SalesLedger`: скрипты конвертации счётчиков и сверку распределений с трежери после внедрения батчевых покупок.
2. Сформировать план миграции `PayoutLedger`: выгрузка победителей из `lottery_multi::payouts`, упаковка данных в payload `LegacyPayoutRecord`, вызов admin-entry `import_existing_payout`/`import_existing_payouts` и dry-run проверки `lottery_rewards_engine::payouts::pay_jackpot_winner` с событиями `WinnerRecorded`/`PayoutStatusUpdated` и `JackpotPaidEvent` на testnet.
3. Подготовить сценарии миграции VRF-запросов и депозита: перенос `DrawLedger`, `VrfDepositLedger`, сверка pending-запросов и dry-run цепочек `schedule → request → fulfill` на тестнете с проверкой пауз.
4. Подготовить миграцию `HistoryCollection` и `HistoryWarden`: выгрузить архивы и события из `support_history`, перенести их в `lottery_utils::history` через `LegacyHistoryRecord` и entry-функции импорта, протестировать `sync_draws_from_rounds` и dry-run очистки `clear_history`/`record_draw_from_rounds`.
5. Подготовить миграцию `AutomationRegistry` и `AutomationCap`: выгрузить зарегистрированных ботов, собрать payloadы `LegacyAutomationBot`, вызвать `import_existing_bot`/`import_existing_bots`, перенести pending-статусы и подтвердить расписания cron и dry-run сценарии на testnet.
6. Подготовить миграцию `AutopurchaseState`: выгрузить активные планы из `rewards_autopurchase`, сформировать payloadы `LegacyAutopurchasePlan`, вызвать `lottery_rewards_engine::autopurchase::import_existing_plan`/`import_existing_plans`, затем сверить снапшоты, события конфигурации и провести dry-run `execute`/`refund` на testnet.
7. Подготовить миграцию `StoreState`: выгрузить товары и остатки из `rewards_store`, конвертировать их в payloadы `LegacyStoreItem`, вызвать `lottery_rewards_engine::store::import_existing_item(s)`, протестировать `purchase`/`set_availability` и сверить события с легаси.
8. Подготовить миграцию `VipState`: выгрузить конфиги, участников и expiry из `rewards_vip`, собрать payloadы `LegacyVipLottery`, вызвать `lottery_rewards_engine::vip::import_existing_lottery(ies)` и сверить снапшоты, выручку и бонусные билеты.
9. Подготовить миграцию `LotteryRegistry`: выгрузить список лотерей и владельцев из `lottery_multi::lottery_registry`, перенести данные в `lottery_gateway::GatewayRegistry` и `registry::LotteryRegistry`, сверить индексы владельцев, статусы активности и причины отмен по снапшотам `registry_snapshot`.
10. Согласовать формат JSON-отчёта из `export_move_inventory.py` для автоматизированной проверки заполнения таблицы (задача на следующую итерацию).
11. Подготовить сценарии переноса capability (`InstanceControl`, `RoundControl`, `TreasuryV1Control`, `TreasuryMultiControl`, `AutopurchaseAccess`, `FeatureSwitchAdminCap`) и задокументировать последовательность транзакций.
12. Согласовать миграцию владельцев и операторов: подготовить batched-скрипт, который формирует payloadы `LegacyOperatorRecord`, вызывает `lottery_data::operators::import_existing_operator_record(s)` для восстановления on-chain состояния и при необходимости повторно прогоняет `lottery_engine::operators::grant_operator` для актуальных изменений; зафиксировать контрольные точки в чек-листе.
13. Подготовить перенос записей отмен: выгрузить данные `CancellationRecord` из `lottery_multi::lottery_registry`, сверить суммы продаж и джекпотов, протестировать admin cancel в `lottery_gateway` на testnet.
14. Сформировать сценарий миграции мульти-трежери: выгрузить текущие доли BPS, перенести их в `lottery_rewards_engine::treasury::configure_lottery_shares`, сверить накопленные балансы `treasury_multi::TreasuryState` с данными legacy и протестировать распределение на testnet.
15. Подготовить миграцию `VipState`: выгрузить активные подписки и expiry из `rewards_vip`, перенести их в `lottery_rewards_engine::vip`, восстановить суммы выручки и подтвердить события `VipSubscribed`/`VipCancelled` в интеграционных сценариях фасада.
16. Подготовить миграцию `MetadataRegistry`: выгрузить записи из `support_metadata`, перенести их в `lottery_utils::metadata`, сверить снапшоты `MetadataSnapshotUpdatedEvent` и выдачу данных через фасад/фронтенд.
17. Подготовить миграцию `ReferralState`: выгрузить конфиги, статистику и регистрацию игроков из `rewards_referrals`, сформировать payloadы `LegacyReferralLottery`/`LegacyReferralRegistration` (допускаются devnet/testnet архивы, dry-run отчёты или ручные константы), вызвать admin-entry `import_existing_lottery(ies)` и `import_existing_registration(s)` и сверить снапшоты `ReferralSnapshotUpdatedEvent`.
18. Подготовить миграцию dual-write контроля: выгрузить pending `expected_hashes` и флаги `enabled/abort_on_*` из `lottery_multi::legacy_bridge::DualWriteControl`, упаковать данные в payload для `lottery_utils::history` (включая последние события `ArchiveDualWriteStarted`/`Completed`), выполнить dry-run `migrate_dual_write_control` с подтверждением совпадения хэшей между архивом и новым `history::DualWriteControl`, затем задокументировать вывод ресурса `MirrorConfig` в миграционном чек-листе.
19. Сконфигурировать перенос `JackpotAccess`: добавить entry `jackpot::init_access` в новом движке, извлечь `MultiTreasuryCap` из `lottery_data::treasury_multi::TreasuryMultiControl`, перенести capability с подтверждением отсутствия dangling-кап в legacy `lottery_rewards::Jackpot`, задокументировать dry-run `claim_jackpot_cap`/`release_caps` и обновить тест сценарии `lottery_rewards_engine::jackpot::fulfill_draw`.

## 5. Журнал изменений

| Дата (UTC) | Изменение | Автор |
| --- | --- | --- |
| 2026-02-16 | Добавлен тест `lottery_vrf_gateway::hub_tests::register_request_and_fulfill_flow`, проверяющий регистрацию лотереи, выдачу запроса, работу callback-отправителя и очистку pending-очереди для dry-run совместимости с легаси VRF. | Supra refactoring bot |
| 2026-02-15 | `lottery_engine::vrf_config` получил view `is_initialized`, чтобы перед snapshot-вызовами можно было убедиться в публикации `instances`/`lottery_state`; обновлены дата карты и шаг миграции VRF-конфигурации. | Supra refactoring bot |
| 2026-02-14 | `lottery_engine::ticketing` и `lottery_engine::lifecycle` получили view `is_initialized`, чтобы миграционные скрипты могли быстро проверять публикацию storage/rounds перед вызовом blueprint- и lifecycle-снапшотов; обновлены дата карты и шаги миграции `LotteryCollection`. | Supra refactoring bot |
| 2026-02-13 | `lottery_utils::migration` получил view `is_initialized` и `session_initialized` для проверки публикации `MigrationLedger` и `MigrationSession` перед dry-run аудитом; обновлены шаги миграции и дата карты. | Supra refactoring bot |
| 2026-02-12 | `lottery_data::cancellations` получил view `is_initialized` для быстрой проверки публикации перед импортом; обновлены дата карты и шаг миграции `CancellationRecord`. | Supra refactoring bot |
| 2026-02-11 | Добавлен view `treasury_multi::is_initialized` и обновлён шаг миграции `TreasuryState` с быстрой проверкой инициализации; дата карты миграции обновлена. | Supra refactoring bot |
| 2025-11-15 | Развёрнут каркас `lottery_data` (lottery_state, instances, rounds, operators, treasury, treasury_multi) и обновлены статусы миграции ядра. | Supra refactoring bot |
| 2025-11-16 | Сформирована базовая карта миграции с перечислением 35 ресурсов и действиями по переносу. | Supra refactoring bot |
| 2025-11-17 | Переведён `SalesLedger` в статус `В работе`: добавлен модуль `lottery_engine::sales`, обновлены сводка статусов и следующий шаг по поддержке батчей. | Supra refactoring bot |
| 2025-11-18 | Переведён `DrawLedger` в статус `В работе`: добавлен модуль `lottery_engine::draw` с запросом VRF и событиями завершения, обновлены сводка статусов и план миграции VRF. | Supra refactoring bot |
| 2025-11-19 | Добавлен модуль `lottery_engine::vrf_config`, обновлены события `lottery_data::lottery_state` и описание миграции VRF-параметров. | Supra refactoring bot |
| 2025-11-20 | Расширен `lottery_engine::sales` батчевыми покупками и обновлены шаги миграции `SalesLedger` и раздел «Следующие шаги». | Supra refactoring bot |
| 2025-11-21 | Развёрнуты `lottery_data::vrf_deposit` и `lottery_engine::vrf`, обновлён контроль паузы запросов и статусы миграции VRF-депозита. | Supra refactoring bot |
| 2025-11-22 | Добавлены события владельцев `lottery_data::instances`, реализован `lottery_engine::operators`, обновлены шаги миграции ролей. | Supra refactoring bot |
| 2025-11-23 | Реализован модуль `lottery_engine::lifecycle` и функции `instances::set_active`; обновлены сводка статусов и описание миграции `LotteryCollection`. | Supra refactoring bot |
| 2025-11-24 | Добавлены `lottery_data::payouts` и `lottery_engine::payouts`, обновлены статусы миграции `PayoutLedger` и план действий по переносу выплат. | Supra refactoring bot |
| 2025-11-25 | Реализованы `lottery_data::cancellations` и `lottery_engine::cancellation`, добавлен сценарий миграции записей отмен и обновлена сводка статусов. | Supra refactoring bot |
| 2025-11-26 | Модули `lottery_engine`/`lottery_data` обновлены на рекурсивные хелперы без циклов, чтобы соблюсти синтаксис Move v1 и устранить риски при миграции `SalesLedger`, `DrawLedger` и `PayoutLedger`. | Supra refactoring bot |
| 2025-11-27 | Добавлены `lottery_data::automation` и `lottery_engine::automation`, что позволяет переносить реестр ботов и capability cron с событиями dry-run/тикета; обновлены статусы миграции и чек-лист. | Supra refactoring bot |
| 2025-11-28 | Создан пакет `lottery_gateway` с фасадом `gateway`, зафиксирован переход `lottery_multi::lottery_registry` в статус `В работе` и расширены шаги миграции `Registry`/`CancellationRecord`. | Supra refactoring bot |
| 2025-11-29 | Добавлен пакет `lottery_rewards_engine` с модулем `treasury`, обновлён `lottery_engine::sales` и уточнена миграция `TreasuryState`/`SalesLedger` для распределения BPS. | Supra refactoring bot |
| 2025-11-30 | Реализованы `lottery_data::jackpot` и `lottery_rewards_engine::jackpot`, обновлены статусы миграции VRF-джекпота и действия по dry-run запросов/fulfill с мульти-трежери. | Supra refactoring bot |
| 2025-12-01 | Добавлены функции автопокупок: `lottery_rewards_engine::autopurchase`, обновлены `lottery_engine::sales`, `lottery_data::treasury` и `lottery_data::rounds` для работы с cap и предоплаченными продажами; статусы миграции `AutopurchaseState` и capability переведены в `В работе`. | Supra refactoring bot |
| 2025-12-03 | Реализован модуль `lottery_rewards_engine::vip` с управлением подписками и событиями, обновлены статусы миграции `VipState`/`VipAccess` и добавлен шаг подготовки переноса подписок. | Supra refactoring bot |
| 2025-12-04 | Добавлен модуль `lottery_rewards_engine::store`, обновлены статусы миграции магазина и capability, расширены «Следующие шаги» и чек-лист транзакций. | Supra refactoring bot |
| 2025-12-15 | `lottery_rewards_engine::vip` расширен payloadом `LegacyVipLottery`, обновлены шаги миграции `VipState` и таблица соответствий, чтобы скрипты могли импортировать конфиги и подписки без повторных оплат. | Supra refactoring bot |
| 2025-12-16 | `lottery_rewards_engine::referrals` получил payloadы `LegacyReferralLottery`/`LegacyReferralRegistration`, обновлены действия миграции `ReferralState`, добавлен шаг в чек-лист и журнал прогресса. | Supra refactoring bot |
| 2025-12-17 | `lottery_rewards_engine::jackpot` расширен payloadом `LegacyJackpotRuntime` и admin-entry `import_existing_jackpot(s)`, `lottery_data::jackpot` получил helper восстановления состояния; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-18 | `lottery_data::payouts` получил структуру `LegacyPayoutRecord` и admin-entry `import_existing_payout(s)` для восстановления победителей, статусов и событий без повторных выплат; обновлены действия миграции `PayoutLedger`, раздел «Следующие шаги» и инвентаризация структур. | Supra refactoring bot |
| 2025-12-19 | `lottery_data::instances` получил payload `LegacyInstanceRecord` и admin-entry `import_existing_instance(s)`, которые восстанавливают владельцев, активность и счётчики проданных билетов с переэмитом снапшотов; обновлены карта миграции, детальный план и инвентаризация структур. | Supra refactoring bot |
| 2025-12-20 | `lottery_data::operators` получил payload `LegacyOperatorRecord` и admin-entry `import_existing_operator_record(s)` для восстановления владельцев и операторов без обращения к легаси-пакетам; обновлены карта миграции, детальный план и инвентаризация структур. | Supra refactoring bot |
| 2025-12-21 | `lottery_data::treasury_multi` получил payload'ы `LegacyMultiTreasuryState`/`LegacyMultiTreasuryLottery` и admin-entry для импорта глобальных получателей, долей BPS и локальных балансов; обновлены карта миграции, детальный план и структурный инвентарь. | Supra refactoring bot |
| 2025-12-22 | `lottery_data::treasury` получил структуры `LegacyVaultConfig`/`LegacyVaultRecipients`, payload `LegacyVaultState` и admin-entry `import_existing_vaults`, что позволяет переносить конфигурацию и получателей без повторных переводов; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-23 | `lottery_data::rounds` получил payload `LegacyRoundRecord` и admin-entry `import_existing_round(s)` плюс функции `import_pending_history_records`/`import_pending_purchase_records`, что позволяет восстанавливать раунды и очереди без запуска legacy-процессов; обновлены карта миграции и структурный отчёт. | Supra refactoring bot |
| 2025-12-24 | `lottery_data::lottery_state` получил payload `LegacyLotteryRuntime` и admin-entry `import_existing_lottery(ies)`, что позволяет разворачивать тикеты, VRF-конфигурацию и whitelists без повторных продаж и переэмитить события `LotterySnapshotUpdatedEvent`/`Vrf*Updated`; обновлены карта миграции, план и структурный отчёт. | Supra refactoring bot |
| 2025-12-25 | `lottery_data::cancellations` получил payload `LegacyCancellationRecord` и admin-entry `import_existing_cancellation(s)`, поэтому исторические причины отмен и суммы продаж можно переносить из devnet/testnet архивов, dry-run отчётов или ручных констант без повторного вызова `lottery_engine::cancellation`; обновлены карта миграции, план, чек-лист и структурный отчёт. | Supra refactoring bot |
| 2025-12-26 | `lottery_data::vrf_deposit` получил payload `LegacyVrfDepositLedger` и admin-entry `import_existing_ledger`, что позволяет переносить конфигурацию, баланс и флаги паузы из devnet/testnet архивов, dry-run отчётов или ручных констант без доступа к legacy-пакетам; обновлены карта миграции, план, чек-лист и структурный отчёт. | Supra refactoring bot |
| 2025-12-27 | Таблица миграции дополнена ресурсом `FeatureSwitchAdminCap`, обновлены счётчики статусов, раздел «Следующие шаги» (capability) и указание на контроль фичей через `lottery_utils::feature_flags`. | Supra refactoring bot |
| 2025-12-28 | Уточнены строки `legacy_bridge::DualWriteControl`/`MirrorConfig`, добавлены требования по dry-run dual-write перед выводом legacy-моста и обновлена дата документа. | Supra refactoring bot |
| 2025-12-29 | Добавлен шаг миграции dual-write контроля (`legacy_bridge::DualWriteControl` → `lottery_utils::history::DualWriteControl`), обновлена дата документа и расширен чек-лист capability/dual-write сценариев. | Supra refactoring bot |
| 2026-01-24 | `lottery_data::treasury` получил snapshot-view `caps_ready`/`control_snapshot` для проверки наличия `AutopurchaseTreasuryCap` и `LegacyTreasuryCap` перед миграцией; обновлены дата карты и шаг переноса `TreasuryV1Control`. | Supra refactoring bot |
| 2026-01-25 | `lottery_data::treasury` получил snapshot-view `token_state_snapshot`, позволяющий dry-run проверку адреса metadata и наличия mint/burn/transfer ref перед переносом токена; обновлены дата карты и шаг миграции `TokenState`. | Supra refactoring bot |
| 2026-01-26 | `lottery_data::rounds` получил snapshot-view `caps_ready`/`control_snapshot`, позволяющие dry-run проверку наличия `HistoryWriterCap`/`AutopurchaseRoundCap` и администратора перед переносом capability; обновлена дата карты и строка `RoundControl`. | Supra refactoring bot |
| 2026-01-27 | `lottery_rewards_engine::autopurchase` получил snapshot-view `access_snapshot`, обновлён шаг миграции `AutopurchaseAccess` для dry-run проверки наличия cap без обращения к legacy-пакетам. | Supra refactoring bot |
| 2026-01-28 | `lottery_engine::ticketing` получил snapshot-view `blueprint_snapshot`/`blueprint_snapshots`, позволяющие dry-run сверку владельца, цены билета и авто-дро без обращения к legacy-пакетам; обновлена дата карты и шаг миграции `LotteryCollection`. | Supra refactoring bot |
| 2026-01-29 | `lottery_engine::lifecycle` получил snapshot-view `lifecycle_snapshot(s)`, агрегирующие активность инстанса, draw-флаги и pending VRF из storage/rounds для dry-run сверки паузы и расписаний; обновлены дата карты и шаг миграции `LotteryCollection`. | Supra refactoring bot |
| 2026-01-30 | `lottery_utils::migration` получил snapshot-view `session_snapshot` для контроля наличия `InstancesExportCap` и `LegacyTreasuryCap` перед миграцией; обновлена дата карты и строка `MigrationSession`. | Supra refactoring bot |
| 2026-02-02 | `lottery_engine::vrf` получил алиасы view `ledger_snapshot`/`is_initialized`, чтобы dry-run аудит депозита VRF можно было проводить через сервисный модуль; обновлена дата карты и шаг миграции `VrfDepositLedger`. | Supra refactoring bot |
| 2026-02-06 | `lottery_gateway::history` получил view `is_initialized`, а карта миграции дополнена требованием проверять публикацию ресурса перед импортом/сверкой снапшотов. | Supra refactoring bot |
| 2026-02-07 | `lottery_rewards_engine::autopurchase` и `referrals` получили view `is_initialized`, карта миграции дополнена шагами dry-run проверки публикации ресурсов перед импортом/снимками. | Supra refactoring bot |
| 2026-02-08 | `lottery_rewards_engine::payouts` получил view `is_initialized`, что позволяет миграционным скриптам через сервисный слой проверять публикацию `PayoutLedger` перед использованием snapshot/view; обновлена дата карты и шаг миграции `PayoutLedger`. | Supra refactoring bot |
| 2026-02-16 | В workspace добавлен целевой пакет `lottery_vrf_gateway` с модулем `hub`, который включает миграционные entry `import_existing_state`/`migrate_lottery_vrf_gateway_state`, view `is_initialized`/`hub_snapshot`/`callback_sender_status` и события регистрации/VRF-запросов для dry-run аудита; статус карты `HubState` оставлен «В работе», но теперь доступен новый namespace для миграции с сохранением адреса. | Supra refactoring bot |
| 2026-02-17 | Фабрика переведена на `lottery_vrf_gateway::hub`, чтобы регистрация лотерей и smoke-тесты фабрики работали через целевой VRF-gateway; обновлена строка карты миграции для `FactoryState`. | Supra refactoring bot |
| 2026-02-18 | Легаси-пакеты `lottery_core` и `lottery_multi` теперь используют `lottery_vrf_gateway` вместо `vrf_hub`, чтобы dry-run тесты и миграционные сценарии работали через целевой VRF-хаб и таблицы. | Supra refactoring bot |
| 2026-02-19 | `lottery_vrf_gateway::hub` получил view `lottery_snapshot` и `request_snapshot` для точечной dry-run сверки регистраций и VRF-заявок (metadata, активность, payload/хэш, pending-флаг) без полного snapshot хаба; обновлена строка `HubState`. | Supra refactoring bot |
| 2026-02-20 | `lottery_data::cancellations` получил view `ready` и точечный `record_snapshot`, а health-снимок фасада расширен флагом `cancellations_ready`, чтобы dry-run миграции могли проверять публикацию ресурса и отдельные записи перед переносом; обновлена строка `CancellationRecord`. | Supra refactoring bot |
| 2026-02-21 | `lottery_data::payouts` получил view `ready` и точечный `payout_record_snapshot`, а `lottery_gateway::health::rewards_ready` теперь использует новый флаг для dry-run сверки `PayoutLedger`; обновлена строка миграции `PayoutLedger`. | Supra refactoring bot |
| 2026-02-23 | `lottery_data::rounds` получил view `ready`, который проверяет публикацию `RoundRegistry`, `RoundControl`, очередей истории/покупок и валидность pending-записей; `lottery_gateway::health::queues_ready` использует новый флаг, а тест `rounds_ready_flow` покрывает сценарии миграции очередей. | Supra refactoring bot |
| 2026-02-22 | `lottery_data::jackpot` получил view `ready`, тестовые helper'ы и модульные тесты, `lottery_rewards_engine::jackpot` проксирует новый флаг, а `lottery_gateway::health::rewards_ready` учитывает проверку регистра джекпотов; обновлена строка `JackpotState` в карте миграции. | Supra refactoring bot |
| 2026-02-10 | `lottery_data::automation` получил view `is_initialized`, а `lottery_engine::automation` — алиас, что позволяет миграционным скриптам проверять публикацию реестра ботов перед вызовом snapshot/view; обновлены дата карты и шаг миграции `AutomationRegistry`. | Supra refactoring bot |
| 2026-02-09 | `lottery_data::jackpot` получил view `is_initialized`, а `lottery_rewards_engine::jackpot` — алиас, что позволяет миграционным скриптам быстро проверять публикацию реестра джекпота перед импортом и использованием snapshot-view; обновлена дата карты и шаг миграции `JackpotState`. | Supra refactoring bot |
| 2026-02-05 | `lottery_data::payouts` получил view `is_initialized`, а `lottery_engine::payouts` — алиас к нему, чтобы миграционные скрипты могли проверять публикацию `PayoutLedger` перед вызовом snapshot/view; обновлены дата карты и шаг миграции `PayoutLedger`. | Supra refactoring bot |
| 2026-02-04 | `lottery_engine::cancellation` получил alias view `is_initialized`/`ledger_snapshot`, чтобы dry-run аудит отмен можно было делать через сервисный слой без прямого обращения к `lottery_data`; обновлены дата карты и шаг миграции `CancellationRecord`. | Supra refactoring bot |
| 2026-02-03 | `lottery_engine::operators` получил alias view `registry_snapshot`, чтобы dry-run аудит владельцев и операторов можно было делать без прямого обращения к `lottery_data`; обновлены дата карты и шаг миграции операторов. | Supra refactoring bot |
| 2026-02-01 | `lottery_utils::metadata` получил view `registry_snapshot`, позволяющий безопасно экспортировать снапшот реестра метаданных даже без опубликованного состояния; обновлена дата карты и шаг миграции `MetadataRegistry`. | Supra refactoring bot |
| 2026-01-23 | `lottery_engine::automation` получил view `registry_snapshot`/`bot_status`/`operators`, чтобы dry-run миграции реестра ботов и capability можно было сверять без обращения к legacy-коду; обновлена дата карты и шаг переноса AutomationRegistry. | Supra refactoring bot |
| 2026-01-22 | `lottery_rewards_engine::jackpot` получил snapshot-view `registry_snapshot`/`lottery_snapshot`/`runtime_view`/`runtime_views`, чтобы dry-run миграции джекпота можно было сверять без обращения к `lottery_data`; обновлена дата карты и шаги миграции джекпота. | Supra refactoring bot |
| 2026-01-21 | `lottery_utils::migration` получил view `ledger_snapshot` с агрегированным списком лотерей и записей прогресса для dry-run аудита миграции; обновлена дата карты и строка `MigrationLedger`. | Supra refactoring bot |
| 2026-01-20 | Добавлены snapshot-view `vrf_config_snapshot`/`vrf_config_snapshots` для аудита газовых лимитов, whitelist и pending-заявок VRF, обновлены строка карты миграции и дата актуальности. | Supra refactoring bot |
| 2026-01-05 | Добавлены миграционные alias `migrate_factory_state` и `migrate_lottery_vrf_gateway_state`, статусы фабрики и VRF-хаба переведены в `В работе`, сводные счётчики обновлены. | Supra refactoring bot |
| 2026-01-06 | Добавлен снапшот реестра ценовых фидов (`registry_snapshot`) для dry-run аудита миграции `PriceFeedRegistry`, план дополнен шагом сверки записей после импорта. | Supra refactoring bot |
| 2026-01-07 | Добавлены view-снимки очередей `PendingHistoryQueue` и `PendingPurchaseQueue` в `lottery_data::rounds`, таблица миграции обновлена инструкциями по dry-run аудиту очередей. | Supra refactoring bot |
| 2026-01-08 | Реализован снапшот `operators::registry_snapshot` для миграционного аудита владельцев и операторов; обновлены дата, действия по миграции операторов и журнал изменений. | Supra refactoring bot |
| 2026-01-09 | `lottery_engine::payouts` получил view `ledger_snapshot`/`lottery_snapshot` для dry-run аудита миграции выплат; обновлены строка `PayoutLedger` и дата актуальности карты миграции. | Supra refactoring bot |
| 2026-01-10 | Добавлены view `vrf_deposit::is_initialized`/`ledger_snapshot` и обновлён план миграции депозита VRF для dry-run сверки конфигурации и статуса без обращения к legacy-коду. | Supra refactoring bot |
| 2026-01-11 | Добавлены view `runtime_snapshot`/`state_snapshot` в `lottery_data::lottery_state` для dry-run аудита билетов, whitelist и VRF-параметров; обновлена дата актуальности карты миграции. | Supra refactoring bot |
| 2026-01-12 | Добавлены view-атрибуты для снапшотов наград (`autopurchase::snapshot`, `store::get_store_snapshot`, `vip::get_vip_snapshot`, `referrals::get_referral_snapshot`) и отражены соответствующие шаги dry-run аудита в карте миграции. | Supra refactoring bot |
| 2026-01-13 | `lottery_data::cancellations` получил view `ledger_snapshot`, обновлён шаг миграции отмен с dry-run сверкой сумм продаж и блокировок джекпота, дата актуальности карты перенесена. | Supra refactoring bot |
| 2026-01-14 | Добавлены view `lottery_rewards_engine::treasury::{state_snapshot, lottery_config, recipients}` и хелперы `treasury_multi::{has_state, has_lottery}` для dry-run аудита долей BPS и получателей мульти-трежери; карта миграции обновлена новым шагом проверки. | Supra refactoring bot |
| 2026-01-15 | `lottery_data::instances` получил view `registry_snapshot`/`instance_snapshot` для dry-run сверки admin/hub и записей реестра перед миграцией; дата актуальности обновлена, строка `LotteryCollection` дополнена шагом аудита. | Supra refactoring bot |
| 2026-01-16 | `lottery_data::rounds` получил view `is_initialized`/`registry_snapshot`/`round_snapshot` и сборку runtime-срезов билетов, draw-флагов и pending-запросов для dry-run аудита миграции раундов; обновлены шаги миграции `RoundCollection` и дата актуальности карты. | Supra refactoring bot |
| 2026-01-17 | `lottery_rewards_engine::payouts` получил view `ledger_snapshot`/`lottery_snapshot`, позволяющие вызывать dry-run аудит выплат из сервисного модуля; обновлена дата актуальности карты миграции и уточнён шаг проверки `PayoutLedger`. | Supra refactoring bot |
| 2026-01-18 | Добавлены snapshot-view `sales_snapshot`/`sales_snapshots` в `lottery_engine::sales`, обновлено описание шага dry-run сверок `SalesLedger` в карте миграции и дата актуальности. | Supra refactoring bot |
| 2026-01-19 | `lottery_engine::draw` получил view `draw_snapshot`/`draw_snapshots` для dry-run аудита VRF-запросов и счётчиков draw; обновлён шаг миграции `DrawLedger` и дата карты. | Supra refactoring bot |
| 2025-12-30 | Проведён аудит legacy `JackpotAccess`, добавлены детальные требования по его переносу, новая задача в чек-листе и обновлена дата документа. | Supra refactoring bot |
| 2025-12-31 | Реализован `lottery_utils::history::DualWriteControl` с payload `LegacyDualWriteState`, view `dual_write_status`/`pending_expected_hashes` и entry `init_dual_write`; статус ресурса переведён в `В работе`, обновлены сводка и план миграции dual-write. | Supra refactoring bot |
| 2026-01-01 | Добавлен `lottery_data::access::RoleStore` с payload'ами для payout/partner/premium cap и admin-entry импорта, обновлены статусы миграции RoleStore и сводка. | Supra refactoring bot |
| 2026-01-02 | Реализован `lottery_rewards_engine::nft` с событиями mint/burn, снапшотами владельцев и импортом `LegacyBadgeAuthority`; статус `BadgeAuthority` переведён в `В работе`, обновлена сводка и инструкции миграции NFT-наград. | Supra refactoring bot |
| 2026-01-04 | Добавлен `lottery_gateway::history` с событиями и импортом `LegacyHistoryImport`, фасад пишет записи при создании и отмене; статус `LotteryHistory` переведён в `В работе`, обновлены сводка статусов и требования по миграции cap `JackpotAccess`. | Supra refactoring bot |
| 2026-01-03 | Добавлены `history::ArchiveLedger` и `history::LegacyArchive` с admin-entry для импорта архивов, dual-write проверками и зеркалированием BCS-сводок, статусы переводов архивов обновлены в таблице и сводке. | Supra refactoring bot |
| 2025-12-05 | Реализован `lottery_utils::history` с синхронизацией очереди `rounds::PendingHistoryQueue`; статусы `HistoryCollection` и `HistoryWarden` переведены в `В работе`, обновлены «Следующие шаги» и требования по dry-run миграции истории. | Supra refactoring bot |
| 2025-12-06 | Добавлен `lottery_utils::metadata`, обновлены статусы миграции `MetadataRegistry`, расширена сводка и список следующих шагов. | Supra refactoring bot |
| 2025-12-07 | Реализован `lottery_utils::migration`, обновлены статусы `MigrationLedger` и `MigrationSession`, добавлены функции извлечения capability и обновлён чек-лист. | Supra refactoring bot |
| 2025-12-08 | Фасад `lottery_gateway::gateway` получил view-функции для snapshot, списка лотерей и индекса владельцев, что подготавливает миграцию `lottery_multi::lottery_registry`. | Supra refactoring bot |
| 2025-12-09 | Добавлен модуль `lottery_gateway::registry`, включающий снапшоты `LotteryRegistrySnapshotUpdatedEvent` и синхронизацию с фасадом при создании/импорте/отмене лотерей; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-10 | `lottery_utils::metadata` получил структуру `LegacyMetadataImport` и batch-entry для импорта исторических записей, обновлена карта миграции и план. | Supra refactoring bot |
| 2025-12-11 | `lottery_utils::history` расширен структурой `LegacyHistoryRecord` и admin-entry для импорта архивных розыгрышей; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-13 | `lottery_rewards_engine::autopurchase` получил структуру `LegacyAutopurchasePlan` и admin-entry для импорта планов, обновлены шаги миграции и сводка статусов. | Supra refactoring bot |
| 2025-12-14 | `lottery_rewards_engine::store` расширен структурой `LegacyStoreItem` и admin-entry `import_existing_item(s)` для переноса каталога, остатков и счётчиков продаж; обновлены шаги миграции магазина и раздел «Следующие шаги». | Supra refactoring bot |
