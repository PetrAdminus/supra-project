# Карта миграции on-chain структур SupraLottery

> Последнее обновление: 2025-12-26 (UTC)

Документ фиксирует сопоставление текущих on-chain ресурсов старой архитектуры SupraLottery и целевых сущностей новой модульной схемы (`lottery_data`, `lottery_engine`, `lottery_gateway`, `lottery_rewards_engine`, `lottery_utils`, `lottery_vrf_gateway`, `lottery_factory`). Таблица служит рабочим источником правды для подготовки миграционных транзакций и контроля статуса переноса. Пакет `lottery_gateway` продолжает текущий `lottery_hub`, а `lottery_vrf_gateway` строится на базе существующего `vrf_hub`; оба переименования будут выполнены после выравнивания интерфейсов.

## 1. Как пользоваться документом
- Каждая строка таблицы описывает ресурс, требующий миграции или явного вывода из эксплуатации.
- Колонка «Действия миграции» фиксирует обязательные шаги: транзакции, проверки инвариантов, зависимость от других переносов.
- Статус используется для отслеживания прогресса:
  - `Запланировано` — миграция пока не начата, действия описаны.
  - `В работе` — идёт разработка или тестирование миграционного скрипта.
  - `Готово` — миграция выполнена и подтверждена тестами.
  - `Не требуется` — ресурс выводится из эксплуатации без переноса.
- При изменении структуры ресурса или действий миграции обязательно обновляйте строку и журнал изменений в конце документа.

## 2. Сводка статусов
- **0** ресурсов со статусом `Готово` (ожидается после реализации миграционных скриптов).
- **33** ресурса в статусе `В работе` — развернуты каркасы хранения (`lottery_data`), продажи поддерживают батчевые покупки (`lottery_engine::sales`), настройка и депозит VRF (`lottery_engine::vrf_config`, `lottery_engine::vrf`), стартовая логика розыгрыша (`lottery_engine::draw`), управление владельцами/операторами (`lottery_engine::operators`), административный цикл паузы/возврата (`lottery_engine::lifecycle`), поток выплат (`lottery_data::payouts`, `lottery_engine::payouts`), админская отмена (`lottery_data::cancellations`, `lottery_engine::cancellation`), автоматизация с ботами (`lottery_data::automation`, `lottery_engine::automation`), фасад `lottery_gateway::gateway`, распределение выручки через `lottery_rewards_engine::treasury`, поток VRF-джекпотов (`lottery_data::jackpot`, `lottery_rewards_engine::jackpot`), новая система автопокупок (`lottery_rewards_engine::autopurchase`, `lottery_data::rounds`, `lottery_data::treasury`), VIP-подписки (`lottery_rewards_engine::vip`), магазин призов (`lottery_rewards_engine::store`), on-chain история розыгрышей (`lottery_utils::history`), реестр метаданных (`lottery_utils::metadata`) и миграционный слой (`lottery_utils::migration`).
- **4** ресурса помечено как `Запланировано` и требует реализации миграционных транзакций.
- **1** ресурс отмечен как `Не требуется` (будет выведен после валидации отсутствия зависимостей).

## 3. Таблица соответствий

### 3.1. `lottery_core`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `core_main_v2` | `LotteryData` | Текущий статус лотереи: билеты, VRF-конфигурация, whitelists, gas-лимиты. | `lottery_data` | `lottery_state::LotteryState` (resource) | 1. Развернуть `lottery_data::lottery_state`.<br>2. Запустить админскую транзакцию `migrate_lottery_state` для каждой лотереи.<br>3. Сверить счётчики билетов с `lottery_multi::sales::SalesLedger` (через интеграционный скрипт).<br>4. Для восстановления исторических данных использовать payload `LegacyLotteryRuntime` и entry `import_existing_lottery`/`import_existing_lotteries`, чтобы развернуть тикеты, VRF и whitelists без повторных продаж и переэмитить события `LotterySnapshotUpdatedEvent`/`Vrf*Updated`. | В работе | Схема хранения развернута (`lottery_data::lottery_state`), импортные entry задокументированы; требуется миграционный скрипт и синхронизация с `SalesLedger`. |
| `core_main_v2` | `LotteryData` (VRF-config функции) | Настройка gas-бюджета, whitelists и client seed VRF. | `lottery_engine` | `vrf_config` (модуль управления VRF) | 1. Перенести функции конфигурации в `lottery_engine::vrf_config`.<br>2. Во время миграции зафиксировать события `VrfGasBudgetUpdated`, `VrfWhitelistUpdated`, `VrfRequestConfigUpdated` в новом `lottery_data`.<br>3. Подготовить сценарий переноса последних client seed и whitelists перед финальной миграцией. | В работе | Модуль `vrf_config` создан, события опубликованы; требуется миграция фактических параметров и dry-run цепочки с `lottery_vrf_gateway`. |
| `core_instances` | `LotteryCollection` | Реестр инстансов: владельцы, цены, доли джекпота, event handles. | `lottery_data` | `instances::InstanceRegistry` (resource) | 1. Создать `lottery_data::instances` с новой схемой.<br>2. Выполнить `migrate_instance_registry` единым батчем.<br>3. Провести сверку `lottery_ids`, активных флагов и владельцев через CLI.<br>4. Для восстановления проданных билетов и накопленного джекпота использовать payload `LegacyInstanceRecord` и admin-entry `import_existing_instance`/`import_existing_instances`. | В работе | Модуль `lottery_data::instances` реализован, добавлены события смены владельца и методы `set_owner`/`set_active`; административная пауза/возврат реализована в `lottery_engine::lifecycle`, а импортные entry переэмитят снапшоты `LotteryInstancesSnapshotUpdatedEvent`. |
| `core_instances` | `CoreControl` | Хранит capability экспорта инстансов. | `lottery_data` | `instances::InstanceControl` (resource) | 1. Вызвать `claim_instance_control_cap` для переноса `InstancesExportCap`.<br>2. Записать новый cap в `instances::InstanceControl`.<br>3. Подтвердить отсутствие «висячих» capability в старом модуле. | В работе | Контрольный ресурс создан (`lottery_data::instances`), ожидает миграции capability. |
| `core_rounds` | `RoundCollection` | Таблица раундов, event handles для покупок и VRF-запросов. | `lottery_data` | `rounds::RoundRegistry` (resource) | 1. Добавить модуль `lottery_data::rounds`.<br>2. Использовать payload `LegacyRoundRecord` и admin-entry `import_existing_round`/`import_existing_rounds`, чтобы разворачивать билеты, флаги расписания и pending-запросы с переэмитом `RoundSnapshotUpdatedEvent`.<br>3. Сверить идентификаторы раундов и состояния с `lottery_multi::draw::DrawLedger`. | В работе | Модуль `lottery_data::rounds` опубликован, импортные entry позволяют переносить раунды батчами и переэмитить события; требуется dry-run миграции и выравнивание событий с `lottery_engine`. |
| `core_rounds` | `HistoryQueue` | Очередь незаписанных историй для внешнего экспорта. | `lottery_data` | `rounds::PendingHistoryQueue` (resource) | 1. На время миграции приостановить продюсеров истории.<br>2. Вызвать admin-entry `import_pending_history_records`, передав подготовленный список `PendingHistoryRecord` (devnet/testnet архивы, dry-run отчёты или ручные константы), чтобы заменить очередь без обращения к legacy-пакетам.<br>3. Перезапустить записи истории уже из `lottery_engine`. | В работе | Очередь развернута в `lottery_data::rounds`, импортная entry принимает батч записей и используется `lottery_utils::history` при sync; требуется dry-run миграции и сверка с `support_history`. |
| `core_rounds` | `PurchaseQueue` | Очередь незавершённых покупок билетов. | `lottery_data` | `rounds::PendingPurchaseQueue` (resource) | 1. Перед миграцией завершить или отменить активные покупки.<br>2. Вызвать admin-entry `import_pending_purchase_records`, чтобы записать подготовленный список `PendingPurchaseRecord` (devnet/testnet архивы, dry-run отчёты или ручные данные) в новую очередь.<br>3. Обновить обработчики в новом `lottery_engine::ticketing`. | В работе | Очередь реализована в `lottery_data::rounds`, импортная entry восстанавливает pending-записи и используется `lottery_rewards_engine::rounds_sync`; требуется очистка активных записей перед переносом. |
| `core_rounds` | `CoreControl` | Capabilities для записи истории и автопокупок. | `lottery_data` | `rounds::RoundControl` (resource) | 1. Перенести `HistoryWriterCap` и `AutopurchaseRoundCap` в новый ресурс.<br>2. Зафиксировать событие миграции в `lottery_utils::audit`. | В работе | Ресурс `lottery_data::rounds::RoundControl` создан, ожидает переноса capability и интеграции с `lottery_rewards_engine`. |
| `core_operators` | `LotteryOperators` | Таблица операторов, event handles выдачи/отзыва. | `lottery_data` | `operators::OperatorRegistry` (resource) | 1. Сформировать ресурс `OperatorRegistry` с индексом `lottery_ids` и событиями.<br>2. Использовать payload `LegacyOperatorRecord` и admin-entry `import_existing_operator_record(s)` для восстановления владельцев и списков операторов с переэмитом owner/grant/snapshot событий.<br>3. Проверить роли операторов в интеграционных тестах и выстроить вызовы через `lottery_engine::operators`/`lottery_gateway`. | В работе | Реестр операторов реализован, доступен payload `LegacyOperatorRecord` для батчевого импорта из devnet/testnet архивов или dry-run отчётов; требуется прогнать миграционный скрипт и связать фасад. |
| `core_treasury_v1` | `Vaults` | Конфигурация распределения средств и получателей. | `lottery_data` | `treasury::Vaults` (resource) | 1. Создать модуль `lottery_data::treasury`.<br>2. Использовать payload `LegacyVaultState` (с `LegacyVaultConfig`/`LegacyVaultRecipients`) и admin-entry `import_existing_vaults`, чтобы восстановить конфигурацию и получателей без повторных переводов.<br>3. Провести сверку получателей с бухгалтерией. | В работе | Структура `lottery_data::treasury::Vaults` создана, импортные entry переэмитят события `ConfigUpdated`/`RecipientsUpdated`, требуется dry-run миграции. |
| `core_treasury_v1` | `TokenState` | Доступ к capability токена (mint/burn/transfer). | `lottery_data` | `treasury::TokenState` (resource) | 1. Перед миграцией выгрузить состояние capability.<br>2. Перезаписать ссылки в новом модуле.<br>3. Обновить вызовы в автопокупках и выплатах. | В работе | Хранилище capability подготовлено (`lottery_data::treasury`), ожидает переноса объектов и ссылок. |
| `core_treasury_v1` | `CoreControl` | Capabilities автопокупок и legacy-трежери. | `lottery_data` | `treasury::TreasuryV1Control` (resource) | 1. Перенести `AutopurchaseTreasuryCap` и `LegacyTreasuryCap`.<br>2. Обновить скрипты автопокупки на новый ресурс. | В работе | Ресурс `lottery_data::treasury::TreasuryV1Control` подготовлен, ожидает фактического переноса capability. |
| `core_treasury_multi` | `TreasuryState` | Балансы джекпота/операций, конфигурация долей и event handles. | `lottery_data` | `treasury_multi::TreasuryState` (resource) | 1. Создать `lottery_data::treasury_multi` с новой схемой.<br>2. Выполнить `migrate_multi_treasury` и использовать payload'ы `LegacyMultiTreasuryState`/`LegacyMultiTreasuryLottery` через admin-entry `import_existing_state`, `import_existing_lottery(ies)` для восстановления получателей, долей BPS и локальных балансов без повторного движения средств.<br>3. Проверить суммы и event handles через тестовый сценарий. | В работе | Хранилище `lottery_data::treasury_multi::TreasuryState` реализовано; модуль `lottery_rewards_engine::treasury` уже распределяет платежи и эмитит события на каждой покупке, а импортные entry переиспользуют события конфигурации/распределения для миграции. |
| `core_treasury_multi` | `CoreControl` | Capability на разные пулы (jackpot/vip/store/referrals). | `lottery_data` | `treasury_multi::TreasuryMultiControl` (resource) | 1. Передать capability в новый ресурс через `claim_multi_treasury_caps`.<br>2. Обновить потребителей (rewards, store, vip). | В работе | Контроллер `lottery_data::treasury_multi` готов, необходимо перенести capability и обновить потребителей. |

### 3.2. `lottery_multi`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `factory` | `FactoryState` | Реестр планируемых лотерей, capability администратора. | `lottery_factory` | `registry::FactoryRegistry` (resource) | 1. Внедрить расширенный модуль `registry` в новой фабрике.<br>2. Выполнить `migrate_factory_state`.<br>3. Пересобрать события планирования/активации. | Запланировано | Требует готовности нового фасада `lottery_gateway`. |
| `lottery_registry` | `Registry` | Список лотерей, причины отмен и история. | `lottery_gateway` | `registry::LotteryRegistry` (resource) | 1. Реализовать `registry::LotteryRegistry`, который копирует владельцев, адреса, цены билетов, доли джекпота и статусы/причины отмен из `instances` и `cancellations`.<br>2. Выполнить `migrate_lottery_registry`, используя entry-функции `record_existing_cancellation`/`record_existing_cancellations` (структура `LegacyCancellationImport`) для конвертации причин отмен и выравнивания ordered-списка лотерей.<br>3. Запустить интеграционный тест сценария создания/отмены и сверку view-функций `registry_snapshot`/`lottery_entry`. | В работе | Модуль `lottery_gateway::registry` опубликован, фасад `gateway` синхронизирует записи при создании, импорте, смене владельца и отмене лотерей; требуется миграция данных из legacy и dry-run сверка снапшотов. |
| `lottery_registry` | `Registry` | Список лотерей, причины отмен и история. | `lottery_gateway` | `gateway::GatewayRegistry` (resource) | 1. Развернуть `lottery_gateway::gateway` с генерацией идентификаторов и индексом владельцев.<br>2. Реализовать миграцию `migrate_lottery_registry`, которая переносит владельцев и статусы в `GatewayRegistry` и выравнивает события.<br>3. Подготовить view/скрипты для проверки состава лотерей по владельцам после миграции. | В работе | Пакет `lottery_gateway` создан, события фасада синхронизированы с `lottery_data`, добавлены view-функции списка лотерей/владельцев и snapshot, а также entry `register_existing_lottery`/`register_existing_lotteries` и `align_next_lottery_id` для импорта легаси-ID перед запуском миграционного скрипта. |
| `lottery_registry` | `CancellationRecord` | Причины отмен, суммы продаж и снапшот статуса. | `lottery_data` | `cancellations::CancellationLedger` (resource) | 1. Развернуть `lottery_data::cancellations` и поток `lottery_engine::cancellation`.<br>2. Подготовить payload'ы `LegacyCancellationRecord` (devnet/testnet архивы, dry-run отчёты или ручные константы) и вызвать `import_existing_cancellation`/`import_existing_cancellations`, чтобы батчево перенести исторические записи и события.<br>3. Зафиксировать dry-run отмены и сверку сумм продаж/джекпота в чек-листе и сценариях фасада (`lottery_gateway::cancel_lottery`). | В работе | Ledger и события отмен развёрнуты; новые import-entry позволяют переносить историю без повторного вызова `lottery_engine::cancellation`. |
| `automation` | `AutomationRegistry` | Таблица ботов и event handles dry-run/ошибок. | `lottery_data` | `automation::AutomationRegistry` (resource) | 1. Развернуть `lottery_data::automation` и сконфигурировать события.<br>2. Выполнить `migrate_automation_registry` через `import_existing_bot(s)` (структура `LegacyAutomationBot`).<br>3. Перепривязать ботов в dev-утилитах и сверить pending-статусы. | В работе | В `lottery_data::automation` опубликованы `LegacyAutomationBot` и admin-entry для импорта ботов, `lottery_engine::automation` обрабатывает cron/события; требуется dry-run миграции и проверка cron. |
| `automation` | `AutomationCap` | Capability с расписанием cron. | `lottery_data` | `automation::AutomationCap` (resource) | 1. Перенести capability через `claim_automation_cap`.<br>2. Обновить авторизацию cron-задач. | В работе | Capability хранится в `lottery_data::automation`, новые entry-функции управления ботами реализованы в `lottery_engine::automation`. |
| `draw` | `DrawLedger` | Состояние VRF-запросов и соответствие nonce ↔ lottery. | `lottery_engine` | `draw` (модули запросов и обработки результатов) | 1. Реализовать `lottery_engine::draw` с планированием розыгрыша, запросом VRF и фиксацией победителя.<br>2. Подготовить скрипт `migrate_draw_ledger` для переноса pending-запросов и истории.<br>3. Сравнить события VRF с `lottery_vrf_gateway::hub::HubState` и обновлённым чек-листом. | В работе | Модуль `draw` опубликован, требуется миграция данных и интеграционные тесты VRF. |
| `feature_switch` | `FeatureSwitchRegistry` | Переключатели функционала, включая devnet-флаги. | `lottery_utils` | `feature_flags::FeatureRegistry` (resource) | 1. Создать модуль `lottery_utils::feature_flags`.<br>2. Выполнить `migrate_feature_flags`.<br>3. Обновить фронтовые проверки через CLI. | В работе | Модуль `lottery_utils::feature_flags` опубликован, реализованы события и режимы; остаётся миграция данных и обновление CLI. |
| `history` | `ArchiveLedger` | Архивированные резюме лотерей и события dual-write. | `lottery_utils` | `history::ArchiveLedger` (resource) | 1. Добавить модуль `lottery_utils::history`.<br>2. Выполнить `migrate_archive_ledger`.<br>3. Сохранить event handles для аудита. | Запланировано | Совместный контроль с `lottery_support::LegacyArchive`. |
| `history` | `DualWriteControl` | Настройки двойной записи и контроль хэшей. | `lottery_utils` | `history::DualWriteControl` (resource) | 1. Перенести конфиг через `migrate_dual_write_control`.<br>2. Проверить ожидаемые хэши на тестнете. | Запланировано | Должно выполняться до запуска нового dual-write. |
| `history` | `MirrorConfig` | Флаг зеркалирования архивов. | — | — | 1. Подтвердить, что новая архитектура не требует зеркала.<br>2. Документировать вывод ресурса.<br>3. Удалить модуль после успешной миграции. | Не требуется | Проверить отсутствие ссылок в скриптах поддержки. |
| `history` | `Registry` | История лотерей и отмен. | `lottery_gateway` | `history::LotteryHistory` (resource) | 1. Реализовать модуль `lottery_gateway::history`.<br>2. Выполнить `migrate_lottery_history`.<br>3. Сверить количество записей с `ArchiveLedger`. | Запланировано | Требует готовности новых view-функций. |
| `payouts` | `PayoutLedger` | Состояние выплат и событий победителей/возвратов. | `lottery_data` / `lottery_engine` / `lottery_rewards_engine` | `payouts::PayoutLedger` (resource) + `lottery_engine::payouts` (статусы) + `lottery_rewards_engine::payouts` (выплаты) | 1. Реализовать хранение `lottery_data::payouts`, административные entry `lottery_engine::payouts` и сервисные выплаты `lottery_rewards_engine::payouts`.<br>2. Для миграции использовать payload `LegacyPayoutRecord` и admin-entry `import_existing_payout`/`import_existing_payouts`, которые восстанавливают счётчики pending/paid/refunded и переэмитят события без повторных выплат.<br>3. Подготовить скрипт `migrate_payout_ledger`, сверить остатки невыплаченных сумм и события `WinnerRecorded`/`PayoutStatusUpdated`, а также `JackpotPaidEvent`/`Operations*` из мульти-трежери. | В работе | Хранилище, статусы, выдача джекпотов/операционных движений и import-entry реализованы; требуется миграция данных и dry-run сверка с мульти-трежери. |
| `price_feed` | `PriceFeedRegistry` | Курсы активов и события обновлений. | `lottery_utils` | `price_feed::PriceFeedRegistry` (resource) | 1. Реализовать модуль `lottery_utils::price_feed`.<br>2. Выполнить `migrate_price_feeds`.<br>3. Настроить тесты на актуальность данных. | В работе | Новый модуль управляет регистрацией курсов, fallback и clamp событиями; требуется миграция существующих записей и тестовые сценарии. |
| `roles` | `RoleStore` | Роли партнёров, премиум доступ и события. | `lottery_data` | `access::RoleStore` (resource) | 1. Обновить модуль `lottery_data::access` для поддержки партнёрских ролей.<br>2. Выполнить `migrate_role_store`.<br>3. Проверить индекс партнёров. | Запланировано | Делится логикой с `LotteryOperators`. |
| `sales` | `SalesLedger` | Учёт продаж, лимитов и распределения. | `lottery_engine` | `sales::SalesLedger` (resource) | 1. Реализовать модуль `lottery_engine::sales` поверх `lottery_data` с поддержкой батчевых покупок и авто-планирования розыгрыша (готово).<br>2. Подготовить миграцию `SalesLedger` (конвертация счётчиков продаж, билетов и истории платежей).<br>3. Сверить суммы с трежери и `LotteryData`. | В работе | Модуль обрабатывает батчевые покупки и вызывает `lottery_rewards_engine::treasury::record_sale_allocation`; далее — миграция состояния и сверка распределений. |
| `vrf_deposit` | `VrfDepositLedger` | Баланс депозита VRF, статусы и события. | `lottery_data` / `lottery_engine` | `vrf_deposit::VrfDepositLedger` (resource) + `lottery_engine::vrf` (логика) | 1. Реализовать хранение `lottery_data::vrf_deposit` и логику `lottery_engine::vrf`.<br>2. Использовать payload `LegacyVrfDepositLedger` и admin-entry `lottery_data::vrf_deposit::import_existing_ledger`, чтобы восстановить конфигурацию, баланс и флаги паузы без обращения к legacy-пакетам (допускаются devnet/testnet архивы, dry-run отчёты или ручные константы).<br>3. Подтвердить балансы и паузы через CLI и dry-run цепочку `schedule → request → fulfill` с `lottery_vrf_gateway::hub::HubState`. | В работе | Ledger и события развернуты, добавлен payload для импорта состояния; требуется миграционный скрипт и сверка с VRF-хабом. |

### 3.3. `lottery_rewards`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `rewards_autopurchase` | `AutopurchaseState` | Планы автопокупки по лотереям, события депозитов и возвратов. | `lottery_rewards_engine` | `autopurchase::AutopurchaseState` (resource) | 1. Развернуть пакет `lottery_rewards_engine` с модулем `autopurchase`.<br>2. Сконвертировать легаси-записи в `LegacyAutopurchasePlan` и вызвать `autopurchase::import_existing_plan`/`import_existing_plans` для восстановления балансов без повторных депозитов.<br>3. Согласовать конфиги с новым `lottery_engine::ticketing` и проверить `execute`/`refund`. | В работе | Модуль `lottery_rewards_engine::autopurchase` развернут, события и снапшоты публикуются; импортные entry доступны для миграционных скриптов. |
| `rewards_autopurchase` | `AutopurchaseAccess` | Capability для раундов и трежери. | `lottery_rewards_engine` | `autopurchase::AutopurchaseAccess` (resource) | 1. Перенести capability через `claim_autopurchase_caps`.<br>2. Обновить вызовы расписаний. | В работе | Ресурс `AutopurchaseAccess` создаётся через `init_access`, капы извлекаются из `lottery_data::rounds` и `treasury`; требуется dry-run миграции capability. |
| `rewards_jackpot` | `JackpotState` | Состояние джекпота, билеты и события VRF. | `lottery_data` | `jackpot::JackpotRegistry` (resource) + логика `lottery_rewards_engine::jackpot` | 1. Развернуть `lottery_data::jackpot` с регистрами и событиями.<br>2. Перенести состояния через `migrate_jackpot_state`, используя payload `LegacyJackpotRuntime` и admin-entry `import_existing_jackpot`/`import_existing_jackpots`, и зафиксировать снапшоты.<br>3. Запустить dry-run `lottery_rewards_engine::jackpot::request_randomness/fulfill_draw` и сверить события с легаси. | В работе | Модуль хранения, import-entry и логика VRF-джекпотов реализованы; требуется миграционный скрипт и dry-run с мульти-трежери. |
| `rewards_jackpot` | `JackpotAccess` | Capability к мульти-трежери. | `lottery_rewards_engine` | `jackpot::JackpotAccess` (resource) | 1. Перенести cap через `claim_jackpot_cap`.<br>2. Обновить payout-скрипты. | Запланировано | Делается после `TreasuryMultiControl`. |
| `rewards_nft` | `BadgeAuthority` | Управление NFT-наградами и снапшотами. | `lottery_rewards_engine` | `nft::BadgeAuthority` (resource) | 1. Создать модуль `lottery_rewards_engine::nft`.<br>2. Выполнить `migrate_badge_authority`.<br>3. Проверить события mint/burn. | Запланировано | Требует обновления фронтенда наград. |
| `rewards_referrals` | `ReferralState` | Конфиги и статистика реферальной программы. | `lottery_rewards_engine` | `referrals::ReferralState` (resource) | 1. Реализовать модуль `lottery_rewards_engine::referrals` и связанный сервис `rounds_sync`.<br>2. Сформировать payloadы `LegacyReferralLottery`/`LegacyReferralRegistration` (допускаются devnet/testnet архивы, dry-run отчёты или ручные константы) и вызвать admin-entry `import_existing_lottery`/`import_existing_lotteries` вместе с `import_existing_registration`/`import_existing_registrations` для восстановления конфигов, статистики и регистраций без повторных списаний.<br>3. Проверить таблицы `referrers` и `stats`, а также снапшоты после импорта. | В работе | Модуль `lottery_rewards_engine::referrals` реализован, импортные entry опубликованы, события и снапшоты доступны; требуется миграционный скрипт и dry-run сверка с легаси. |
| `rewards_referrals` | `ReferralsControl` | Capability на пул рефералов. | `lottery_rewards_engine` | `referrals::ReferralsControl` (resource) | 1. Перенести cap через `claim_referrals_cap`.<br>2. Обновить вызовы выплат. | В работе | Capability извлекается через `init_access`, платежи проводят `referrals::record_reward` и `rounds_sync::sync_purchases_from_rounds`. |
| `rewards_store` | `StoreState` | Магазин призов, события покупок и конфигов. | `lottery_rewards_engine` | `store::StoreState` (resource) | 1. Модуль `lottery_rewards_engine::store` развёрнут, фиксирует товары, остатки и события покупок.<br>2. Сформировать payloadы `LegacyStoreItem` и вызвать admin-entry `import_existing_item`/`import_existing_items` для переноса каталога, остатков и счётчиков продаж без повторных оплат.<br>3. Сверить события `ItemConfigured`/`ItemPurchased` на тестнете. | В работе | Требуется миграция данных и dry-run фасада с покупкой. |
| `rewards_store` | `StoreAccess` | Capability на магазин. | `lottery_rewards_engine` | `store::StoreAccess` (resource) | 1. Вызвать `store::ensure_caps_initialized` для переноса капов из мульти-трежери.<br>2. Описать миграцию `claim_store_cap`/`release_caps` в чек-листе. | В работе | Зависит от `TreasuryMultiControl`; capability ожидает фактического переноса. |
| `rewards_vip` | `VipState` | VIP-подписки, события бонусов и отмен. | `lottery_rewards_engine` | `vip::VipState` (resource) | 1. Создать модуль `lottery_rewards_engine::vip`.<br>2. Сформировать payloadы `LegacyVipLottery` (допускаются devnet/testnet архивы, dry-run снапшоты или ручные константы) и вызвать admin-entry `import_existing_lottery`/`import_existing_lotteries` для восстановления конфигов, подписчиков и статистики без повторных платежей.<br>3. Проверить индексы лотерей и подписчиков в интеграционных тестах фасада. | В работе | Модуль `vip` реализован, импортные entry позволяют переносить данные; требуется миграционный скрипт и dry-run на testnet. |
| `rewards_vip` | `VipAccess` | Capability на VIP-пул. | `lottery_rewards_engine` | `vip::VipAccess` (resource) | 1. Перенести cap через `claim_vip_cap`.<br>2. Обновить сценарии подписки, чтобы использовать новый `VipAccess` и подтверждать возврат capability при миграции. | В работе | Публикуется ресурс `VipAccess`, реализованы функции `ensure_caps_initialized`/`release_caps`. Ожидает миграции фактического cap. |

### 3.4. `lottery_support`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `support_history` | `HistoryCollection` | История розыгрышей и снапшоты. | `lottery_utils` | `history::HistoryCollection` (resource) | 1. Развернуть `lottery_utils::history` (`init`, события, снапшоты).<br>2. Подготовить `migrate_history_collection` для переноса записей и сверки счётчиков, используя `LegacyHistoryRecord` и entry-функции `import_existing_history_record`/`import_existing_history_batch`.<br>3. Настроить `sync_draws_from_rounds` и dry-run очистки/обновления истории. | В работе | Модуль истории реализован, события и снапшоты публикуются; добавлены импорт-helpers для legacy, требуется миграционный скрипт и сравнение с legacy. |
| `support_history` | `HistoryWarden` | Capability записи истории. | `lottery_utils` | `history::HistoryWarden` (resource) | 1. Перенести `HistoryWriterCap` через `rounds::extract_history_cap` и `history::init_caps`.<br>2. Подтвердить работу `sync_draws_from_rounds` и возврат capability при откате. | В работе | Ресурс `HistoryWarden` публикуется, история синхронизируется через очередь `rounds::PendingHistoryQueue`; требуется dry-run переноса cap. |
| `history_bridge` | `LegacyArchive` | Архив легаси-снапшотов. | `lottery_utils` | `history::LegacyArchive` (resource) | 1. Добавить поддержку legacy в новом модуле.<br>2. Выполнить `migrate_legacy_archive`.<br>3. Зафиксировать контрольные суммы. | Запланировано | Используется для аудита после миграции. |
| `support_metadata` | `MetadataRegistry` | Метаданные лотерей. | `lottery_utils` | `metadata::MetadataRegistry` (resource) | 1. Развернуть `lottery_utils::metadata` с событиями `LotteryMetadataUpsertedEvent`/`MetadataSnapshotUpdatedEvent` и рекурсивными обходами вместо циклов.<br>2. Подготовить скрипт `migrate_metadata_registry`, используя `LegacyMetadataImport` и entry-функции `import_existing_metadata`/`import_existing_metadata_batch` для переноса записей и индексов владельцев.<br>3. Сверить снапшоты и выдачу через фасад/фронтенд после миграции. | В работе | Модуль `lottery_utils::metadata` опубликован, добавлены admin-entry для импорта исторических записей; требуется миграционный скрипт и dry-run сверка снапшотов. |
| `support_migration` | `MigrationLedger` | Снимки прогресса миграции. | `lottery_utils` | `migration::MigrationLedger` (resource) | 1. Реализовать `lottery_utils::migration::record_snapshot` и события.<br>2. Подготовить скрипт `migrate_migration_ledger`.<br>3. Перенести снапшоты и сверить лотереи. | В работе | Модуль `lottery_utils::migration` публикует `MigrationLedger` и события; требуется миграционный скрипт и dry-run сверка записей. |
| `support_migration` | `MigrationSession` | Capability миграции (инстансы, legacy-трежери). | `lottery_utils` | `migration::MigrationSession` (resource) | 1. Перенести capability через `claim_migration_caps`.<br>2. Обновить скрипты управления миграцией с учётом `instances::extract_export_cap` и `treasury::extract_legacy_cap`. | В работе | Сессия и функции извлечения/возврата capability реализованы (`lottery_data::instances`, `lottery_data::treasury`); остались скрипты миграции. |

### 3.5. `lottery_factory`, `lottery_gateway`, `lottery_vrf_gateway`

| Старый пакет / модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `lottery_factory::registry` | `FactoryState` | Администратор фабрики, таблица лотерей и события (повтор записи). | `lottery_factory` | `registry::FactoryRegistry` (resource) | 1. Совместить перенос с таблицей из `lottery_multi::factory` (см. раздел 3.2).<br>2. Выполнить миграцию единым скриптом `migrate_factory_registry`.<br>3. Провести smoke-тесты создания лотерей. | Запланировано | Старый и новый модули объединяются в один ресурс. |
| `lottery_gateway::registry` | `Registry` | Простая заглушка реестра для прототипа. | `lottery_gateway` | `registry::LotteryRegistry` (resource) | 1. Реализовать полноценный ресурс с таблицей записей, snapshot-событиями и view-функциями.<br>2. Подключить `gateway::gateway` ко всем операциям (создание, импорт, смена владельца, пауза/отмена).<br>3. Использовать новый ресурс как целевой при миграции `lottery_multi::lottery_registry`. | В работе | Новый модуль создан, снапшоты `LotteryRegistrySnapshotUpdatedEvent` публикуются, фасад обновляет записи и причины отмен; следующими шагами остаётся миграция legacy-данных и dry-run проверки. |
| `lottery_vrf_gateway::hub` | `HubState` | Регистрация лотерей в VRF, pending-запросы и события. | `lottery_vrf_gateway` | `hub::HubState` (resource) | 1. Обновить схему без изменения адреса.<br>2. Выполнить `migrate_lottery_vrf_gateway_state` (конвертация таблиц к новому формату).<br>3. Сверить pending-запросы с `lottery_engine::draw::DrawLedger`. | Запланировано | Ресурс остаётся в том же пакете, требуется только обновление схемы. |

## 4. Следующие шаги
1. Подготовить миграцию `SalesLedger`: скрипты конвертации счётчиков и сверку распределений с трежери после внедрения батчевых покупок.
2. Сформировать план миграции `PayoutLedger`: выгрузка победителей из `lottery_multi::payouts`, упаковка данных в payload `LegacyPayoutRecord`, вызов admin-entry `import_existing_payout`/`import_existing_payouts` и dry-run проверки `lottery_rewards_engine::payouts::pay_jackpot_winner` с событиями `WinnerRecorded`/`PayoutStatusUpdated` и `JackpotPaidEvent` на testnet.
3. Подготовить сценарии миграции VRF-запросов и депозита: перенос `DrawLedger`, `VrfDepositLedger`, сверка pending-запросов и dry-run цепочек `schedule → request → fulfill` на тестнете с проверкой пауз.
4. Подготовить миграцию `HistoryCollection` и `HistoryWarden`: выгрузить архивы и события из `support_history`, перенести их в `lottery_utils::history` через `LegacyHistoryRecord` и entry-функции импорта, протестировать `sync_draws_from_rounds` и dry-run очистки `clear_history`/`record_draw_from_rounds`.
5. Подготовить миграцию `AutomationRegistry` и `AutomationCap`: выгрузить зарегистрированных ботов, собрать payloadы `LegacyAutomationBot`, вызвать `import_existing_bot`/`import_existing_bots`, перенести pending-статусы и подтвердить расписания cron и dry-run сценарии на testnet.
6. Подготовить миграцию `AutopurchaseState`: выгрузить активные планы из `rewards_autopurchase`, сформировать payloadы `LegacyAutopurchasePlan`, вызвать `lottery_rewards_engine::autopurchase::import_existing_plan`/`import_existing_plans`, затем сверить снапшоты, события конфигурации и провести dry-run `execute`/`refund` на testnet.
7. Подготовить миграцию `StoreState`: выгрузить товары и остатки из `rewards_store`, конвертировать их в payloadы `LegacyStoreItem`, вызвать `lottery_rewards_engine::store::import_existing_item(s)`, протестировать `purchase`/`set_availability` и сверить события с легаси.
8. Подготовить миграцию `VipState`: выгрузить конфиги, участников и expiry из `rewards_vip`, собрать payloadы `LegacyVipLottery`, вызвать `lottery_rewards_engine::vip::import_existing_lottery(ies)` и сверить снапшоты, выручку и бонусные билеты.
9. Подготовить миграцию `LotteryRegistry`: выгрузить список лотерей и владельцев из `lottery_multi::lottery_registry`, перенести данные в `lottery_gateway::GatewayRegistry` и `registry::LotteryRegistry`, сверить индексы владельцев, статусы активности и причины отмен по снапшотам `registry_snapshot`.
10. Согласовать формат JSON-отчёта из `export_move_inventory.py` для автоматизированной проверки заполнения таблицы (задача на следующую итерацию).
11. Подготовить сценарии переноса capability (`InstanceControl`, `RoundControl`, `TreasuryV1Control`, `TreasuryMultiControl`, `AutopurchaseAccess`) и задокументировать последовательность транзакций.
12. Согласовать миграцию владельцев и операторов: подготовить batched-скрипт, который формирует payloadы `LegacyOperatorRecord`, вызывает `lottery_data::operators::import_existing_operator_record(s)` для восстановления on-chain состояния и при необходимости повторно прогоняет `lottery_engine::operators::grant_operator` для актуальных изменений; зафиксировать контрольные точки в чек-листе.
13. Подготовить перенос записей отмен: выгрузить данные `CancellationRecord` из `lottery_multi::lottery_registry`, сверить суммы продаж и джекпотов, протестировать admin cancel в `lottery_gateway` на testnet.
14. Сформировать сценарий миграции мульти-трежери: выгрузить текущие доли BPS, перенести их в `lottery_rewards_engine::treasury::configure_lottery_shares`, сверить накопленные балансы `treasury_multi::TreasuryState` с данными legacy и протестировать распределение на testnet.
15. Подготовить миграцию `VipState`: выгрузить активные подписки и expiry из `rewards_vip`, перенести их в `lottery_rewards_engine::vip`, восстановить суммы выручки и подтвердить события `VipSubscribed`/`VipCancelled` в интеграционных сценариях фасада.
16. Подготовить миграцию `MetadataRegistry`: выгрузить записи из `support_metadata`, перенести их в `lottery_utils::metadata`, сверить снапшоты `MetadataSnapshotUpdatedEvent` и выдачу данных через фасад/фронтенд.
17. Подготовить миграцию `ReferralState`: выгрузить конфиги, статистику и регистрацию игроков из `rewards_referrals`, сформировать payloadы `LegacyReferralLottery`/`LegacyReferralRegistration` (допускаются devnet/testnet архивы, dry-run отчёты или ручные константы), вызвать admin-entry `import_existing_lottery(ies)` и `import_existing_registration(s)` и сверить снапшоты `ReferralSnapshotUpdatedEvent`.

## 5. Журнал изменений

| Дата (UTC) | Изменение | Автор |
| --- | --- | --- |
| 2025-11-15 | Развёрнут каркас `lottery_data` (lottery_state, instances, rounds, operators, treasury, treasury_multi) и обновлены статусы миграции ядра. | Supra refactoring bot |
| 2025-11-16 | Сформирована базовая карта миграции с перечислением 35 ресурсов и действиями по переносу. | Supra refactoring bot |
| 2025-11-17 | Переведён `SalesLedger` в статус `В работе`: добавлен модуль `lottery_engine::sales`, обновлены сводка статусов и следующий шаг по поддержке батчей. | Supra refactoring bot |
| 2025-11-18 | Переведён `DrawLedger` в статус `В работе`: добавлен модуль `lottery_engine::draw` с запросом VRF и событиями завершения, обновлены сводка статусов и план миграции VRF. | Supra refactoring bot |
| 2025-11-19 | Добавлен модуль `lottery_engine::vrf_config`, обновлены события `lottery_data::lottery_state` и описание миграции VRF-параметров. | Supra refactoring bot |
| 2025-11-20 | Расширен `lottery_engine::sales` батчевыми покупками и обновлены шаги миграции `SalesLedger` и раздел «Следующие шаги». | Supra refactoring bot |
| 2025-11-21 | Развёрнуты `lottery_data::vrf_deposit` и `lottery_engine::vrf`, обновлён контроль паузы запросов и статусы миграции VRF-депозита. | Supra refactoring bot |
| 2025-11-22 | Добавлены события владельцев `lottery_data::instances`, реализован `lottery_engine::operators`, обновлены шаги миграции ролей. | Supra refactoring bot |
| 2025-11-23 | Реализован модуль `lottery_engine::lifecycle` и функции `instances::set_active`; обновлены сводка статусов и описание миграции `LotteryCollection`. | Supra refactoring bot |
| 2025-11-24 | Добавлены `lottery_data::payouts` и `lottery_engine::payouts`, обновлены статусы миграции `PayoutLedger` и план действий по переносу выплат. | Supra refactoring bot |
| 2025-11-25 | Реализованы `lottery_data::cancellations` и `lottery_engine::cancellation`, добавлен сценарий миграции записей отмен и обновлена сводка статусов. | Supra refactoring bot |
| 2025-11-26 | Модули `lottery_engine`/`lottery_data` обновлены на рекурсивные хелперы без циклов, чтобы соблюсти синтаксис Move v1 и устранить риски при миграции `SalesLedger`, `DrawLedger` и `PayoutLedger`. | Supra refactoring bot |
| 2025-11-27 | Добавлены `lottery_data::automation` и `lottery_engine::automation`, что позволяет переносить реестр ботов и capability cron с событиями dry-run/тикета; обновлены статусы миграции и чек-лист. | Supra refactoring bot |
| 2025-11-28 | Создан пакет `lottery_gateway` с фасадом `gateway`, зафиксирован переход `lottery_multi::lottery_registry` в статус `В работе` и расширены шаги миграции `Registry`/`CancellationRecord`. | Supra refactoring bot |
| 2025-11-29 | Добавлен пакет `lottery_rewards_engine` с модулем `treasury`, обновлён `lottery_engine::sales` и уточнена миграция `TreasuryState`/`SalesLedger` для распределения BPS. | Supra refactoring bot |
| 2025-11-30 | Реализованы `lottery_data::jackpot` и `lottery_rewards_engine::jackpot`, обновлены статусы миграции VRF-джекпота и действия по dry-run запросов/fulfill с мульти-трежери. | Supra refactoring bot |
| 2025-12-01 | Добавлены функции автопокупок: `lottery_rewards_engine::autopurchase`, обновлены `lottery_engine::sales`, `lottery_data::treasury` и `lottery_data::rounds` для работы с cap и предоплаченными продажами; статусы миграции `AutopurchaseState` и capability переведены в `В работе`. | Supra refactoring bot |
| 2025-12-03 | Реализован модуль `lottery_rewards_engine::vip` с управлением подписками и событиями, обновлены статусы миграции `VipState`/`VipAccess` и добавлен шаг подготовки переноса подписок. | Supra refactoring bot |
| 2025-12-04 | Добавлен модуль `lottery_rewards_engine::store`, обновлены статусы миграции магазина и capability, расширены «Следующие шаги» и чек-лист транзакций. | Supra refactoring bot |
| 2025-12-15 | `lottery_rewards_engine::vip` расширен payloadом `LegacyVipLottery`, обновлены шаги миграции `VipState` и таблица соответствий, чтобы скрипты могли импортировать конфиги и подписки без повторных оплат. | Supra refactoring bot |
| 2025-12-16 | `lottery_rewards_engine::referrals` получил payloadы `LegacyReferralLottery`/`LegacyReferralRegistration`, обновлены действия миграции `ReferralState`, добавлен шаг в чек-лист и журнал прогресса. | Supra refactoring bot |
| 2025-12-17 | `lottery_rewards_engine::jackpot` расширен payloadом `LegacyJackpotRuntime` и admin-entry `import_existing_jackpot(s)`, `lottery_data::jackpot` получил helper восстановления состояния; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-18 | `lottery_data::payouts` получил структуру `LegacyPayoutRecord` и admin-entry `import_existing_payout(s)` для восстановления победителей, статусов и событий без повторных выплат; обновлены действия миграции `PayoutLedger`, раздел «Следующие шаги» и инвентаризация структур. | Supra refactoring bot |
| 2025-12-19 | `lottery_data::instances` получил payload `LegacyInstanceRecord` и admin-entry `import_existing_instance(s)`, которые восстанавливают владельцев, активность и счётчики проданных билетов с переэмитом снапшотов; обновлены карта миграции, детальный план и инвентаризация структур. | Supra refactoring bot |
| 2025-12-20 | `lottery_data::operators` получил payload `LegacyOperatorRecord` и admin-entry `import_existing_operator_record(s)` для восстановления владельцев и операторов без обращения к легаси-пакетам; обновлены карта миграции, детальный план и инвентаризация структур. | Supra refactoring bot |
| 2025-12-21 | `lottery_data::treasury_multi` получил payload'ы `LegacyMultiTreasuryState`/`LegacyMultiTreasuryLottery` и admin-entry для импорта глобальных получателей, долей BPS и локальных балансов; обновлены карта миграции, детальный план и структурный инвентарь. | Supra refactoring bot |
| 2025-12-22 | `lottery_data::treasury` получил структуры `LegacyVaultConfig`/`LegacyVaultRecipients`, payload `LegacyVaultState` и admin-entry `import_existing_vaults`, что позволяет переносить конфигурацию и получателей без повторных переводов; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-23 | `lottery_data::rounds` получил payload `LegacyRoundRecord` и admin-entry `import_existing_round(s)` плюс функции `import_pending_history_records`/`import_pending_purchase_records`, что позволяет восстанавливать раунды и очереди без запуска legacy-процессов; обновлены карта миграции и структурный отчёт. | Supra refactoring bot |
| 2025-12-24 | `lottery_data::lottery_state` получил payload `LegacyLotteryRuntime` и admin-entry `import_existing_lottery(ies)`, что позволяет разворачивать тикеты, VRF-конфигурацию и whitelists без повторных продаж и переэмитить события `LotterySnapshotUpdatedEvent`/`Vrf*Updated`; обновлены карта миграции, план и структурный отчёт. | Supra refactoring bot |
| 2025-12-25 | `lottery_data::cancellations` получил payload `LegacyCancellationRecord` и admin-entry `import_existing_cancellation(s)`, поэтому исторические причины отмен и суммы продаж можно переносить из devnet/testnet архивов, dry-run отчётов или ручных констант без повторного вызова `lottery_engine::cancellation`; обновлены карта миграции, план, чек-лист и структурный отчёт. | Supra refactoring bot |
| 2025-12-26 | `lottery_data::vrf_deposit` получил payload `LegacyVrfDepositLedger` и admin-entry `import_existing_ledger`, что позволяет переносить конфигурацию, баланс и флаги паузы из devnet/testnet архивов, dry-run отчётов или ручных констант без доступа к legacy-пакетам; обновлены карта миграции, план, чек-лист и структурный отчёт. | Supra refactoring bot |
| 2025-12-05 | Реализован `lottery_utils::history` с синхронизацией очереди `rounds::PendingHistoryQueue`; статусы `HistoryCollection` и `HistoryWarden` переведены в `В работе`, обновлены «Следующие шаги» и требования по dry-run миграции истории. | Supra refactoring bot |
| 2025-12-06 | Добавлен `lottery_utils::metadata`, обновлены статусы миграции `MetadataRegistry`, расширена сводка и список следующих шагов. | Supra refactoring bot |
| 2025-12-07 | Реализован `lottery_utils::migration`, обновлены статусы `MigrationLedger` и `MigrationSession`, добавлены функции извлечения capability и обновлён чек-лист. | Supra refactoring bot |
| 2025-12-08 | Фасад `lottery_gateway::gateway` получил view-функции для snapshot, списка лотерей и индекса владельцев, что подготавливает миграцию `lottery_multi::lottery_registry`. | Supra refactoring bot |
| 2025-12-09 | Добавлен модуль `lottery_gateway::registry`, включающий снапшоты `LotteryRegistrySnapshotUpdatedEvent` и синхронизацию с фасадом при создании/импорте/отмене лотерей; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-10 | `lottery_utils::metadata` получил структуру `LegacyMetadataImport` и batch-entry для импорта исторических записей, обновлена карта миграции и план. | Supra refactoring bot |
| 2025-12-11 | `lottery_utils::history` расширен структурой `LegacyHistoryRecord` и admin-entry для импорта архивных розыгрышей; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-13 | `lottery_rewards_engine::autopurchase` получил структуру `LegacyAutopurchasePlan` и admin-entry для импорта планов, обновлены шаги миграции и сводка статусов. | Supra refactoring bot |
| 2025-12-14 | `lottery_rewards_engine::store` расширен структурой `LegacyStoreItem` и admin-entry `import_existing_item(s)` для переноса каталога, остатков и счётчиков продаж; обновлены шаги миграции магазина и раздел «Следующие шаги». | Supra refactoring bot |
