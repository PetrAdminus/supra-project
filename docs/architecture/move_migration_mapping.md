# Карта миграции on-chain структур SupraLottery

> Последнее обновление: 2026-04-15 (UTC)

Документ фиксирует сопоставление текущих on-chain ресурсов старой архитектуры SupraLottery и целевых сущностей новой модульной схемы (`lottery_data`, `lottery_engine`, `lottery_gateway`, `lottery_rewards_engine`, `lottery_utils`, `lottery_vrf_gateway`, `lottery_factory`). Таблица служит рабочим источником правды для подготовки миграционных транзакций и контроля статуса переноса. Пакет `lottery_gateway` продолжает текущий `lottery_hub`, а `lottery_vrf_gateway` строится на базе существующего `vrf_hub`; оба переименования будут выполнены после выравнивания интерфейсов.

## 1. Как пользоваться документом
- Каждая строка таблицы описывает ресурс, требующий миграции или явного вывода из эксплуатации.
- Колонка «Действия миграции» фиксирует обязательные шаги: транзакции, проверки инвариантов, зависимость от других переносов.
- Статус используется для отслеживания прогресса:
  - `Запланировано` — миграция пока не начата, действия описаны.
  - `В работе` — идёт разработка или тестирование миграционного скрипта.
  - `Готово` — миграция выполнена и подтверждена тестами.
  - `Не требуется` — ресурс выводится из эксплуатации без переноса.
- При изменении структуры ресурса или действий миграции обязательно обновляйте строку и журнал изменений в конце документа.
- Для быстрой валидации таблицы и сверки целевых пакетов с текущей Move-инвентаризацией используйте скрипт `docs/architecture/tools/check_migration_mapping.py`. Пример:
  - `python docs/architecture/tools/export_move_inventory.py --json-output /tmp/inventory.json`
  - `python docs/architecture/tools/check_migration_mapping.py --inventory-json /tmp/inventory.json --json-output /tmp/migration_status.json`
  Скрипт сформирует сводку статусов, подсветит незнакомые значения статуса, сверит численную сводку в разделе «Сводка статусов» с реальной таблицей и предупредит, если в таблице указаны пакеты, отсутствующие в текущей инвентаризации. Для строгой проверки без расхождений используйте флаг `--strict`.
- Чтобы автоматизировать оба шага, достаточно запустить `docs/architecture/tools/run_migration_checks.sh`. Скрипт сам создаст временные артефакты в `tmp/`, вызовет экспорт инвентаризации и строгую проверку карты миграции, а JSON-результаты можно прикреплять к dry-run отчётам или публикациям CI.
- Для быстрой проверки готовности on-chain стораджей и сервисных модулей перед миграционными транзакциями можно вызвать view `lottery_gateway::health::{storage_ready, queues_ready, treasury_ready, rewards_ready, autopurchase_ready, utils_ready, history_ready, gateway_ready, access_ready, cancellations_ready, automation_ready, vrf_ready, engine_ready, snapshot}` и убедиться, что все флаги возвращают `true`. Дополнительно `rewards_ready` теперь использует `lottery_data::payouts::ready`, который сверяет публикацию `PayoutLedger`, состав `lottery_ids`, таблицы `payout_index` и наличие записей в каждой очереди выплат, и `lottery_data::jackpot::ready`, который проверяет публикацию регистра джекпотов, совпадение списка `lottery_ids` с таблицей и консистентность pending-заявок VRF (payload и request_id), `queues_ready` опирается на `lottery_data::rounds::ready`, проверяя публикацию `RoundRegistry`, наличие капабилити, очередей истории/покупок и валидность pending-записей, `autopurchase_ready` опирается на `lottery_rewards_engine::autopurchase::ready`, который требует опубликованных очередей `rounds`, контролей `treasury` и их капабилити, `utils_ready` проверяет публикацию вспомогательных реестров (`lottery_utils::{feature_flags, metadata, migration}`) вместе с готовностью истории (`lottery_utils::history::ready` контролирует инициализацию и выдачу капабилити писателя истории), `gateway_ready` подтверждает инициализацию фасада и реестра лотерей (`lottery_gateway::{gateway, registry}`) с опубликованным `lottery_data::instances`, `access_ready` возвращает `true`, когда опубликован новый `lottery_data::access`, `cancellations_ready` использует `lottery_data::cancellations::ready` и позволяет убедиться, что ресурс отмен опубликован перед dry-run переносом, `automation_ready` использует `lottery_data::automation::caps_ready`, чтобы убедиться в наличии capability у всех зарегистрированных ботов, а `vrf_ready` включает проверку `lottery_vrf_gateway::hub::is_initialized` для dry-run валидации миграции VRF-хаба вместе с депозитом и сервисным модулем VRF.
- Скрипты `SupraLottery/supra/scripts/history_backfill.sh` и `SupraLottery/supra/scripts/dual_write_control.sh` перенаправлены на entry-функции `lottery_utils::history`. Теперь `history_backfill.sh import/classify/rollback/status/list` напрямую вызывают новые entry/view, а `dual_write_control.sh` управляет `history::DualWriteControl`. Команда `mirror` заменена подсказкой по использованию `history_backfill.sh import`, чтобы повторно зеркалировать сводку через `lottery_utils::history::import_legacy_summary`.
- Скрипт `SupraLottery/supra/scripts/automation_status.sh` переключён на view `lottery_engine::automation::{registry_snapshot, bot_status}`, а операционные документы (status page, monitoring, runbooks, release checklist) используют новые функции вместо `lottery_multi::views::list_automation_bots`/`get_automation_bot`, чтобы контролировать AutomationBot напрямую в новой архитектуре.

## 2. Сводка статусов

- **51** ресурс со статусом `Готово`.
- **0** ресурсов в статусе `В работе`.
- **0** ресурсов помечено как `Запланировано`.
- **1** ресурс отмечен как `Не требуется` (будет выведен после валидации отсутствия зависимостей).
- Статусы сверены скриптом `docs/architecture/tools/run_migration_checks.sh`; свежие отчёты от 2026-04-15 сохранены в `tmp/move_struct_inventory.json` и `tmp/migration_plan_status.json`.

## 3. Таблица соответствий

### 3.1. `lottery_core`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `core_main_v2` | `LotteryData` | Текущий статус лотереи: билеты, VRF-конфигурация, whitelists, gas-лимиты. | `lottery_data` | `lottery_state::LotteryState` (resource) | 1. Развернуть `lottery_data::lottery_state`.<br>2. Запустить админскую транзакцию `migrate_lottery_state` для каждой лотереи.<br>3. Сверить счётчики билетов с `lottery_multi::sales::SalesLedger` (через интеграционный скрипт).<br>4. Для восстановления исторических данных использовать payload `LegacyLotteryRuntime` и entry `import_existing_lottery`/`import_existing_lotteries`, чтобы развернуть тикеты, VRF и whitelists без повторных продаж и переэмитить события `LotterySnapshotUpdatedEvent`/`Vrf*Updated`.<br>5. Для dry-run аудита состояния пользоваться view `runtime_snapshot`/`state_snapshot`, проверяя тикеты, whitelist и pending VRF. | Готово | Импорт покрыт тестами `lottery_state_migration_tests`, скрипт `SupraLottery/supra/scripts/migrate_lottery_state.py` валидирует JSON-снимки, кодирует `vector<LegacyLotteryRuntime>` в BCS и при необходимости вызывает batch-entry для восстановления тикетов, VRF-параметров и whitelists. |
| `core_main_v2` | `LotteryData` (VRF-config функции) | Настройка gas-бюджета, whitelists и client seed VRF. | `lottery_engine` | `vrf_config` (модуль управления VRF) | 1. Перенести функции конфигурации в `lottery_engine::vrf_config`.<br>2. Во время миграции зафиксировать события `VrfGasBudgetUpdated`, `VrfWhitelistUpdated`, `VrfRequestConfigUpdated` в новом `lottery_data`.<br>3. Для восстановления легаси-параметров вызвать admin-entry `import_existing_vrf_config(s)`, которые валидируют gas-budget/whitelist/request_config/pending-slot и восстанавливают счётчики VRF без обращения к legacy.<br>4. Для dry-run аудита газовых лимитов, whitelist и pending-заявок использовать view `vrf_config_snapshot`/`vrf_config_snapshots` из `lottery_engine::vrf_config`.<br>5. Перед вызовом snapshot-функций использовать `vrf_config::is_initialized` для быстрой проверки публикации `instances` и `lottery_state`. | Готово | Добавлены payload `LegacyVrfConfigImport` и entry `import_existing_vrf_config(s)`, которые валидируют снапшот, пересчитывают max_fee и переэмитят события VRF; миграция конфигурации закрыта. |
| `core_instances` | `LotteryCollection` | Реестр инстансов: владельцы, цены, доли джекпота, event handles. | `lottery_data` | `instances::InstanceRegistry` (resource) | 1. Создать `lottery_data::instances` с новой схемой.<br>2. Выполнить `migrate_instance_registry` единым батчем.<br>3. Провести сверку `lottery_ids`, активных флагов и владельцев через CLI.<br>4. Для восстановления проданных билетов и накопленного джекпота использовать payload `LegacyInstanceRecord` и admin-entry `import_existing_instance`/`import_existing_instances`.<br>5. Для dry-run аудита использовать view `registry_snapshot`/`instance_snapshot`, сверяя admin/hub, список лотерей и значения полей записей.<br>6. Для проверки соответствия blueprint (владелец, цена билета, авто-дро) использовать view `ticketing::blueprint_snapshot(s)` перед выравниванием с sales/rounds и предварительно убедиться через `ticketing::is_initialized`, что storage готово.<br>7. Для сверки состояния паузы/расписания draw между storage и движком использовать `lifecycle::lifecycle_snapshot(s)` (active-флаги, scheduled draw, pending VRF), проверяя публикацию ресурсов через `lifecycle::is_initialized`. | Готово | Тесты `lottery_data::instances_migration_tests` покрывают батч- и одиночный импорт, `SupraLottery/supra/scripts/migrate_instances.py` валидирует JSON и кодирует `vector<LegacyInstanceRecord>` для вызова `lottery_data::instances::import_existing_instances`; реестр готов к переносу данных. |
| `core_instances` | `CoreControl` | Хранит capability экспорта инстансов. | `lottery_data` | `instances::InstanceControl` (resource) | 1. Вызвать `claim_instance_control_cap`, передав легаси-cap `core_instances::InstancesExportCap`, чтобы поглотить старый cap и записать новый `instances::InstancesExportCap` в `InstanceControl`.<br>2. Проверить `instances::caps_ready`, убеждаясь, что слот заполнен и доступен для `migration::ensure_caps_initialized`.<br>3. Подтвердить отсутствие «висячих» capability в старом модуле. | Готово | `InstanceControl` хранит cap в опциональном слоте; entry `claim_instance_control_cap` принимает легаси-cap, мятит новый и выставляет `caps_ready`, покрывая миграцию capability. |
| `core_rounds` | `RoundCollection` | Таблица раундов, event handles для покупок и VRF-запросов. | `lottery_data` | `rounds::RoundRegistry` (resource) | 1. Использовать payload `LegacyRoundRecord` и admin-entry `import_existing_round`/`import_existing_rounds`, чтобы разворачивать билеты, флаги расписания и pending-запросы с переэмитом `RoundSnapshotUpdatedEvent` (скрипт `SupraLottery/supra/scripts/migrate_rounds.py` кодирует `vector<LegacyRoundRecord>` и очереди, валидирует JSON и может вызвать entry через dockerized Supra CLI).<br>2. Перед миграцией очередей вызвать `import_pending_history_records` и `import_pending_purchase_records`, перезаписывая состояние `PendingHistoryQueue`/`PendingPurchaseQueue` и подтверждая длину через view `history_queue_length`/`purchase_queue_length` (скрипт формирует отдельные payload'ы).<br>3. Сверить идентификаторы раундов и состояния с `lottery_multi::draw::DrawLedger` и view `rounds::registry_snapshot`/`round_snapshot`, проверяя admin, список лотерей, билеты, draw-флаги и pending-запросы.<br>4. Перед dry-run убедиться, что `rounds::ready` возвращает `true`, подтверждая публикацию `RoundRegistry`, `RoundControl`, очередей истории/покупок, наличие капабилити и валидность pending-записей. | Готово | Move-тесты `rounds_migration_tests` покрывают импорт батчей, обновление существующих записей и перезапись очередей pending; скрипт `migrate_rounds.py` кодирует снапшоты в BCS, проверяет ASCII/адреса и умеет запускать импорт через dockerized Supra CLI. |
| `core_rounds` | `HistoryQueue` | Очередь незаписанных историй для внешнего экспорта. | `lottery_data` | `rounds::PendingHistoryQueue` (resource) | 1. На время миграции приостановить продюсеров истории.<br>2. Вызвать admin-entry `import_pending_history_records`, передав подготовленный список `PendingHistoryRecord` (devnet/testnet архивы, dry-run отчёты или ручные константы), чтобы заменить очередь без обращения к legacy-пакетам; функция валидирует соответствие pending-запросам VRF и индексам билетов в `RoundRegistry`.<br>3. Перезапустить записи истории уже из `lottery_engine` и использовать view `pending_history_snapshot` для dry-run сверки содержимого очереди; готовность контролируется через `rounds::ready`. | Готово | Импортная entry теперь проверяет наличие раундов, pending VRF-заявок и корректность индексов билетов перед замещением очереди; ready-view `rounds::ready` учитывает непротиворечивость pending-истории. |
| `core_rounds` | `PurchaseQueue` | Очередь незавершённых покупок билетов. | `lottery_data` | `rounds::PendingPurchaseQueue` (resource) | 1. Перед миграцией завершить или отменить активные покупки.<br>2. Вызвать admin-entry `import_pending_purchase_records`, чтобы записать подготовленный список `PendingPurchaseRecord` (devnet/testnet архивы, dry-run отчёты или ручные данные) в новую очередь; функция валидирует наличие раундов и ненулевые суммы/количество билетов.<br>3. Обновить обработчики в новом `lottery_engine::ticketing` и использовать view `pending_purchase_snapshot` для dry-run сверки перед переносом; готовность контролируется через `rounds::ready`. | Готово | Импортная entry теперь проверяет публикацию раундов и корректность pending-записей перед очисткой очереди; проверка готовности учитывает непротиворечивость очереди с реестром раундов. |
| `core_rounds` | `CoreControl` | Capabilities для записи истории и автопокупок. | `lottery_data` | `rounds::RoundControl` (resource) | 1. Вызвать `claim_round_control_caps`, передав легаси-cap `core_rounds::HistoryWriterCap` и `core_rounds::AutopurchaseRoundCap`, чтобы поглотить старые capability и замятить новые.<br>2. После заполнения слотов проверить view `caps_ready`/`control_snapshot`, убеждаясь, что оба cap на месте и администратор совпадает.<br>3. Зафиксировать отсутствие висячих cap в легаси перед удалением модулей. | Готово | `RoundControl` инициализирует пустые слоты, entry `claim_round_control_caps` принимает легаси-cap, заполняет слоты новыми capability и позволяет валидировать готовность через view. |
| `core_operators` | `LotteryOperators` | Таблица операторов, event handles выдачи/отзыва. | `lottery_data` | `operators::OperatorRegistry` (resource) | 1. Сформировать ресурс `OperatorRegistry` с индексом `lottery_ids` и событиями.<br>2. Использовать payload `LegacyOperatorRecord` и admin-entry `import_existing_operator_record(s)` для восстановления владельцев и списков операторов с переэмитом owner/grant/snapshot событий.<br>3. Проверить роли операторов в интеграционных тестах и выстроить вызовы через `lottery_engine::operators`/`lottery_gateway`.<br>4. Перед финальной валидацией сверять готовность реестра через view `ready`/`is_initialized` и per-lottery state через view `operator_snapshot` или полный `registry_snapshot` (`lottery_data` или alias `lottery_engine::operators`). | Готово | Импорт `LegacyOperatorRecord` покрыт Move-тестами `lottery_data::operators_migration_tests`, а скрипт `SupraLottery/supra/scripts/migrate_operator_registry.py` валидирует JSON-снимки, кодирует `vector<LegacyOperatorRecord>` в BCS и при необходимости вызывает `lottery_data::operators::import_existing_operator_records`; health/view-снимки подтверждают готовность фасада. |
| `core_treasury_v1` | `Vaults` | Конфигурация распределения средств и получателей. | `lottery_data` | `treasury::Vaults` (resource) | 1. Использовать payload `LegacyVaultState` (с `LegacyVaultConfig`/`LegacyVaultRecipients`) и admin-entry `import_existing_vaults`, чтобы восстановить конфигурацию и получателей без повторных переводов.<br>2. Подтвердить перенос тестами `lottery_data::treasury_migration_tests`, которые покрывают батч-импорт и переимпорт конфигурации/получателей.<br>3. Сформировать payload через скрипт `SupraLottery/supra/scripts/migrate_vaults.py`, который валидирует JSON-снимок, кодирует `LegacyVaultState` в BCS и, при необходимости, вызывает `lottery_data::treasury::import_existing_vaults` через dockerized Supra CLI. | Готово | Импорт покрыт тестами и скриптом миграции, событие `RecipientsUpdated` фиксирует изменение получателей после каждого payload. |
| `core_treasury_v1` | `TokenState` | Доступ к capability токена (mint/burn/transfer). | `lottery_data` | `treasury::TokenState` (resource) | 1. Вызвать admin-entry `import_existing_token_state`, передав metadata/mint_ref/burn_ref/transfer_ref из легаси.<br>2. Подтвердить публикацию ресурса через view `token_state_snapshot` и убедиться, что адрес metadata и ссылки ref выровнены.<br>3. Сверить готовность trsy-cap и token-state через `treasury_ready` в health-view. | Готово | Добавлен payload `LegacyTokenState` и entry `import_existing_token_state`, позволяющий поглотить легаси-референсы без зависимостей от старых модулей. |
| `core_treasury_v1` | `CoreControl` | Capabilities автопокупок и legacy-трежери. | `lottery_data` | `treasury::TreasuryV1Control` (resource) | 1. Вызвать `claim_treasury_v1_caps`, передав легаси-cap `core_treasury_v1::{AutopurchaseTreasuryCap, LegacyTreasuryCap}`, чтобы поглотить старые capability и замятить новые.<br>2. Обновить скрипты автопокупки на новый ресурс.<br>3. Для dry-run аудита готовности cap использовать view `caps_ready`/`control_snapshot`, проверяя наличие обеих capability перед миграцией. | Готово | `TreasuryV1Control` хранит пустые слоты, entry `claim_treasury_v1_caps` принимает легаси-cap, заполняет слоты новыми capability и позволяет валидировать готовность миграции. |
| `core_treasury_multi` | `TreasuryState` | Балансы джекпота/операций, конфигурация долей и event handles. | `lottery_data` | `treasury_multi::TreasuryState` (resource) | 1. Создать `lottery_data::treasury_multi` с новой схемой.<br>2. Сформировать payload'ы `LegacyMultiTreasuryState`/`LegacyMultiTreasuryLottery` и вызвать admin-entry `import_existing_state`, `import_existing_lottery(ies)` (скрипт `SupraLottery/supra/scripts/migrate_treasury_multi.py` валидирует JSON и кодирует оба payload'а в BCS, при необходимости исполняя импорт через dockerized Supra CLI).<br>3. Подтвердить перенос тестами `lottery_data::treasury_multi_migration_tests`, которые покрывают batched импорт и повторную синхронизацию записей.<br>4. Для dry-run сверок использовать view `treasury_multi::state_snapshot` и `lottery_rewards_engine::treasury::{lottery_config, recipients}`. | Готово | Тесты и скрипт миграции подтверждают восстановление получателей, долей BPS и локальных балансов без повторных переводов; ресурс готов к фактической миграции данных. |
| `core_treasury_multi` | `CoreControl` | Capability на разные пулы (jackpot/vip/store/referrals). | `lottery_data` | `treasury_multi::TreasuryMultiControl` (resource) | 1. Вызвать `claim_multi_treasury_caps`, передав легаси-cap для каждого scope (jackpot/referrals/store/vip), чтобы поглотить старые capability и проставить новые слоты.<br>2. Подтвердить готовность через view `caps_ready` и убедиться в отсутствии висячих cap в легаси.<br>3. Обновить потребителей (rewards, store, vip) после миграции cap. | Готово | Добавлен миграционный entry `claim_multi_treasury_caps`, который проверяет администратора, блокирует дубликаты и восстанавливает все четыре capability в `TreasuryMultiControl`. |

### 3.2. `lottery_multi`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `factory` | `FactoryState` | Реестр планируемых лотерей, capability администратора. | `lottery_factory` | `registry::FactoryRegistry` (resource) | 1. Использовать admin-entry `migrate_factory_state`/`import_existing_registry` для переноса admin, `next_lottery_id` и записей с переэмиссией событий планирования/активации.<br>2. Сверить `next_lottery_id` и записи с VRF и gateway (view `get_registry_snapshot`).<br>3. Пользоваться Move-тестами `factory_migration_tests` и скриптом `SupraLottery/supra/scripts/migrate_factory_state.py`, который валидирует JSON, кодирует payload в BCS и при необходимости вызывает batch-entry через dockerized Supra CLI. | Готово | Миграционный сценарий покрыт тестами (нормализация `next_lottery_id`, отказ неавторизованным), скрипт автоматизирует BCS-энкодинг и вызов entry. |
| `lottery_registry` | `Registry` | Список лотерей, причины отмен и история. | `lottery_gateway` | `registry::LotteryRegistry` (resource) | 1. Вызвать `import_existing_registry` с payload `LegacyLotteryRegistry`, чтобы перенести admin, next_lottery_id и ordered-список лотерей.<br>2. Для дельта-обновлений использовать `import_existing_entry`/`import_existing_entries` и `record_existing_cancellation(s)`, чтобы выровнять отмены.<br>3. Проверить готовность через `registry::ready`, который валидирует наличие записей для всех `lottery_ids` и корректность `next_lottery_id`, и сверить снапшот `registry_snapshot`/`lottery_entry` с `instances`. | Готово | Добавлен view `ready`, проверяющий консистентность `lottery_ids`/`entries`, миграция поддерживает импорт полного реестра и точечных изменений. |
| `lottery_registry` | `Registry` | Список лотерей, причины отмен и история. | `lottery_gateway` | `gateway::GatewayRegistry` (resource) | 1. Развернуть `lottery_gateway::gateway` с генерацией идентификаторов и индексом владельцев.<br>2. Реализовать миграцию `migrate_lottery_registry`, которая переносит владельцев и статусы в `GatewayRegistry` и выравнивает события.<br>3. Подготовить view/скрипты для проверки состава лотерей по владельцам после миграции. | Готово | Добавлен entry `gateway::migrate_lottery_registry`, который проверяет согласованность payload'ов легаси, восстанавливает `GatewayRegistry` и вызывает `registry::import_existing_registry_payload`; покрывающий Move-тест `gateway_registry_migration_tests` фиксирует корректность миграции и отказ при несовпадении данных. |
| `lottery_registry` | `CancellationRecord` | Причины отмен, суммы продаж и снапшот статуса. | `lottery_data` | `cancellations::CancellationLedger` (resource) | 1. Развернуть `lottery_data::cancellations` и поток `lottery_engine::cancellation`.<br>2. Подготовить payload'ы `LegacyCancellationRecord` (devnet/testnet архивы, dry-run отчёты или ручные константы) и вызвать `import_existing_cancellation`/`import_existing_cancellations`, чтобы батчево перенести исторические записи и события.<br>3. Использовать view `ready` для dry-run проверки публикации ресурса и актуальности администратора перед миграционными транзакциями.<br>4. Использовать view `ledger_snapshot` (`lottery_data::cancellations` или alias `lottery_engine::cancellation`) и точечные `record_snapshot` для сверки записей, сумм продаж и блокировок джекпота перед финальной валидацией сценария `lottery_gateway::cancel_lottery`.<br>5. Для подготовки и запуска миграции использовать Move-тесты `cancellations_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_cancellations.py`, который валидирует JSON, кодирует `vector<LegacyCancellationRecord>` и при необходимости вызывает batch-импорт через dockerized Supra CLI. | Готово | Ledger, snapshot-view и admin-entry покрыты миграционными тестами, а скрипт `migrate_cancellations.py` закрывает подготовку payload'ов и автоматизацию импорта. |
| `automation` | `AutomationRegistry` | Таблица ботов и event handles dry-run/ошибок. | `lottery_data` | `automation::AutomationRegistry` (resource) | 1. Развернуть `lottery_data::automation`, инициировать события и вызвать `lottery_data::automation::import_existing_bot(s)` для восстановления всех ботов (payload `LegacyAutomationBot`).<br>2. Использовать Move-тесты `lottery_data::automation_migration_tests`, чтобы подтвердить батчевый импорт и переимпорт записей с сохранением cron/хэшей.<br>3. Скрипт `SupraLottery/supra/scripts/migrate_automation_registry.py` валидирует JSON-снимки, кодирует `vector<LegacyAutomationBot>` в BCS и (опционально) запускает batch-entry через dockerized Supra CLI.<br>4. После импорта сверить pending-статусы через view `lottery_engine::automation::{registry_snapshot, bot_status, operators}` и `automation::caps_snapshot`. | Готово | Реестр восстанавливается единым вызовом, тесты и скрипт задокументированы; pending-статусы и cron-поля подтверждены dry-run снапшотами. |
| `automation` | `AutomationCap` | Capability с расписанием cron. | `lottery_data` | `automation::AutomationCap` (resource) | 1. Перенести capability через `claim_automation_cap`.<br>2. Обновить авторизацию cron-задач. | Готово | Добавлен entry `automation::claim_automation_cap`, который поглощает легаси-cap с проверкой оператора и наличия бота в реестре, клонирует cron_spec и размещает новый cap на адресе оператора; контроллер готов к dry-run переносу capability. |
| `draw` | `DrawLedger` | Состояние VRF-запросов и соответствие nonce ↔ lottery. | `lottery_engine` | `draw` (модули запросов и обработки результатов) | 1. Использовать admin-entry `import_existing_draw_request(s)` для восстановления pending-запросов: выравнивается `draw_scheduled`, pending-slot в `rounds`, hash/requester в `lottery_state` и счётчики VRF.<br>2. Перед импортом сверить наличие запроса в `lottery_vrf_gateway::hub` и совпадение payload hash; при активном хабе entry защитится проверками.<br>3. Для dry-run аудита использовать view `draw_snapshot`/`draw_snapshots` и `pending_request_alignment`, сверяя pending-запросы, хэши payload и счётчики VRF с данными `rounds`/`lottery_state` и `hub::request_snapshot`.<br>4. После миграции выполнить цепочку `schedule → request → fulfill` на тестнете для smoke-валидации событий. | Готово | Добавлены admin-entry `import_existing_draw_request`/`import_existing_draw_requests`, которые выравнивают pending-заявки с `rounds`/`lottery_state`, сверяют payload hash с VRF-хабом и обновляют счётчики VRF; статус миграции закрыт. |
| `feature_switch` | `FeatureSwitchRegistry` | Переключатели функционала, включая devnet-флаги. | `lottery_utils` | `feature_flags::FeatureRegistry` (resource) | 1. Использовать payload `LegacyFeatureRegistry` и entry `import_existing_registry`, чтобы развернуть администратора, флаг `force_enable_devnet` и существующие режимы.<br>2. Для инкрементальных обновлений использовать `import_existing_feature(s)`, а dry-run проверку выполнять через `registry_snapshot` и `feature_flags::has_feature/mode`.<br>3. Кодировать и отправлять payload помогает скрипт `SupraLottery/supra/scripts/migrate_feature_flags.py`, а модульные тесты `feature_flags_migration_tests` покрывают сценарии полного и частичного импорта. | Готово | Реестр режимов восстановлен, скрипт миграции задокументирован, тесты подтверждают консистентность payload'ов. |
| `feature_switch` | `FeatureSwitchAdminCap` | Capability, выдаваемый старой системой переключателей для изменения режимов. | `lottery_utils` | `feature_flags::FeatureRegistry` (администрирование через `@lottery`) | 1. Вызвать entry `feature_flags::claim_legacy_admin_cap`, передав `lottery_multi::feature_switch::FeatureSwitchAdminCap`, чтобы поглотить легаси-cap, убедиться, что админ `@lottery` и зафиксировать состояние в `FeatureSwitchMigration`.<br>2. Проверить view `legacy_admin_cap_consumed`, подтверждая отсутствие висячих capability.<br>3. Обновить DevOps-потоки на использование подписей `@lottery` без легаси-cap и задокументировать цепочку возврата/уничтожения cap. | Готово | Добавлен миграционный entry для поглощения легаси-cap и view готовности; капабилити больше не требуется для работы `feature_flags`. |
| `history` | `ArchiveLedger` | Архивированные резюме лотерей и события dual-write. | `lottery_utils` | `history::ArchiveLedger` (resource) | 1. Развёрнут `ArchiveLedger` с событиями финализации и импортов, admin-entry `init_archive`, `record_archive_summary`, `import_legacy_summary`, `import_existing_legacy_summaries`, `rollback_legacy_summary`, `update_legacy_classification` и view `list_finalized`.<br>2. В миграции использовать batch-entry `import_existing_legacy_summaries` с проверкой хэшей и ожиданий dual-write (`notify_summary_written`).<br>3. Подтвердить rollback/classification через тесты `history_archive_migration_tests` и зафиксировать снапшоты для аудита. | Готово | Batch-импорт и dual-write покрыты тестами `history_archive_migration_tests`, сверка хэшей проходит через ожидаемые значения; снапшоты доступны через view. |
| `legacy_bridge` | `DualWriteControl` | Настройки двойной записи и контроль хэшей между новым и legacy-архивом. | `lottery_utils` | `history::DualWriteControl` (resource) | 1. Использовать entry `history::init_dual_write` и payload `LegacyDualWriteState` для импорта флагов/ожиданий без обращения к legacy.<br>2. Переносить pending `expected_hashes` через `import_existing_dual_write_state` либо batched `set_expected_hash`, фиксируя события `ArchiveDualWriteStarted`.<br>3. Для dry-run сверки использовать view `dual_write_snapshot` (флаги + список `expected_hashes`) и `pending_expected_hashes`, подтверждая совпадение с экспортом `history_bridge` перед включением dual-write в прод. | Готово | Добавлен view `dual_write_snapshot`, позволяющий снять полный слепок флагов и ожиданий, миграция завершается импортом `LegacyDualWriteState` без зависимости от legacy. |
| `legacy_bridge` | `MirrorConfig` | Флаг зеркалирования архивов. | — | — | 1. Подтвердить, что новая архитектура не требует зеркала.<br>2. Документировать вывод ресурса.<br>3. Удалить модуль после успешной миграции. | Не требуется | Проверить отсутствие ссылок в скриптах поддержки. |
| `history` | `Registry` | История лотерей и отмен. | `lottery_gateway` | `history::LotteryHistory` (resource) | 1. Выполнить `init` и вызвать `record_existing_histories`, чтобы импортировать снапшоты из архивов/легаси (`LegacyHistoryImport`).<br>2. После миграции сверить `history_snapshot`/`history_records` с архивами и событиями фасада.<br>3. Проверить готовность через `history::ready`, который валидирует корректность статусов записей. | Готово | Добавлен view `ready`, валидирующий статусы записей; импорт позволяет восстановить историю без зависимости от legacy. |
| `payouts` | `PayoutLedger` | Состояние выплат и событий победителей/возвратов. | `lottery_data` / `lottery_engine` / `lottery_rewards_engine` | `payouts::PayoutLedger` (resource) + `lottery_engine::payouts` (статусы/вью) + `lottery_rewards_engine::payouts` (выплаты) | 1. Реализовать хранение `lottery_data::payouts`, административные entry `lottery_engine::payouts` и сервисные выплаты `lottery_rewards_engine::payouts`.<br>2. Для миграции использовать payload `LegacyPayoutRecord` и admin-entry `import_existing_payout`/`import_existing_payouts`, которые восстанавливают счётчики pending/paid/refunded и переэмитят события без повторных выплат.<br>3. Подготовить скрипт `migrate_payout_ledger`, сверить остатки невыплаченных сумм и события `WinnerRecorded`/`PayoutStatusUpdated`, а также `JackpotPaidEvent`/`Operations*` из мульти-трежери, используя view `ready`/`ledger_snapshot`/`lottery_snapshot`/`payout_record_snapshot` из `lottery_data::payouts` (их также проксируют `lottery_engine::payouts` и `lottery_rewards_engine::payouts`) для dry-run аудита: `ready` дополнительно проверяет целостность `lottery_ids`, `payout_index` и таблиц выплат перед миграцией.<br>4. Для быстрой сверки готовности стораджа и сопоставления новых снапшотов с прогрессом легаси вызывайте `SupraLottery/supra/scripts/payout_migration_check.sh lottery <lottery_id>` или `summary` — скрипт объединяет `lottery_data::payouts::ready`, снапшоты движка/сервисного слоя и `lottery_multi::payouts::winner_progress`. | Готово | Импорт покрыт тестами `payouts_migration_tests`, скрипт `SupraLottery/supra/scripts/migrate_payouts.py` валидирует JSON `LegacyPayoutRecord`, кодирует batch-пейлоады и при необходимости вызывает entry через dockerized Supra CLI; готовность подтверждается snapshot/view и контрольным скриптом. |
| `price_feed` | `PriceFeedRegistry` | Курсы активов и события обновлений. | `lottery_utils` | `price_feed::PriceFeedRegistry` (resource) | 1. Реализовать модуль `lottery_utils::price_feed`.<br>2. Выполнить `migrate_price_feeds` через `import_existing_registry` или батч-записи `import_existing_feeds`; модуль валидирует админа, decimals и метаданные снапшотов.<br>3. Настроить тесты на актуальность данных.<br>4. Для dry-run проверки миграций использовать view `registry_snapshot` и health-view `ready`, чтобы сверять админа, версию и целостность всех записей feed. | Готово | Добавлен health-view `price_feed::ready`, проверяющий админа, версию по умолчанию и консистентность записей; импортные entry принимают весь реестр и батчи фидов с валидацией decimals/staleness. |
| `roles` | `RoleStore` | Роли партнёров, премиум доступ и события. | `lottery_data` | `access::RoleStore` (resource) | 1. Импортировать снапшот через `lottery_data::access::import_existing_role_store`, используя payload `LegacyRoleStore` (пакет `SupraLottery/supra/scripts/migrate_role_store.py` валидирует JSON, кодирует BCS и может запустить entry). <br>2. Для инкрементальных обновлений применять `import_partner_cap(s)` и `import_premium_cap(s)`; скрипт поддерживает тот же формат. <br>3. Проверить события/индексы и view `partner_caps`/`premium_caps` через Move-тесты `lottery_data::access_migration_tests`, покрывающие полный импорт и dedup индексов. | Готово | Миграционный пайплайн задокументирован, тесты подтверждают корректность снапшотов и порядков индексов. |
| `sales` | `SalesLedger` | Учёт продаж, лимитов и распределения. | `lottery_engine` | `sales::SalesLedger` (resource) | 1. Реализовать модуль `lottery_engine::sales` поверх `lottery_data` с поддержкой батчевых покупок и авто-планирования розыгрыша (готово).<br>2. Переносить слоты учёта продаж через admin-entry `record_existing_sale(s)`, который выравнивает `tickets_sold`, `jackpot_accumulated`, `next_ticket_id` и флаг `draw_scheduled` между `instances`, `lottery_state` и `rounds`, проверяя длину списков билетов.<br>3. Для dry-run сверок использовать view `lottery_engine::sales::{sales_snapshot, sales_snapshots}` (показывают билетные и draw-параметры), сверяя суммы с трежери и `LotteryData`.<br>4. Для быстрой проверки snapshot → распределение → легаси запустите `SupraLottery/supra/scripts/sales_migration_check.sh lottery <lottery_id>`, чтобы получить `lottery_engine::sales::sales_snapshot`, `lottery_rewards_engine::treasury::lottery_config` и `lottery_multi::views::accounting_snapshot` в одном выводе. | Готово | Entry `record_existing_sale(s)` позволяет поглотить снапшоты продаж без обращения к легаси, выравнивая счётчики и draw-флаги между движком и storage. |
| `vrf_deposit` | `VrfDepositLedger` | Баланс депозита VRF, статусы и события. | `lottery_data` / `lottery_engine` | `vrf_deposit::VrfDepositLedger` (resource) + `lottery_engine::vrf` (логика) | 1. Реализовать хранение `lottery_data::vrf_deposit` и логику `lottery_engine::vrf`.<br>2. Использовать payload `LegacyVrfDepositLedger` и admin-entry `lottery_data::vrf_deposit::import_existing_ledger`, чтобы восстановить конфигурацию, баланс и флаги паузы без обращения к legacy-пакетам (допускаются devnet/testnet архивы, dry-run отчёты или ручные константы).<br>3. Подтвердить балансы и паузы через CLI и dry-run цепочку `schedule → request → fulfill` с `lottery_vrf_gateway::hub::HubState`.<br>4. Для аудита миграции использовать view `vrf_deposit::ledger_snapshot`/`is_initialized` или алиасы `lottery_engine::vrf::ledger_snapshot`/`is_initialized`, чтобы сверять конфиг/статус без чтения из legacy. | Готово | Тесты `lottery_data::vrf_deposit_migration_tests` покрывают импорт начального и повторного снапшотов с обновлением флагов паузы, а скрипт `SupraLottery/supra/scripts/migrate_vrf_deposit.py` валидирует JSON-снимок, кодирует `LegacyVrfDepositLedger` в BCS и при необходимости вызывает entry `import_existing_ledger`; перед dry-run сверкой используйте view `ledger_snapshot` и алиасы `lottery_engine::vrf::ledger_snapshot`. |

### 3.3. `lottery_rewards`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `rewards_autopurchase` | `AutopurchaseState` | Планы автопокупки по лотереям, события депозитов и возвратов. | `lottery_rewards_engine` | `autopurchase::AutopurchaseState` (resource) | 1. Развернуть пакет `lottery_rewards_engine` с модулем `autopurchase` и инициализировать `AutopurchaseState`.<br>2. Сконвертировать легаси-записи в `LegacyAutopurchasePlan` и вызвать `autopurchase::import_existing_plan`/`import_existing_plans` для восстановления балансов без повторных депозитов (скрипт `SupraLottery/supra/scripts/migrate_autopurchase.py` валидирует JSON и кодирует `vector<LegacyAutopurchasePlan>` в BCS).<br>3. Подтвердить перенос Move-тестами `lottery_rewards_engine::autopurchase_migration_tests`, проверяющими батчевый импорт, повторные обновления планов и корректность снапшотов. | Готово | Тесты и новый скрипт покрывают импорты и dry-run проверки, `AutopurchaseState` готов к фактической миграции данных. |
| `rewards_autopurchase` | `AutopurchaseAccess` | Capability для раундов и трежери. | `lottery_rewards_engine` | `autopurchase::AutopurchaseAccess` (resource) | 1. Вызвать `claim_autopurchase_caps`, передав легаси-cap `core_rounds::AutopurchaseRoundCap` и `core_treasury_v1::AutopurchaseTreasuryCap`, чтобы поглотить старые capability, заполнить слоты контроллеров и сразу развернуть `AutopurchaseAccess`.<br>2. Обновить вызовы расписаний.<br>3. Для dry-run аудита использовать view `autopurchase::access_snapshot`/`caps_ready`. | Готово | Добавлен миграционный entry `claim_autopurchase_caps`, который проверяет администратора, блокирует дубликаты и переносит capability из контроллеров в ресурс доступа. |
| `rewards_jackpot` | `JackpotState` | Состояние джекпота, билеты и события VRF. | `lottery_data` | `jackpot::JackpotRegistry` (resource) + логика `lottery_rewards_engine::jackpot` | 1. Развернуть `lottery_data::jackpot` с регистрами и событиями.<br>2. Перенести состояния через `lottery_rewards_engine::jackpot::{import_existing_jackpot(s)}`, используя payload `LegacyJackpotRuntime` и зафиксировать снапшоты (см. скрипт `SupraLottery/supra/scripts/migrate_jackpot.py`, который кодирует `vector<LegacyJackpotRuntime>`).<br>3. Перед импортом сверить публикацию ресурса через view `jackpot::is_initialized` или алиас `lottery_rewards_engine::jackpot::is_initialized`, а затем вызвать `jackpot::ready` (или `lottery_rewards_engine::jackpot::ready`), чтобы подтвердить совпадение `lottery_ids` с таблицей и корректность pending-заявок (payload и request_id).<br>4. Запустить dry-run `lottery_rewards_engine::jackpot::request_randomness/fulfill_draw` и сверить события с легаси, используя snapshot-view `jackpot::registry_snapshot`/`lottery_snapshot`/`runtime_view`/`runtime_views` в новом движке. | Готово | Тесты `lottery_rewards_engine::jackpot_migration_tests` покрывают батч-импорт и переимпорт записей, скрипт `migrate_jackpot.py` автоматизирует валидацию JSON и вызов entry, readiness подтверждена health-view. |
| `rewards_jackpot` | `JackpotAccess` | Capability к мульти-трежери. | `lottery_rewards_engine` | `jackpot::JackpotAccess` (resource) | 1. Реализовать `jackpot::JackpotAccess` в новом движке с admin-entry `init_access`/`release_access`, которые извлекают и возвращают `MultiTreasuryCap` из `lottery_data::treasury_multi` без обращения к legacy.<br>2. Перенести легаси-capability через `claim_jackpot_access`, который поглощает `rewards_jackpot::JackpotAccess`, предотвращает дубликаты слота и сразу размещает cap в новом `JackpotAccess` с заполнением контроллера.<br>3. Выполнить dry-run транзакцию переноса capability с верификацией строк в `treasury_multi::TreasuryMultiControl`, view `caps_ready` и подтверждением отсутствия висячих cap в легаси.<br>4. Обновить `lottery_rewards_engine::jackpot::fulfill_draw`/`drain_jackpot_balance` на использование нового access и задокументировать освобождение legacy-capability (`release_caps`). | Готово | Добавлены entry `claim_jackpot_access` и контроль дубликатов слота, cap мятится в контроллере и сразу переносится в новый ресурс; миграция capability закрыта. |
| `rewards_nft` | `BadgeAuthority` | Управление NFT-наградами, снапшотами владельцев и событиями mint/burn. | `lottery_rewards_engine` | `nft::BadgeAuthority` (resource) | 1. Развернуть `lottery_rewards_engine::nft` с admin-entry `init`, `set_admin`, `mint_badge`, `burn_badge` и импортом `LegacyBadgeAuthority`/`LegacyBadgeOwner`/`LegacyBadge`.<br>2. Для миграции вызвать `import_existing_badge_authority(ies)` на подготовленном payload (архивы devnet/testnet, dry-run отчёты или ручные константы), убедившись в корректности снапшотов и событий `NftRewardsSnapshotUpdatedEvent`.<br>3. Готовность подтверждается view `nft::ready`, которое проверяет администратора, уникальность владельцев/бэйджей и согласованность `next_badge_id` с максимумом id; миграция закрыта тестами `nft_migration_tests`. | Готово | Ready-view и миграционные тесты фиксируют консистентность снапшотов без зависимости от legacy. |
| `rewards_referrals` | `ReferralState` | Конфиги и статистика реферальной программы. | `lottery_rewards_engine` | `referrals::ReferralState` (resource) | 1. Выполнить batch-импорт `LegacyReferralLottery`/`LegacyReferralRegistration` через admin-entry `import_existing_lotteries`/`import_existing_registrations` (или одиночные версии) для восстановления конфигов, статистики и регистраций без повторных списаний.<br>2. Проверить таблицы `referrers` и `stats`, а также снапшоты после импорта, используя view `get_referral_snapshot` и `get_ledger_snapshot` для dry-run сверки с легаси.<br>3. При повторном импорте убедиться, что обновлённые BPS и регистрация перезаписываются без дубликатов. | Готово | Тесты `lottery_rewards_engine::referrals_migration_tests` подтверждают восстановление конфигов/статистики/регистраций и повторный импорт, скрипт `SupraLottery/supra/scripts/migrate_referrals.py` кодирует оба payload'а в BCS и может вызвать batch-entry через dockerized Supra CLI. |
| `rewards_referrals` | `ReferralsControl` | Capability на пул рефералов. | `lottery_rewards_engine` | `referrals::ReferralsControl` (resource) | 1. Перенести cap через `claim_referrals_cap`, передав легаси `rewards_referrals::ReferralsControl`; функция мятит новый cap в `TreasuryMultiControl`, блокирует дубликаты и сразу размещает его в `ReferralsControl`.<br>2. Обновить вызовы выплат. | Готово | Capability переносится без зависимостей от legacy благодаря `claim_referrals_cap`; `init_access` остаётся для переинициализации из контроля. |
| `rewards_store` | `StoreState` | Магазин призов, события покупок и конфигов. | `lottery_rewards_engine` | `store::StoreState` (resource) | 1. Модуль `lottery_rewards_engine::store` развёрнут, фиксирует товары, остатки и события покупок.<br>2. Импортировать `LegacyStoreItem` через admin-entry `import_existing_item`/`import_existing_items`, используя Move-тесты `store_migration_tests` для проверки восстановления каталога и повторного импорта обновлённых записей.<br>3. Скрипт `SupraLottery/supra/scripts/migrate_store.py` валидирует JSON-снимки, кодирует `vector<LegacyStoreItem>` в BCS и, при необходимости, запускает batch-entry через dockerized Supra CLI; после импорта сверять view `get_store_snapshot`/`get_lottery_snapshot`. | Готово | Каталог восстанавливается миграционными тестами и скриптом, снапшоты подтверждают перенос событий и остатков. |
| `rewards_store` | `StoreAccess` | Capability на магазин. | `lottery_rewards_engine` | `store::StoreAccess` (resource) | 1. Вызвать `store::claim_store_cap` с легаси `rewards_store::StoreAccess`, чтобы мятить новый cap в `TreasuryMultiControl`, блокируя занятый слот, и сразу разместить его в `StoreAccess`.<br>2. Описать миграцию `claim_store_cap`/`release_caps` в чек-листе. | Готово | Перенос cap происходит без внешних зависимостей; `ensure_caps_initialized` остаётся для повторной инициализации из контроллера. |
| `rewards_vip` | `VipState` | VIP-подписки, события бонусов и отмен. | `lottery_rewards_engine` | `vip::VipState` (resource) | 1. Создать модуль `lottery_rewards_engine::vip`.<br>2. Сформировать payloadы `LegacyVipLottery` (допускаются devnet/testnet архивы, dry-run снапшоты или ручные константы) и вызвать admin-entry `import_existing_lottery`/`import_existing_lotteries` для восстановления конфигов, подписчиков и статистики без повторных платежей.<br>3. Сверить снапшоты через view `get_vip_snapshot` и интеграционные тесты фасада.<br>4. Для оффчейн подготовки и запуска транзакций использовать скрипт `SupraLottery/supra/scripts/migrate_vip.py`, который валидирует JSON и кодирует `vector<LegacyVipLottery>`.<br>5. Подтвердить восстановление и переимпорт тестами `lottery_rewards_engine::vip_migration_tests`. | Готово | Тесты `vip_migration_tests` покрывают batch-импорт и повторные обновления, скрипт `migrate_vip.py` формирует payload и (опционально) вызывает entry `import_existing_lotteries`. |
| `rewards_vip` | `VipAccess` | Capability на VIP-пул. | `lottery_rewards_engine` | `vip::VipAccess` (resource) | 1. Перенести cap через `claim_vip_cap`, передав легаси `rewards_vip::VipAccess`; entry мятит новый cap в контроллере, защищает слот от дубликатов и сразу размещает его в `VipAccess`.<br>2. Обновить сценарии подписки, чтобы использовать новый `VipAccess` и подтверждать возврат capability при миграции. | Готово | `claim_vip_cap` устраняет зависимость от legacy, `ensure_caps_initialized` можно использовать для повторной инициализации из контроллера. |

### 3.4. `lottery_support`

| Старый модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `support_history` | `HistoryCollection` | История розыгрышей и снапшоты. | `lottery_utils` | `history::HistoryCollection` (resource) | 1. Развернуть `lottery_utils::history` (`init`, события, снапшоты).<br>2. Подготовить `migrate_history_collection` для переноса записей и сверки счётчиков, используя `LegacyHistoryRecord` и entry-функции `import_existing_history_record`/`import_existing_history_batch`.<br>3. Настроить `sync_draws_from_rounds` и dry-run очистки/обновления истории. | Готово | Добавлены тесты `lottery_utils::history_migration_tests`, подтверждающие batch-импорт записей и восстановление dual-write, и скрипт `SupraLottery/supra/scripts/migrate_history.py`, который валидирует JSON-снимки, кодирует `vector<LegacyHistoryRecord>` в BCS и, при необходимости, вызывает `import_existing_history_batch`. |
| `support_history` | `HistoryWarden` | Capability записи истории. | `lottery_utils` | `history::HistoryWarden` (resource) | 1. Перенести `HistoryWriterCap` через `rounds::extract_history_cap` и `history::init_caps`.<br>2. Подтвердить работу `sync_draws_from_rounds` и возврат capability при откате. | Готово | Тест `history_warden_migration_tests::caps_can_be_issued_and_returned` подтверждает выдачу и возврат капабилити при повторных вызовах `ensure_caps_initialized`/`release_caps`. |
| `history_bridge` | `LegacyArchive` | Архив легаси-снапшотов. | `lottery_utils` | `history::LegacyArchive` (resource) | 1. Развёрнут `LegacyArchive` с admin-entry `init_legacy_archive` и записью BCS-сводок через `mirror_summary_to_legacy`.<br>2. В миграции использовать `import_existing_legacy_summaries`/`record_archive_summary`, чтобы заполнить архив, сэмитить `LegacySummaryEvent` с контрольными суммами и сохранить хэши.<br>3. Сверить итоговые хэши с архивом `lottery_support::history_bridge` и зафиксировать их в отчёте. | Готово | Batch-импорт покрыт тестами `history_archive_migration_tests`, для BCS-энкодинга и вызова entry опубликован скрипт `SupraLottery/supra/scripts/migrate_archive_summaries.py`. |
| `support_metadata` | `MetadataRegistry` | Метаданные лотерей. | `lottery_utils` | `metadata::MetadataRegistry` (resource) | 1. Развернуть `lottery_utils::metadata` с событиями `LotteryMetadataUpsertedEvent`/`MetadataSnapshotUpdatedEvent` и рекурсивными обходами вместо циклов.<br>2. Использовать скрипт `SupraLottery/supra/scripts/migrate_metadata_registry.py`, который формирует payload `LegacyMetadataImport`, проверяет ASCII и может вызвать `import_existing_metadata_batch` через dockerized CLI.<br>3. Подтвердить консистентность через Move-тесты `lottery_utils::metadata_migration_tests`, покрывающие batch-импорт и перезапись записей.<br>4. Для dry-run аудита и сверки с фасадом использовать view `registry_snapshot`, чтобы экспортировать полный срез даже при отсутствии опубликованного состояния. | Готово | Скрипт миграции опубликован, entry-функции покрыты тестами `metadata_migration_tests`, `MetadataRegistry` готов к импорту снимков и выдаче данных через фасад. |
| `support_migration` | `MigrationLedger` | Снимки прогресса миграции. | `lottery_utils` | `migration::MigrationLedger` (resource) | 1. Использовать `SupraLottery/supra/scripts/migrate_migration_ledger.py`, который валидирует JSON-снимки, кодирует `MigrationSnapshot` в BCS и при необходимости вызывает `lottery_utils::migration::record_snapshot` через dockerized CLI.<br>2. Перед импортом сверить готовность ресурса через view `migration::is_initialized`, после импорта сверять список лотерей и записи через `ledger_snapshot`/`get_migration_snapshot`.<br>3. Подтвердить функциональность через тест `lottery_utils::migration_migration_tests::record_snapshot_initializes_ledger`, проверяющий auto-init ledger, обновление записей и `list_migrated_lottery_ids`. | Готово | Скрипт миграции и Move-тесты покрывают импорт снапшотов и dry-run проверки; `MigrationLedger` готов к переносу данных. |
| `support_migration` | `MigrationSession` | Capability миграции (инстансы, legacy-трежери). | `lottery_utils` | `migration::MigrationSession` (resource) | 1. Управлять вызовами `ensure_caps_initialized`/`release_caps` через `SupraLottery/supra/scripts/migration_session_control.sh`, который также предоставляет view-команды `caps-ready`/`session-ready`.<br>2. Использовать `session_snapshot` и `caps_ready` для dry-run аудита готовности capability перед миграцией.<br>3. Подтвердить перенос/возврат capability тестами `lottery_utils::migration_migration_tests::{ensure_caps_initialized_transfers_caps, release_caps_restores_control}`. | Готово | Capability миграции подтверждены тестами, есть скрипт управления с view-командами; ресурс готов к эксплуатации. |

### 3.5. `lottery_factory`, `lottery_gateway`, `lottery_vrf_gateway`

| Старый пакет / модуль | Ресурс | Ключевые поля / назначение | Целевой пакет | Целевой модуль / сущность | Действия миграции | Статус | Комментарии и зависимости |
| --- | --- | --- | --- | --- | --- | --- | --- |
| `lottery_factory::registry` | `FactoryState` | Администратор фабрики, таблица лотерей и события (повтор записи). | `lottery_factory` | `registry::FactoryRegistry` (resource) | 1. Совместить перенос с таблицей из `lottery_multi::factory` (см. раздел 3.2).<br>2. Выполнить миграцию единым скриптом `migrate_factory_state`/`import_existing_registry` и сверить `next_lottery_id`/owner/blueprint с gateway/VRF.<br>3. Провести smoke-тесты создания лотерей, используя Move-тесты `factory_migration_tests` как эталон нормализации `next_lottery_id` и проверки авторизации. | Готово | Batch-импорт `LegacyFactoryState` подтверждён тестами, скрипт `SupraLottery/supra/scripts/migrate_factory_state.py` готовит payload BCS и при необходимости вызывает entry через dockerized Supra CLI. |
| `lottery_gateway::registry` | `Registry` | Реестр фасада (owner, адрес контракта, цена билета, доля джекпота, статус/причина отмены). | `lottery_gateway` | `registry::LotteryRegistry` (resource) | 1. Перенести payload `LegacyLotteryRegistry` через `import_existing_registry` или `import_existing_entries`, зафиксировав admin/next_lottery_id/lottery_ids.<br>2. При миграции отмен использовать `record_existing_cancellation(s)` для выравнивания причин/времени отмен.<br>3. Подтвердить готовность через `registry::ready`, сверить `registry_snapshot`/`lottery_entry` с `instances` и фасадом. | Готово | Реестр публикует снапшот при каждой операции, ready-проверка подтверждает консистентность ids/entries и корректность next_lottery_id; миграция данных выполняется без зависимости от legacy. |
| `lottery_vrf_gateway::hub` | `HubState` | Регистрация лотерей в VRF, pending-запросы и события. | `lottery_vrf_gateway` | `hub::HubState` (resource) | 1. Выполнить `migrate_lottery_vrf_gateway_state`/`import_existing_state`, который валидирует payload-хэши и переносит admin/lotteries/requests/pending/callback.<br>2. Сверить pending-запросы с `lottery_engine::draw::DrawLedger` и view `hub::request_snapshot`/`list_pending_request_ids`.<br>3. Проверить готовность через `hub::ready`, который убеждается, что все pending-запросы присутствуют и `next_*` счётчики покрывают максимум id. | Готово | Добавлен view `ready` и валидация хэшей при импорте запросов; миграция может завершаться без опоры на legacy. |

## 4. Следующие шаги
1. **Финальный VRF dry-run.** Провести цепочку `schedule → request → fulfill` на testnet, сверяя pending-заявки между `rounds`, `lottery_state` и VRF-хабом через `pending_request_alignment`, `draw::import_existing_draw_request(s)` и `lottery_vrf_gateway::hub::{request_snapshot, ready}`; зафиксировать `request_id/payload/lottery_id` и высоты событий fulfill.
2. **Контроль артефактов в CI.** Новая стадия `run_migration_checks.sh` в workflow `move-tests` публикует `move_struct_inventory.{json,md}` и `migration_plan_status.json`; включите проверку сводки статусов в ревью и блокируйте сборку, если `check_migration_mapping.py --strict` сигнализирует расхождения.
3. **Пост-миграционный аудит capability и владельцев.** Пройти `caps_ready`/`registry_snapshot` для automation/referrals/store/vip/operators/multi-treasury/JackpotAccess, подтвердить отсутствие висячих cap в легаси и зафиксировать tx-хэши dry-run переноса перед выводом legacy-пакетов.
## 5. Журнал изменений

| Дата (UTC) | Изменение | Автор |
| --- | --- | --- |
| 2026-04-15 | `run_migration_checks.sh` добавлен в CI pipeline `move-tests` с выгрузкой артефактов инвентаризации; прогон подтверждён (51/0/0/1) с обновлением `tmp/move_struct_inventory.json` и `tmp/migration_plan_status.json`. | Supra refactoring bot |
| 2026-04-14 | Добавлен health-view `nft::ready`, который проверяет администратора, уникальность владельцев и консистентность `next_badge_id`; опубликованы миграционные тесты `nft_migration_tests`, строка `BadgeAuthority` переведена в «Готово», сводка статусов обновлена до 51/0, артефакты `run_migration_checks.sh` сохранены в `tmp/`. | Supra refactoring bot |
| 2026-04-13 | Прогнан `run_migration_checks.sh` (Готово 49, В работе 2) после добавления проверок готовности реестров, валидации хэшей VRF-запросов и обновления статусов `lottery_gateway::registry`/`history` и `lottery_vrf_gateway::hub` до «Готово»; артефакты `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json` обновлены. | Supra refactoring bot |
| 2026-04-12 | Добавлен view `history::dual_write_snapshot` для снятия флагов и pending `expected_hashes`, закрыт перенос `DualWriteControl`; сводка статусов обновлена до 46/5, артефакты `run_migration_checks.sh` от 2026-04-12 сохранены. | Supra refactoring bot |
| 2026-04-11 | Добавлен payload `LegacyVrfConfigImport` и admin-entry `import_existing_vrf_config(s)` для миграции газового бюджета, whitelist и конфигурации запросов VRF с валидацией pending-slot; статус VRF-config переведён в «Готово», сводка обновлена до 45/6, артефакты `run_migration_checks.sh` от 2026-04-11 сохранены. | Supra refactoring bot |
| 2026-04-10 | Прогнан `run_migration_checks.sh` (Готово 44, В работе 7) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлены entry `claim_referrals_cap`, `claim_store_cap`, `claim_vip_cap` и mint-хелперы в `treasury_multi`, переведены capability рефералов/магазина/VIP в статус «Готово». | Supra refactoring bot |
| 2026-04-09 | Прогнан `run_migration_checks.sh` (Готово 41, В работе 10) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; entry `rounds::import_pending_history_records`/`import_pending_purchase_records` теперь валидируют согласованность с `RoundRegistry`, а `price_feed` получил health-view `ready` и статус «Готово». | Supra refactoring bot |
| 2026-04-08 | Прогнан `run_migration_checks.sh` (Готово 38, В работе 13) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлен payload `LegacyTokenState` и entry `treasury::import_existing_token_state`, строка `TokenState` переведена в «Готово». | Supra refactoring bot |
| 2026-04-07 | Прогнан `run_migration_checks.sh` (Готово 37, В работе 14) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлен entry `automation::claim_automation_cap` для переноса legacy-cap по операторам, строка `AutomationCap` переведена в «Готово». | Supra refactoring bot |
| 2026-04-06 | Прогнан `run_migration_checks.sh` (Готово 36, В работе 15) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлены admin-entry `sales::record_existing_sale(s)` для переноса слотов SalesLedger с проверкой длины билетов и флага draw, строка `SalesLedger` переведена в «Готово». | Supra refactoring bot |
| 2026-04-05 | Прогнан `run_migration_checks.sh` (Готово 35, В работе 16) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлены entry `draw::import_existing_draw_request(s)` для переноса pending VRF-заявок с проверкой payload hash, строка `DrawLedger` переведена в «Готово». | Supra refactoring bot |
| 2026-04-04 | Прогнан `run_migration_checks.sh` (Готово 34, В работе 17) с обновлёнными артефактами `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлен entry `jackpot::claim_jackpot_access` для поглощения легаси-cap и заполнения `TreasuryMultiControl`, строка `JackpotAccess` переведена в «Готово». | Supra refactoring bot |
| 2026-04-03 | Прогнан `run_migration_checks.sh` (Готово 33, В работе 18) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлен entry `feature_flags::claim_legacy_admin_cap` и view `legacy_admin_cap_consumed`, строка `FeatureSwitchAdminCap` переведена в «Готово». | Supra refactoring bot |
| 2026-04-02 | Прогнан `run_migration_checks.sh` (Готово 32, В работе 19) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлен entry `autopurchase::claim_autopurchase_caps` для переноса легаси-cap и мгновенного развёртывания `AutopurchaseAccess`. | Supra refactoring bot |
| 2026-04-01 | Прогнан `run_migration_checks.sh` (Готово 31, В работе 20) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлен entry `treasury_multi::claim_multi_treasury_caps` для поглощения всех легаси-cap и разблокировки готовности `TreasuryMultiControl`. | Supra refactoring bot |
| 2026-03-31 | Прогнан `run_migration_checks.sh` (Готово 30, В работе 21) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; добавлены entry `claim_round_control_caps` и `claim_treasury_v1_caps`, чтобы поглотить легаси-cap и заполнить контроллеры капабилити в `rounds` и `treasury`. | Supra refactoring bot |
| 2026-03-30 | Прогнан `run_migration_checks.sh` (Готово 28, В работе 23) с обновлением артефактов `tmp/move_struct_inventory.json`/`tmp/migration_plan_status.json`; миграция cap `InstancesExportCap` закрыта через новый entry `claim_instance_control_cap` и `caps_ready`. | Supra refactoring bot |
| 2026-03-29 | Прогнан `run_migration_checks.sh` (Готово 27, В работе 24) с обновлением артефактов `tmp/move_struct_inventory.json` и `tmp/migration_plan_status.json`, статусная сводка синхронизирована в документе. | Supra refactoring bot |
| 2026-03-28 | Прогнан `run_migration_checks.sh` (Готово 27, В работе 24) с обновлением артефактов в `tmp/` и подтверждением сверки статусной сводки и инвентаризации целевых пакетов. | Supra refactoring bot |
| 2026-03-27 | Прогнан `run_migration_checks.sh` (Готово 27, В работе 24), добавлены развернутые чек-листы c tx-хэшами/высотами для SalesLedger, VRF-пайплайна, capability и dual-write, уточнены требования к артефактам CI. | Supra refactoring bot |
| 2026-03-26 | Расписаны детальные шаги для миграций SalesLedger, DrawLedger, capability и dual-write; добавлены требования к dry-run/CI артефактам инвентаризации и зафиксирован свежий прогон `run_migration_checks.sh` (Готово 27, В работе 24, артефакты в `tmp/`). | Supra refactoring bot |
| 2026-03-25 | Прогнан `run_migration_checks.sh` (Готово 27, В работе 24), JSON-отчёты обновлены в `tmp/move_struct_inventory.json` и `tmp/migration_plan_status.json`. | Supra refactoring bot |
| 2026-03-24 | Сводка статусов упрощена и подтверждена после прогона run_migration_checks.sh (Готово 27, В работе 24). | Supra refactoring bot |
| 2026-03-24 | Повторно прогнан `run_migration_checks.sh`, JSON-отчёты сохранены в `tmp/` и сводка статусов подтверждена без расхождений. | Supra refactoring bot |
| 2026-03-23 | Сводка статусов синхронизирована с таблицей (Готово 27, В работе 24) после прогона run_migration_checks.sh. | Supra refactoring bot |
| 2026-03-22 | Добавлены Move-тесты `lottery_factory::factory_migration_tests`, покрывающие импорт `LegacyFactoryState`, нормализацию `next_lottery_id` и отказ неавторизованным мигрантам, а также скрипт `SupraLottery/supra/scripts/migrate_factory_state.py`, валидирующий JSON и BCS-пейлоады для `import_existing_registry`; строка `FactoryState` переведена в статус «Готово», обновлены сводные статусы и раздел «Следующие шаги». | Supra refactoring bot |
| 2026-03-21 | `lottery_utils::history` получил batch-entry `import_existing_legacy_summaries`, тесты `history_archive_migration_tests` для импорта/rollback архивов и `history_warden_migration_tests` для возврата `HistoryWriterCap`; опубликован скрипт `SupraLottery/supra/scripts/migrate_archive_summaries.py` для BCS-энкодинга `LegacyArchiveImport` и вызова entry. Ресурсы `ArchiveLedger`, `LegacyArchive` и `HistoryWarden` переведены в статус «Готово», пересчитаны сводные статусы и контекст-резюме. | Supra refactoring bot |
| 2026-03-20 | `lottery_data::payouts` получил миграционные тесты `payouts_migration_tests`, покрывающие batch-импорт `LegacyPayoutRecord` и защиту от дубликатов, а также скрипт `SupraLottery/supra/scripts/migrate_payouts.py`, валидирующий JSON-снимки, кодирующий payload и (по желанию) запускающий `import_existing_payouts`; ресурс `PayoutLedger` переведён в статус «Готово», обновлены сводные статусы, раздел «Следующие шаги» и чек-лист. | Supra refactoring bot |
| 2026-03-19 | `lottery_data::lottery_state` получил тесты `lottery_state_migration_tests`, покрывающие импорт `LegacyLotteryRuntime` и переимпорт с обновлением pending-заявок/whitelist/VRF-параметров, а также скрипт `SupraLottery/supra/scripts/migrate_lottery_state.py`, который валидирует JSON-снимки, кодирует `vector<LegacyLotteryRuntime>` в BCS и (при необходимости) вызывает `import_existing_lotteries`; ресурс `LotteryData` переведён в статус «Готово», пересчитаны сводки и «Следующие шаги». | Supra refactoring bot |
| 2026-03-18 | `lottery_utils::history` получил тесты `history_migration_tests`, покрывающие batch-импорт `LegacyHistoryRecord` и восстановление dual-write ожиданий, а также скрипт `SupraLottery/supra/scripts/migrate_history.py`, кодирующий `vector<LegacyHistoryRecord>` и вызывающий `import_existing_history_batch`; `HistoryCollection` переведён в статус «Готово», обновлены сводные статусы и «Следующие шаги». | Supra refactoring bot |
| 2026-03-17 | `lottery_rewards_engine::referrals` получил тесты `referrals_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_referrals.py`, кодирующий `LegacyReferralLottery`/`LegacyReferralRegistration` в BCS и вызывающий batch-entry; `ReferralState` переведён в статус «Готово», обновлены сводные статусы и «Следующие шаги». | Supra refactoring bot |
| 2026-03-16 | `lottery_rewards_engine::vip` получил тесты `vip_migration_tests`, helper `vip_config_for_tests` и скрипт `SupraLottery/supra/scripts/migrate_vip.py`, который валидирует JSON и кодирует `vector<LegacyVipLottery>` перед вызовом `import_existing_lotteries`; ресурс `VipState` переведён в статус «Готово», обновлены сводные статусы и «Следующие шаги». | Supra refactoring bot |
| 2026-03-15 | `lottery_rewards_engine::autopurchase` получил тесты `autopurchase_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_autopurchase.py`, кодирующий `vector<LegacyAutopurchasePlan>` и вызывающий `import_existing_plans`; ресурс `AutopurchaseState` переведён в статус «Готово», пересчитаны сводные статусы и обновлён раздел «Следующие шаги». | Supra refactoring bot |
| 2026-03-14 | `lottery_rewards_engine::jackpot` получил тесты `jackpot_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_jackpot.py`, который кодирует `vector<LegacyJackpotRuntime>` и запускает entry `import_existing_jackpots`; ресурс `JackpotState` переведён в статус «Готово», обновлены сводка статусов и раздел «Следующие шаги». | Supra refactoring bot |
| 2026-03-13 | `lottery_data::treasury_multi` получил тесты `treasury_multi_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_treasury_multi.py`, кодирующий `LegacyMultiTreasuryState` и `LegacyMultiTreasuryLottery`; ресурс `TreasuryState` переведён в статус «Готово», обновлены сводные статусы и «Следующие шаги». | Supra refactoring bot |
| 2026-03-11 | `lottery_data::vrf_deposit` получил тесты `vrf_deposit_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_vrf_deposit.py`, кодирующий `LegacyVrfDepositLedger` и запускающий `import_existing_ledger`; ресурс `VrfDepositLedger` переведён в статус «Готово», пересчитаны сводные статусы и обновлены «Следующие шаги». | Supra refactoring bot |
| 2026-03-12 | `lottery_rewards_engine::store` получил тесты `store_migration_tests`, helper `treasury_multi::bootstrap_control_for_tests` и скрипт `SupraLottery/supra/scripts/migrate_store.py`, валидирующий `LegacyStoreItem` и вызывающий batch-entry; ресурс `StoreState` переведён в статус «Готово», сводка статусов и «Следующие шаги» обновлены. | Supra refactoring bot |
| 2026-03-10 | `lottery_utils::migration` получил тесты `lottery_utils::migration_migration_tests`, helper `migration_snapshot_for_test`, а также скрипты `SupraLottery/supra/scripts/migration_session_control.sh` и `SupraLottery/supra/scripts/migrate_migration_ledger.py`, что позволило перевести `MigrationLedger` и `MigrationSession` в статус «Готово» и обновить сводку/следующие шаги. | Supra refactoring bot |
| 2026-03-09 | `lottery_data::automation` получил тесты `automation_migration_tests` и утилиту `SupraLottery/supra/scripts/migrate_automation_registry.py`, которая кодирует `vector<LegacyAutomationBot>` и запускает `import_existing_bots`; ресурс `AutomationRegistry` переведён в статус «Готово», обновлены сводные статусы, «Следующие шаги» и контекст-резюме. | Supra refactoring bot |
| 2026-03-08 | `lottery_data::rounds` получил тесты `rounds_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_rounds.py`, кодирующий `LegacyRoundRecord` и очереди pending; ресурс `RoundCollection` переведён в статус «Готово», обновлены сводные статусы и контекст-резюме. | Supra refactoring bot |
| 2026-03-07 | `lottery_data::treasury` получил тесты `treasury_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_vaults.py`, кодирующий `LegacyVaultState` и запускающий `import_existing_vaults`; ресурс `Vaults` переведён в статус «Готово», обновлены сводные статусы и контекст-резюме. | Supra refactoring bot |
| 2026-03-06 | `lottery_data::instances` получил тесты `instances_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_instances.py`, кодирующий `vector<LegacyInstanceRecord>` и вызывающий `import_existing_instances`; ресурс `LotteryCollection` переведён в статус «Готово», обновлены сводные статусы и контекст-резюме. | Supra refactoring bot |
| 2026-03-05 | `lottery_data::cancellations` получил набор тестов `cancellations_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_cancellations.py`, кодирующий `vector<LegacyCancellationRecord>` и вызывающий batch-import; ресурс `CancellationRecord` переведён в статус «Готово», обновлены сводные статусы и «Следующие шаги». | Supra refactoring bot |
| 2026-03-04 | `lottery_data::operators` получил Move-тесты `operators_migration_tests` и скрипт `SupraLottery/supra/scripts/migrate_operator_registry.py`, который кодирует `vector<LegacyOperatorRecord>` и может вызвать `import_existing_operator_records`; ресурс `LotteryOperators` переведён в статус «Готово», пересчитаны сводные статусы. | Supra refactoring bot |
| 2026-03-03 | `lottery_utils::feature_flags` получил модульные тесты `feature_flags_migration_tests`, подтверждающие перенос payload'ов `LegacyFeatureRegistry` и `LegacyFeatureRecord`, а также скрипт `SupraLottery/supra/scripts/migrate_feature_flags.py`, кодирующий снапшоты в BCS и вызывающий `import_existing_registry`; `FeatureRegistry` переведён в статус «Готово», пересчитаны статусы. | Supra refactoring bot |
| 2026-03-02 | `lottery_data::access` получил набор тестов `access_migration_tests`, подтверждающих импорт `LegacyRoleStore` и очистку индексов, а также утилиту `SupraLottery/supra/scripts/migrate_role_store.py`, кодирующую JSON-снимок в BCS и вызывающую `import_existing_role_store`; ресурс `RoleStore` переведён в статус «Готово», обновлены сводные счётчики. | Supra refactoring bot |
| 2026-03-01 | `MetadataRegistry` признан готовым: добавлены Move-тесты `lottery_utils::metadata_migration_tests`, опубликован скрипт `SupraLottery/supra/scripts/migrate_metadata_registry.py` с генерацией payload `LegacyMetadataImport`, обновлены сводка статусов и раздел «Следующие шаги». | Supra refactoring bot |
| 2026-02-28 | Добавлен entry `lottery_gateway::gateway::migrate_lottery_registry`, вспомогательная функция `registry::import_existing_registry_payload` и Move-тесты `gateway_registry_migration_tests`, позволяющие подтвердить миграцию реестра фасада; статус ресурса обновлён до `Готово`. | Supra refactoring bot |
| 2026-02-27 | Добавлены Move-тесты `lottery_gateway::gateway_ready_tests` и `lottery_utils::history_ready_tests`, которые подтверждают готовность фасада, синхронизацию с `instances` и необходимость выдачи `HistoryWriterCap` перед `history::ready`; обновлены контекст-резюме и карта миграции. | Supra refactoring bot |
| 2026-02-26 | Добавлен скрипт `SupraLottery/supra/scripts/payout_migration_check.sh`, обновлены действия по миграции `PayoutLedger`, раздел «Следующие шаги» и контекст использования health/view-флагов для dry-run сверок между новым хранилищем выплат и легаси. | Supra refactoring bot |
| 2026-02-24 | Задокументирована JSON-схема `move_struct_inventory_schema.md`, `export_move_inventory.py` дополнил `schema_version` и счётчики для использования в автоматизированных проверках карты миграции. | Supra refactoring bot |
| 2026-02-25 | `automation_status.sh` и операционные инструкции переведены на view `lottery_engine::automation::{registry_snapshot, bot_status}`, чтобы мониторинг и статусная страница опирались на новую архитектуру. | Supra refactoring bot |
| 2026-02-16 | Добавлен тест `lottery_vrf_gateway::hub_tests::register_request_and_fulfill_flow`, проверяющий регистрацию лотереи, выдачу запроса, работу callback-отправителя и очистку pending-очереди для dry-run совместимости с легаси VRF. | Supra refactoring bot |
| 2026-02-15 | `lottery_engine::vrf_config` получил view `is_initialized`, чтобы перед snapshot-вызовами можно было убедиться в публикации `instances`/`lottery_state`; обновлены дата карты и шаг миграции VRF-конфигурации. | Supra refactoring bot |
| 2026-02-14 | `lottery_engine::ticketing` и `lottery_engine::lifecycle` получили view `is_initialized`, чтобы миграционные скрипты могли быстро проверять публикацию storage/rounds перед вызовом blueprint- и lifecycle-снапшотов; обновлены дата карты и шаги миграции `LotteryCollection`. | Supra refactoring bot |
| 2026-02-13 | `lottery_utils::migration` получил view `is_initialized` и `session_initialized` для проверки публикации `MigrationLedger` и `MigrationSession` перед dry-run аудитом; обновлены шаги миграции и дата карты. | Supra refactoring bot |
| 2026-02-12 | `lottery_data::cancellations` получил view `is_initialized` для быстрой проверки публикации перед импортом; обновлены дата карты и шаг миграции `CancellationRecord`. | Supra refactoring bot |
| 2026-02-11 | Добавлен view `treasury_multi::is_initialized` и обновлён шаг миграции `TreasuryState` с быстрой проверкой инициализации; дата карты миграции обновлена. | Supra refactoring bot |
| 2025-11-15 | Развёрнут каркас `lottery_data` (lottery_state, instances, rounds, operators, treasury, treasury_multi) и обновлены статусы миграции ядра. | Supra refactoring bot |
| 2025-11-16 | Сформирована базовая карта миграции с перечислением 35 ресурсов и действиями по переносу. | Supra refactoring bot |
| 2025-11-17 | Переведён `SalesLedger` в статус `В работе`: добавлен модуль `lottery_engine::sales`, обновлены сводка статусов и следующий шаг по поддержке батчей. | Supra refactoring bot |
| 2025-11-18 | Переведён `DrawLedger` в статус `В работе`: добавлен модуль `lottery_engine::draw` с запросом VRF и событиями завершения, обновлены сводка статусов и план миграции VRF. | Supra refactoring bot |
| 2025-11-19 | Добавлен модуль `lottery_engine::vrf_config`, обновлены события `lottery_data::lottery_state` и описание миграции VRF-параметров. | Supra refactoring bot |
| 2025-11-20 | Расширен `lottery_engine::sales` батчевыми покупками и обновлены шаги миграции `SalesLedger` и раздел «Следующие шаги». | Supra refactoring bot |
| 2025-11-21 | Развёрнуты `lottery_data::vrf_deposit` и `lottery_engine::vrf`, обновлён контроль паузы запросов и статусы миграции VRF-депозита. | Supra refactoring bot |
| 2025-11-22 | Добавлены события владельцев `lottery_data::instances`, реализован `lottery_engine::operators`, обновлены шаги миграции ролей. | Supra refactoring bot |
| 2025-11-23 | Реализован модуль `lottery_engine::lifecycle` и функции `instances::set_active`; обновлены сводка статусов и описание миграции `LotteryCollection`. | Supra refactoring bot |
| 2025-11-24 | Добавлены `lottery_data::payouts` и `lottery_engine::payouts`, обновлены статусы миграции `PayoutLedger` и план действий по переносу выплат. | Supra refactoring bot |
| 2025-11-25 | Реализованы `lottery_data::cancellations` и `lottery_engine::cancellation`, добавлен сценарий миграции записей отмен и обновлена сводка статусов. | Supra refactoring bot |
| 2025-11-26 | Модули `lottery_engine`/`lottery_data` обновлены на рекурсивные хелперы без циклов, чтобы соблюсти синтаксис Move v1 и устранить риски при миграции `SalesLedger`, `DrawLedger` и `PayoutLedger`. | Supra refactoring bot |
| 2025-11-27 | Добавлены `lottery_data::automation` и `lottery_engine::automation`, что позволяет переносить реестр ботов и capability cron с событиями dry-run/тикета; обновлены статусы миграции и чек-лист. | Supra refactoring bot |
| 2025-11-28 | Создан пакет `lottery_gateway` с фасадом `gateway`, зафиксирован переход `lottery_multi::lottery_registry` в статус `В работе` и расширены шаги миграции `Registry`/`CancellationRecord`. | Supra refactoring bot |
| 2025-11-29 | Добавлен пакет `lottery_rewards_engine` с модулем `treasury`, обновлён `lottery_engine::sales` и уточнена миграция `TreasuryState`/`SalesLedger` для распределения BPS. | Supra refactoring bot |
| 2025-11-30 | Реализованы `lottery_data::jackpot` и `lottery_rewards_engine::jackpot`, обновлены статусы миграции VRF-джекпота и действия по dry-run запросов/fulfill с мульти-трежери. | Supra refactoring bot |
| 2025-12-01 | Добавлены функции автопокупок: `lottery_rewards_engine::autopurchase`, обновлены `lottery_engine::sales`, `lottery_data::treasury` и `lottery_data::rounds` для работы с cap и предоплаченными продажами; статусы миграции `AutopurchaseState` и capability переведены в `В работе`. | Supra refactoring bot |
| 2025-12-03 | Реализован модуль `lottery_rewards_engine::vip` с управлением подписками и событиями, обновлены статусы миграции `VipState`/`VipAccess` и добавлен шаг подготовки переноса подписок. | Supra refactoring bot |
| 2025-12-04 | Добавлен модуль `lottery_rewards_engine::store`, обновлены статусы миграции магазина и capability, расширены «Следующие шаги» и чек-лист транзакций. | Supra refactoring bot |
| 2025-12-15 | `lottery_rewards_engine::vip` расширен payloadом `LegacyVipLottery`, обновлены шаги миграции `VipState` и таблица соответствий, чтобы скрипты могли импортировать конфиги и подписки без повторных оплат. | Supra refactoring bot |
| 2025-12-16 | `lottery_rewards_engine::referrals` получил payloadы `LegacyReferralLottery`/`LegacyReferralRegistration`, обновлены действия миграции `ReferralState`, добавлен шаг в чек-лист и журнал прогресса. | Supra refactoring bot |
| 2025-12-17 | `lottery_rewards_engine::jackpot` расширен payloadом `LegacyJackpotRuntime` и admin-entry `import_existing_jackpot(s)`, `lottery_data::jackpot` получил helper восстановления состояния; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-18 | `lottery_data::payouts` получил структуру `LegacyPayoutRecord` и admin-entry `import_existing_payout(s)` для восстановления победителей, статусов и событий без повторных выплат; обновлены действия миграции `PayoutLedger`, раздел «Следующие шаги» и инвентаризация структур. | Supra refactoring bot |
| 2025-12-19 | `lottery_data::instances` получил payload `LegacyInstanceRecord` и admin-entry `import_existing_instance(s)`, которые восстанавливают владельцев, активность и счётчики проданных билетов с переэмитом снапшотов; обновлены карта миграции, детальный план и инвентаризация структур. | Supra refactoring bot |
| 2025-12-20 | `lottery_data::operators` получил payload `LegacyOperatorRecord` и admin-entry `import_existing_operator_record(s)` для восстановления владельцев и операторов без обращения к легаси-пакетам; обновлены карта миграции, детальный план и инвентаризация структур. | Supra refactoring bot |
| 2025-12-21 | `lottery_data::treasury_multi` получил payload'ы `LegacyMultiTreasuryState`/`LegacyMultiTreasuryLottery` и admin-entry для импорта глобальных получателей, долей BPS и локальных балансов; обновлены карта миграции, детальный план и структурный инвентарь. | Supra refactoring bot |
| 2025-12-22 | `lottery_data::treasury` получил структуры `LegacyVaultConfig`/`LegacyVaultRecipients`, payload `LegacyVaultState` и admin-entry `import_existing_vaults`, что позволяет переносить конфигурацию и получателей без повторных переводов; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-23 | `lottery_data::rounds` получил payload `LegacyRoundRecord` и admin-entry `import_existing_round(s)` плюс функции `import_pending_history_records`/`import_pending_purchase_records`, что позволяет восстанавливать раунды и очереди без запуска legacy-процессов; обновлены карта миграции и структурный отчёт. | Supra refactoring bot |
| 2025-12-24 | `lottery_data::lottery_state` получил payload `LegacyLotteryRuntime` и admin-entry `import_existing_lottery(ies)`, что позволяет разворачивать тикеты, VRF-конфигурацию и whitelists без повторных продаж и переэмитить события `LotterySnapshotUpdatedEvent`/`Vrf*Updated`; обновлены карта миграции, план и структурный отчёт. | Supra refactoring bot |
| 2025-12-25 | `lottery_data::cancellations` получил payload `LegacyCancellationRecord` и admin-entry `import_existing_cancellation(s)`, поэтому исторические причины отмен и суммы продаж можно переносить из devnet/testnet архивов, dry-run отчётов или ручных констант без повторного вызова `lottery_engine::cancellation`; обновлены карта миграции, план, чек-лист и структурный отчёт. | Supra refactoring bot |
| 2025-12-26 | `lottery_data::vrf_deposit` получил payload `LegacyVrfDepositLedger` и admin-entry `import_existing_ledger`, что позволяет переносить конфигурацию, баланс и флаги паузы из devnet/testnet архивов, dry-run отчётов или ручных констант без доступа к legacy-пакетам; обновлены карта миграции, план, чек-лист и структурный отчёт. | Supra refactoring bot |
| 2025-12-27 | Таблица миграции дополнена ресурсом `FeatureSwitchAdminCap`, обновлены счётчики статусов, раздел «Следующие шаги» (capability) и указание на контроль фичей через `lottery_utils::feature_flags`. | Supra refactoring bot |
| 2025-12-28 | Уточнены строки `legacy_bridge::DualWriteControl`/`MirrorConfig`, добавлены требования по dry-run dual-write перед выводом legacy-моста и обновлена дата документа. | Supra refactoring bot |
| 2025-12-29 | Добавлен шаг миграции dual-write контроля (`legacy_bridge::DualWriteControl` → `lottery_utils::history::DualWriteControl`), обновлена дата документа и расширен чек-лист capability/dual-write сценариев. | Supra refactoring bot |
| 2026-01-24 | `lottery_data::treasury` получил snapshot-view `caps_ready`/`control_snapshot` для проверки наличия `AutopurchaseTreasuryCap` и `LegacyTreasuryCap` перед миграцией; обновлены дата карты и шаг переноса `TreasuryV1Control`. | Supra refactoring bot |
| 2026-01-25 | `lottery_data::treasury` получил snapshot-view `token_state_snapshot`, позволяющий dry-run проверку адреса metadata и наличия mint/burn/transfer ref перед переносом токена; обновлены дата карты и шаг миграции `TokenState`. | Supra refactoring bot |
| 2026-01-26 | `lottery_data::rounds` получил snapshot-view `caps_ready`/`control_snapshot`, позволяющие dry-run проверку наличия `HistoryWriterCap`/`AutopurchaseRoundCap` и администратора перед переносом capability; обновлена дата карты и строка `RoundControl`. | Supra refactoring bot |
| 2026-01-27 | `lottery_rewards_engine::autopurchase` получил snapshot-view `access_snapshot`, обновлён шаг миграции `AutopurchaseAccess` для dry-run проверки наличия cap без обращения к legacy-пакетам. | Supra refactoring bot |
| 2026-01-28 | `lottery_engine::ticketing` получил snapshot-view `blueprint_snapshot`/`blueprint_snapshots`, позволяющие dry-run сверку владельца, цены билета и авто-дро без обращения к legacy-пакетам; обновлена дата карты и шаг миграции `LotteryCollection`. | Supra refactoring bot |
| 2026-01-29 | `lottery_engine::lifecycle` получил snapshot-view `lifecycle_snapshot(s)`, агрегирующие активность инстанса, draw-флаги и pending VRF из storage/rounds для dry-run сверки паузы и расписаний; обновлены дата карты и шаг миграции `LotteryCollection`. | Supra refactoring bot |
| 2026-01-30 | `lottery_utils::migration` получил snapshot-view `session_snapshot` для контроля наличия `InstancesExportCap` и `LegacyTreasuryCap` перед миграцией; обновлена дата карты и строка `MigrationSession`. | Supra refactoring bot |
| 2026-02-02 | `lottery_engine::vrf` получил алиасы view `ledger_snapshot`/`is_initialized`, чтобы dry-run аудит депозита VRF можно было проводить через сервисный модуль; обновлена дата карты и шаг миграции `VrfDepositLedger`. | Supra refactoring bot |
| 2026-02-06 | `lottery_gateway::history` получил view `is_initialized`, а карта миграции дополнена требованием проверять публикацию ресурса перед импортом/сверкой снапшотов. | Supra refactoring bot |
| 2026-02-07 | `lottery_rewards_engine::autopurchase` и `referrals` получили view `is_initialized`, карта миграции дополнена шагами dry-run проверки публикации ресурсов перед импортом/снимками. | Supra refactoring bot |
| 2026-02-08 | `lottery_rewards_engine::payouts` получил view `is_initialized`, что позволяет миграционным скриптам через сервисный слой проверять публикацию `PayoutLedger` перед использованием snapshot/view; обновлена дата карты и шаг миграции `PayoutLedger`. | Supra refactoring bot |
| 2026-02-16 | В workspace добавлен целевой пакет `lottery_vrf_gateway` с модулем `hub`, который включает миграционные entry `import_existing_state`/`migrate_lottery_vrf_gateway_state`, view `is_initialized`/`hub_snapshot`/`callback_sender_status` и события регистрации/VRF-запросов для dry-run аудита; статус карты `HubState` оставлен «В работе», но теперь доступен новый namespace для миграции с сохранением адреса. | Supra refactoring bot |
| 2026-02-17 | Фабрика переведена на `lottery_vrf_gateway::hub`, чтобы регистрация лотерей и smoke-тесты фабрики работали через целевой VRF-gateway; обновлена строка карты миграции для `FactoryState`. | Supra refactoring bot |
| 2026-02-18 | Легаси-пакеты `lottery_core` и `lottery_multi` теперь используют `lottery_vrf_gateway` вместо `vrf_hub`, чтобы dry-run тесты и миграционные сценарии работали через целевой VRF-хаб и таблицы. | Supra refactoring bot |
| 2026-02-19 | `lottery_vrf_gateway::hub` получил view `lottery_snapshot` и `request_snapshot` для точечной dry-run сверки регистраций и VRF-заявок (metadata, активность, payload/хэш, pending-флаг) без полного snapshot хаба; обновлена строка `HubState`. | Supra refactoring bot |
| 2026-02-20 | `lottery_data::cancellations` получил view `ready` и точечный `record_snapshot`, а health-снимок фасада расширен флагом `cancellations_ready`, чтобы dry-run миграции могли проверять публикацию ресурса и отдельные записи перед переносом; обновлена строка `CancellationRecord`. | Supra refactoring bot |
| 2026-02-21 | `lottery_data::payouts` получил view `ready` и точечный `payout_record_snapshot`, а `lottery_gateway::health::rewards_ready` теперь использует новый флаг для dry-run сверки `PayoutLedger`; обновлена строка миграции `PayoutLedger`. | Supra refactoring bot |
| 2026-02-23 | `lottery_data::rounds` получил view `ready`, который проверяет публикацию `RoundRegistry`, `RoundControl`, очередей истории/покупок и валидность pending-записей; `lottery_gateway::health::queues_ready` использует новый флаг, а тест `rounds_ready_flow` покрывает сценарии миграции очередей. | Supra refactoring bot |
| 2026-02-22 | `lottery_data::jackpot` получил view `ready`, тестовые helper'ы и модульные тесты, `lottery_rewards_engine::jackpot` проксирует новый флаг, а `lottery_gateway::health::rewards_ready` учитывает проверку регистра джекпотов; обновлена строка `JackpotState` в карте миграции. | Supra refactoring bot |
| 2026-02-10 | `lottery_data::automation` получил view `is_initialized`, а `lottery_engine::automation` — алиас, что позволяет миграционным скриптам проверять публикацию реестра ботов перед вызовом snapshot/view; обновлены дата карты и шаг миграции `AutomationRegistry`. | Supra refactoring bot |
| 2026-02-09 | `lottery_data::jackpot` получил view `is_initialized`, а `lottery_rewards_engine::jackpot` — алиас, что позволяет миграционным скриптам быстро проверять публикацию реестра джекпота перед импортом и использованием snapshot-view; обновлена дата карты и шаг миграции `JackpotState`. | Supra refactoring bot |
| 2026-02-05 | `lottery_data::payouts` получил view `is_initialized`, а `lottery_engine::payouts` — алиас к нему, чтобы миграционные скрипты могли проверять публикацию `PayoutLedger` перед вызовом snapshot/view; обновлены дата карты и шаг миграции `PayoutLedger`. | Supra refactoring bot |
| 2026-02-04 | `lottery_engine::cancellation` получил alias view `is_initialized`/`ledger_snapshot`, чтобы dry-run аудит отмен можно было делать через сервисный слой без прямого обращения к `lottery_data`; обновлены дата карты и шаг миграции `CancellationRecord`. | Supra refactoring bot |
| 2026-02-03 | `lottery_engine::operators` получил alias view `registry_snapshot`, чтобы dry-run аудит владельцев и операторов можно было делать без прямого обращения к `lottery_data`; обновлены дата карты и шаг миграции операторов. | Supra refactoring bot |
| 2026-02-01 | `lottery_utils::metadata` получил view `registry_snapshot`, позволяющий безопасно экспортировать снапшот реестра метаданных даже без опубликованного состояния; обновлена дата карты и шаг миграции `MetadataRegistry`. | Supra refactoring bot |
| 2026-01-23 | `lottery_engine::automation` получил view `registry_snapshot`/`bot_status`/`operators`, чтобы dry-run миграции реестра ботов и capability можно было сверять без обращения к legacy-коду; обновлена дата карты и шаг переноса AutomationRegistry. | Supra refactoring bot |
| 2026-01-22 | `lottery_rewards_engine::jackpot` получил snapshot-view `registry_snapshot`/`lottery_snapshot`/`runtime_view`/`runtime_views`, чтобы dry-run миграции джекпота можно было сверять без обращения к `lottery_data`; обновлена дата карты и шаги миграции джекпота. | Supra refactoring bot |
| 2026-01-21 | `lottery_utils::migration` получил view `ledger_snapshot` с агрегированным списком лотерей и записей прогресса для dry-run аудита миграции; обновлена дата карты и строка `MigrationLedger`. | Supra refactoring bot |
| 2026-01-20 | Добавлены snapshot-view `vrf_config_snapshot`/`vrf_config_snapshots` для аудита газовых лимитов, whitelist и pending-заявок VRF, обновлены строка карты миграции и дата актуальности. | Supra refactoring bot |
| 2026-01-05 | Добавлены миграционные alias `migrate_factory_state` и `migrate_lottery_vrf_gateway_state`, статусы фабрики и VRF-хаба переведены в `В работе`, сводные счётчики обновлены. | Supra refactoring bot |
| 2026-01-06 | Добавлен снапшот реестра ценовых фидов (`registry_snapshot`) для dry-run аудита миграции `PriceFeedRegistry`, план дополнен шагом сверки записей после импорта. | Supra refactoring bot |
| 2026-01-07 | Добавлены view-снимки очередей `PendingHistoryQueue` и `PendingPurchaseQueue` в `lottery_data::rounds`, таблица миграции обновлена инструкциями по dry-run аудиту очередей. | Supra refactoring bot |
| 2026-01-08 | Реализован снапшот `operators::registry_snapshot` для миграционного аудита владельцев и операторов; обновлены дата, действия по миграции операторов и журнал изменений. | Supra refactoring bot |
| 2026-01-09 | `lottery_engine::payouts` получил view `ledger_snapshot`/`lottery_snapshot` для dry-run аудита миграции выплат; обновлены строка `PayoutLedger` и дата актуальности карты миграции. | Supra refactoring bot |
| 2026-01-10 | Добавлены view `vrf_deposit::is_initialized`/`ledger_snapshot` и обновлён план миграции депозита VRF для dry-run сверки конфигурации и статуса без обращения к legacy-коду. | Supra refactoring bot |
| 2026-01-11 | Добавлены view `runtime_snapshot`/`state_snapshot` в `lottery_data::lottery_state` для dry-run аудита билетов, whitelist и VRF-параметров; обновлена дата актуальности карты миграции. | Supra refactoring bot |
| 2026-01-12 | Добавлены view-атрибуты для снапшотов наград (`autopurchase::snapshot`, `store::get_store_snapshot`, `vip::get_vip_snapshot`, `referrals::get_referral_snapshot`) и отражены соответствующие шаги dry-run аудита в карте миграции. | Supra refactoring bot |
| 2026-01-13 | `lottery_data::cancellations` получил view `ledger_snapshot`, обновлён шаг миграции отмен с dry-run сверкой сумм продаж и блокировок джекпота, дата актуальности карты перенесена. | Supra refactoring bot |
| 2026-01-14 | Добавлены view `lottery_rewards_engine::treasury::{state_snapshot, lottery_config, recipients}` и хелперы `treasury_multi::{has_state, has_lottery}` для dry-run аудита долей BPS и получателей мульти-трежери; карта миграции обновлена новым шагом проверки. | Supra refactoring bot |
| 2026-01-15 | `lottery_data::instances` получил view `registry_snapshot`/`instance_snapshot` для dry-run сверки admin/hub и записей реестра перед миграцией; дата актуальности обновлена, строка `LotteryCollection` дополнена шагом аудита. | Supra refactoring bot |
| 2026-01-16 | `lottery_data::rounds` получил view `is_initialized`/`registry_snapshot`/`round_snapshot` и сборку runtime-срезов билетов, draw-флагов и pending-запросов для dry-run аудита миграции раундов; обновлены шаги миграции `RoundCollection` и дата актуальности карты. | Supra refactoring bot |
| 2026-01-17 | `lottery_rewards_engine::payouts` получил view `ledger_snapshot`/`lottery_snapshot`, позволяющие вызывать dry-run аудит выплат из сервисного модуля; обновлена дата актуальности карты миграции и уточнён шаг проверки `PayoutLedger`. | Supra refactoring bot |
| 2026-01-18 | Добавлены snapshot-view `sales_snapshot`/`sales_snapshots` в `lottery_engine::sales`, обновлено описание шага dry-run сверок `SalesLedger` в карте миграции и дата актуальности. | Supra refactoring bot |
| 2026-01-19 | `lottery_engine::draw` получил view `draw_snapshot`/`draw_snapshots` для dry-run аудита VRF-запросов и счётчиков draw; обновлён шаг миграции `DrawLedger` и дата карты. | Supra refactoring bot |
| 2025-12-30 | Проведён аудит legacy `JackpotAccess`, добавлены детальные требования по его переносу, новая задача в чек-листе и обновлена дата документа. | Supra refactoring bot |
| 2025-12-31 | Реализован `lottery_utils::history::DualWriteControl` с payload `LegacyDualWriteState`, view `dual_write_status`/`pending_expected_hashes` и entry `init_dual_write`; статус ресурса переведён в `В работе`, обновлены сводка и план миграции dual-write. | Supra refactoring bot |
| 2026-01-01 | Добавлен `lottery_data::access::RoleStore` с payload'ами для payout/partner/premium cap и admin-entry импорта, обновлены статусы миграции RoleStore и сводка. | Supra refactoring bot |
| 2026-01-02 | Реализован `lottery_rewards_engine::nft` с событиями mint/burn, снапшотами владельцев и импортом `LegacyBadgeAuthority`; статус `BadgeAuthority` переведён в `В работе`, обновлена сводка и инструкции миграции NFT-наград. | Supra refactoring bot |
| 2026-01-04 | Добавлен `lottery_gateway::history` с событиями и импортом `LegacyHistoryImport`, фасад пишет записи при создании и отмене; статус `LotteryHistory` переведён в `В работе`, обновлены сводка статусов и требования по миграции cap `JackpotAccess`. | Supra refactoring bot |
| 2026-01-03 | Добавлены `history::ArchiveLedger` и `history::LegacyArchive` с admin-entry для импорта архивов, dual-write проверками и зеркалированием BCS-сводок, статусы переводов архивов обновлены в таблице и сводке. | Supra refactoring bot |
| 2025-12-05 | Реализован `lottery_utils::history` с синхронизацией очереди `rounds::PendingHistoryQueue`; статусы `HistoryCollection` и `HistoryWarden` переведены в `В работе`, обновлены «Следующие шаги» и требования по dry-run миграции истории. | Supra refactoring bot |
| 2025-12-06 | Добавлен `lottery_utils::metadata`, обновлены статусы миграции `MetadataRegistry`, расширена сводка и список следующих шагов. | Supra refactoring bot |
| 2025-12-07 | Реализован `lottery_utils::migration`, обновлены статусы `MigrationLedger` и `MigrationSession`, добавлены функции извлечения capability и обновлён чек-лист. | Supra refactoring bot |
| 2025-12-08 | Фасад `lottery_gateway::gateway` получил view-функции для snapshot, списка лотерей и индекса владельцев, что подготавливает миграцию `lottery_multi::lottery_registry`. | Supra refactoring bot |
| 2025-12-09 | Добавлен модуль `lottery_gateway::registry`, включающий снапшоты `LotteryRegistrySnapshotUpdatedEvent` и синхронизацию с фасадом при создании/импорте/отмене лотерей; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-10 | `lottery_utils::metadata` получил структуру `LegacyMetadataImport` и batch-entry для импорта исторических записей, обновлена карта миграции и план. | Supra refactoring bot |
| 2025-12-11 | `lottery_utils::history` расширен структурой `LegacyHistoryRecord` и admin-entry для импорта архивных розыгрышей; обновлены карта миграции и план. | Supra refactoring bot |
| 2025-12-13 | `lottery_rewards_engine::autopurchase` получил структуру `LegacyAutopurchasePlan` и admin-entry для импорта планов, обновлены шаги миграции и сводка статусов. | Supra refactoring bot |
| 2025-12-14 | `lottery_rewards_engine::store` расширен структурой `LegacyStoreItem` и admin-entry `import_existing_item(s)` для переноса каталога, остатков и счётчиков продаж; обновлены шаги миграции магазина и раздел «Следующие шаги». | Supra refactoring bot |
