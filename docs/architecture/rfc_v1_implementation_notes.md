# RFC v1 Implementation Notes

> ⚠️ Шаблон заполняется на русском языке. Комментарии внутри таблиц следует очищать по мере перехода к рабочей эксплуатации.

## 1. Сводка статуса по этапам

| Этап | Диапазон задач (см. [план параллельных лотерей](./lottery_parallel_plan.md)) | Статус \(Not Started / In Progress / Done\) | Основные комментарии | Дата обновления |
|------|--------------------------------------------------------------------------------|----------------------------------------------|----------------------|-----------------|
| 0    | Подготовка архитектуры, согласование RFC, публикация книги проекта             | Done               | Архитектура согласована, книга проекта опубликована | 2025-11-09 |
| 1    | Фундаментальные артефакты: схемы ресурсов, событий, view и документации        | Done               | Сформированы ключевые модули (`registry`, `sales`, `draw`, `payouts`, `automation`, `price_feed`), добавлены view `get_lottery`/`list_active`/`list_by_*`, обновлены unit-тесты жизненного цикла и документация | 2025-11-10 |
| 2    | Миграции, capabilities, тестовая инфраструктура и мониторинг VRF-депозита      | Done               | Завершены `winner_tests`, dual-write контроль и проверки VRF-депозита; подготовлены миграционные инструменты и Prover-спеки | 2025-11-12 |
| 3    | Реализация ядра lottery_multi, партнёрских ограничений и премиальных фич       | In Progress                    | Реализованы агрегаты и события выплат (`total_*`, `PayoutBatch`, `PartnerPayout`, `PurchaseRateLimitHit`), добавлены `roles::RoleStore`, капабилити `PayoutBatchCap`/`PartnerPayoutCap`; интеграционные тесты `payouts_tests::{payout_handles_multi_slot_plan, partner_payout_cannot_exceed_cap}` и `sales_tests::{block_rate_limit_triggers, window_rate_limit_triggers, grace_window_blocks_first_purchase}` закрывают многослотные призы, остаток партнёрского бюджета и анти-DoS проверки; схема view дополнена примером `json/examples/lottery_multi_view_samples.json` и Python-валидатором; подготовлена матрица выдачи capability и политика тегов (`docs/handbook/governance/roles.md`, `docs/handbook/contracts/tags_policy.md`); добавлены on-chain рефанды через `force_refund_batch_admin`/`RefundBatchEvent`, `sales::refund_progress` и тесты `payouts_tests::{refund_batch_records_progress, refund_requires_canceled_status, refund_cannot_exceed_tickets}`; добавлены view `views::get_cancellation` и `views::get_refund_progress`, покрытые тестом `views_tests::cancellation_and_refund_views` для оперативного мониторинга отмен и возвратов; архив отмен завершается `payouts::archive_canceled_lottery_admin`, что зафиксировано тестами `payouts_tests::{archive_canceled_requires_record, archive_canceled_requires_full_refund, archive_canceled_records_summary}`; публичные view `views::list_automation_bots`/`get_automation_bot` раскрывают состояние AutomationBot и задокументированы в runbook/статусной странице | 2025-12-07 |
| 4    | Расширение пользовательских сервисов, локализация, поддержка партнёров         | In Progress           | Добавлены админ-функции `history::{import_legacy_summary_admin, rollback_legacy_summary_admin, update_legacy_classification_admin}`, события `LegacySummaryImported/RolledBack/ClassificationUpdated`, view `is_legacy_summary`, тесты `history_migration_tests` и CLI-утилита `supra/scripts/history_backfill.sh` (`dry-run`, `import`, `rollback`, `classify`, `status`, `list`) с Python-драйвером `supra.tools.history_backfill_dry_run` и pytest `tests/test_history_backfill_dry_run.py` | 2025-11-28 |
| 5    | Наблюдаемость, автоматизация, прайс-фиды, очистка хранилища                    | In Progress        | Расширен runbook AutomationBot (dry-run, таймлоки, контроль `failure_count`), подготовлены `operations/release_checklist.md`, `operations/monitoring.md`, `operations/incident_log.md`; модуль `price_feed` получил тесты `price_feed_tests`, Prover-спеку и справочник `price_feeds.md`; добавлены Move-тесты `automation_tests` для `ensure_action` и сброса лимитов; view `status_overview` и `list_automation_bots` агрегируют статусы, VRF, выплаты и состояние AutomationBot для статусной страницы, покрыты тестами `views_tests::{status_overview_counts_vrf_and_statuses, automation_views_list_registered_bot}` и JSON Schema v1.0.3; внедрён CLI `supra/scripts/incident_log.sh` и Python-модуль `supra.tools.incident_log` для автоматизации журнала операций; реализована on-chain отмена через `registry::cancel_lottery_admin` с событием `LotteryCanceledEvent`, последующая фиксация отмены и рефандов завершается `payouts::archive_canceled_lottery_admin`; CLI `supra/scripts/refund_control.sh` объединяет сценарии `cancel/batch/progress/archive`; подготовлен CLI `supra/scripts/automation_status.sh` для проверки AutomationBot через view `list_automation_bots`/`get_automation_bot`; статусная страница и мониторинг дополнены таблицей AutomationBot | 2025-12-08 |
| 6    | Пострелизная стабилизация, баг-баунти, расширенные тесты и документация        | In Progress                                   | Подготовлены `operations/post_release_support.md`, `operations/postmortems.md`, обновлены runbook, мониторинг, статусная страница и релизный чек-лист | 2025-12-01 |
| 7    | Governance/API (перенесено на позднюю фазу)                                    | Not Started                                   |                      | _YYYY-MM-DD_ |

## 2. Прогресс по модулям Move

| Модуль | Ключевые обязанности | Текущее состояние | Ответственный | Последний апдейт |
|--------|----------------------|-------------------|---------------|------------------|
| `registry` | Жизненный цикл лотерей, статусы, идентификаторы | In Progress | Стартовая версия с тегами, событиями и блокировкой snapshot; `cancel_lottery_admin` публикует `LotteryCanceledEvent`, сохраняет `CancellationRecord` и активирует `sales::begin_refund`; тесты `config_tests::{cancel_requires_reason, cancel_records_reason}` покрывают проверку кода и запись метаданных; view `views::get_cancellation` использует `registry::get_cancellation_record` для выдачи причин отмены | 2025-12-05 |
| `sales` | Выпуск билетов, лимиты, анти-DoS | In Progress | Реализованы события `TicketPurchase`/`PurchaseRateLimitHit`, хранение чанков, выдача владельца билета через `ticket_owner`, учёт `SalesDistribution`, блоковые/оконные лимиты, grace-window; добавлены `record_payouts`, трекинг `refund_active`/`refund_round`/`RefundProgressView` и функция `record_refund_batch`; модуль `sales_tests` подтверждает срабатывание ограничений (`block_rate_limit_triggers`, `window_rate_limit_triggers`, `grace_window_blocks_first_purchase`) и их ошибки; прогресс возвратов доступен через view `views::get_refund_progress` | 2025-12-05 |
| `draw` | VRF-запросы, обработка retry, анти-bias | In Progress | Создан ledger запросов, события `VrfRequested/VrfFulfilled`, контроль retry/attempt и финализационный снимок; тесты `draw_tests` покрывают повторные запросы и окна retry, а Prover-спека `spec/draw.move` гарантирует монотонность `attempt`/`next_client_seed`, фиксацию `RETRY_STRATEGY_FIXED` и корректность `finalization_snapshot` | 2025-11-22 |
| `payouts` | Подсчёт победителей, батчи выплат, идемпотентность | In Progress | Ledger победителей, события `WinnersComputed`/`PayoutBatch` и `RefundBatchEvent`; функции выплат требуют капабилити, обновляют агрегаты, блокируются после `STATUS_FINALIZED`; добавлена on-chain отмена с `force_refund_batch_admin` и связкой `sales::record_refund_batch`; тесты `payouts_tests` покрывают лимиты, финализацию, партнёрские выплаты, многослотные призовые планы и рефанды (`payout_handles_multi_slot_plan`, `partner_payout_cannot_exceed_cap`, `refund_batch_records_progress`, `refund_requires_canceled_status`, `refund_cannot_exceed_tickets`); Prover-спека `spec/payouts.move` проверяет рост `payout_round` и отражение сумм в `sales::accounting_snapshot` | 2025-12-03 |
| `economics` | Резервы, распределение долей, джекпот | In Progress | Учёт распределения 70/15/10/5, контроль `total_operations_allocated`, проверки выплат и ошибки `E_PAYOUT_ALLOC_EXCEEDED`/`E_OPERATIONS_ALLOC_EXCEEDED`; Prover-спека `spec/economics.move` фиксирует суммы `apply_sale`, `record_*_payout` и ограничения `jackpot_allowance_token` | 2025-11-21 |
| `history` | Архивы, dual-write, снапшоты | In Progress | `ArchiveLedger`, dual-write контроль, импорт/откат наследуемых сводок; тесты `history_migration_tests` покрывают `import`/`rollback`/классификацию, добавлены события `LegacySummaryImported/RolledBack/ClassificationUpdated` и view `is_legacy_summary` | 2025-11-25 |
| `legacy_bridge` | Dual-write контроль, ожидание хэшей | In Progress | Ресурсы `DualWriteControl` и `MirrorConfig`, события `ArchiveDualWriteStarted/Completed`, функции `mirror_summary_to_legacy`/`notify_summary_written`; синхронизируется с импортом через `history_backfill.sh` (зеркалирование сводок при `import`/`classify`), view `dual_write_status`/`pending_expected_hashes`, CLI `dual_write_control.sh` | 2025-11-25 |
| `views` | Публичные API, фильтры, JSON-схемы | In Progress | Реализованы фильтры по типам и тегам, выдача бейджей, `get_lottery`, `list_active`, доступ к архивным summary и спискам финализированных ID; добавлены тесты `views_tests`, JSON Schema `docs/handbook/architecture/json/lottery_multi_views.schema.json`, пример `json/examples/lottery_multi_view_samples.json` и Python-валидатор `tests/test_view_schema_examples.py`; новые функции `get_cancellation`, `get_refund_progress`, `list_automation_bots`, `get_automation_bot` предоставляют оперативные данные об отменах, возвратах и состоянии AutomationBot | 2025-12-07 |
| `roles` | Capabilities, партнёры, премиальные подписки | In Progress | `RoleStore` теперь хранит `PayoutBatchCap`/`PartnerPayoutCap`/`PremiumAccessCap`, выдача и отзыв сопровождаются событиями и листингами `list_partner_caps`/`list_premium_caps`, добавлены `cleanup_expired_admin` и тесты `roles_tests::{partner_cap_blocks_after_expiry, admin_can_list_and_track_partner_caps, cleanup_expired_removes_caps, premium_grant_and_revoke_updates_events}`; документация пополнена матрицей выдачи/таймлоков ([roles.md](../handbook/governance/roles.md)) | 2025-11-24 |
| `tags` | Классификаторы, фильтрация, маски | In Progress | Валидация масок, ограничение по бюджету тегов, блокировка изменения тегов после `snapshot_frozen` через `registry`; добавлена политика допустимых комбинаций и ручных исключений ([tags_policy.md](../handbook/contracts/tags_policy.md)) | 2025-11-18 |
| `price_feed` | Оракулы SUPRA/USD и прочие активы | In Progress | `PriceFeedRegistry` дополнился ручным снятием клампа (`clear_clamp`), событием `PriceFeedClampClearedEvent`, тестами `price_feed_tests` и Prover-спекой `spec/price_feed.move`; подготовлен справочник [price_feeds.md](../handbook/architecture/price_feeds.md) | 2025-11-26 |
| `feature_switch` | Управление доступом к функциям | In Progress | Добавлен реестр режимов и devnet override | 2025-11-08 |
| `automation` | AutomationBot, dry-run, репутация | In Progress | Реализован модуль `automation` с регистрацией ботов, событиями dry-run/tick/error; тесты `automation_tests` покрывают лимит `max_failures`, поведение `ensure_action` и сброс pending; добавлены публичные хелперы `automation_status`/`automation_operators` для view `list_automation_bots` | 2025-12-07 |

## 3. Контроль ключевых инвариантов

| Инвариант | Инструменты проверки | Текущий статус | Комментарий |
|-----------|----------------------|----------------|-------------|
| `snapshot_hash` неизменен после `Closing` | Move Prover, unit-тесты | In Progress | Инварианты длины хэшей и заморозки добавлены в `spec/registry.move`; `spec/draw.move` фиксирует, что callback и пост-обработка не меняют снапшот, требуется общее доказательство по всем путям |
| `payout_round` строго возрастает | Move Prover | In Progress | `spec/payouts.move` проверяет рост `payout_round` и отслеживает, что партнёрские выплаты не изменяют раунд; остаётся формальное доказательство на уровне Prover |
| `allocated >= paid` во всех пулах | Move Prover, unit-тесты | In Progress | Инварианты и постусловия `spec/economics.move` фиксируют приращения `apply_sale`/`record_*_payout`; юнит-тест `lottery_multi::economics_tests` покрывает базовый сценарий, остаются интеграционные проверки |
| `jackpot_allowance_token` не увеличивается | Move Prover | In Progress | `spec/economics.move` ограничивает рост и фиксирует, что `consume_jackpot_allowance` только уменьшает токен; необходимо формальное доказательство |
| Детерминированный выбор победителей | Differential / property tests | In Progress | Юнит-тесты `winner_tests.move` сравнивают on-chain расчёт с эталонной реализацией |
| Dual-write архива остаётся консистентным | Unit-тесты, интеграционные тесты | In Progress | Юнит-тесты `history_dual_write_tests` и `history_migration_tests` закрывают зеркалирование, ручной сброс ожиданий, импорт/откат наследуемых сводок; CLI `history_backfill.sh` с командой `dry-run` (python-модуль `supra.tools.history_backfill_dry_run`, pytest `tests/test_history_backfill_dry_run.py`) автоматизирует расчёт хэшей, остаётся интегрировать внешний backfill-драйвер |

## 4. Архив и миграции

- **Legacy backfill**: ответственный Backend (А. Петров). Черновой скрипт преобразования `lottery_support::History` → `ArchiveLedger` готов; on-chain импорт выполняется через `history::import_legacy_summary_admin` и CLI `supra/scripts/history_backfill.sh` (команда `dry-run` использует Python-модуль `supra.tools.history_backfill_dry_run` и выгружает hex/хэши для журналов). Dry-run devnet перенесён на 2025-11-26, целевой запуск prod — 2025-11-29.
- **Dual-write мониторинг**: метрика `archive_dual_hash_match`, события `ArchiveDualWriteStarted/Completed`, зеркальные `LegacySummaryEvent` и журнал `dual_write.log` обновляются cron-скриптом каждые 30 минут; статус, ожидания и зеркальные записи проверяются через view `legacy_bridge::{dual_write_status, pending_expected_hashes}`, `history_bridge::get_summary` и Supra CLI (`supra/scripts/dual_write_control.sh`, команды `status`, `flags`, `pending`, `mirror`). Последняя сверка хэшей (2025-11-11 09:30 UTC) — совпадение, расхождений не обнаружено.
- **Состояние миграции `LotteryHistoryArchive`**: активная схема `ArchiveSummaryV1`, подготовлена JSON Schema v1 и чек-лист сверки; остаётся задокументировать процедуру отката и покрыть сценарий «finalize + cancel» интеграционным тестом.

## 5. Фронтенд и API

| Компонент | Зависимости от on-chain | Статус | Комментарии |
|-----------|-------------------------|--------|-------------|
| Раздел «История» | `views::list_by_primary_type`, `get_lottery_status`, JSON Schema v1 | In Progress | Тесты `views_tests` подтверждают фильтры/пагинацию; подготовлена схема `lottery_multi_views.schema.json`, пример `lottery_multi_view_samples.json` и Python-валидатор схемы; добавлено агрегированное представление `status_overview` для статусной страницы |
| Админ-конструктор | `views::validate_config`, таблица тегов, FeatureSwitch dev override | Not Started |  |
| Партнёрский мастер | Preset API, квоты песочницы, allowed tags/types | Not Started |  |
| API/индексатор | Dual-write архив, события v1 с `event_version` | In Progress | Схема ответов view добавлена, требуется связка с индексатором и миграциями | 

## 6. Операционные регламенты

- **VRF-депозит**: 2025-11-11 — runbook [operations/vrf_deposit.md](../handbook/operations/vrf_deposit.md) в рабочем режиме; Ops-инженер Н. Иванова отслеживает `effective_balance` и `required_minimum` через дашборд Grafana. Автономное возобновление запросов планируется через AutomationBot (ETA 2025-11-25); записи заносятся в [incident_log.md](../handbook/operations/incident_log.md) через `supra/scripts/incident_log.sh`.
- **AutomationBot**: последняя ротация ключей — 2025-11-08; счётчик успешных задач 24/24, предупреждений нет. Обновлённый runbook описывает dry-run, таймлоки, `ensure_action`, контроль `failure_count` и использование view `views::list_automation_bots`/`get_automation_bot`; мониторинг метрик агрегирован в [monitoring.md](../handbook/operations/monitoring.md). Требуется связка с `vrf_deposit::record_snapshot_automation` и настройка таймлоков перед запуском на prod.
- **Рефанд-процедуры**: SLA 24 часа, контрольный прогон runbook завершён 2025-11-07; on-chain батчи доступны через `payouts::force_refund_batch_admin`/`RefundBatchEvent`, прогресс мониторится `views::get_refund_progress` (обёртка над `sales::refund_progress`), причины отмен доступны через `views::get_cancellation`; остаётся интеграционный тест «force_cancel → refund» и запуск CLI-скрипта рефанда в стейджинге.
- **Прайс-фид**: `staleness_window` = 300 c, кламп фиксируется событиями `PriceFeedClampEvent`/`PriceFeedClampClearedEvent`, fallback переключается через `PriceFeedFallbackEvent`. Проверка 2025-11-26 подтвердила отсутствие активных клампов и fallback; runbook требует ручного подтверждения `clear_clamp` после расследования скачка.
- **Supra CLI**: 2025-11-09 — попытка запуска `build_lottery_packages.sh lottery_multi` завершилась ошибкой (бинарь отсутствует). Ответственный DevOps (К. Смирнов) устанавливает CLI и обновляет runbook до 2025-11-13.
- **Баг-баунти**: черновик [operations/bug_bounty.md](../handbook/operations/bug_bounty.md) опубликован, требуется финализация таблицы вознаграждений и согласование с отделом безопасности.

## 7. Журнал решений (RFC Notes)

| Дата | Решение | Область (модуль/процесс) | Следующие действия |
|------|---------|--------------------------|--------------------|
| 2025-11-16 | Включить события `ArchiveDualWriteStarted/Completed`, view `dual_write_status` и Supra CLI-скрипт для управления dual-write | `legacy_bridge`, операции миграции | Подготовить интеграционные тесты dual-write и dry-run миграции |
| 2025-11-17 | Включить зеркальную запись `mirror_summary_to_legacy` и модуль `history_bridge`, расширить Supra CLI командами `enable/disable-mirror`, `mirror` | `legacy_bridge`, `history`, операции миграции | Проверить dry-run миграции с использованием `history_bridge::get_summary` |
| 2025-11-18 | Зафиксировать лимиты AutomationBot через тесты `ensure_action` и обновить runbook наблюдаемости | `automation`, операции | Подготовить интеграционные проверки CLI и графики мониторинга `failure_count` |
| 2025-11-19 | Подготовить JSON Schema ответов view и покрыть фильтры UI тестами `views_tests` | `views`, фронтенд/API | Согласовать схему с фронтендом и индексаторами, добавить smoke-тесты REST |
| 2025-11-20 | Зафиксировать пример ответов view и Python-проверку JSON Schema | `views`, фронтенд/API | Подключить схему и пример в smoke-тесты REST и пайплайн индексатора |
| 2025-11-21 | Ввести релизный чек-лист, журнал операций и документ мониторинга | Операции, AutomationBot, dual-write | Интегрировать заполнение `incident_log.md` в Ops-процессы и согласовать баг-баунти вознаграждения |
| 2025-11-22 | Усилить Move Prover-спеки модуля `draw`: контроль retry, статуса `FULFILLED` и финализационного снимка | `draw`, VRF жизненный цикл | Провести прогон Move Prover после установки CLI, дополнить интеграционные тесты retry-стратегий |
| 2025-11-23 | Добавить view `pending_expected_hashes` и CLI-команду `pending` для контроля dual-write ожиданий | `legacy_bridge`, операции миграции | Привязать список ожиданий к процедурам backfill и автоматическому журналу dual-write |
| 2025-11-24 | Зафиксировать анти-DoS тесты продаж и многослотные партнёрские выплаты (`sales_tests`, `payouts_tests`) | `sales`, `payouts`, экономика | После установки CLI прогнать `aptos move test` для новых сценариев и обновить runbook по мониторингу rate-limit событий |
| 2025-11-25 | Добавить импорт/откат наследуемых сводок (`history_migration_tests`, `history_backfill.sh`) | `history`, `legacy_bridge`, операции миграции | Связать CLI с внешним backfill-скриптом, задокументировать dry-run и журнал ручных операций |
| 2025-11-28 | Включить Python-dry-run для `history_backfill.sh` и pytest-покрытие `tests/test_history_backfill_dry_run.py` | `history`, операции миграции | Интегрировать dry-run в внешние backfill-утилиты и автоматическое заполнение `incident_log.md` |
| 2025-11-30 | Автоматизировать ведение журнала операций через CLI и Python-модуль | Операции, документация | Подключить `supra/scripts/incident_log.sh` к внешним DevOps-плейбукам и интеграционным тестам миграций |
| 2025-11-26 | Ввести ручное снятие клампа (`clear_clamp`), события `PriceFeedClampClearedEvent`, тесты `price_feed_tests` и спецификацию `spec/price_feed.move`; опубликовать справочник `price_feeds.md` | `price_feed`, наблюдаемость | Интегрировать проверку событий клампа в мониторинг и добавить сценарий `clear_clamp` в release checklist |
| 2025-12-01 | Добавить пострелизные процедуры (`operations/post_release_support.md`, `operations/postmortems.md`), обновить runbook, мониторинг, статусную страницу и релизный чек-лист | Операции, пострелизная поддержка | Провести пилотную ретроспективу и синхронизировать roadmap этапа 6 |
| 2025-12-02 | Зафиксировать матрицу выдачи capability и политику тегов (`roles.md`, `tags_policy.md`) | Роли, классификаторы | Подключить контроль мультисиг/таймлоков в DevOps и автоматическую проверку масок в CI |
| 2025-12-03 | Перевести Dashboard на `status_overview` через хук `useLotteryMultiViews`, показывая активные розыгрыши и бэклог VRF/выплат | Фронтенд, статусная страница | Добавить smoke-тест внешнего REST-клиента и связать проверку `/lottery-multi/views` с мониторингом |
| 2025-12-04 | Включить on-chain рефанды: `sales::record_refund_batch`, `payouts::force_refund_batch_admin`, событие `RefundBatchEvent` и тесты `payouts_tests::{refund_batch_records_progress, refund_requires_canceled_status, refund_cannot_exceed_tickets}` | `sales`, `payouts`, операции рефанда | Подготовить интеграционный сценарий «cancel → refund → finalize архив» и обновить мониторинг статусной страницы |
| 2025-12-05 | Экспортировать причины отмен и прогресс рефандов через view `views::{get_cancellation, get_refund_progress}`, покрыв сценарий `cancel → refund` тестом `views_tests::cancellation_and_refund_views` | `registry`, `sales`, `views`, операции рефанда | Синхронизировать JSON Schema и статусную страницу с новыми полями, обновить мониторинг возвратов |
| 2025-12-06 | Ввести CLI `supra/scripts/refund_control.sh` для сценариев `cancel/batch/progress/archive` и задокументировать его в runbook/release checklist | Операции, `registry`, `payouts`, `views` | Согласовать dry-run скрипта с DevOps, добавить проверки CLI в пайплайн |
| 2025-12-07 | Добавить view `list_automation_bots`/`get_automation_bot`, публичные хелперы `automation_status`/`automation_operators`, обновить JSON Schema v1.0.3 и статусную страницу | `automation`, `views`, операции | Включить интеграционные проверки AutomationBot CLI и добавить наблюдение pending-действий в мониторинг |
| 2025-12-08 | Ввести CLI `supra/scripts/automation_status.sh` и обновить runbook/monitoring/status page для контроля AutomationBot через view `list_automation_bots`/`get_automation_bot` | `automation`, операции, мониторинг | Прогнать dry-run CLI на стейджинге и подключить вывод к журналу операций |

> Обновляя таблицы, не забывайте ссылаться на коммиты, PR или внешние документы. При необходимости расширяйте разделы, но сохраняйте структуру шаблона для единообразия.
