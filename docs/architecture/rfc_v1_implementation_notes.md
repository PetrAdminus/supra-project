# RFC v1 Implementation Notes

> ⚠️ Шаблон заполняется на русском языке. Комментарии внутри таблиц следует очищать по мере перехода к рабочей эксплуатации.

## 1. Сводка статуса по этапам

| Этап | Диапазон задач (см. [план параллельных лотерей](./lottery_parallel_plan.md)) | Статус \(Not Started / In Progress / Done\) | Основные комментарии | Дата обновления |
|------|--------------------------------------------------------------------------------|----------------------------------------------|----------------------|-----------------|
| 0    | Подготовка архитектуры, согласование RFC, публикация книги проекта             | Not Started                                   | Заполнить после старта работ | _YYYY-MM-DD_ |
| 1    | Фундаментальные артефакты: схемы ресурсов, событий, view и документации        | In Progress        | Расширены `types`, `registry`, `views`, добавлены `economics`, `feature_switch`, `sales`, запущен `draw` и `payouts` с VRF/победителями, внедрены анти-DoS лимиты покупок | 2025-11-09 |
| 2    | Миграции, capabilities, тестовая инфраструктура и мониторинг VRF-депозита      | Not Started                                   |                      | _YYYY-MM-DD_ |
| 3    | Реализация ядра lottery_multi, партнёрских ограничений и премиальных фич       | Not Started                                   |                      | _YYYY-MM-DD_ |
| 4    | Расширение пользовательских сервисов, локализация, поддержка партнёров         | Not Started                                   |                      | _YYYY-MM-DD_ |
| 5    | Наблюдаемость, автоматизация, прайс-фиды, очистка хранилища                    | Not Started                                   |                      | _YYYY-MM-DD_ |
| 6    | Пострелизная стабилизация, баг-баунти, расширенные тесты и документация        | Not Started                                   |                      | _YYYY-MM-DD_ |
| 7    | Governance/API (перенесено на позднюю фазу)                                    | Not Started                                   |                      | _YYYY-MM-DD_ |

## 2. Прогресс по модулям Move

| Модуль | Ключевые обязанности | Текущее состояние | Ответственный | Последний апдейт |
|--------|----------------------|-------------------|---------------|------------------|
| `registry` | Жизненный цикл лотерей, статусы, идентификаторы | In Progress | Стартовая версия с тегами, событиями и блокировкой snapshot | 2025-11-08 |
| `sales` | Выпуск билетов, лимиты, анти-DoS | In Progress | Реализованы события `TicketPurchase`/`PurchaseRateLimitHit`, хранение чанков, выдача владельца билета через `ticket_owner`, учёт `SalesDistribution`, блоковые/оконные лимиты и grace-window | 2025-11-09 |
| `draw` | VRF-запросы, обработка retry, анти-bias | In Progress | Создан ledger запросов, события `VrfRequested/VrfFulfilled`, хэш снапшота билетов, подготовка payload для winners | 2025-11-08 |
| `payouts` | Подсчёт победителей, батчи выплат, идемпотентность | In Progress | Добавлен ledger победителей, события `WinnersComputed`/`PayoutBatch`, детерминированный выбор и курсовые хэши | 2025-11-08 |
| `economics` | Резервы, распределение долей, джекпот | In Progress | Введены структуры распределения и учёта продаж | 2025-11-08 |
| `history` | Архивы, dual-write, снапшоты | In Progress | Добавлены события с версиями и checksum | 2025-11-08 |
| `views` | Публичные API, фильтры, JSON-схемы | In Progress | Реализованы фильтры по типам и тегам, выдача бейджей | 2025-11-08 |
| `roles` | Capabilities, партнёры, премиальные подписки | In Progress | Расширены PartnerCap и введён `PremiumAccessCap` | 2025-11-08 |
| `tags` | Классификаторы, фильтрация, маски | In Progress | Валидация масок, ограничение по бюджету тегов | 2025-11-08 |
| `price_feed` | Оракулы SUPRA/USD и прочие активы | In Progress | Реализован `PriceFeedRegistry` с событиями обновления/фолбэка/клампа, добавлены константы SUPRA/USDT | 2025-11-08 |
| `feature_switch` | Управление доступом к функциям | In Progress | Добавлен реестр режимов и devnet override | 2025-11-08 |
| `automation` | AutomationBot, dry-run, репутация | In Progress | Реализован модуль `automation` с регистрацией ботов, событиями dry-run/tick/error и учётом репутации | 2025-11-08 |

## 3. Контроль ключевых инвариантов

| Инвариант | Инструменты проверки | Текущий статус | Комментарий |
|-----------|----------------------|----------------|-------------|
| `snapshot_hash` неизменен после `Closing` | Move Prover, unit-тесты | In Progress | Инварианты длины хэшей и заморозки добавлены в `spec/registry.move`, требуется доказательство неизменности |
| `payout_round` строго возрастает | Move Prover | In Progress | `spec/payouts.move` теперь фиксирует длины хэшей и связь `next_winner_batch_no ≥ payout_round`, остаётся формальное доказательство роста |
| `allocated >= paid` во всех пулах | Unit-тесты, property-тесты | In Progress | Инвариант `spec/economics.move` контролирует базовое условие, нужны тесты |
| `jackpot_allowance_token` не увеличивается | Move Prover | In Progress | Инвариант `spec/economics.move` ограничивает рост, необходимо формальное доказательство |
| Детерминированный выбор победителей | Differential / property tests | Not Started |  |
| Dual-write архива остаётся консистентным | Интеграционные тесты | Not Started |  |

## 4. Архив и миграции

- **Legacy backfill**: статус, ответственный, дата завершения.
- **Dual-write мониторинг**: ссылка на логи/дашборды, результат последней сверки хэшей.
- **Состояние миграции `LotteryHistoryArchive`**: версии схемы, outstanding задачи.

## 5. Фронтенд и API

| Компонент | Зависимости от on-chain | Статус | Комментарии |
|-----------|-------------------------|--------|-------------|
| Раздел «История» | `views::list_by_primary_type`, `get_lottery_status`, JSON Schema v1 | Not Started |  |
| Админ-конструктор | `views::validate_config`, таблица тегов, FeatureSwitch dev override | Not Started |  |
| Партнёрский мастер | Preset API, квоты песочницы, allowed tags/types | Not Started |  |
| API/индексатор | Dual-write архив, события v1 с `event_version` | Not Started |  |

## 6. Операционные регламенты

- **VRF-депозит**: дата последней проверки баланса, остаток, ответственный.
- **AutomationBot**: актуальный репутационный рейтинг, дата последней ротации ключей.
- **Рефанд-процедуры**: SLA, последнее тестирование runbook.
- **Прайс-фид**: `staleness_window`, текущий статус `price clamp`.

## 7. Журнал решений (RFC Notes)

| Дата | Решение | Область (модуль/процесс) | Следующие действия |
|------|---------|--------------------------|--------------------|
| _YYYY-MM-DD_ | – | – | – |

> Обновляя таблицы, не забывайте ссылаться на коммиты, PR или внешние документы. При необходимости расширяйте разделы, но сохраняйте структуру шаблона для единообразия.
