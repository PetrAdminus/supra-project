# Контекст-резюме реструктуризации Supra Lottery

## Основные цели и требования
- Перенос легаси-пакетов (`lottery_core`, `lottery_multi`, `lottery_rewards`, `lottery_support`, `vrf_hub`, `lottery_factory`) в целевую архитектуру ядра (`lottery_data`, `lottery_engine`, `lottery_rewards_engine`, `lottery_utils`, `lottery_gateway`, `lottery_vrf_gateway`) в соответствии с подробным [планом реструктуризации](./supra_restructuring_detailed_plan.md).
- Строгое соблюдение правил Move v1: только ASCII, без `let mut`, контроль размера модулей, явные ошибки и чёткое разделение ролей между слоями (см. раздел «Жёсткие правила Move» в [плане](./supra_restructuring_detailed_plan.md)).

## Карта миграции и инструменты контроля
- Таблица соответствий и статусы ресурсов ведутся в [карте миграции](./move_migration_mapping.md); последняя фиксация — 26 ресурсов «готово», 25 «в работе», 0 «запланировано», 1 «не требуется».
- Для проверки карты используются утилиты `export_move_inventory.py` (генерирует Markdown и JSON-инвентарь) и `check_migration_mapping.py` (сверяет таблицу со сводкой и инвентарём), описанные в разделе «Быстрые проверки» [карты миграции](./move_migration_mapping.md#быстрые-проверки).
- Добавлен обёрточный скрипт `docs/architecture/tools/run_migration_checks.sh`, который запускает оба шага (экспорт и проверку) в строгом режиме и пишет артефакты в `tmp/…`, что позволяет быстро включить сверку в CI и ручные dry-run чек-листы.
- Для подготовки миграции `SalesLedger` используйте `SupraLottery/supra/scripts/sales_migration_check.sh`: он вызывает snapshot-view `lottery_engine::sales`, конфигурацию долей `lottery_rewards_engine::treasury::lottery_config` и легаси `lottery_multi::views::accounting_snapshot`, помогая сверить счётчики продаж и распределение средств перед импортом.
- Для подготовки миграции `PayoutLedger` используйте `SupraLottery/supra/scripts/payout_migration_check.sh`: он проверяет `lottery_data::payouts::ready`, выгружает снапшоты выплат через `lottery_engine::payouts`/`lottery_rewards_engine::payouts` и сравнивает их с прогрессом победителей в `lottery_multi::payouts::winner_progress`.

## Выполненные работы
1. Создан пакет `lottery_vrf_gateway` с модулем `hub`, импортными entry-функциями и view для точечных снапшотов; все легаси-пакеты и фабрика переведены на новый VRF-хаб.
2. Добавлены агрегированные health-view (`lottery_gateway::health`) и многочисленные readiness/snapshot view в `lottery_data`, `lottery_rewards_engine`, `lottery_utils`, покрывающие automation, cancellations, payouts, jackpot, history, rounds, gateway и операторы.
3. Для каждого из указанных модулей добавлены Move-тесты, журнал изменений и инструкции в [карте миграции](./move_migration_mapping.md#журнал-изменений) с датами 2026‑02‑16 — 2026‑02‑23.
4. Согласован JSON-формат отчёта `export_move_inventory.py` (см. `docs/architecture/move_struct_inventory_schema.md`), добавлена версия схемы и агрегированные счётчики для автоматизированных проверок карты миграции.
5. Добавлены Move-тесты `lottery_gateway::gateway_ready_tests` и `lottery_utils::history_ready_tests`, которые подтверждают публикацию фасада/реестра и необходимость выдачи `HistoryWriterCap` перед `history::ready`, фиксируя готовность всех новых пакетов ядра.
6. Реализован entry `lottery_gateway::gateway::migrate_lottery_registry`, вспомогательная функция `registry::import_existing_registry_payload` и тесты `gateway_registry_migration_tests`, что позволяет переносить реестр фасада в один вызов с проверкой согласованности payload'ов.
7. `MetadataRegistry` переведён в статус «готово»: добавлены модульные тесты `lottery_utils::metadata_migration_tests`, подтверждающие импорт батчей и перезапись записей, а также Python-скрипт `SupraLottery/supra/scripts/migrate_metadata_registry.py`, который формирует payload `LegacyMetadataImport`, валидирует ASCII и может напрямую вызвать entry `import_existing_metadata_batch`.
8. Ресурс `RoleStore` отмечен готовым: модульные тесты `lottery_data::access_migration_tests` покрывают импорт всего снапшота и инкрементальные операции, а скрипт `SupraLottery/supra/scripts/migrate_role_store.py` кодирует JSON-снимок в `LegacyRoleStore` (BCS) и при желании запускает `lottery_data::access::import_existing_role_store` через dockerized Supra CLI.
9. `FeatureRegistry` и режимы фичей перенесены: тесты `lottery_utils::feature_flags_migration_tests` подтверждают восстановление payload'ов через `import_existing_registry`/`import_existing_features`, а скрипт `SupraLottery/supra/scripts/migrate_feature_flags.py` валидирует JSON-снимки, кодирует `LegacyFeatureRegistry` и, при необходимости, вызывает `lottery_utils::feature_flags::import_existing_registry`.
10. `OperatorRegistry` закрыт: тесты `lottery_data::operators_migration_tests` покрывают батч-импорт и повторное восстановление владельцев/операторов, а скрипт `SupraLottery/supra/scripts/migrate_operator_registry.py` валидирует JSON-снимки, кодирует `vector<LegacyOperatorRecord>` в BCS и умеет вызвать `lottery_data::operators::import_existing_operator_records` через dockerized Supra CLI.
11. Ресурс `CancellationRecord` признан готовым: тесты `lottery_data::cancellations_migration_tests` покрывают батч-импорт и защиту от дубликатов, а скрипт `SupraLottery/supra/scripts/migrate_cancellations.py` валидирует JSON-снимки, кодирует `vector<LegacyCancellationRecord>` и по желанию вызывает `lottery_data::cancellations::import_existing_cancellations`.
12. `LotteryCollection` закрыт: тесты `lottery_data::instances_migration_tests` подтверждают восстановление снапшотов через батч- и одиночный импорт, а скрипт `SupraLottery/supra/scripts/migrate_instances.py` валидирует JSON реестра, кодирует `vector<LegacyInstanceRecord>` и при необходимости вызывает `lottery_data::instances::import_existing_instances`.
13. Ресурс `Vaults` завершён: добавлены тесты `lottery_data::treasury_migration_tests`, подтверждающие восстановление конфигурации долей и получателей через `import_existing_vaults`, а также скрипт `SupraLottery/supra/scripts/migrate_vaults.py`, который проверяет JSON-снимок, кодирует `LegacyVaultState` в BCS и может запустить `lottery_data::treasury::import_existing_vaults` через dockerized Supra CLI.
14. `RoundCollection` закрыт: тесты `lottery_data::rounds_migration_tests` подтверждают восстановление снапшотов раундов и очередей ожидания через `import_existing_rounds`, `import_pending_history_records` и `import_pending_purchase_records`, а скрипт `SupraLottery/supra/scripts/migrate_rounds.py` валидирует JSON, кодирует `LegacyRoundRecord` и pending-очереди в BCS и при необходимости вызывает соответствующие entry-функции.
15. `AutomationRegistry` перенесён: тесты `lottery_data::automation_migration_tests` покрывают батчевый импорт и переимпорт ботов через `import_existing_bots`, подтверждая сохранение статусов и cron-данных, а скрипт `SupraLottery/supra/scripts/migrate_automation_registry.py` валидирует JSON-снимки, кодирует `vector<LegacyAutomationBot>` и может вызвать `lottery_data::automation::import_existing_bots` через dockerized Supra CLI.
16. Миграционный слой (`MigrationSession` и `MigrationLedger`) признан готовым: тесты `lottery_utils::migration_migration_tests` покрывают захват/возврат capability и восстановление снапшотов, `SupraLottery/supra/scripts/migration_session_control.sh` управляет вызовами `ensure_caps_initialized`/`release_caps` и health-view, а `SupraLottery/supra/scripts/migrate_migration_ledger.py` валидирует JSON-снимки прогресса, кодирует payload `MigrationSnapshot` и при необходимости вызывает `lottery_utils::migration::record_snapshot`.
17. `VrfDepositLedger` закрыт: тесты `lottery_data::vrf_deposit_migration_tests` подтверждают импорт нового и повторного снапшота с обновлением флагов паузы, а скрипт `SupraLottery/supra/scripts/migrate_vrf_deposit.py` валидирует JSON-снимок депозита, кодирует `LegacyVrfDepositLedger` в BCS и при необходимости вызывает `lottery_data::vrf_deposit::import_existing_ledger` через dockerized Supra CLI.
18. `StoreState` переведён в статус «готово»: тесты `lottery_rewards_engine::store_migration_tests` покрывают батчевый импорт `LegacyStoreItem` и переимпорт обновлённых записей, а скрипт `SupraLottery/supra/scripts/migrate_store.py` проверяет JSON-снимки, кодирует payload `vector<LegacyStoreItem>` в BCS и, при необходимости, вызывает `lottery_rewards_engine::store::import_existing_items`.
19. `TreasuryState` признан готовым: тесты `lottery_data::treasury_multi_migration_tests` покрывают восстановление `LegacyMultiTreasuryState` и batched `LegacyMultiTreasuryLottery`, включая повторный импорт, а скрипт `SupraLottery/supra/scripts/migrate_treasury_multi.py` валидирует JSON, кодирует payload'ы состояния и лотерей и при желании вызывает `lottery_data::treasury_multi::{import_existing_state, import_existing_lotteries}` через dockerized Supra CLI.
20. `JackpotState` переведён в статус «готово»: тесты `lottery_rewards_engine::jackpot_migration_tests` подтверждают восстановление снапшотов через `import_existing_jackpot(s)` с проверкой pending-заявок и билетов, а скрипт `SupraLottery/supra/scripts/migrate_jackpot.py` валидирует JSON-снимки, кодирует `vector<LegacyJackpotRuntime>` в BCS и может вызвать `lottery_rewards_engine::jackpot::import_existing_jackpots` через dockerized Supra CLI.
21. `AutopurchaseState` закрыт: тесты `lottery_rewards_engine::autopurchase_migration_tests` покрывают батчевый импорт, повторные обновления планов и проверку снапшотов, а скрипт `SupraLottery/supra/scripts/migrate_autopurchase.py` валидирует JSON-снимки, кодирует `vector<LegacyAutopurchasePlan>` в BCS и при необходимости вызывает `lottery_rewards_engine::autopurchase::import_existing_plans`.
22. `VipState` признан готовым: тесты `lottery_rewards_engine::vip_migration_tests` восстанавливают batched `LegacyVipLottery`, проверяют переимпорт и снапшоты, а скрипт `SupraLottery/supra/scripts/migrate_vip.py` валидирует JSON-снимки VIP-подписок, кодирует `vector<LegacyVipLottery>` в BCS и по желанию вызывает `lottery_rewards_engine::vip::import_existing_lotteries` через dockerized Supra CLI.
23. `ReferralState` закрыт: тесты `lottery_rewards_engine::referrals_migration_tests` подтверждают восстановление конфигов, статистики и регистраций через batch-импорт `LegacyReferralLottery`/`LegacyReferralRegistration`, а скрипт `SupraLottery/supra/scripts/migrate_referrals.py` валидирует JSON-снимки, кодирует оба вектора в BCS и при необходимости вызывает `import_existing_lotteries`/`import_existing_registrations`.
24. `HistoryCollection` признан готовым: тесты `lottery_utils::history_migration_tests` покрывают batch-импорт `LegacyHistoryRecord` и восстановление dual-write ожиданий, а скрипт `SupraLottery/supra/scripts/migrate_history.py` валидирует JSON-снимки, кодирует `vector<LegacyHistoryRecord>` в BCS и по желанию вызывает `lottery_utils::history::import_existing_history_batch` через dockerized Supra CLI.
25. `LotteryData` (runtime лотерей) закрыт: тесты `lottery_data::lottery_state_migration_tests` покрывают импорт `LegacyLotteryRuntime` и переимпорт с обновлением pending-заявок и whitelist/VRF-конфигурации, а скрипт `SupraLottery/supra/scripts/migrate_lottery_state.py` валидирует JSON-снимки, кодирует `vector<LegacyLotteryRuntime>` в BCS и при необходимости вызывает batch-entry `import_existing_lotteries`.
26. `PayoutLedger` переведён в статус «готово»: тесты `lottery_data::payouts_migration_tests` подтверждают batch-импорт `LegacyPayoutRecord` и защиту от дубликатов, а скрипт `SupraLottery/supra/scripts/migrate_payouts.py` валидирует JSON-снимки выплат, кодирует payload `vector<LegacyPayoutRecord>` в BCS и при желании вызывает `lottery_data::payouts::import_existing_payouts` через dockerized Supra CLI.
27. `HistoryWarden` и `LegacyArchive` закрыты: тесты `lottery_utils::{history_warden_migration_tests, history_archive_migration_tests}` подтверждают повторную выдачу/возврат капабилити и batch-импорт архивных сводок, модуль `history` получил batch-entry `import_existing_legacy_summaries`, а скрипт `SupraLottery/supra/scripts/migrate_archive_summaries.py` валидирует JSON, кодирует payload `vector<LegacyArchiveImport>` и при необходимости вызывает entry через dockerized Supra CLI.

28. `FactoryState` готов: модульные тесты `lottery_factory::factory_migration_tests` покрывают batch-импорт `LegacyFactoryState`, нормализацию `next_lottery_id` и защиту от неавторизованных мигрантов, а скрипт `SupraLottery/supra/scripts/migrate_factory_state.py` валидирует JSON-снимки, кодирует payload в BCS и при необходимости вызывает `lottery_factory::registry::import_existing_registry` через dockerized Supra CLI.
## Следующие шаги
- Выбрать ресурс из раздела «Следующие шаги» [карты миграции](./move_migration_mapping.md#следующие-шаги) (например, `SalesLedger`, цепочка VRF-запросов через `DrawLedger`, перенос capability) и свериться с описанными dry-run проверками и зависимостями перед началом разработки; при переносе FeatureRegistry использовать `migrate_feature_flags.py` для BCS-энкодинга и запуска entry-функции, при восстановлении депозита VRF пользоваться `migrate_vrf_deposit.py`, при переносе JackpotState пользоваться `migrate_jackpot.py`, а при подготовке capability и снапшотов прогресса опираться на `migration_session_control.sh` и `migrate_migration_ledger.py`.
- При переходе в новый чат передать ссылку на настоящее резюме и убедиться, что исполнитель ориентируется в [главном плане](./supra_restructuring_detailed_plan.md) и актуальном статусе [карты миграции](./move_migration_mapping.md).
