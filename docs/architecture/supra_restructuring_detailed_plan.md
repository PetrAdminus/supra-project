# SupraLottery — детальный план реструктуризации (Supra Restructuring Detailed Plan)

## 1. Контекст проекта

**Цель:** превратить текущий набор Move‑пакетов SupraLottery в цельную, расширяемую и безопасную платформу честных и прозрачных Web3‑розыгрышей и лотерей на Supra.

**Исходные условия:**
- Есть рабочий (но фрагментированный) код в нескольких пакетах:
  - `lottery_core`
  - `lottery_multi`
  - `lottery_rewards`
  - `lottery_support`
  - `vrf_hub` (будущий `lottery_vrf_gateway`)
  - `lottery_factory`
- Есть тестовые профили/боты `player1..player5` (конфиги в `configs/playerX.yaml`).
- Сейчас всё деплоится и тестируется на **testnet Supra**, в будущем планируется **mainnet**.
- Фронтенд частично интегрирован, но будет переработан под новую архитектуру.

**Позиционирование:** честный и прозрачный Web3 dApp, с максимально понятной on-chain логикой, событиями и возможностью внешнего аудита.

---

## 2. Жёсткие правила разработки Move

Эти правила обязательны для всех новых и рефакторимых модулей.

1. **Только ASCII в Move‑файлах**
   - Никакой кириллицы в коде и комментариях.
   - Не использовать псевдографику (`─`, `★` и т.п.) — только базовые ASCII‑символы.

2. **Move v1 синтаксис (как в текущем Supra CLI)**
   - Не использовать `let mut`, `loop {}`, и другие конструкции, которые не поддерживаются текущим компилятором Supra.
   - Не использовать зарезервированные слова (`copy`, `move`) как имена переменных.

3. **Ограничение по размеру модулей**
   - Стремиться к тому, чтобы размер байткода **каждого модуля** не превышал ~60 000 байт.
   - Если модуль разрастается — делить его на несколько логических модулей (например, `storage`, `logic`, `events`).

4. **Строгие инварианты и явные ошибки**
   - Для всех критичных проверок использовать константы ошибок `E_*` в одном месте модуля.
   - Не «глушить» ошибки — либо `abort`, либо явное событие с кодом/причиной.

5. **Стиль и читаемость**
   - Единый стиль имён: `snake_case` для функций и переменных, `CamelCase` для структур и ошибок типа `ErrorName`.
   - Отдельные модули под:
     - хранение (storage),
     - бизнес‑логику (logic),
     - события/интерфейсы (events/api),
     - вспомогательные функции (support/utils).

---

## 3. Общая целевая архитектура пакетов

### 3.1. Старая структура и источники правды

Старые пакеты используются как **источник проверенной логики**:
- `lottery_core` — базовые структуры раундов, билетов, логика покупки, выбор победителей, события.
- `lottery_multi` — механика нескольких лотерей, более сложные сценарии.
- `lottery_rewards` — распределение наград, снапшоты.
- `lottery_support` — вспомогательные функции и проверки.
- `vrf_hub` (будущий `lottery_vrf_gateway`) — взаимодействие с Supra VRF, события запросов/результатов.
- `lottery_factory` — создание/инициализация лотерей и связанных ресурсов.

**Важно:** мы не выбрасываем эту логику, а аккуратно переносим в новую структуру.

### 3.2. Целевые Move-пакеты ядра (этап 1)

> Эти шесть пакетов — непосредственный фокус текущей реорганизации. Именно их нужно разрабатывать и рефакторить в первую очередь,
> чтобы получить устойчивое ядро перед релизом.

1. `lottery_data`
   - Общий слой хранения: глобальные конфигурации, состояние лотерей, раунды, история, whitelists и индексы.
   - Содержит только ресурсы, события и простые функции чтения/инициализации.

2. `lottery_engine`
   - Бизнес‑логика розыгрышей: создание конфигураций, продажи, проверки ограничений, обработка VRF и выбор победителей.
   - Использует структуры из `lottery_data`, генерирует события для фасада и наград.

3. `lottery_rewards_engine`
   - Управление джекпотами, выплатами, магазинами призов, программами лояльности и сопутствующими capability.
   - Работает поверх `lottery_data` и интегрируется с `lottery_engine`.
   - Стартовая реализация: модуль `treasury` синхронизирует продажи с мульти-трежери (`lottery_data::treasury_multi`), проверяет доли BPS и обновляет накопления джекпота/операционного пула сразу из `lottery_engine::sales`,
     модуль `payouts` обеспечивает выплату джекпотов, запись операций и бонусов через `lottery_data::treasury_multi`, синхронизируя статусы `PayoutLedger`,
     модуль `jackpot` управляет VRF-джекпотом: регистрирует лотереи, выдаёт билеты, инициирует и обрабатывает запросы Supra VRF с валидацией депозитов и списанием мульти-трежери,
     модуль `autopurchase` переносит планы автопокупки: хранит балансы игроков, управляет капами раундов/трежери, вызывает `lottery_engine::sales::record_prepaid_purchase` и публикует снапшоты для аудита миграции,
     модуль `vip` переносит VIP-подписки: конфигурации, события, выдачу бонусных билетов и интеграцию с мульти-трежери через capability `VipAccess`,
     модуль `store` переносит магазин призов: поддерживает каталог, остатки, события `ItemConfigured`/`ItemPurchased` и работу с мульти-трежери через `StoreAccess`.

4. `lottery_utils`
   - Общие утилиты и проверки: математические помощники, валидация конфигураций, конверторы и аудит миграций.
   - Стартовая реализация включает `math` для безопасных расширений типов и операций с BPS, `feature_flags` с событиями изменения режимов и devnet-override, `price_feed` с регистрацией курсов, fallback/clamp событиями и настройками свежести цен, а также `history`, который хранит записи розыгрышей, управляет capability `HistoryWarden` и синхронизирует очередь `rounds::PendingHistoryQueue` через `sync_draws_from_rounds`.
   - Модуль `metadata` переносит реестр метаданных из легаси: публикует события апдейтов, поддерживает снапшоты `MetadataSnapshotUpdatedEvent`, хранит индекс лотерей и предоставляет admin-интерфейсы без нарушения ограничений Move v1 (все обходы реализованы рекурсивно).
   - Модуль `migration` фиксирует прогресс переноса: публикует `MigrationLedger` со снапшотами, управляет `MigrationSession` и capability (`InstancesExportCap`, `LegacyTreasuryCap`), обеспечивает события `MigrationSnapshotUpdatedEvent` и рекурсивные обходы без циклов.
   - Переносим сюда всё полезное из старого `lottery_support`.

5. `lottery_gateway`
   - Фасад/оркестратор для фронтенда (на базе текущего `lottery_hub`): entry‑функции участия, выдачи наград, реестр лотерей по владельцам и агрегированные view.
   - Тонкий слой над `lottery_data`, `lottery_engine` и `lottery_rewards_engine`.

6. `lottery_vrf_gateway`
   - Базовый пакет Supra VRF (текущий `vrf_hub`), который уже используется и остаётся без радикальных изменений.
   - Необходим для регистрации потребителей и обработки callback после миграции логики.

### 3.3. Пакеты последующих этапов (этап 2+)

> Эти компоненты планируются после стабилизации ядра. Их реализация не блокирует релиз первой версии.

- `profiles_accounts` — on-chain профиль и настройки пользователя, а также флаги премиума/ограничений.
- `bots_devtools` — вспомогательные dev-скрипты и тестовые сценарии, преимущественно off-chain.
- `api_governance` — будущий слой админских API, голосований и партнёрского управления.

### 3.4. Легаси Move-пакеты (источник для миграции)

> Эти пакеты **не входят в целевую архитектуру**, но содержат проверенную логику, которую переносим. После миграции они останутся
> только как источник исторического кода и база для тестов миграции.

- `lottery_core`
- `lottery_multi`
- `lottery_rewards`
- `lottery_support`
- `lottery_factory`

Для контроля уникальности модулей в `lottery_data` и последующих пакетов ведём сравнение с опубликованными на testnet модулями по
адресу `0xbc95…caafe0`. Новые модули используют оригинальные имена (`lottery_state`, `instances`, `rounds` и т.д.) и не совпадают
с легаси-модулями (`core_main_v2`, `core_rounds`, `core_treasury_*`), что исключает конфликты при совместном деплое во время
миграции.

---

## 4. Миграция: что брать из старых пакетов

> Подробная карта соответствий ресурсов и шагов переноса ведётся в `docs/architecture/move_migration_mapping.md`. При планировании конкретных транзакций и проверок используйте её как основной чек-лист.

### 4.1. `lottery_core` → `lottery_data` + `lottery_engine`

**В `lottery_data` переносим:**
- Структуры, описывающие:
  - лотерею/розыгрыш (id, владелец, статус, конфиг),
  - билет/участие,
  - историю раундов,
  - базовые ресурсы владельца/хаба.
- Константы ошибок, относящиеся к инвариантам данных (например, невалидный статус, дубликаты и т.п., если они привязаны к хранению).

**В `lottery_engine` переносим и упрощаем:**
- Логику:
  - создания раунда/лотереи,
  - покупки билетов,
  - смены статусов (продажа/закрытие/розыгрыш),
  - выбор победителя по результату VRF.
- События:
  - покупка билета,
  - изменение статуса лотереи/раунда,
  - фиксация победителя и суммы выигрыша.

**Удаляем или переписываем заново:**
- Логику, которая смешивает:
  - хранение,
  - бизнес‑правила,
  - входные/выходные интерфейсы для фронтенда,
  - прямые вызовы VRF.
- Всё это должно быть разделено по модулям и пакетам.

### 4.2. `lottery_multi` → `lottery_gateway` (новый фасад на базе `lottery_hub`) + `lottery_engine`

**В `lottery_gateway` переносим:**
- Реестр нескольких лотерей:
  - мэппинг владельцев → список лотерей,
  - функции для перечисления/фильтрации.
- Entry‑функции «верхнего уровня» для фронтенда:
  - создание лотерей по шаблонам,
  - запуск/остановка продаж,
  - запуск розыгрыша (через VRF),
  - чтение сводного статуса.

**В `lottery_engine` дорабатываем:**
- Поддержку нескольких типов лотерей (если уже есть в `lottery_multi`).
- Общие механики, которые используются в нескольких сценариях.

### 4.3. `lottery_rewards`

**Сохраняем и переносим:**
- Логику распределения наград,
- механику снапшотов,
- события начислений.

**Приводим к новой архитектуре:**
- Используем структуры хранения из `lottery_data`.
- Не храним дублирующую информацию, если её можно получить из ядра.

### 4.4. `lottery_support`

**Извлекаем:**
- Все полезные проверки параметров,
- математические утилиты,
- общие помощники.

**Чистим:**
- Удаляем мёртвый код и функции, которые стали не нужны в новой архитектуре.

### 4.5. `lottery_vrf_gateway` (текущий `vrf_hub`)

**Используем как шаблон:**
- Структуры запросов и результатов VRF,
- события запроса случайности и получения ответа.

**Выделяем явный интерфейс:**
- `request_randomness(...)` — вызывается из `lottery_gateway`/`lottery_engine`.
- `on_randomness_fulfilled(...)` — вызывается VRF‑системой, внутри которого вызывается логика выбора победителя.

### 4.6. `lottery_factory`

**Оставляем:**
- Низкоуровневые операции создания ресурсов/структур.

**Меняем:**
- Завязываем только на структуры `lottery_data`, не на старые типы.

---

## 5. Детальная конфигурация лотерей и правило минимума игроков

### 5.1. Обязательные параметры конфигурации лотереи

Каждая лотерея/розыгрыш должна иметь как минимум:
- `ticket_price: u64` — цена билета в минимальных единицах SUPRA.
- `min_players: u64` — минимальное количество участников для проведения розыгрыша.
- `max_players: u64` — максимальное количество участников (0 — может означать «без жёсткого лимита» или использоваться отдельно).
- `sales_start_ts: u64` — timestamp начала продаж билетов.
- `sales_end_ts: u64` — timestamp окончания продаж билетов.

### 5.2. Расширенные параметры конфигурации

В перспективе (или сразу, если удобно) добавляем:
- `max_tickets_per_wallet: u64` — лимит билетов на один адрес.
- `auto_close_on_max: bool` — нужно ли автоматически закрывать продажи при достижении `max_players`.
- `draw_mode` — режим розыгрыша (например, классический, по этапам, много-победителей).
- `refund_policy` — политика рефандов при недоборе игроков/ошибках:
  - `NoRefund`,
  - `FullRefundIfNotStarted`,
  - `PartialRefund`, и т.п.
- `allow_bots: bool` — разрешены ли тестовые/бот‑аккаунты для этой лотереи.

### 5.3. Инварианты конфигурации

При создании/обновлении конфигурации платформа должна проверять:
- `ticket_price > 0`;
- `min_players > 0`;
- `max_players == 0` **или** `max_players >= min_players`;
- `sales_start_ts < sales_end_ts`;
- окна и лимиты не конфликтуют с глобальной политикой платформы.

При нарушении любого инварианта — `abort E_INVALID_CONFIG` или аналогичным кодом.

### 5.4. Правило минимума игроков (min_players)

**Бизнес‑правило:** розыгрыш **нельзя** проводить до тех пор, пока количество участников не достигнет `min_players`.

- Пока `players_count < min_players`:
  - лотерея может находиться в статусах:
    - `Sales` (идут продажи),
    - `CancelledNotEnoughPlayers` / `OnHoldNotEnoughPlayers` (если `sales_end_ts` прошло, а игроков мало).
- Как только `players_count >= min_players` и:
  - текущее время ≥ `sales_end_ts`,
  - либо достигнут `max_players` (при включённом `auto_close_on_max`),
  - лотерея может переходить в статус `ReadyForDraw`.

Если к моменту окончания окна продаж `players_count < min_players`:
- либо лотерея **отменяется** с рефандом по `refund_policy`,
- либо переводится в статус «ожидание» до ручного решения админа/организатора.

### 5.5. Статусы лотереи и переходы

Примерный набор статусов:
- `Created` — лотерея создана, но продажи ещё не стартовали.
- `Sales` — идёт продажа билетов.
- `SalesClosed` — продажи завершены, идёт подготовка к розыгрышу.
- `ReadyForDraw` — выполнены все условия (включая min_players), можно запускать VRF.
- `DrawRequested` — запрос случайности отправлен в VRF.
- `WinnerSelected` — победитель (или несколько) зафиксирован(ы).
- `CancelledNotEnoughPlayers` — отменено из‑за недостатка игроков.
- `CancelledByAdmin` — отменено админом.

Все переходы между статусами должны быть описаны в `lottery_engine`, а `lottery_gateway` вызывает соответствующие функции.

### 5.6. События

Для прозрачности и интеграции с фронтендом/анализом:
- `LotteryCreated` — создание лотереи;
- `LotteryConfigUpdated` — изменение конфигурации;
- `TicketPurchased` — покупка билета;
- `LotteryStatusChanged` — изменение статуса;
- `DrawRequested` — запрос VRF для розыгрыша;
- `WinnerSelected` — выбран победитель;
- `LotteryCancelled` — отмена с указанием причины.

---

## 6. Интеграция с Supra VRF

### 6.1. Базовый поток

1. `lottery_gateway` или `lottery_engine` вызывает функцию `lottery_vrf_gateway::request_randomness(...)` с:
   - идентификатором лотереи/раунда,
   - параметрами запроса,
   - нужным «payload» (например, hash конфигурации и списка участников).

2. `lottery_vrf_gateway`:
   - записывает запрос в on-chain структуру (можно использовать старые структуры из текущего `vrf_hub` как шаблон),
   - эмитит событие `RandomnessRequested`.

3. После выполнения VRF‑процесса вызывается callback `lottery_vrf_gateway::on_randomness_fulfilled(...)`:
   - находит соответствующий запрос по id,
   - передаёт результат (`random_value`) в `lottery_engine::apply_vrf_result(...)`.

4. `lottery_engine::apply_vrf_result(...)`:
   - выбирает победителя(ей) по результату случайности,
   - обновляет статус лотереи на `WinnerSelected`,
   - эмитит событие `WinnerSelected`/`RewardsAssigned`.

### 6.2. Требования

- Максимально следовать официальным примерам из `Supra-Labs`.
- Все идентификаторы запросов/ответов и события должны быть понятны для последующего аудита.
- В случае ошибок (нет лотереи, повторное использование результата, некорректный статус) — аккуратный `abort` или событие ошибки.

---

## 7. Боты и тестовые аккаунты (player1..player5)

- В проекте уже есть тестовые профили `player1`, `player2`, `player3`, `player4`, `player5`.
- Они используются:
  - в интеграционных тестах,
  - для локальных/тестнет‑розыгрышей,
  - для имитации активности, если реальных игроков мало.

**Правила:**
- Логика участия ботов не должна давать им преимуществ перед реальными игроками (в терминах вероятности выигрыша).
- На mainnet участие таких аккаунтов либо отключается, либо строго прозрачно и явно документируется.
- Настройка параметра `allow_bots` в конфигурации лотереи:
  - если `false` — любые «ботовые» адреса должны фильтроваться на уровне фронта/бэк‑логики;
  - если `true` — боты могут участвовать, но по тем же правилам, что и обычные игроки.

---

## 8. Стратегия тестирования и команды запуска

### 8.1. Базовые команды

Для каждого пакета после изменений необходимо запускать unit‑тесты:

```bash
docker compose -f SupraLottery/compose.yaml run --rm \
  supra_cli bash -lc "\
    cd /supra/SupraLottery && \
    PYTHONPATH=/supra/SupraLottery python3 -m supra.scripts.cli move-test \
      --workspace supra/move_workspace \
      --package <PACKAGE_NAME> \
      --cli /supra/supra \
      --report-json tmp/move-test-<PACKAGE_NAME>.json \
      --report-junit tmp/move-test-<PACKAGE_NAME>.xml \
      --report-log tmp/move-test-<PACKAGE_NAME>.log\
  "
```

Где `<PACKAGE_NAME>` — `lottery_data`, `lottery_engine`, `lottery_gateway`, `lottery_rewards_engine`, `lottery_utils`, `vrf_hub` и т.д.

### 8.2. Что считается «зелёным» состоянием

- Компиляция проходит без ошибок.
- Unit‑тесты выполняются без падений.
- Warnings допускаются на первых этапах, но по мере стабилизации их нужно по возможности устранять (особенно связанные с неиспользуемыми переменными или недостижимым кодом).

### 8.3. Расширенное тестирование

- Добавлять unit‑тесты на:
  - проверку инвариантов конфигурации (ticket_price, min/max players, окна продаж),
  - поведение при недостатке игроков,
  - корректность переходов статусов и вызовов VRF,
  - сценарии с рефандами.

---

## 9. Границы с фронтендом

### 9.1. Ожидаемые entry‑функции

Фронтенд должен использовать только ограниченный набор публичных `entry`:
- `lottery_gateway::create_lottery_with_config(...)`
- `lottery_gateway::enter_paid_round(...)`
- `lottery_gateway::start_sales(...)` / `stop_sales(...)`
- `lottery_gateway::request_draw(...)` (запуск VRF)
- `lottery_gateway::claim_reward(...)` (если применимо)

Все остальные функции — внутренние (`public`/`friend` без `entry`).

### 9.2. Данные для отображения во фронтенде

Фронтенду нужны:
- конфигурация лотереи (все поля, описанные в разделе 5);
- текущий статус лотереи;
- количество участников, проданных билетов;
- информация о победителе(ях) и суммах выигрыша;
- история ключевых событий (создание, старт продаж, завершение продаж, розыгрыш, отмена).

Это должно быть доступно через:
- события,
- структурированные ресурсы (через RPC),
- при необходимости — специальные view‑функции.

---

## 10. Этапы реструктуризации

### Этап 1. Подготовка

1. Создать отдельную ветку для рефакторинга (уже сделано).
2. Зафиксировать текущее состояние рабочих пакетов (`lottery_core`, `lottery_multi`, и т.д.) как «источник правды».
3. Настроить быстрый запуск тестов (см. раздел 8).

### Этап 2. Анализ существующих пакетов

1. Пройтись по всем модулям старых пакетов и:
   - выписать ключевые структуры,
   - выписать основные публичные функции,
   - выписать события и их поля,
   - отметить компоненты, которые будут перенесены как есть, и те, что лучше переписать заново.
2. Отдельно проанализировать модуль/модули, связанные с VRF,
   - понять текущий формат запросов/ответов,
   - зафиксировать, какие события используются.

### Этап 3. Создание каркасов новых пакетов

1. Создать минимум:
   - `lottery_data` с пустыми или минимальными структурами,
   - `lottery_engine` с заглушками логики,
   - `lottery_gateway` с entry‑заглушками,
   - при необходимости обновить/создать `lottery_rewards_engine`, `lottery_utils`, `lottery_vrf_gateway` под новую архитектуру.
2. Убедиться, что новые пакеты **компилируются**, даже если функции пока пустые или просто `abort E_NOT_IMPLEMENTED`.

### Этап 4. Миграция хранения (`lottery_data`)

1. Перенести все ключевые ресурсы из `lottery_core`/`lottery_multi` в `lottery_data`.
2. Обновить зависимости остальных пакетов так, чтобы они использовали новые структуры.
3. Запустить тесты для проверки, что типы согласованы.

### Этап 5. Миграция бизнес‑логики (`lottery_engine`)

1. Перенести и адаптировать функции:
   - создание лотерей и раундов,
   - покупка билетов,
   - смена статусов лотереи,
   - выбор победителя по VRF.
2. Реализовать проверку всех инвариантов конфигурации и статусов.
3. Обновить события, чтобы они были консистентны и удобны для фронтенда.

**Статус на 2025-11-20:** `lottery_engine::sales` теперь поддерживает батчевые покупки билетов и синхронизацию расписания розыгрыша с `lottery_data::rounds`, сохраняя события для каждого билета. В связке с `ticketing`, `draw` и `vrf_config` это закрывает минимальный цикл «продажа → авто-планирование → запрос VRF». Следующие шаги — подготовить миграцию `SalesLedger`, завершить перенос `DrawLedger` и интегрировать настройки VRF с депонированием (`vrf_deposit`) и фасадом `lottery_vrf_gateway`.

**Статус на 2025-11-21:** Развёрнут модуль хранения `lottery_data::vrf_deposit` и логика `lottery_engine::vrf`, добавляющие события снапшотов, алёртов и контроль паузы VRF-запросов. `lottery_engine::draw::request_randomness` теперь проверяет состояние депозита перед запросом в Supra VRF. Следующие шаги — подготовить миграционный скрипт для `VrfDepositLedger`, сверить статусы с `lottery_vrf_gateway` и связать автозапуск снапшотов с будущим модулем `automation`.

**Статус на 2025-11-22:** `lottery_data::instances` фиксирует события смены владельца и предоставляет безопасный метод `set_owner`, а модуль `lottery_engine::operators` обеспечивает управление владельцами и операторами лотерей (grant/revoke) с проверкой прав. Требуется подготовить миграцию владельцев/операторов из `core_instances`/`core_operators` и встроить новые entry-функции в будущий фасад `lottery_gateway`.

**Статус на 2025-11-23:** Добавлен модуль `lottery_engine::lifecycle`, обеспечивающий административную паузу и возобновление лотерей с проверкой pending-запросов и синхронизацией событий. В `lottery_data::instances` реализован метод `set_active`, что закрывает базовую поддержку активного флага. Следующие шаги — подготовить миграцию статусов `LotteryCollection` и встроить `pause_lottery`/`resume_lottery` в фасад `lottery_gateway`.

**Статус на 2025-11-24:** Добавлены `lottery_data::payouts` и `lottery_engine::payouts`, интегрированы записи победителей в `lottery_engine::draw`, обновлены карта миграции, чек-лист и инвентаризация структур.

**Статус на 2025-11-25:** Реализованы `lottery_data::cancellations` и `lottery_engine::cancellation`, фиксирующие причины отмены, очищающие pending-запросы/билеты и переводящие инстансы в неактивное состояние. Следующие шаги — подготовить миграцию записей отмен из `lottery_multi::lottery_registry` и встроить административный поток в фасад `lottery_gateway`.

**Статус на 2025-11-27:** Развёрнуты `lottery_data::automation` и `lottery_engine::automation`, обеспечивающие реестр ботов, cron-capability и события dry-run/тикета. Добавлены entry-функции регистрации/ротации ботов, проверки timelock и фиксации успехов/ошибок. Следующие шаги — подготовить миграционные скрипты `AutomationRegistry`/`AutomationCap`, восстановить pending-действия из легаси и связать автоматизацию с VRF/планировщиком.

### Этап 6. `lottery_gateway` как фасад

1. Реализовать реестр лотерей и владельцев.
2. Реализовать простые entry‑функции для фронтенда, которые внутри вызывают `lottery_engine`.
3. Добавить view‑функции или просто ясные ресурсы, чтобы фронтенд мог получать нужную информацию.

**Статус на 2025-11-28:** Создан пакет `lottery_gateway` с модулем `gateway`, который хранит собственный `GatewayRegistry`,
генерирует идентификаторы лотерей и проксирует ключевые операции `lottery_engine`. Реализованы entry-функции:
`create_lottery`, `set_owner`, `grant_operator`/`revoke_operator`, `pause_lottery`, `resume_lottery`, `cancel_lottery`,
`schedule_draw`, `request_randomness`, `enter_paid_round`. События фасада (`LotteryCreated`, `LotteryOwnerUpdated`,
`LotteryStatusUpdated`, `GatewaySnapshot`) синхронизированы с `lottery_data`, а индекс владельцев поддерживает миграцию из
`lottery_multi::lottery_registry`. Следующие шаги — расширить фасад view-функциями и подготовить сценарии миграции
`Registry`/`CancellationRecord`.

### Этап 7. Интеграция с VRF (`lottery_vrf_gateway`)

1. Привести `lottery_vrf_gateway` к форме, максимально близкой к официальным примерам Supra.
2. Реализовать поток запросов/ответов, описанный в разделе 6.
3. Связать `lottery_vrf_gateway` и `lottery_engine::apply_vrf_result`.

### Этап 8. Профили, боты, тестовые сценарии

1. Добавить/обновить пакет профилей (`profiles_accounts`):
   - базовые настройки,
   - флаги премиума,
   - настройки отображения адресов.
2. Настроить ботов/тест‑аккаунты (`player1..player5`) через вспомогательные модули или чисто на уровне тестов.
3. Добавить тестовые сценарии, где участвуют как реальные, так и бот‑аккаунты.

### Этап 9. Чистка и подготовка к релизу

1. Удалить старые, неиспользуемые модули и пакеты (или пометить как legacy).
2. Привести все имена, события и ошибки к единому стилю.
3. Минимизировать количество warning‑ов компилятора.
4. Подготовить документацию по entry‑функциям и событиям для фронтенда и аудита.

---

## 11. Что должен знать исполнитель этого плана

1. **Проект SupraLottery ещё не в проде.** Сейчас идёт активная разработка и рефакторинг, поэтому задача — не просто «написать с нуля», а аккуратно использовать уже наработанный, частично рабочий код.
2. **Нельзя ломать Move‑код Unicode‑символами.** В исходниках были ошибки из‑за кириллицы и псевдографики — этого нужно избегать.
3. **Старые пакеты — не мусор, а источник проверенных решений.** Любую новую логику нужно сверять с тем, как она была реализована в `lottery_core`, `lottery_multi`, `lottery_rewards`, `vrf_hub` (будущий `lottery_vrf_gateway`).
4. **Текущий фокус — ядро на тестнете.** Mainnet — следующий шаг, но архитектуру и безопасность надо закладывать уже сейчас.
5. **Проект позиционируется как честный и прозрачный Web3 dApp.** Это значит максимум событий, понятная логика, отсутствие «магии» и скрытых правил.

Этот план можно использовать как ТЗ для другого чата/разработчика: он содержит контекст, цели, структуру пакетов, детальную конфигурацию лотерей, требования к VRF, ботам, тестам и фронтенду.


## 13. Зоны неопределённости и управление рисками

### 13.1. Дорожная карта и критерии готовности
- Ввести явную **roadmap** по этапам (Этап 1–Этап 7 из плана) с:
  - контрольными точками (milestones) для каждого этапа;
  - критериями готовности (*Definition of Done*) для каждого подпункта;
  - зависимостями между задачами (например: рефакторинг `lottery_core` должен быть завершён до финального рефакторинга `lottery_gateway` и интеграции VRF);
  - приоритетами (что обязательно к первому тестнет-рилизу, а что можно отложить).
- Синхронизировать эту дорожную карту с задачами фронтенда, чтобы:
  - API-слой `lottery_gateway` и форматы событий были стабилизированы **до** активной интеграции UI;
  - изменения в storage/структурах были заранее объявлены как breaking/non-breaking.

### 13.2. Миграция данных и стратегия отката
- Добавить в план отдельный подпункт **«Миграция данных/состояний»**:
  - перечислить все on-chain ресурсы, которые сейчас используются (`core_state`, состояния лотерей, балансы призов и т.п.);
  - описать, какие из них будут **переиспользованы** новыми модулями, а какие — **выведены из эксплуатации**;
  - спланировать безопасный сценарий миграции: деплой новых модулей → включение новых entry-функций → мягкое отключение старых маршрутов (через флаги/конфигурацию) → архивирование старых структур.
- Зафиксировать рабочие артефакты:
  - `docs/architecture/move_migration_mapping_template.md` — шаблон таблицы соответствий «старые → новые» структуры и ресурсов;
  - `docs/architecture/migration_transaction_checklist.md` — пошаговый чек-лист миграционных транзакций, пост-валидации и отката.
- Для mainnet-деплоя добавить:
  - чёткий чек-лист для финальной проверки на **testnet** (все сценарии, которые должны быть отыграны перед релизом);
  - описание стратегии отката: какое именно обновление можно откатить, а что потребует выпуска новой версии модулей с миграционными скриптами.

### 13.3. Тестовая стратегия, CI и метрики качества
- Расширить раздел тестирования следующими пунктами:
  - **CI-пайплайн** (например, GitHub Actions):
    - запуск `move-test` для всех критичных пакетов при каждом push/PR;
    - отдельная джоба для статического анализа (lint/формат, проверки на размер байткода и базовые инварианты);
    - отчёты по тестам (junit/json) с артефактами.
  - **Интеграционные тесты**:
    - сценарии, покрывающие полный жизненный цикл лотереи: создание → продажа билетов → запрос VRF → распределение призов → запись в историю;
    - сценарии с ошибочными путями: недобор игроков, истекшее время продаж, неверный конфиг, повторный запуск розыгрыша и т.п.
  - **Нагрузочные тесты (по возможности)**:
    - моделирование массовых покупок билетов и большого числа активных лотерей;
    - оценка газа/стоимости операций для ключевых entry-функций.
  - **Метрики качества**:
    - минимальный уровень покрытия юнит-тестами для core-логики;
    - список обязательных инвариантов, которые проверяются тестами (например, сумма призов никогда не превышает собранные средства, статус лотереи меняется только по допустимым переходам и т.д.).

- Зафиксировать, что эта тестовая стратегия — часть заявленной **прозрачности и честности** проекта: отчёты о тестах и основных инвариантах могут позже использоваться в документации и материалах для аудита.



---

## 15. Нейтральное именование участия (замена `buy_ticket`)

Чтобы поддержать как платные лотереи, так и бесплатные розыгрыши, фиксируем новые правила именования и конфигурации:

1. **Отказ от названия `buy_ticket`**
   - В старых модулях (`lottery_core`, `lottery_multi` и др.) функции вида `buy_ticket` считаем устаревшими.
   - В новой архитектуре базовое действие называется **«вход в раунд/лотерею»**, а не «покупка».

2. **Новое базовое имя функции участия**
   - В доменном слое (`lottery_engine::ticketing`) используем нейтральную функцию:
     - `public fun enter_round(...)` — единая точка, которая регистрирует участие игрока в конкретном раунде/лотерее.
   - Внутри `enter_round` не важно, платное это участие или бесплатное — решение принимается по конфигу лотереи.

3. **Разделение платных и бесплатных сценариев на уровне хаба**
   - В `lottery_gateway` вводим отдельные entry-функции для фронтенда:
     - `public entry fun enter_paid_round(...)` — платное участие (списывает токены согласно `ticket_price`).
     - `public entry fun enter_free_round(...)` — бесплатное участие (не трогает баланс, но всё равно создаёт запись билета/участника).
   - Обе функции внутри вызывают общий доменный метод `lottery_engine::enter_round(...)`.

4. **Расширение конфигурации лотереи для поддержки бесплатных розыгрышей**
   - В `lottery_engine::types::LotteryConfig` добавляем флаг режима:
     - `is_free: bool` — если `true`, участие бесплатное;
     - `ticket_price: u64` — если `is_free == true`, **обязан быть 0**; если `is_free == false`, **обязан быть > 0**.
   - В `lottery_utils` добавляем проверку:
     - `assert_valid_pricing(config: &LotteryConfig)` — гарантирует согласованность `is_free` и `ticket_price`.
   - В `create_lottery` (и других функциях создания) вызываем эту проверку как часть `is_valid_config`.

5. **Правила по проверкам при входе в раунд**
   - В `lottery_engine::ticketing::enter_round` всегда проверяем:
     - статус лотереи и раунда (должны быть в фазе продаж/участия);
     - окно продаж (`sales_start_ts <= now < sales_end_ts` — позже будет подключён реальный timestamp);
     - выполнение `min_players`/`max_players` с учётом уже записанных участников;
     - корректность конфигурации цен (через `lottery_utils::assert_valid_pricing`).
   - Для платного сценария (`enter_paid_round`) дополнительно проверяем и выполняем списание средств.

6. **Связь с существующим кодом**
   - Все места, где в старых модулях сейчас используется `buy_ticket`, при миграции переводим на новую схему:
     - доменная часть логики → `lottery_engine::enter_round`;
     - интеграционная/entry-часть → `lottery_gateway::enter_paid_round` или `lottery_gateway::enter_free_round`.
   - В `legacy`-модулях можно оставить старое имя `buy_ticket`, но чётко пометить их как неиспользуемые в новой архитектуре.

Эти правила гарантируют, что одна и та же архитектура поддерживает как платные, так и бесплатные розыгрыши, а фронтенд всегда работает через понятные и стабильные entry-функции хаба.

---

## 16. Журнал работ и артефактов

| Дата (UTC) | Что сделано | Артефакты |
| --- | --- | --- |
| 2025-11-15 | Подготовлен каркас пакета `lottery_data` (lottery_state, instances, rounds, operators, treasury_v1, treasury_multi) и обновлены статусы миграции ядра. | `SupraLottery/supra/move_workspace/lottery_data`, `docs/architecture/move_migration_mapping.md` |
| 2025-11-15 | Автоматизирована инвентаризация текущих структур и ресурсов Move: добавлен скрипт `python docs/architecture/tools/export_move_inventory.py`, который формирует актуальный отчёт для подготовки таблиц соответствий. | `docs/architecture/move_struct_inventory.md`, `docs/architecture/tools/export_move_inventory.py` |
| 2025-11-15 | Подготовлен шаблон таблицы сопоставления старых и новых структур и оформлен чек-лист миграционных транзакций с проверками и откатом. | `docs/architecture/move_migration_mapping_template.md`, `docs/architecture/migration_transaction_checklist.md` |
| 2025-11-16 | Составлена заполненная карта миграции с перечнем ресурсов и шагами переноса. | `docs/architecture/move_migration_mapping.md` |
| 2025-11-16 | Переклассифицированы пакеты на «ядро / этап 2+ / легаси» и задокументировано отсутствие конфликтов имён модулей с текущим деплоем на testnet. | Раздел 3, `docs/architecture/move_struct_inventory.md`, проверка адреса `0xbc95…caafe0` |
| 2025-11-17 | Развёрнут пакет `lottery_engine` с модулями `ticketing` и `sales`, подключёнными к `lottery_data`; обновлены карта миграции и инвентаризация структур. | `SupraLottery/supra/move_workspace/lottery_engine`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/move_struct_inventory.md` |
| 2025-11-18 | Добавлен модуль `lottery_engine::draw` с управлением расписанием розыгрыша и обработкой VRF; обновлены карта миграции, чек-лист транзакций и инвентаризация. | `SupraLottery/supra/move_workspace/lottery_engine/sources/Draw.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md` |
| 2025-11-19 | Реализован `lottery_engine::vrf_config` и события VRF-конфигурации в `lottery_data`; обновлены карта миграции, чек-лист и инвентаризация. | `SupraLottery/supra/move_workspace/lottery_engine/sources/VrfConfig.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/LotteryState.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md` |
| 2025-11-20 | Обновлён `lottery_engine::sales`: поддержаны батчевые покупки и автоматическое планирование розыгрыша, синхронизированное с `lottery_data::rounds`; документация отражает прогресс и новые шаги миграции. | `SupraLottery/supra/move_workspace/lottery_engine/sources/Sales.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/supra_restructuring_detailed_plan.md` |
| 2025-11-21 | Реализованы `lottery_data::vrf_deposit` и `lottery_engine::vrf`, добавлена проверка паузы VRF-запросов в `lottery_engine::draw` и обновлён автоматический отчёт по структурам. | `SupraLottery/supra/move_workspace/lottery_data/sources/VrfDeposit.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Vrf.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Draw.move`, `docs/architecture/move_struct_inventory.md`, `docs/architecture/move_migration_mapping.md` |
| 2025-11-22 | Добавлены события смены владельца в `lottery_data::instances`, новый модуль `lottery_engine::operators` и обновления документации по миграции ролей. | `SupraLottery/supra/move_workspace/lottery_data/sources/Instances.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Operators.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md` |
| 2025-11-23 | Реализован административный цикл паузы/возврата (`lottery_engine::lifecycle`) и функция `instances::set_active`; обновлены карта миграции, чек-лист и план. | `SupraLottery/supra/move_workspace/lottery_engine/sources/Lifecycle.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/Instances.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md` |
| 2025-11-24 | Добавлены `lottery_data::payouts` и `lottery_engine::payouts`, интегрированы записи победителей в `lottery_engine::draw`, обновлены карта миграции, чек-лист и инвентаризация структур. | `SupraLottery/supra/move_workspace/lottery_data/sources/Payouts.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Payouts.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Draw.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md` |
| 2025-11-25 | Добавлены `lottery_data::cancellations` и `lottery_engine::cancellation`, обеспечен полный цикл админской отмены с очисткой pending-запросов и событий, обновлены карта миграции, чек-лист и инвентаризация. | `SupraLottery/supra/move_workspace/lottery_data/sources/Cancellations.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Cancellation.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md` |
| 2025-11-26 | Приведены модули `lottery_engine` и `lottery_data` к рекурсивным хелперам вместо циклов, чтобы соответствовать требованиям Move v1 (без `let mut`), обновлён журнал для фиксации соблюдения синтаксических правил. | `SupraLottery/supra/move_workspace/lottery_engine/sources/Sales.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/VrfConfig.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Draw.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/Operators.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/Payouts.move` |
| 2025-11-27 | Развернуты `lottery_data::automation` и `lottery_engine::automation`, дополнены карта миграции и чек-лист шагами по переносу ботов и cron-capability. | `SupraLottery/supra/move_workspace/lottery_data/sources/Automation.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Automation.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md` |
| 2025-11-28 | Создан пакет `lottery_gateway` с модулем `gateway`, обновлены карта миграции, чек-лист и инвентаризация для фиксации нового фасада и миграции `LotteryRegistry`. | `SupraLottery/supra/move_workspace/lottery_gateway/Move.toml`, `SupraLottery/supra/move_workspace/lottery_gateway/sources/Gateway.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md` |
| 2025-11-29 | Развёрнут пакет `lottery_rewards_engine` с модулем `treasury`, который синхронизирует продажи с мульти-трежери и проверяет доли BPS; обновлены `lottery_engine::sales`, карта миграции и чек-лист транзакций. | `SupraLottery/supra/move_workspace/lottery_rewards_engine`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Sales.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md` |
| 2025-11-30 | Добавлен модуль `lottery_rewards_engine::payouts`, связывающий `PayoutLedger` с мульти-трежери и событиями выплат: реализованы entry-функции для выдачи джекпотов, учёта операционных списаний/бонусов и синхронизации статусов; обновлены карта миграции, чек-лист и инвентаризация. | `SupraLottery/supra/move_workspace/lottery_rewards_engine/sources/Payouts.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md`, `docs/architecture/supra_restructuring_detailed_plan.md` |
| 2025-12-01 | Реализованы `lottery_data::jackpot` и `lottery_rewards_engine::jackpot`, обновлены план, карта миграции и чек-лист миграций с dry-run VRF и проверкой мульти-трежери; `lottery_engine::ticketing::create_lottery` автоматически регистрирует джекпот. | `SupraLottery/supra/move_workspace/lottery_data/sources/Jackpot.move`, `SupraLottery/supra/move_workspace/lottery_rewards_engine/sources/Jackpot.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Ticketing.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md`, `docs/architecture/supra_restructuring_detailed_plan.md` |
| 2025-12-01 | Развёрнут пакет `lottery_utils` с модулями `math`, `feature_flags` и `price_feed`, обновлены карта миграции и чек-лист шагами инициализации utility-слоя и переносом devnet-конфигураций. | `SupraLottery/supra/move_workspace/lottery_utils`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md` |
| 2025-12-02 | Добавлен модуль `lottery_rewards_engine::autopurchase`, расширены `lottery_engine::sales`, `lottery_data::treasury_v1` и `lottery_data::rounds` для предоплаченных покупок и управления capability; обновлены карта миграции, чек-лист, инвентаризация и план. | `SupraLottery/supra/move_workspace/lottery_rewards_engine/sources/Autopurchase.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Sales.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/TreasuryV1.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/Rounds.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md`, `docs/architecture/supra_restructuring_detailed_plan.md` |
| 2025-12-03 | Реализован модуль `lottery_rewards_engine::vip`, обновлены `lottery_data::treasury_multi` (capability `VipAccess`), карта миграции, чек-лист транзакций и инвентаризация; зафиксированы новые шаги миграции подписок и обновлена дорожная карта. | `SupraLottery/supra/move_workspace/lottery_rewards_engine/sources/Vip.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/TreasuryMulti.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md`, `docs/architecture/supra_restructuring_detailed_plan.md` |
| 2025-12-04 | Добавлен модуль `lottery_rewards_engine::store` с управлением каталогом и покупками, обновлены карта миграции, чек-лист и инвентаризация; зафиксированы шаги миграции `StoreState`/`StoreAccess`. | `SupraLottery/supra/move_workspace/lottery_rewards_engine/sources/Store.move`, `SupraLottery/supra/move_workspace/lottery_rewards_engine/Move.toml`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md`, `docs/architecture/supra_restructuring_detailed_plan.md` |
| 2025-12-05 | Реализован `lottery_utils::history` с поддержкой `HistoryWarden`, синхронизацией очереди `rounds::PendingHistoryQueue` и событиями истории; обновлены карта миграции, чек-лист транзакций, план и инвентаризация. | `SupraLottery/supra/move_workspace/lottery_utils/sources/History.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/Rounds.move`, `SupraLottery/supra/move_workspace/lottery_engine/sources/Draw.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md`, `docs/architecture/supra_restructuring_detailed_plan.md` |
| 2025-12-06 | Добавлен `lottery_utils::metadata`: события апдейта и удаления метаданных, снапшоты `MetadataSnapshotUpdatedEvent`, рекурсивные обходы без циклов; обновлены карта миграции, чек-лист транзакций, план и автоматический отчёт по структурам. | `SupraLottery/supra/move_workspace/lottery_utils/sources/Metadata.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md`, `docs/architecture/supra_restructuring_detailed_plan.md` |
| 2025-12-07 | Реализован `lottery_utils::migration`: `MigrationLedger`, `MigrationSession`, события `MigrationSnapshotUpdatedEvent` и управление capability; обновлены карта миграции, чек-лист, план и автоматическая инвентаризация. | `SupraLottery/supra/move_workspace/lottery_utils/sources/Migration.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/Instances.move`, `SupraLottery/supra/move_workspace/lottery_data/sources/TreasuryV1.move`, `docs/architecture/move_migration_mapping.md`, `docs/architecture/migration_transaction_checklist.md`, `docs/architecture/move_struct_inventory.md`, `docs/architecture/supra_restructuring_detailed_plan.md` |

> Журнал обновляется при каждом значимом шаге рефакторинга: сюда добавляются ссылки на документы, скрипты и отчёты, чтобы фиксировать накопленные артефакты и упростить контроль прогресса.

