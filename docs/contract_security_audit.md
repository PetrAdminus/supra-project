# Аудит безопасности контрактов SupraLottery

**Дата аудита:** 2025-11-02  
**Версия контрактов:** core_main_v2 / lottery_* (текущая ветка)  
**Аудитор:** Внутренний анализ (Codex)

---

## Резюме

Кодовая база SupraLottery построена вокруг модульной архитектуры c использованием Supra VRF и стандартных библиотек Move. При ручном анализе критических уязвимостей (переполнения, повторные входы, смещение вероятностей) не обнаружено: встроенные проверки `safe_add_u64` предотвращают overflow, выбор победителя опирается на равномерное `u64`, а модель исполнения Move исключает reentrancy через сторонние контракты. Основные зоны внимания носят продуктовый и операционный характер — настройка параметров, удобство администрирования, тестовое покрытие.

**Общая оценка:** 8.5/10  
**Критические проблемы:** 0  
**Высокий приоритет:** 0  
**Средний приоритет:** 3  
**Низкий приоритет:** 4

---

## 1. Подтверждённые свойства безопасности ✅

| Тема | Статус | Комментарий |
| --- | --- | --- |
| Переполнения при расчётах (jackpot, ticket_id) | Пройдена | Везде используется `safe_add_u64` c кодами ошибок `E_JACKPOT_OVERFLOW`, `E_TICKET_ID_OVERFLOW`; при срабатывании транзакция абортится. |
| Reentrancy | Пройдена | Move не допускает повторный вход в тот же модуль в рамках транзакции. `fungible_asset::transfer_with_ref` не исполняет пользовательский код. |
| RVF случайность | Пройдена | `randomness_to_u64` конвертирует первые 8 байт VRF-ответа; модульное деление обеспечивает равномерное распределение. |
| Контроль доступа | Пройдена | Capability-модель и friend-доступ разграничивают операции; критичные функции требуют ресурсов администратора. |

---

## 2. Области улучшения ⚙️

### 2.1 Настраиваемые параметры лотереи (приоритет: средний)

- ✅ Цена билета и порог авто-розыгрыша теперь хранятся в `LotteryData` и настраиваются через `set_ticket_price` / `set_auto_draw_threshold` (release 2025-11-02).  
- ✅ Добавлено событие `LotteryConfigUpdatedEvent`, фиксирующее каждое изменение.  
- ⏳ Часть конфигураций (например, доли распределения призов) всё ещё меняются только через обновление пакета.

**Следующие шаги**
1. Рассмотреть вынос остальных параметров (лимиты на draw, доли распределения) в конфиг, управляемый администратором.  
2. Добавить e2e-тесты, подтверждающие корректную установку новых параметров и автоматическое планирование draw.  
3. Согласовать мониторинг событий `LotteryConfigUpdatedEvent` с операционной командой.

### 2.2 Управление доступами и операционными токенами (приоритет: средний)

- Разные модули используют несколько аккаунтов-администраторов (`@lottery`, `@lottery_factory`, `@vrf_hub`).  
- В runbook нет единого описания того, кто отвечает за обновление snapshot-ов, whitelist VRF и пополнение депозитов.

**Рекомендации**
1. Документировать схему владения capability и подписей (кто управляет каким модулем).  
2. Рассмотреть внедрение multisig / роли «оператор» vs «владелец» для критичных функций.  
3. Обновить runbook с чек-листом по VRF-профилю: whitelist consumer, поддержание депозита, миграция snapshot-ов.

### 2.3 UX/операционные улучшения (приоритет: средний)

- Нет возможности купить сразу N билетов в одной транзакции.  
- Пользователь может многократно вызывать `buy_ticket` подряд, что усложняет ограничение абьюза.  
- Rate limiting и лимиты на размер очереди не реализованы.

**Рекомендации**
1. Реализовать `buy_tickets_batch(user, count)` с верхним ограничением (`MAX_TICKETS_PER_BATCH`).  
2. Ввести лёгкий rate limiting (хранить счётчик покупок за последний интервал, ограничивать «спам»).  
3. Добавить метрики/события `TicketsPurchased(count)` для мониторинга нагрузки.

### 2.4 Документация и тесты (приоритет: низкий)

- Не все публичные функции снабжены комментариями / пояснениями.  
- Move-тесты покрывают основной happy-path, но не содержат edge-case сценариев (максимальные значения, комбинации ошибок VRF, отсутствие snapshot-а и т.д.).

**Рекомендации**
1. Расширить тесты: отрицательные сценарии (нет билетов, двойное исполнение fulfill, рестарт без snapshot), проверки событий.  
2. Добавить fuzz/deterministic тест на распределение выигрыша при разном числе билетов.  
3. Поддерживать справочник кодов ошибок и назначение capability в `docs/`.

### 2.5 Мониторинг и события (приоритет: низкий)

- Не все изменения конфигурации и результаты миграций попадают в события.  
- Для VRF миграции полезно фиксировать события «consumer_whitelisted», «callback_sender_changed».

**Рекомендации**
1. Добавить события для административных изменений (цены, конфиг VRF, обновление whitelist).  
2. Прописать в runbook минимальный набор метрик/алертинга (остаток в `deposit`, количество pending history records).

---

## 3. План реализации

### Фаза 1 (1–2 недели) — продуктовые параметры
- [x] Добавить административные setter-ы (цена билета, лимиты, интервалы).  
- [x] Подготовить события и документацию по их использованию.  
- [x] Обновить runbook: кто и как меняет параметры.

### Фаза 2 (2–3 недели) — администрирование и UX
- [ ] Определить модель владения (единый админ или распределённые роли); при необходимости внедрить multisig.  
- [ ] Реализовать batch-покупку билетов и rate limiting.  
- [ ] Расширить метрики/журналы для мониторинга нагрузки.

### Фаза 3 (3–4 недели) — тесты и документация
- [ ] Добавить негативные Move-тесты и сценарии на отказ VRF.  
- [ ] Задокументировать pipeline пополнения депозитов и работы со snapshot-ами.  
- [ ] Подготовить справочник кодов ошибок / capability.

### Фаза 4 (ongoing) — сопровождение
- [ ] Ревью конфигурации при каждом релизе.  
- [ ] Поддержка алертинга на стороне операционной команды.  
- [ ] Регулярное тестирование smoke-тестами перед деплоем в testnet/mainnet.

---

## 4. Положительные стороны

1. **Модульность**: разделение `lottery_core`, `lottery_support`, `lottery_rewards`, `treasury` упрощает аудит и апгрейды.  
2. **Интеграция VRF**: корректно оформлен цикл `request → fulfill`, snapshot-ы whitelist-а и повторная запись вызова через `hub::record_fulfillment`.  
3. **События и история**: очередь HistoryQueue и события `DrawFulfilledEvent` облегчают синхронизацию фронта.  
4. **Capability-модель**: доступ к критичным действиям (миграция, распределение призов) защищён ресурсами и friend-декларациями.

---

## 5. Следующие шаги

1. Согласовать roadmap улучшений с продуктовой и операционной командами.  
2. После внедрения фич — прогнать обновлённые Move-тесты и smoke-тест (`supra/scripts/testnet_smoke_test.sh`).  
3. Подготовить внешнее ревью (или internal peer review) перед деплоем в публичный testnet/mainnet.  
4. Обновить пользовательскую документацию с учётом новых параметров/метрик.

---

## Приложение: коды ошибок (отрывок)

- `E_JACKPOT_OVERFLOW` = 32  
- `E_TICKET_ID_OVERFLOW` = 33  
- `E_RNG_REQUEST_OVERFLOW` = 34  
- `E_RNG_RESPONSE_OVERFLOW` = 35  
- `E_RANDOM_INDEX_OVERFLOW` = 36  

Полный перечень рекомендуется поддерживать в wiki/документации для фронтенда и интеграторов.

---

**Версия документа:** 2.0  
**Последнее обновление:** 2025-11-02
