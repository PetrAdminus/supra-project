# Справочник ошибок SupraLottery для dVRF 3.0

Документ перечисляет коды аварий из `lottery_core::core_main_v2`, связанные с онбордингом подписки, настройкой газа и обработкой VRF-колбэков.

## 1. Онбординг клиента и управление депозитом

| Код | Константа | Когда возникает | Что делать |
| --- | --- | --- | --- |
| `1` | `E_NOT_OWNER` | Любая административная функция вызывается не владельцем ресурса лотереи. | Повторить вызов от администратора (`lottery_admin`). |
| `9` | `E_INITIAL_DEPOSIT_TOO_LOW` | Передан депозит меньше расчётного `min_balance_limit`. | Увеличить `INITIAL_DEPOSIT` или уменьшить лимиты газа перед `create_subscription`. |
| `10` | `E_WITHDRAWAL_PENDING_REQUEST` | Попытка вывода средств при незавершённом VRF-запросе. | Дождаться завершения запроса (получить событие `DrawHandledEvent`) и повторить `withdraw_funds`. |
| `15` | `E_MIN_BALANCE_OVERFLOW` | Расчёт минимального баланса переполнил `u128`. | Снизить `max_gas_price`/`max_gas_limit`/`verification_gas_value`. |
| `16` | `E_GAS_CONFIG_NOT_SET` | Не вызван `configure_vrf_gas`, отсутствуют лимиты газа и снапшоты. | Настроить газ через `configure_vrf_gas` и зафиксировать снапшоты whitelist. |
| `22` | `E_CONSUMER_ALREADY_WHITELISTED` | Повторная регистрация того же потребителя VRF. | Использовать существующего потребителя либо удалить перед повторным добавлением. |
| `23` | `E_CONSUMER_NOT_WHITELISTED` | Попытка удалить потребителя, которого нет в whitelist. | Сверить `consumer_whitelist_snapshot` и передаваемый адрес. |
| `24` | `E_CLIENT_WHITELIST_SNAPSHOT_MISMATCH` | Значения `max_gas_price`/`max_gas_limit` не совпадают с сохранённым снапшотом клиента. | Обновить снапшот (`record_client_whitelist_snapshot`) и повторить операцию. |
| `25` | `E_CONSUMER_WHITELIST_SNAPSHOT_MISMATCH` | `callback_gas_price`/`callback_gas_limit` не соответствуют снапшоту потребителя. | Перезаписать снапшот (`record_consumer_whitelist_snapshot`). |
| `28` | `E_GAS_MATH_OVERFLOW` | Перемножение лимитов газа превысило границы `u128`. | Уменьшить параметры газа или использовать меньший `window`. |
| `29` | `E_INVALID_GAS_CONFIG` | Настройка газа нарушает ограничения (`callback_*` больше `max_*` или `verification_gas_value` = 0). | Согласовать параметры, затем повторить `configure_vrf_gas`. |

## 2. Настройка и отправка VRF-запросов

| Код | Константа | Когда возникает | Что делать |
| --- | --- | --- | --- |
| `6` | `E_PENDING_REQUEST_STATE` | Новый запрос пытается стартовать при уже запланированном розыгрыше. | Дождаться события `DrawHandledEvent` или отменить розыгрыш. |
| `17` | `E_REQUEST_STILL_PENDING` | Запрос случайности инициируется повторно до завершения предыдущего. | Не запускать `request_draw`, пока `pending_request` не очищен. |
| `18` | `E_UNEXPECTED_RNG_COUNT` | Количество случайных чисел не совпадает с настройкой `EXPECTED_RNG_COUNT`. | Сверить конфигурацию `configure_vrf_request`. |
| `19` | `E_CLIENT_SEED_OVERFLOW` | Поле `next_client_seed` достигло `u64::MAX`. | Сбросить seed через административную функцию (после аудита), чтобы восстановить диапазон. |
| `26` | `E_INVALID_REQUEST_CONFIG` | Пара `rng_count`/`num_confirmations` нарушает ограничения (`rng_count = 0` или подтверждений больше `MAX_CONFIRMATIONS`). | Передать допустимые значения в `configure_vrf_request`. |
| `27` | `E_CLIENT_SEED_REGRESSION` | Новый `client_seed` меньше сохранённого. | Использовать монотонно возрастающий seed. |
| `31` | `E_INVALID_CONSUMER_ADDRESS` | Попытка whitelisting для нулевого или повторяющегося адреса. | Проверить аргумент `consumer` перед вызовом. |

## 3. Обработка VRF-колбэков

| Код | Константа | Когда возникает | Что делать |
| --- | --- | --- | --- |
| `7` | `E_NONCE_MISMATCH` | Колбэк пришёл с nonce, не совпадающим с `pending_request`. | Игнорировать событие и запросить повторную генерацию через Supra. |
| `8` | `E_RANDOM_BYTES_TOO_SHORT` | `verified_nums` пустой или меньше ожидаемого количества значений. | Проверить статус dVRF и выполнить повторный запрос. |
| `14` | `E_INVALID_CALLBACK_PAYLOAD` | Хэш полезной нагрузки VRF не совпадает с записанным при запросе. | Сигнализировать Supra и повторить запрос; убедиться, что агрегатор не подменяет payload. |
| `20` | `E_CALLBACK_SOURCE_NOT_SET` | Не настроен адрес агрегатора до прихода колбэка. | Вызвать `set_callback_aggregator` перед запросом. |
| `21` | `E_CALLBACK_CALLER_NOT_ALLOWED` | Колбэк пришёл от адреса, отличного от whitelisted агрегатора. | Сверить whitelisting и авторизовать корректный адрес. |
| `30` | `E_INVALID_CALLBACK_SENDER` | Сам вызов обработчика выполнен не через Supra VRF агрегатор (например, напрямую админом). | Не вызывать `handle_verified_random` вручную; использовать VRF. |
| `32` | `E_JACKPOT_OVERFLOW` | Выплата победителю переполнит `u64`. | Уменьшить накопленный приз до безопасного значения. |
| `33` | `E_TICKET_ID_OVERFLOW` | Билеты превысили лимит `u64`. | Сбросить розыгрыш, переинициализировать `next_ticket_id`. |
| `34` | `E_RNG_REQUEST_OVERFLOW` | Счётчик запросов достиг `u64::MAX`. | Заархивировать данные и сбросить счётчик через миграцию. |
| `35` | `E_RNG_RESPONSE_OVERFLOW` | Количество обработанных ответов превысило `u64::MAX`. | Аналогично: провести миграцию или сбросить состояние. |
| `36` | `E_RANDOM_INDEX_OVERFLOW` | Индекс победителя при оффлайн-розыгрыше вышел за пределы `vector::length`. | Проверить состояние тикетов перед `simple_draw`. |
| `37` | `E_CANNOT_REMOVE_DEFAULT_CONSUMER` | Попытка удалить базового потребителя (`@lottery`). | Убедиться, что удаляется дополнительный потребитель, а не основной. |

## 4. Дополнительные материалы

- [План миграции dVRF 3.0](./dvrf_v3_migration_plan.md)
- [Тестнет-runbook: раздел об оффлайн-режиме](./testnet_runbook.md#81-оффлайн-и-демо-режим)
