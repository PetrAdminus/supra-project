# План трансформации Supra Lottery

## Основные принципы
- **Эволюция вместо переписывания:** строим VRF-хаб, фабрику лотерей и сопутствующие сервисы поверх текущего репозитория Supra Lottery, сохраняя полезные инструменты и последовательно рефакторя ончейн-состояние.
- **Решения совместно с владельцем продукта:** когда требуется уточнение по функциональности или реализации, команда разработки запрашивает вводные у владельца продукта до начала работ.
- **Масштабируемость по умолчанию:** избегаем уникальных допущений, чтобы каждый компонент (контракты, бэкенд, фронтенд, growth-функции) легко поддерживал новые лотереи, джекпоты, партнёров и регионы без капитальной перестройки.
- **Приоритет Supra-инструментов:** целимся в блокчейн Supra и при любой возможности используем официальные SDK, CLI и инфраструктуру Supra.
- **Двухсетевой режим по умолчанию:** все инструкции, скрипты и конфигурации готовим так, чтобы без изменений работали в тестовой и основной сетях Supra; тестнет служит площадкой разработки, а к релизу контракты, параметры VRF и казначейства должны быть задеплоины и на мейннете.

## Сводка статуса (октябрь 2025)
**Move-контракты.** В `SupraLottery/supra/move_workspace/lottery/sources/` опубликованы модули ядра (`Lottery.move`), раундов и экземпляров (`LotteryRounds.move`, `LotteryInstances.move`), автопокупки (`Autopurchase.move`), VIP/рефералок/магазина (`Vip.move`, `Referrals.move`, `Store.move`), глобального джекпота и истории (`Jackpot.move`, `History.move`), операторов и NFT-наград (`Operators.move`, `NftRewards.move`), а также многопулового казначейства (`Treasury.move`, `TreasuryMulti.move`) и миграций (`Migration.move`).
**Инфраструктура VRF.** Пакеты `vrf_hub` и `lottery_factory` содержат VRF-хаб с таблицами запросов и событиями (`VRFHub.move`, `Table.move`) и фабрику идентификаторов (`LotteryFactory.move`), используемую лотереей и мониторингом.
**Python-утилиты.** Каталог `SupraLottery/supra/scripts/` предоставляет CLI (`cli.py`), FastAPI-сервер (`api_server.py`) и сервисные подмодули (`accounts/`, `progress/`, `realtime/`, `support/`), а также автоматизацию миграций, мониторинга и отчётности (`testnet_*.sh`, `lib/monitoring.py`, `testnet_monitor_*.py`).
**Тесты.** Move-юнит-тесты размещены в `SupraLottery/supra/move_workspace/lottery/tests/`, Python-тесты — в `SupraLottery/tests`, фронтенд покрыт Vitest-спецификациями и мок-режимами в `frontend/src/testing/`.
**Фронтенд.** Актуальные экраны собраны в `frontend/src/features/` (Dashboard, Lotteries, Tickets, Wallet) с общими состояниями (`frontend/src/app/`, `frontend/src/store/`) и интеграцией с Supra API (`frontend/src/api/supraClient.ts`).

## Направления работ
### 1. Ончейн-архитектура (VRF-хаб и фабрика лотерей)
**Реализовано**
- Move-пакет разделён на специализированные модули: экземпляры (`LotteryInstances.move`), раунды (`LotteryRounds.move`), история (`History.move`), операторы (`Operators.move`), автопокупка (`Autopurchase.move`), глобальный джекпот (`Jackpot.move`) и миграции (`Migration.move`), что позволяет хранить состояние каждой лотереи в таблицах и обрабатывать жизненный цикл раунда независимо.
- VRF-хаб (`SupraLottery/supra/move_workspace/vrf_hub/sources/VRFHub.move`) ведёт `HubState` с очередью запросов, whitelisting отправителя колбэка и событиями регистрации/fulfill, а `vrf_hub::table` предоставляет общий примитив хранения.
- `lottery::instances` синхронизируется с фабрикой (`lottery_factory::registry`), создаёт/активирует лотереи, публикует события и предоставляет view-функции `list_lottery_ids` и `list_active_lottery_ids` для фронтенда и мониторинга.
- `lottery::rounds` управляет покупкой билетов, планированием и исполнением розыгрышей, запрашивает случайность у VRF-хаба, валидирует whitelisting и обновляет снапшоты; интеграция с `treasury_v1` и `treasury_multi` фиксирует поступления и выплаты.
- Дополнительные модули (`lottery::history`, `lottery::operators`, `lottery::autopurchase`, `lottery::vip`, `lottery::store`, `lottery::referrals`) расширяют оффчейн API: события, агрегированные view-функции и Move-тесты покрывают основные сценарии пользователей и админов.
- `lottery::migration` переносит данные из `main_v2` в новые таблицы, проверяет отсутствие незавершённых VRF-запросов и обновляет конфигурацию долей.

**Следующие шаги**
- Завершить эксплуатационные скрипты для массовой миграции исторических розыгрышей и синхронизации snapshot-таблиц (интеграция с `supra/scripts/testnet_migration.sh`).
- Подготовить публичную спецификацию API view-функций (описание полезной нагрузки для фронтенда/интеграций), чтобы снизить зависимость от чтения Move-кода.
- Расширить мониторинг VRF-хаба метриками в Prometheus/Slack-алертах (использовать существующие заготовки `testnet_monitor_*.py`).
### 2. Казначейство и экономика
**Реализовано**
- `lottery::treasury_v1` и `lottery::treasury_multi` управляют многопуловым распределением средств: настраиваемые доли в базисных пунктах, события `AllocationRecordedEvent`/`JackpotPaidEvent` и view-функции `get_lottery_summary`, `list_lottery_ids` доступны оффчейн-сервисам.
- `lottery::rounds` и `lottery::jackpot` автоматически фиксируют поступления и джекпот, вызывая `treasury_multi::record_draw_internal` и `treasury_multi::distribute_jackpot_internal`, а Move-тесты покрывают нормальные и отрицательные сценарии.
- `lottery::autopurchase`, `lottery::vip`, `lottery::store` и `lottery::referrals` расширяют экономику: события фиксируют депозиты, подписки и продажи, агрегированные view-функции возвращают сводки по лотереям и игрокам.
- CLI и Python-скрипты (`SupraLottery/supra/scripts/configure_treasury_distribution.py`, `configure_vrf_gas.py`, `testnet_migration.sh`) автоматизируют настройку долей, whitelisting и миграции.

**Следующие шаги**
- Согласовать с владельцем продукта конечные значения долей и задокументировать их в `docs/adr/treasury-multi-pool.md`.
- Добавить оффчейн-дашборды по событиям казначейства (использовать `supra/scripts/testnet_monitor_prometheus.py` и `testnet_monitor_slack.py`).
- Провести аудит учётных записей получателей и заморозки primary store, чтобы подтвердить соответствие политикам Supra FA.
### 3. Аккаунты, прогресс и платформа данных
**Реализовано**
- FastAPI-бэкенд (`SupraLottery/supra/scripts/api_server.py`) агрегирует роутеры `accounts`, `progress`, `realtime`, `support`; модули используют SQLAlchemy и Pydantic для управления профилями, прогрессом и уведомлениями.
- Python-тесты (`SupraLottery/tests/test_accounts.py`, `test_progress.py`, `test_support.py`, `test_api_server.py`) покрывают CRUD-операции, валидацию и кеширование/WS-обновления API.
- Фронтенд использует TypeScript-клиент (`frontend/src/api/supraClient.ts`) и глобальные состояния (`frontend/src/store/`) для отображения профиля, прогресса и статусов лотерей.

**Следующие шаги**
- Завершить проектирование постоянного хранилища (PostgreSQL) и вынести настройки подключений из `.env`/переменных окружения в отдельный конфиг.
- Подготовить миграции БД и документацию REST/WS API (OpenAPI-спека + схемы событий), чтобы облегчить интеграцию сторонних сервисов.
- Обновить фронтенд-дизайн после согласования макета Figma и синхронизировать гайды в `frontend/README.md`.
### 4. Прозрачность и честность
- Собирать события VRF, хэши payload и снапшоты whitelisting через выделенный сервис-инжестер.
- Открыть аудит-эндпоинты, которые отдают воспроизводимые данные розыгрышей на фронтенд.
- Построить интерфейс «Панель честности», демонстрирующий генерацию seed, доказательство случайности и выбор победителя.
- Хранить артефакты для долгосрочной проверки и регуляторных запросов.
- Python-утилита мониторинга (`supra.scripts.lib.monitoring`) уже собирает состояние VRF-хаба, коллекции мульти-лотерей, многопулового казначейства и теперь включает автопокупку: в отчёте `/status` появляется раздел с суммарными балансами и списком игроков по каждой лотерее.
- Тот же отчёт расширен секцией `metadata`: мониторинг вызывает `lottery::metadata::list_lottery_ids` и `get_metadata`, поэтому фронтенд и Supra AutoFi получают витринные описания розыгрышей из одного источника без дублирования с CMS.
- Тот же отчёт расширен секцией `operators`: мониторинг читает `lottery::operators::list_lottery_ids`, `get_owner` и `list_operators`, что позволяет Supra AutoFi, админ-панели и фронтенду видеть ответственных и делегированных операторов по каждой лотерее.
- Тот же отчёт расширен блоком `referrals`: для каждой лотереи возвращаются конфигурация бонусов и агрегированные выплаты, что упрощает настройку growth-кампаний и контроль операционного пула.
- Добавлен раздел `vip`: мониторинг подтягивает `lottery::vip::get_lottery_summary` и `list_players`, чтобы фронтенд и Supra AutoFi видели выручку подписок, активных участников и список адресов без дополнительных запросов.
- Модуль `supra.scripts.lib.vrf_audit` и команда CLI `vrf-audit` выгружают события `DrawRequestIssued/DrawFulfilled` и `RandomnessRequested/RandomnessFulfilled`, а REST-эндпоинт `/lotteries/{id}/vrf-log` отдаёт агрегированный отчёт для будущей панели честности.
- Фронтенд получил страницу `/fairness`, которая отображает VRF-журнал, снепшоты раундов и события хаба для выбранной лотереи с настройкой лимита событий.
- Интерфейс панели честности поддерживает фильтрацию по типу события и поисковому запросу, что облегчает анализ запросов VRF и сопоставление ответов.

### 5. Real-time коммуникации и уведомления
- Внедрить слой WebSocket/SSE для лобби-чата, объявлений о лотереях и трансляции результатов.
- Хранить историю чата с политиками модерации и сроками хранения, задокументированными в `docs/policies/chat-moderation.md`.
- Отображать уведомления на фронтенде и интегрировать механики шаринга результатов в соцсети.
- Реализован базовый сервис `/chat`: REST-эндпоинты для сообщений и объявлений, SQLAlchemy-таблицы, WebSocket `/chat/ws/{room}` и
  тесты `test_chat_rest_roundtrip`/`test_websocket_receives_broadcast`, подтверждающие сохранение и push-рассылку.
- На дашборде добавлена панель чата и объявлений: фронтенд загружает данные через `/chat/messages`/`/chat/announcements`, в Supra-режиме автоматически подключается WebSocket, а в mock-режиме работает локальное хранилище.

### 6. NFT-стратегия и награды
- Определить, какие NFT выпускаем сами, а какие берём у партнёров (например, Crystara), и зафиксировать подход в `docs/adr/nft-strategy.md`.
- При необходимости реализовать Move-модули для выпуска трофеев победителей и связать их с результатами лотерей.
- Синхронизировать метаданные на бэкенде и отрисовывать выбор аватаров/трофеев в профилях пользователей.
- Модуль `lottery::nft_rewards` уже выпускает уникальные бейджи победителей: события `BadgeMintedEvent`/`BadgeBurnedEvent`, view-функции `has_badge`/`list_badges`/`get_badge` и Move-тесты подтверждают корректность минта, ограничение по администратору и возможность ручного сжигания владельцем.

### 7. Поддержка, контент и локализация
- Обновить инфраструктуру i18n, чтобы поддерживать несколько локалей и динамический контент.
- Создать центр поддержки с FAQ, формой тикетов и редакционными гайдами.
- Предоставить инструменты для извлечения переводов и выкладки контента (`frontend/scripts/extract-translations.ts`).
- Реализован базовый центр поддержки: SQLAlchemy-таблицы статей и тикетов, REST-эндпоинты `/support/*`, тесты сервиса и API.
- Внедрены `i18next` и `react-i18next`, добавлен ADR `docs/adr/i18n-cms.md`, хук `useI18n` построен на стандартном API, а скрипт `pnpm run i18n:extract` выгружает словари в `frontend/public/locales/*`.

### 8. Интеграция дизайн-системы
- Перенести предстоящий Figma-дизайн в переиспользуемые токены (цвет, типографика, отступы) и применить их ко всей библиотеке React-компонентов.
- Пересобрать базовые layout-компоненты, страницы каталога и детальные карточки лотерей по спецификации Figma.
- Обновить истории Storybook и визуальные регрессионные тесты, чтобы зафиксировать новый гайд.
- Подготовить `docs/design-system.md` с правилами использования для будущих компонентов.

### 9. Безопасность, комплаенс и операции
- Определить ожидания KYC/AML и регуляторные ограничения для мульти-лотерей (`docs/adr/compliance.md`).
- Запланировать внешние аудиты Move-контрактов и бэкенда и оформить план в `docs/security/audit_plan.md`.
- Настроить runbook’и реагирования на инциденты, процедуры отзывов ключей и проверки в CI (статический анализ, сканирование зависимостей).
- Усилить мониторинг VRF-хаба, балансов казначейства и real-time сервисов (дашборды, алерты).
- Подготовить двусетевой пайплайн деплоя: поддерживать отдельные профили Supra CLI (`testnet` и `mainnet`), синхронизированные версии пакетов и runbook’и переключения окружений, включая whitelisting и управление ключами.

### 10. Аналитика и рост
- Собирать продуктовые метрики (DAU, покупки билетов, выполнение чек-листов, эффективность рефералок) и описать их в `docs/adr/analytics.md`.
- Поток событий с бэкенда и фронтенда направить в аналитическое хранилище (ClickHouse/BigQuery) с дашбордами (Metabase/Superset).
- Реализовать growth-механики: билеты за чек-лист, реферальные и тестерские награды, магазин монетизации (NFT или VIP-подписки). Автопокупка билетов реализована на ончейн-уровне (`lottery::autopurchase`) и готова к интеграции с оффчейн-сервисами и UX.
- `lottery::referrals` уже реализует реферальную программу: конфигурацию бонусов на лотерею, регистрацию связей игрок → реферер, автоматические выплаты из операционного пула и view-статистику для мониторинга; покрыт Move-тестами `referrals_tests`.
- `lottery::store` добавляет магазин цифровых товаров: администратор управляет ассортиментом через `upsert_item` и `set_availability`, игроки покупают товары напрямую из кошелька через `purchase`, а выручка отражается в операционном пуле (`treasury_multi::record_operations_income_internal`). View-функции `list_lottery_ids`, `list_item_ids` и `get_lottery_summary` обеспечивают мониторинг каталога; Move-тесты `store_tests` покрывают списание запасов и защиту от перепродажи.
- `lottery::metadata` разворачивает реестр витринных описаний (название, описание, ссылки, изображение) для каждой лотереи, публикует события `LotteryMetadataUpsertedEvent`/`LotteryMetadataRemovedEvent` и предоставляет view-функции `list_lottery_ids`, `has_metadata`, `get_metadata`; Move-тесты `metadata_tests` проверяют обновление записей и защиту от неавторизованных вызовов.
- Подготовить бренд-активы (название, логотип, промо-сайт) и синхронизировать маркетинг с запуском лотерей.

## Дорожная карта поставки
1. **Этап 0 – Исследование и архитектура:** подтвердить требования, создать ADR, согласовать дизайн-токены и подготовить общий инструментарий.
2. **Этап 1 – Ончейн-ядро:** реализовать VRF-хаб, фабрику лотерей, расширения казначейства и миграционные скрипты с Move-тестами.
   - Статус: VRF-хаб, фабрика, коллекция экземпляров, модуль раундов и многопуловое казначейство развернуты и связаны между собой; добавлены события регистрации, синхронизации blueprint, управления раундами и Move-тесты на основные сценарии.
3. **Этап 2 – Бэкенд-платформа:** развернуть сервис аккаунтов, сбор данных, real-time слой, fairness-API и автоматизации Supra AutoFi.
4. **Этап 3 – Фронтенд-опыт:** интегрировать Figma-дизайн, построить каталог/детали лотерей, управление профилем, чат, панель честности и локализацию.
5. **Этап 4 – Growth-функции:** запустить чек-листы, розыгрыши глобального джекпота, автопокупку, реферальные и тестерские бонусы, NFT-награды и магазин.
6. **Этап 5 – Запуск и сопровождение:** провести аудиты, нагрузочные тесты, комплаенс-проверки, маркетинговый релиз и наладить пост-релизную аналитику.
   - Дополнительно: зафиксировать успешный деплой и smoke-тесты VRF-хаба, фабрики и мульти-лотерей в обеих сетях (`testnet`/`mainnet`), синхронизировать адреса и параметры в документации и runbook’ах.

## Открытые вопросы и участие владельца продукта
- Вопросы по продукту, экономике или дизайну, требующие решения, будем выносить владельцу продукта до начала разработки.
- Новые инструменты Supra или партнёрские интеграции оцениваем совместно, чтобы сохранить совместимость с возможностями экосистемы.

## Как стартовать
- Использовать текущий репозиторий как фундамент, постепенно заменяя модули и сервисы согласно дорожной карте.
- Раннее развернуть общую инфраструктуру (БД, очереди сообщений, аналитический конвейер), чтобы команды могли работать параллельно.
- По возможности применять Supra CLI, Supra AutoFi и другие официальные инструменты, оставаясь нацелёнными на блокчейн Supra.

