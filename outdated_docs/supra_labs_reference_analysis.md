# Анализ открытых репозиториев Supra-Labs

## Обзор доступных источников
Организация Supra-Labs в открытом доступе предоставляет в основном документацию и шаблоны, а не полноценные рабочие пакеты лотереи. Репозиторий `documentation` представляет собой монорепозиторий с руководствами и не содержит Move-модулей, применимых в качестве эталона для лотереи.【F:tmp/Supra-Labs-documentation-7c97570/README.md†L1-L12】

Move-код обнаружен в двух публичных шаблонах:

- `supra-dapp-templates` — содержит простые проекты, включая шаблон VRF и шаблон автоматизации.【F:tmp/Supra-Labs-supra-dapp-templates-ee13b1c/templates/Supra dVRF Template/Move.toml†L1-L23】【F:tmp/Supra-Labs-supra-dapp-templates-ee13b1c/templates/Supra Automation Template/sources/source.move†L1-L190】
- `PBO-Full-Voting-dapp` — демонстрационный децентрализованный сервис голосования с единичным пакетом Move.【F:tmp/Supra-Labs-PBO-Full-Voting-dapp-159d29e/supra/move_workspace/exampleContract/Move.toml†L1-L16】【F:tmp/Supra-Labs-PBO-Full-Voting-dapp-159d29e/supra/move_workspace/exampleContract/sources/voting.move†L1-L200】

## Move.toml и адреса
Рабочее пространство SupraLottery объединяет четыре пакета (`lottery`, `vrf_hub`, `lottery_factory`, `SupraVrf`) и закрепляет все ключевые адреса (лотерея, VRF-хаб, фабрика) за одним аккаунтом, что отражает тесно связанную многомодульную архитектуру.【F:SupraLottery/supra/move_workspace/Move.toml†L1-L18】 Локальный пакет `lottery` дополнительно зависит от внутренних модулей и определяет тестовые адреса игроков и пулов.【F:SupraLottery/supra/move_workspace/lottery/Move.toml†L1-L27】

В шаблонах Supra-Labs `Move.toml` описывает лишь одиночный пакет с внешними зависимостями на SupraFramework (и SupraVrf для VRF-примера), без объединения нескольких локальных пакетов либо тестовой адресации для сложных сценариев.【F:tmp/Supra-Labs-supra-dapp-templates-ee13b1c/templates/Supra dVRF Template/Move.toml†L1-L23】【F:tmp/Supra-Labs-PBO-Full-Voting-dapp-159d29e/supra/move_workspace/exampleContract/Move.toml†L1-L16】 Таким образом, структура workspace SupraLottery существенно богаче и не находит прямого аналога в доступных шаблонах Supra-Labs.

## Ключевые модули и логика
- **VRF и основная лотерея.** Модуль `lottery::main_v2` описывает десятки кодов ошибок, снапшоты whitelists, конфигурацию VRF и обширный набор событий для управления подпиской, розыгрышами и whitelisting’ом.【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L1-L200】 В шаблоне Supra-Labs VRF реализован через `dice_addr::dice_roll`, который хранит только таблицу запросов и умеет отправлять/обрабатывать одиночные запросы без whitelists, контроля газа и сложных проверок.【F:tmp/Supra-Labs-supra-dapp-templates-ee13b1c/templates/Supra dVRF Template/sources/contract.move†L1-L128】 Полноценного соответствия логике SupraLottery в эталоне нет.

- **Раунды и экземпляры.** В SupraLottery управление раундами (`lottery::rounds`) и экземплярами (`lottery::instances`) основано на таблицах состояний, снапшотах и множестве событий для синхронизации с фабрикой и VRF-хабом.【F:SupraLottery/supra/move_workspace/lottery/sources/LotteryRounds.move†L1-L200】【F:SupraLottery/supra/move_workspace/lottery/sources/LotteryInstances.move†L1-L200】 Аналогичных модулей в шаблонах Supra-Labs не обнаружено.

- **Автопокупка.** Локальный `lottery::autopurchase` ведёт балансы игроков, планы покупки, события депозита/возврата и синхронизацию с раундами и казначейством.【F:SupraLottery/supra/move_workspace/lottery/sources/Autopurchase.move†L1-L200】 Шаблон Supra-Labs `autofinal` ограничивается контролем баланса одного получателя и испусканием базовых событий автоматизации без интеграции с лотереей или VRF.【F:tmp/Supra-Labs-supra-dapp-templates-ee13b1c/templates/Supra Automation Template/sources/source.move†L1-L190】

- **Прочие модули.** Единственный другой найденный Move-код Supra-Labs (`owner::voting`) реализует простую логику предложений и голосов, не связанную с лотереей.【F:tmp/Supra-Labs-PBO-Full-Voting-dapp-159d29e/supra/move_workspace/exampleContract/sources/voting.move†L1-L200】 Он не покрывает VRF, казначейство, многоэкземплярные сценарии или whitelists, присутствующие в SupraLottery.

## Вспомогательные структуры и проверки
Локальные структуры (`LotteryData`, `RoundCollection`, `AutopurchaseState`) включают сложные снапшоты, счетчики и ограничения для VRF/казначейства, отражая зрелую бизнес-логику。【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L1-L200】【F:SupraLottery/supra/move_workspace/lottery/sources/LotteryRounds.move†L1-L200】【F:SupraLottery/supra/move_workspace/lottery/sources/Autopurchase.move†L1-L200】 В Supra-Labs шаблонах структуры минималистичны (таблица запросов VRF, состояние топ-апа, список предложений) и не обеспечивают сопоставимых проверок или исторических данных.【F:tmp/Supra-Labs-supra-dapp-templates-ee13b1c/templates/Supra dVRF Template/sources/contract.move†L1-L128】【F:tmp/Supra-Labs-supra-dapp-templates-ee13b1c/templates/Supra Automation Template/sources/source.move†L1-L190】【F:tmp/Supra-Labs-PBO-Full-Voting-dapp-159d29e/supra/move_workspace/exampleContract/sources/voting.move†L1-L200】

## Тесты
Тестовый модуль `lottery::lottery_tests` покрывает десятки позитивных и негативных сценариев: настройку казначейства, whitelists, ошибки VRF и переполнения, используя многочисленные ожидаемые коды ошибок.【F:SupraLottery/supra/move_workspace/lottery/tests/lottery_tests.move†L1-L160】 В Supra-Labs тесты ограничены шаблонными случаями (`test_init`, `test_create_proposal`, `test_vote`) без взаимодействия с VRF, whitelists или автопокупкой.【F:tmp/Supra-Labs-PBO-Full-Voting-dapp-159d29e/supra/move_workspace/exampleContract/sources/voting.move†L84-L195】

## Выводы
1. Публичные репозитории Supra-Labs предоставляют лишь упрощённые шаблоны, которые не покрывают функциональность SupraLottery (VRF-подписки, многоэкземплярные раунды, автопокупку, казначейство).
2. Move.toml из шаблонов описывает одиночные проекты и не отражает структуру workspace SupraLottery.
3. Для сопоставления с эталоном остаётся либо получать закрытый код, либо формализовать текущую реализацию SupraLottery как самостоятельный стандарт и документировать ключевые отличия.

## Сопоставление с официальной документацией Supra

- **Базовые зависимости и структура workspace.** Гайд Supra по созданию Move-пакета требует обязательной зависимости от `SupraFramework` на ветке `dev` репозитория Aptos и настройки именованных адресов через `Move.toml`.[^supra-framework] В SupraLottery это требование выполняется: общий workspace включает пакеты лотереи, фабрики и VRF-хаба, а `lottery/Move.toml` явно тянет `SupraFramework`, `MoveStdlib` и локальные пакеты, сохраняя единые адреса для on-chain аккаунтов и тестовых профилей.【F:SupraLottery/supra/move_workspace/Move.toml†L1-L18】【F:SupraLottery/supra/move_workspace/lottery/Move.toml†L1-L27】 Это соответствует рекомендованной структуре Supra и фиксирует все зависимости на «базу» платформы.

- **Настройки газа VRF.** Документация Supra описывает два уровня конфигурации газа (пара `maxGasPrice`/`maxGasLimit` на подписку и `callbackGasPrice`/`callbackGasLimit` для контракта) и указывает, что обновление происходит через on-chain функции `addClientToWhitelist`, `addContractToWhitelist` и соответствующие апдейтеры.[^supra-gas] Модуль `Lottery.move` повторяет эту модель: админ конфигурирует четыре параметра и `verification_gas_value`, при этом Move-код проверяет положительные значения, ограничения `callback <= max` и запрещает изменения при pending-запросе, а событие `GasConfigUpdatedEvent` логирует текущую конфигурацию.【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L658-L817】 Это поведение напрямую следует рекомендациям Supra по «базовым» настройкам газа.

- **Расчёт минимального баланса.** Supra определяет формулу `Minimum Balance = 30 requests × maxGasPrice × (maxGasLimit + verificationGas)` для приёма VRF-запросов.[^supra-gas] В SupraLottery функции `calculate_per_request_gas_fee` и `calculate_min_balance` реализуют ту же формулу: сначала суммируют `max_gas_limit` и `verification_gas_value`, умножают на `max_gas_price`, а затем масштабируют на константу окна запросов `MIN_REQUEST_WINDOW_U128`, конвертируя результат в `u64` с проверкой переполнения.【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L1983-L2011】 Дополнительно событие `MinimumBalanceUpdatedEvent` фиксирует пересчитанное значение для мониторинга.【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L640-L650】 Таким образом, экономика подписки полностью синхронизирована с публичной документацией Supra.

- **Само-включение и whitelisting потребителей.** Руководство по миграции на dVRF 3.0 подчёркивает self-whitelisting через `addClientToWhitelist` (с проверкой положительных `maxGasPrice`/`maxGasLimit`) и добавление контрактов функцией `addContractToWhitelist`, где `callback`-параметры не должны превышать клиентские лимиты.[^supra-whitelist] SupraLottery сохраняет эти инварианты: перед записью снапшотов whitelists Move-код сверяет `max_gas_price`/`max_gas_limit` и `callback`-значения с текущей конфигурацией и отклоняет несоответствие, что гарантирует согласованность с ожидаемыми параметрами self-whitelisting.【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L676-L740】 События `ClientWhitelistRecordedEvent` и `ConsumerWhitelistSnapshotRecordedEvent` зеркалят рекомендации Supra по журнальному контролю whitelists.

- **Блокировка средств при pending-запросах.** Документация Supra указывает, что в dVRF 3.0 средства блокируются при наличии незавершённых запросов и клиента нельзя мигрировать/вывести средства до их обработки.[^supra-whitelist] Модуль `Lottery.move` соответствует этой модели: функции `configure_vrf_gas_internal`, `configure_vrf_request`, `withdraw_funds_internal` и `remove_subscription_internal` проверяют `pending_request` и при его наличии прерывают операцию ошибкой `E_REQUEST_STILL_PENDING`/`E_WITHDRAWAL_PENDING_REQUEST`, тем самым повторяя «базовую» логику Supra.【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L772-L877】

В результате ключевые элементы «базы Supra» (зависимости, конфигурация газа, whitelisting и экономические ограничения подписки) в SupraLottery реализованы в полном соответствии с публичной документацией. Это позволяет использовать официальные гайты Supra в качестве эталона для ревью и дальнейших проверок без доступа к закрытым исходникам.

[^supra-framework]: Supra Docs — *Create a Move Package*, раздел о генерации `Move.toml` и автоматическом подключении `SupraFramework` (ветка `dev`).【F:tmp/documentation-main/movevm/getting-started/create-a-move-package/README.md†L5-L41】
[^supra-gas]: Supra Docs — *Gas Configurations* (раздел dVRF), описание уровней конфигурации, on-chain функций и формулы минимального баланса.【F:tmp/documentation-main/dvrf/build-third-party-evm-networks/gas-configurations.md†L1-L68】
[^supra-whitelist]: Supra Docs — *Migration to dVRF 3.0*, разделы Self-whitelisting, Whitelist Your Consumer Contracts и сравнительная таблица dVRF 2/3 (блокировка средств).【F:tmp/documentation-main/dvrf/build-third-party-evm-networks/migration-to-dvrf-3.0.md†L158-L210】
