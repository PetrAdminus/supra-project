# Аудит интеграции Supra dVRF 3.0 в SupraLottery

## Использованные источники
- [Supra Docs — Overview](https://docs.supra.com/)
- [Supra Docs — Move SDK](https://docs.supra.com/network/move/)
- [Supra Labs GitHub — dVRF примеры и Move контракты](https://github.com/Supra-Labs)

## Резюме
- Контракт `lottery::main_v2` хранит и сверяет sha3-256 хеш BCS-конверта запроса, декодирует полезную нагрузку и сопоставляет `nonce`, `client_seed` и `requester`, что соответствует рекомендациям Supra по защите колбэков dVRF.【F:supra/move_workspace/lottery/sources/Lottery.move†L470-L520】【F:supra/move_workspace/lottery/sources/Lottery.move†L644-L716】【F:supra/move_workspace/lottery/sources/Lottery.move†L947-L962】
- Газовые параметры VRF и callback конфигурация управляются через on-chain события и используют формулу VRF 3.0 `minRequests × maxGasPrice × (maxGasLimit + verificationGasValue)` при расчёте минимального баланса подписки.【F:supra/move_workspace/lottery/sources/Lottery.move†L208-L335】【F:supra/move_workspace/lottery/sources/Lottery.move†L772-L808】
- On-chain whitelisting агрегатора и потребителей, а также проверка `rng_count` и длины массива случайностей предотвращают несанкционированные колбэки и неполные ответы, что согласуется с Supra Docs и GitHub-примерами Supra Labs.【F:supra/move_workspace/lottery/sources/Lottery.move†L328-L400】【F:supra/move_workspace/lottery/sources/Lottery.move†L620-L716】
- Модульные тесты покрывают whitelisting, расчёт газа, валидацию хеша полезной нагрузки и негативные сценарии с подменой данных, что подтверждает соблюдение требований Supra VRF 3.0 на уровне Move-кода.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L1-L200】【F:supra/move_workspace/lottery/tests/lottery_tests.move†L520-L677】【F:supra/move_workspace/lottery/tests/lottery_tests.move†L964-L1004】

## Карта соответствия требованиям Supra dVRF 3.0
| Требование | Реализация | Тестовое покрытие |
| --- | --- | --- |
| Проверка хеша полезной нагрузки и параметров `nonce`/`client_seed`/`requester` | `record_vrf_request` сохраняет sha3-256 хеш, `ensure_payload_hash_matches` сверяет его с `message` и декодирует конверт VRF.【F:supra/move_workspace/lottery/sources/Lottery.move†L470-L520】【F:supra/move_workspace/lottery/sources/Lottery.move†L947-L962】 | `validate_payload_hash_*` и `handle_verified_random_*` тесты эмулируют корректные и подменённые payload'ы.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L587-L720】【F:supra/move_workspace/lottery/tests/lottery_tests.move†L964-L1004】 |
| Контроль `rng_count` и длины массива случайностей | `handle_verified_random` проверяет `rng_count` и `vector::length` перед обработкой результата.【F:supra/move_workspace/lottery/sources/Lottery.move†L644-L716】 | Тесты VRF-обработчика проверяют отклонение ответов с неверным `rng_count` и размером массива.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L720-L900】 |
| Предварительная конфигурация газа и whitelisting перед VRF-запросом | `configure_vrf_gas_internal` запрещает изменение настроек при pending-запросе, `request_draw` вызывает `ensure_gas_configured` и проверяет whitelisting агрегатора/потребителя.【F:supra/move_workspace/lottery/sources/Lottery.move†L328-L520】 | Тесты фиксируют необходимость настройки газа, whitelisting и событие конфигурации.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L200-L519】 |
| Формула минимального баланса VRF 3.0 | `calculate_per_request_gas_fee` и `calculate_min_balance` используют `maxGasPrice × (maxGasLimit + verificationGasValue) × minRequests`.【F:supra/move_workspace/lottery/sources/Lottery.move†L772-L808】 | Тесты пересчитывают хеш payload'а и стоимость запроса после обновления газа.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L520-L600】 |
| Whitelisting агрегатора и потребителей, запрет несанкционированных колбэков | Хранение белых списков и проверки в `ensure_callback_caller_allowed`/`ensure_consumer_whitelisted` предотвращают доступ посторонних адресов.【F:supra/move_workspace/lottery/sources/Lottery.move†L328-L400】【F:supra/move_workspace/lottery/sources/Lottery.move†L716-L738】 | Тесты `whitelisting_events_*` и `handle_verified_random_rejects_wrong_requester_in_payload` подтверждают защиту от чужих вызовов.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L1-L200】【F:supra/move_workspace/lottery/tests/lottery_tests.move†L964-L1004】 |

## Наблюдения и рекомендации
1. **Операционный контроль whitelisting.** Агрегатор и потребители управляются on-chain, события `AggregatorWhitelistedEvent` и `ConsumerWhitelistedEvent` фиксируют изменения. Рекомендуется вести off-chain мониторинг событий, чтобы своевременно реагировать на несанкционированные изменения конфигурации.【F:supra/move_workspace/lottery/sources/Lottery.move†L328-L400】
2. **Автоматизация тестов с Supra Move CLI.** Набор модульных тестов покрывает ключевые сценарии, однако для production-среды следует настроить CI, который запускает `supra move test` при обновлении зависимостей и конфигурации газа.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L1-L200】【F:supra/move_workspace/lottery/tests/lottery_tests.move†L520-L720】
3. **Мониторинг подписки и газа.** События `SubscriptionConfiguredEvent`, `MinimumBalanceUpdatedEvent` и `GasConfigUpdatedEvent` фиксируют текущие параметры; интеграции следует отслеживать баланс подписки относительно `calculate_min_balance`, чтобы исключить отклонённые VRF-запросы при росте цены газа в сети Supra.【F:supra/move_workspace/lottery/sources/Lottery.move†L208-L335】【F:supra/move_workspace/lottery/sources/Lottery.move†L360-L400】【F:supra/move_workspace/lottery/sources/Lottery.move†L772-L808】

## Заключение
Текущая реализация SupraLottery соблюдает ключевые требования Supra dVRF 3.0 по валидации payload'а, whitelisting, контролю параметров газа и тестовому покрытию. Рекомендуется внедрить оперативный мониторинг whitelisting и автоматический прогон Supra Move CLI, чтобы поддерживать соответствие при последующих изменениях сети и документации Supra.【F:supra/move_workspace/lottery/sources/Lottery.move†L328-L400】【F:supra/move_workspace/lottery/sources/Lottery.move†L644-L716】【F:supra/move_workspace/lottery/tests/lottery_tests.move†L520-L720】
