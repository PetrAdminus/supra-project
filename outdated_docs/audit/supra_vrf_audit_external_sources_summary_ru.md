# Внешний аудит SupraLottery по документации Supra dVRF 3.0

## Методология и источники
- [Supra Docs — Overview](https://docs.supra.com/)
- [Supra Docs — Move SDK](https://docs.supra.com/network/move/)
- [Supra Labs на GitHub](https://github.com/Supra-Labs)

Аудит сопоставляет требования этих источников с реализацией `lottery::main_v2` и модульными тестами `lottery_tests.move`, уделяя внимание сохранению контекста VRF-запросов, whitelisting, конфигурации газа и расчёту минимального баланса подписки.

## Соответствие ключевым требованиям Supra
| Требование из документации Supra | Реализация | Подтверждающие тесты |
| --- | --- | --- |
| **Хеширование и проверка конверта VRF-запроса**. Migration to dVRF 3.0 и Move SDK предписывают хранить sha3-256 конверта (`nonce`, `client_seed`, `caller`, параметры газа) и сверять его с payload колбэка. | `record_vrf_request` сохраняет хеш, `ensure_payload_hash_matches` сравнивает его с `message`, декодирует `VrfRequestEnvelope` и проверяет `nonce`, `client_seed`, `requester`, параметры газа и whitelisted инициатора перед очисткой состояния.【F:supra/move_workspace/lottery/sources/Lottery.move†L470-L520】【F:supra/move_workspace/lottery/sources/Lottery.move†L947-L962】 | Тесты `validate_payload_hash_*` и `handle_verified_random_*` имитируют корректную и изменённую полезную нагрузку, подтверждая отказ при подмене.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L587-L720】【F:supra/move_workspace/lottery/tests/lottery_tests.move†L964-L1004】 |
| **Whitelisting и контроль источника колбэка**. Supra Docs Overview требует хранить белый список потребителей и проверять `caller_address` агрегатора. | Контракт хранит whitelisted потребителей и агрегатора, проверяет их в `ensure_consumer_whitelisted` и `ensure_callback_caller_allowed`, а события фиксируют изменения.【F:supra/move_workspace/lottery/sources/Lottery.move†L328-L400】【F:supra/move_workspace/lottery/sources/Lottery.move†L620-L716】 | Тестовые сценарии whitelisting подтверждают отказ для неавторизованных адресов и корректную обработку событий.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L200-L519】 |
| **Предварительная конфигурация газа VRF и блокировка изменений при pending-запросе**. Руководство Gas Configurations требует фиксировать `maxGasPrice`, `maxGasLimit`, `verificationGasValue` до отправки запроса и учитывать их при расчёте депозита. | `configure_vrf_gas_internal` запрещает обновление при активном запросе, `ensure_gas_configured` вызывается перед `request_draw`, а `calculate_min_balance` применяет формулу VRF 3.0 `minRequests × maxGasPrice × (maxGasLimit + verificationGasValue)`.【F:supra/move_workspace/lottery/sources/Lottery.move†L208-L335】【F:supra/move_workspace/lottery/sources/Lottery.move†L772-L808】 | Тесты `request_draw_requires_gas_config` и сценарии обновления подписки проверяют расчёт и события конфигурации.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L200-L519】【F:supra/move_workspace/lottery/tests/lottery_tests.move†L520-L677】 |
| **Контроль `rng_count` и размера массива случайностей**. Supra Labs демонстрирует проверку заявленного числа случайностей. | `handle_verified_random` сравнивает `rng_count` с константой и проверяет длину массива перед выбором победителя.【F:supra/move_workspace/lottery/sources/Lottery.move†L644-L716】 | Тесты колбэка содержат негативные кейсы с неверным `rng_count` и длиной.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L720-L900】 |
| **Журналирование ключевых параметров VRF-запроса**. Документация рекомендует логировать `nonce`, `client_seed`, конфигурацию газа и инициатора. | `DrawRequestedEvent`, `GasConfigUpdatedEvent`, `MinimumBalanceUpdatedEvent` и `SubscriptionConfiguredEvent` публикуют параметры, а состояние хранит `next_client_seed` и адрес инициатора.【F:supra/move_workspace/lottery/sources/Lottery.move†L52-L120】【F:supra/move_workspace/lottery/sources/Lottery.move†L328-L520】 | Тесты событий проверяют содержимое логов и изменение сидов.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L1-L200】【F:supra/move_workspace/lottery/tests/lottery_tests.move†L520-L677】 |

## Выявленные проблемы и рекомендации
1. **Операционный мониторинг whitelisting.** Документация Supra рекомендует отслеживать whitelisting агрегаторов и потребителей; стоит автоматизировать сбор событий `AggregatorWhitelistedEvent` и `ConsumerWhitelistedEvent`, чтобы оперативно выявлять несанкционированные изменения.【F:supra/move_workspace/lottery/sources/Lottery.move†L328-L400】
2. **Автоматический прогон Supra Move CLI.** Репозитории Supra Labs подчёркивают необходимость регулярного запуска `supra move test`; рекомендуется интегрировать CLI в CI-пайплайн для подтверждения совместимости при обновлениях.【F:supra/move_workspace/lottery/tests/lottery_tests.move†L1-L200】
3. **Наблюдение за минимальным балансом.** Изменение `max_gas_price` или `verification_gas_value` может потребовать увеличения депозита; следует мониторить `GasConfigUpdatedEvent` и `MinimumBalanceUpdatedEvent`, чтобы поддерживать баланс выше `calculate_min_balance`.【F:supra/move_workspace/lottery/sources/Lottery.move†L208-L335】【F:supra/move_workspace/lottery/sources/Lottery.move†L772-L808】

## Итог
Текущая версия SupraLottery удовлетворяет ключевым требованиям Supra dVRF 3.0 по валидации payload'а, whitelisting, контролю газа и журналированию параметров. Для поддержания соответствия рекомендуется выстроить операционный мониторинг whitelisting и подписки, а также автоматизировать запуск Supra Move CLI при каждом обновлении зависимостей.
