# Supra Integration Guide

Р­С‚Р° РїР°РјСЏС‚РєР° РѕРїРёСЃС‹РІР°РµС‚ С€Р°РіРё, С‡С‚РѕР±С‹ Р·Р°РјРµРЅРёС‚СЊ mock-СЂРµР¶РёРј С„СЂРѕРЅС‚РµРЅРґР° РЅР° СЂРµР°Р»СЊРЅС‹Рµ РІС‹Р·РѕРІС‹ Supra РїРѕСЃР»Рµ РїРѕР»СѓС‡РµРЅРёСЏ whitelisting.

## 1. РџСЂРµРґРїРѕСЃС‹Р»РєРё
- Р”РѕР¶РґР°С‚СЊСЃСЏ РїРѕРґС‚РІРµСЂР¶РґРµРЅРёСЏ РѕС‚ Supra support (СЃРј. `../SupraLottery/docs/testnet_runbook.md`, СЂР°Р·РґРµР» 2).
- РЈР±РµРґРёС‚СЊСЃСЏ, С‡С‚Рѕ dVRF РїРѕРґРїРёСЃРєР° СѓСЃРїРµС€РЅРѕ РЅР°СЃС‚СЂРѕРµРЅР° (`deposit::*`, `configure_vrf`, `record_*` РѕС‚СЂР°Р±РѕС‚Р°Р»Рё Р±РµР· РѕС€РёР±РѕРє).
- РРјРµСЋС‚СЃСЏ СѓС‡РµС‚РЅС‹Рµ РґР°РЅРЅС‹Рµ StarKey (РёР»Рё Р°Р»СЊС‚РµСЂРЅР°С‚РёРІРЅРѕРіРѕ РєРѕС€РµР»СЊРєР°), РєРѕС‚РѕСЂС‹Рµ Р±СѓРґСѓС‚ РїРѕРґРїРёСЃС‹РІР°С‚СЊ С‚СЂР°РЅР·Р°РєС†РёРё РёР· С„СЂРѕРЅС‚РµРЅРґР°.
- РќР°СЃС‚СЂРѕРµРЅ РґРѕСЃС‚СѓРї Рє Supra RPC (С‚РµСЃС‚РЅРµС‚: `https://rpc-testnet.supra.com`, РјРµР№РЅРЅРµС‚: `https://rpc-mainnet.supra.com`).

## 2. Р—Р°РјРµРЅР° `supraClient.ts`
Р¤Р°Р№Р» `src/api/supraClient.ts` СЃРѕРґРµСЂР¶РёС‚ Р·Р°РіР»СѓС€РєРё. Р”Р»СЏ РєР°Р¶РґРѕРіРѕ РјРµС‚РѕРґР° РЅСѓР¶РЅРѕ СЂРµР°Р»РёР·РѕРІР°С‚СЊ СЂРµР°Р»СЊРЅС‹Рµ РІС‹Р·РѕРІС‹.

### Р’Р°СЂРёР°РЅС‚ A: РїСЂСЏРјС‹Рµ JSON-RPC Р·Р°РїСЂРѕСЃС‹
- РСЃРїРѕР»СЊР·РѕРІР°С‚СЊ HTTP POST РЅР° `NEXT_PUBLIC_SUPRA_RPC_URL` СЃ РјРµС‚РѕРґР°РјРё `move_view`, `submit_transaction`, `get_account_resources`, Рё С‚.Рґ.
-  Р”Р»СЏ view-С„СѓРЅРєС†РёР№ (`fetchLotteryStatusSupra`, `fetchWhitelistStatusSupra`, `fetchTicketsSupra`, `fetchLotteryEventsSupra`):
   1. РЎС„РѕСЂРјРёСЂРѕРІР°С‚СЊ payload РІРёРґР° `{ "jsonrpc": "2.0", "id": 1, "method": "move_view", "params": { ... } }`.
   2. РџРµСЂРµРґР°С‚СЊ `function_id` (`<Р°РґСЂРµСЃ>::main_v2::get_lottery_status`) Рё СЃРїРёСЃРѕРє Р°СЂРіСѓРјРµРЅС‚РѕРІ/С‚РёРїРѕРІ.
   3. Р Р°СЃРїР°СЂСЃРёС‚СЊ РѕС‚РІРµС‚ Рё РїСЂРёРІРµСЃС‚Рё Рє С‚РёРїР°Рј `LotteryStatus`, `WhitelistStatus`, `TicketPurchase`, `LotteryEvent`.
- Р”Р»СЏ `purchaseTicketSupra` (Рё РґСЂСѓРіРёС… РјСѓС‚Р°С†РёР№) С‚СЂРµР±СѓРµС‚СЃСЏ РіРѕС‚РѕРІРёС‚СЊ Рё РїРѕРґРїРёСЃС‹РІР°С‚СЊ BCS-С‚СЂР°РЅР·Р°РєС†РёСЋ. Р РµРєРѕРјРµРЅРґСѓРµС‚СЃСЏ РІС‹РЅРµСЃС‚Рё Р»РѕРіРёРєСѓ РїРѕРґРїРёСЃРё РІ РѕС‚РґРµР»СЊРЅС‹Р№ helper (РЅР°РїСЂРёРјРµСЂ, РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ StarKey SDK РёР»Рё Р±СЌРєРµРЅРґ-РїСЂРѕРєСЃРё, С‡С‚РѕР±С‹ СЃРєСЂС‹С‚СЊ РїСЂРёРІР°С‚РЅС‹Р№ РєР»СЋС‡).

### Р’Р°СЂРёР°РЅС‚ B: Р±СЌРєРµРЅРґ-РїСЂРѕРєСЃРё / CLI wrapper
- РџРѕРґРЅСЏС‚СЊ СЃРµСЂРІРёСЃ, РєРѕС‚РѕСЂС‹Р№ РІРЅСѓС‚СЂРё РІС‹Р·С‹РІР°РµС‚ `supra move tool view/run` (С‡РµСЂРµР· Docker Р»РёР±Рѕ Р±РёРЅР°СЂСЊ).
- Р¤СЂРѕРЅС‚РµРЅРґ РѕР±СЂР°С‰Р°РµС‚СЃСЏ Рє REST СЌРЅРґРїРѕРёРЅС‚Р°Рј (РЅР°РїСЂРёРјРµСЂ, `/api/supra/view/lottery-status`), РєРѕС‚РѕСЂС‹Рµ РІРѕР·РІСЂР°С‰Р°СЋС‚ JSON.
- Р­С‚РѕС‚ РїРѕРґС…РѕРґ РїСЂРѕС‰Рµ РІ СЂРµР°Р»РёР·Р°С†РёРё, РµСЃР»Рё СѓР¶Рµ РµСЃС‚СЊ РіРѕС‚РѕРІС‹Рµ CLI СЃРєСЂРёРїС‚С‹, РЅРѕ С‚СЂРµР±СѓРµС‚ Р±СЌРєРµРЅРґР° Рё Р±РµР·РѕРїР°СЃРЅРѕРіРѕ С…СЂР°РЅРµРЅРёСЏ РєР»СЋС‡РµР№.

Р РµРєРѕРјРµРЅРґСѓРµС‚СЃСЏ РЅР°С‡Р°С‚СЊ СЃ РІР°СЂРёР°РЅС‚Р° B РґР»СЏ Р±С‹СЃС‚СЂРѕРіРѕ РїСЂРѕС‚РѕС‚РёРїР°, Р° Р·Р°С‚РµРј РїРµСЂРµР№С‚Рё Рє С‡РёСЃС‚РѕРјСѓ RPC (РІР°СЂРёР°РЅС‚ A), С‡С‚РѕР±С‹ СЃРѕРєСЂР°С‚РёС‚СЊ Р·Р°РґРµСЂР¶РєРё Рё Р·Р°РІРёСЃРёРјРѕСЃС‚СЊ РѕС‚ CLI.

## 3. РќР°СЃС‚СЂРѕР№РєР° РѕРєСЂСѓР¶РµРЅРёСЏ (`.env`)
РџСЂРёРјРµСЂ РґР»СЏ С‚РµСЃС‚РЅРµС‚Р°:
```
VITE_API_MODE=mock
VITE_SUPRA_RPC_URL=https://rpc-testnet.supra.com
VITE_SUPRA_CHAIN_ID=6
VITE_LOTTERY_MODULE=0x9a969d3b77941cec267f03b9bbb323c0333fa63d0e9e15204edabc415f134490::main_v2
```
РџСЂРё РІРєР»СЋС‡РµРЅРёРё СЂРµР¶РёРјР° `supra` РІ UI С‡РёС‚Р°С‚СЊ СЌС‚Рё РїРµСЂРµРјРµРЅРЅС‹Рµ Рё РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РІ `supraClient.ts`.

## 4. РљРѕС€РµР»С‘Рє StarKey / WalletConnect
- Р’ `src/features/wallet/` СЃРµР№С‡Р°СЃ РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ СЃС‚Р°Р±. Р РµР°Р»РёР·СѓР№С‚Рµ:
  - `connectWallet` / `disconnectWallet` С‡РµСЂРµР· StarKey SDK.
  - РџРѕРґРїРёСЃР°РЅРЅС‹Рµ С‚СЂР°РЅР·Р°РєС†РёРё РїРµСЂРµРґР°Р№С‚Рµ РІ `purchaseTicketSupra`.
  - Р”РѕР±Р°РІСЊС‚Рµ РѕР±СЂР°Р±РѕС‚РєСѓ СЃРѕР±С‹С‚РёР№ (РїСЂРёРјРµСЂ: Crystara SDK РёСЃРїРѕР»СЊР·СѓРµС‚ `walletEvents.on(WALLET_EVENTS.TRANSACTION_START)` вЂ” РјРѕР¶РЅРѕ РїРѕРІС‚РѕСЂРёС‚СЊ РїРѕРґС…РѕРґ).
- Р•СЃР»Рё РїРѕС‚СЂРµР±СѓРµС‚СЃСЏ WalletConnect, Р·Р°РІРµРґРёС‚Рµ РѕС‚РґРµР»СЊРЅС‹Р№ РїСЂРѕРІР°Р№РґРµСЂ Рё РїРµСЂРµРєР»СЋС‡Р°С‚РµР»СЊ РІ UI.

## 5. Storybook Рё С‚РµСЃС‚С‹
- РџРѕСЃР»Рµ РёРЅС‚РµРіСЂР°С†РёРё РІР°Р¶РЅРѕ РѕР±РЅРѕРІРёС‚СЊ JSON РІ `src/mocks/`, С‡С‚РѕР±С‹ `mock` СЂРµР¶РёРј Рё СЃС‚РѕСЂРёСЃС‹ РѕС‚СЂР°Р¶Р°Р»Рё СЂРµР°Р»СЊРЅС‹Рµ СЃС‚СЂСѓРєС‚СѓСЂС‹.
- Р”РѕР±Р°РІРёС‚СЊ РёСЃС‚РѕСЂРёРё, РїРѕРєСЂС‹РІР°СЋС‰РёРµ `supra` СЂРµР¶РёРј (РЅР°РїСЂРёРјРµСЂ, Storybook `SupraMode` СѓР¶Рµ РµСЃС‚СЊ РґР»СЏ Tickets вЂ” СЂР°СЃС€РёСЂРёС‚СЊ Р°РЅР°Р»РѕРіР°РјРё РґР»СЏ Dashboard/Admin/Logs).
- Р®РЅРёС‚-С‚РµСЃС‚С‹ (`Vitest`) РјРѕР¶РЅРѕ РґРѕРїРѕР»РЅРёС‚СЊ РјРѕРєР°РјРё RPC Р·Р°РїСЂРѕСЃРѕРІ (РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ `vi.mock('node-fetch', ...)`).

## 6. РљРѕРЅС‚СЂРѕР»СЊ РєР°С‡РµСЃС‚РІР°
- Р”Р»СЏ РєР°Р¶РґРѕРіРѕ RPC-Р·Р°РїСЂРѕСЃР° Р»РѕРіРёСЂСѓР№С‚Рµ (РІ dev-СЂРµР¶РёРјРµ) payload/response вЂ” РїСЂРёРіРѕРґРёС‚СЃСЏ РїСЂРё РѕС‚Р»Р°РґРєРµ.
- РќР°СЃС‚СЂРѕР№С‚Рµ РЅР°Р±Р»СЋРґРµРЅРёРµ Р·Р° РѕС€РёР±РєР°РјРё (Sentry, console-toasts) вЂ” РїСЂРёР»РѕР¶РµРЅРёРµ РґРѕР»Р¶РЅРѕ РєРѕСЂСЂРµРєС‚РЅРѕ РѕС‚РѕР±СЂР°Р¶Р°С‚СЊ РѕС€РёР±РєРё Supra Рё retry-СЃС†РµРЅР°СЂРёРё.
- РџСЂРё РґРµРїР»РѕРµ Р·Р°С„РёРєСЃРёСЂСѓР№С‚Рµ РёСЃРїРѕР»СЊР·СѓРµРјС‹Рµ RPC endpoints Рё chain_id РІ РґРѕРєСѓРјРµРЅС‚Р°С†РёРё.

## 7. Р§РµРєР»РёСЃС‚ РїРµСЂРµС…РѕРґР° РЅР° СЂРµР°Р»СЊРЅСѓСЋ СЃРµС‚СЊ
1. РџРѕР»СѓС‡РёС‚СЊ whitelisting Рё Р·Р°РїРёСЃР°С‚СЊ С…СЌС€Рё С‚СЂР°РЅР·Р°РєС†РёР№ РІ `docs/testnet_runbook.md`.
2. Р РµР°Р»РёР·РѕРІР°С‚СЊ `supraClient.ts` (view + РјСѓС‚Р°С†РёРё) Рё РїСЂРѕРІРµСЂСЏС‚СЊ С‡РµСЂРµР· `VITE_API_MODE=supra`.
3. Р—Р°РјРµРЅРёС‚СЊ СЃС‚Р°Р± РєРѕС€РµР»СЊРєР° РЅР° StarKey/WalletConnect.
4. РћР±РЅРѕРІРёС‚СЊ mock JSON Рё Storybook.
5. РџСЂРѕРіРЅР°С‚СЊ e2e (Playwright/Cypress) РІ СЂРµР¶РёРјРµ mock Рё Р·Р°С‚РµРј supra.
6. РћР±РЅРѕРІРёС‚СЊ README/runbook СЃ РёС‚РѕРіРѕРІС‹РјРё РїР°СЂР°РјРµС‚СЂР°РјРё (RPC, chain id, Р°РґСЂРµСЃ РјРѕРґСѓР»СЏ).

## 8. РџРѕР»РµР·РЅС‹Рµ РјР°С‚РµСЂРёР°Р»С‹
- Supra JSON-RPC СЃРїРµС†РёС„РёРєР°С†РёСЏ (РІ РѕС„РёС†РёР°Р»СЊРЅРѕР№ РґРѕРєСѓРјРµРЅС‚Р°С†РёРё)
- РџСЂРёРјРµСЂ Crystara SDK (README РІ `/docs/crystara_note` РёР»Рё РѕР±С‰РёР№ README РїСЂРѕРµРєС‚Р°)
- РќР°С€ runbook: `../SupraLottery/docs/testnet_runbook.md`### Reference: Base documentation snippets
- Foundry tutorial “Generating random numbers contracts using Supra dVRF” показывает, как в EVM контракте вызывать `ISupraRouter.generateRequest("requestCallback(uint256,uint256[])", rngCount, numConfirmations, clientAddress)` и обрабатывать колбэк `requestCallback(uint256 nonce, uint256[] rngList)` с проверкой `msg.sender == supraAddr`.
- Для Base Sepolia используется `ISUPRA_ROUTER_ADDRESS=0x99a021029EBC90020B193e111Ae2726264a111A2`; аналогичные адреса нужно уточнять для Supra testnet/mainnet.
- Перед развёртыванием контракт нужно whitelisting’ить и пополнить баланс через Supra (аналогичные шаги перечислены в нашем runbook).
- После деплоя контрактов через Foundry вызывают `forge create ... --constructor-args $ISUPRA_ROUTER_ADDRESS`, а кошелёк импортируют командой `cast wallet import` — пригодится, если будем работать с EVM-сервисами поверх Supra.
## Выписки из статьи "What Components Do You Need to Build a dApp on Supra"
- dApp на Supra = backend (Move-контракты + CLI) + frontend (React.js + SDK + Vite). Наш стек React/Vite соответствует рекомендациям, а CLI-скрипты из ../SupraLottery/docs/testnet_runbook.md покрывают бэкенд-часть.
- SupraClient должен уметь три вещи: читать on-chain данные (view), собирать аргументы транзакций и отправлять подписанные операции. Именно это предстоит реализовать в src/api/supraClient.ts после whitelisting.
- CLI остаётся рабочей лошадкой: через него компилируем, деплоим и вызываем контракты. При миграции на реальный RPC важно сохранить профили и команды (compile/run/view) — фронтенд опирается на те же функции.
- Кошелёк (StarKey/WalletConnect) обязателен для подписи транзакций: пользователь подключается, подписывает, SupraClient отправляет. Наша моковая wallet-фича — временное решение, далее нужно заменить на реальный SDK.
- План фронтенда: моки > SupraClient RPC. После whitelisting переключаем piMode на supra и подменяем моки реальными ответами; Storybook и тесты должны получать те же структуры данных.
