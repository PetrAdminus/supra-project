# Первичные расхождения и вопросы для выравнивания SupraLottery

| Область | Наблюдение | Комментарий / следующий шаг | Ссылки |
| --- | --- | --- | --- |
| Move workspace | В `SupraLottery/supra/move_workspace/Move.toml` заданы только dev-адреса `lottery`, `vrf_hub`, `lottery_factory`; адрес для `SupraVrf` отсутствует, резолвер остаётся в режиме `legacy`. | ✅ Добавлен dev-алиас `supra_addr` для Supra dVRF. Осталось уточнить у Supra актуальные адреса пакетов и рекомендации по `resolver` (ожидается переход на `"v2"`) перед обновлением остальной конфигурации. | `Move.toml` 【F:SupraLottery/supra/move_workspace/Move.toml†L1-L14】 |
| Зависимость на dVRF | Контракты `Lottery.move` и другие напрямую импортируют модули по жёстко закодированному адресу `0x186b…`, а не через именованные адреса workspace. | ✅ Адрес Supra dVRF вынесен в `Move.toml`, `Lottery.move` использует алиас `supra_addr`. Необходимо перепроверить остальные пакеты (`vrf_hub`, `lottery_factory`), как только появятся ссылки на `supra_vrf`/`deposit`. | `Lottery.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L1-L16】 |
| dVRF API | Сигнатуры `rng_request` и `verify_callback` в `SupraVrf/sources/supra_vrf.move` совпадают не только с шаблоном `Supra dVRF Template`, но и с открытым пакетом [`Entropy-Foundation/vrf-interface@testnet`](https://github.com/Entropy-Foundation/vrf-interface/tree/testnet/supra/testnet). | ✅ Базовый API подтверждён: расхождений по сигнатурам и именам функций нет. Следующий шаг — сравнить структуры событий и формат сообщений в `Lottery.move` с документацией Supra (как только будут доступны примеры). | `supra_vrf.move` 【F:SupraLottery/supra/move_workspace/SupraVrf/sources/supra_vrf.move†L1-L23】, `dvrf_reference_snapshot.md` 【F:SupraLottery/docs/dvrf_reference_snapshot.md†L33-L44】 |
| SupraVrf пакет | `SupraVrf/Move.toml` теперь повторяет официальный пакет `vrf-interface`: подключает `SupraFramework` из `Entropy-Foundation/aptos-core` и использует только именованный адрес `supra_addr`. | ✅ Move.toml синхронизирован с эталоном. Следующий шаг — убедиться, что остальные пакеты workspace совместимы с git-зависимостью `SupraFramework` (обновить CI, задокументировать требования к окружению). | `SupraVrf/Move.toml` 【F:SupraLottery/supra/move_workspace/SupraVrf/Move.toml†L1-L11】, `dvrf_reference_snapshot.md` 【F:SupraLottery/docs/dvrf_reference_snapshot.md†L33-L44】 |
| Move Stdlib зависимость | Ранее пакеты зависели от локальной копии `move-stdlib`, что расходилось с шаблонами Supra, использующими git-зависимости `aptos-core`. | ✅ Пакеты `lottery`, `vrf_hub`, `lottery_factory` теперь подтягивают `move-stdlib` из `Entropy-Foundation/aptos-core` (`rev = "dev"`), а workspace переключён на `resolver = "v2"`, что закрывает требование F1 о синхронизации зависимостей. | `Move.toml` 【F:SupraLottery/supra/move_workspace/Move.toml†L1-L4】, `lottery/Move.toml` 【F:SupraLottery/supra/move_workspace/lottery/Move.toml†L6-L19】, `vrf_hub/Move.toml` 【F:SupraLottery/supra/move_workspace/vrf_hub/Move.toml†L9-L16】, `lottery_factory/Move.toml` 【F:SupraLottery/supra/move_workspace/lottery_factory/Move.toml†L9-L16】 |
| Использование адресов | В `lottery` модуле вызывается `supra_vrf` по жёстко зашитому адресу `0x186b…`, а шаблон Supra демонстрирует применение именованных адресов и параметров `Move.toml`. | ✅ `Lottery.move` переведён на алиасы `supra_addr::supra_vrf` и `supra_addr::deposit`. Следующий шаг — унифицировать этот паттерн в скриптах/Runbook и других модулях после ревизии. | `Lottery.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L1-L16】, `dvrf_reference_snapshot.md` 【F:SupraLottery/docs/dvrf_reference_snapshot.md†L19-L30】 |
| Событийная подсистема | В шаблоне Supra события эмитятся через `supra_framework::event`, тогда как в SupraLottery использовалась стандартная `event` из `0x1`. | ✅ Модули лотереи, VRF hub и фабрики переведены на `supra_framework::event`, сохраняя сигнатуры событий и совместимость тестов. Дополнительно `RandomnessRequestedEvent` публикует `payload_hash`, позволяя аудиту сравнивать его с `CallbackRequest` из Supra dVRF. Следующий шаг — обновить runbook/скрипты, если они ссылаются на старые пути. | `Lottery.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L9-L15】, `VRFHub.move` 【F:SupraLottery/supra/move_workspace/vrf_hub/sources/VRFHub.move†L6-L12】【F:SupraLottery/supra/move_workspace/vrf_hub/sources/VRFHub.move†L299-L320】, `LotteryFactory.move` 【F:SupraLottery/supra/move_workspace/lottery_factory/sources/LotteryFactory.move†L3-L8】 |
| Ограничения газа VRF | Руководство Supra по подпискам фиксирует неравенства `callbackGasPrice ≤ maxGasPrice` и `callbackGasLimit ≤ maxGasLimit`, но контракт этого не проверял. | ✅ `configure_vrf_gas` валидирует ограничения перед сохранением, а CLI `configure_vrf_gas.py` отфильтровывает некорректные параметры до вызова Supra CLI. | `Lottery.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L700-L711】, `configure_vrf_gas.py` 【F:SupraLottery/supra/scripts/configure_vrf_gas.py†L52-L65】, `vrf-subscription-model.md` 【F:SupraLottery/docs/dvrf_reference_snapshot.md†L53-L60】 |
| Управление подпиской | Документация dVRF описывает `removeContractFromWhitelist`, но лотерея не предоставляла on-chain обёртку и операторам приходилось обращаться напрямую к Deposit. | ✅ Добавлена entry-функция `remove_subscription`, которая проверяет отсутствие pending_request, вызывает `deposit::remove_contract_from_whitelist` и публикует событие `SubscriptionContractRemovedEvent`. CLI-команда `remove-subscription` повторяет проверку мониторинга. | `Lottery.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L520-L551】【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L981-L996】, `remove_subscription.py` 【F:SupraLottery/supra/scripts/remove_subscription.py†L1-L123】 |
| CallbackRequest payload | Исторически лотерея хранила и хешировала только `nonce`, `client_seed`, параметры газа и `requester`, тогда как миграционное руководство Supra описывает `CallbackRequest`, включающий целевой адрес и колбэк. | ✅ Структура запроса обновлена: `CallbackRequest` теперь включает адрес колбэка, имена модуля/функции, `rng_count` и `num_confirmations`; события `DrawRequestedEvent`/`DrawHandledEvent` публикуют whitelisted `callback_sender`, `request_hash`, конфигурацию газа и список `randomness`, а `VrfRequestConfigUpdatedEvent` и CLI `configure_vrf_request` логируют `num_confirmations`. Для on-chain аудита добавлена view-функция `get_pending_request_view`, возвращающая `PendingRequestView` с теми же полями и `request_hash`. | `Lottery.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L209-L221】【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L888-L903】【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L1587-L1614】【F:SupraLottery/supra/move_workspace/lottery/tests/lottery_tests.move†L611-L662】【F:SupraLottery/supra/move_workspace/lottery/tests/lottery_tests.move†L665-L679】 |
| Whitelisting агрегатора и потребителей | Supra рекомендует публиковать агрегированный снимок whitelisting (агрегатор + список потребителей) после каждой операции, чтобы мониторинг не реконструировал состояние по одиночным событиям. Ранее приходилось анализировать `ConsumerWhitelistedEvent`/`ConsumerRemovedEvent` и отдельные события агрегатора. | ✅ Добавлено событие `WhitelistSnapshotUpdatedEvent`, которое эмитится при `init`, `whitelist_callback_sender`, `revoke_callback_sender`, `whitelist_consumer` и `remove_consumer`, публикуя текущий whitelisted агрегатор и полный список потребителей; тесты проверяют снапшоты после добавления и удаления адресов. | `Lottery.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L160-L188】【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L511-L573】【F:SupraLottery/supra/move_workspace/lottery/tests/lottery_tests.move†L286-L333】【F:SupraLottery/supra/move_workspace/lottery/tests/lottery_tests.move†L724-L748】 |
| Фабрика лотерей / наблюдаемость | В официальных гайдах Supra фабрика должна публиковать актуальные данные о зарегистрированных лотереях (админ, адреса, параметры билетов), чтобы аудит не восстанавливал состояние через историю `LotteryPlannedEvent`. | ✅ `LotteryRegistrySnapshotUpdatedEvent` фиксирует администратора и полный список лотерей с ценой билета и долей джекпота, `get_registry_snapshot` и `list_lottery_ids` позволяют читать это состояние через view. Move-тесты проверяют снапшоты при создании, обновлении плана и смене администратора. | `LotteryFactory.move` 【F:SupraLottery/supra/move_workspace/lottery_factory/sources/LotteryFactory.move†L1-L238】, `factory_tests.move` 【F:SupraLottery/supra/move_workspace/lottery_factory/tests/factory_tests.move†L1-L142】 |
| Экземпляры лотерей / наблюдаемость | Supra просит предоставлять агрегированный снимок по всем активным и архивным экземплярам (адреса контрактов, владельцы, цены билетов, доли джекпота и показатели продаж), чтобы мониторинг не восстанавливал состояние через последовательность `LotteryInstanceCreatedEvent`/`LotteryInstanceStatusUpdatedEvent`. | ✅ Добавлено событие `LotteryInstancesSnapshotUpdatedEvent`, которое публикует администратора, адрес VRF-хаба и полный набор параметров экземпляра после каждой административной/пользовательской операции; view-функции `get_instance_snapshot` и `get_instances_snapshot` возвращают такие же структуры для Supra CLI. Юнит-тесты `instances_tests` проверяют содержимое view и поток событий при создании, синхронизации blueprint и смене статуса активности. | `LotteryInstances.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/LotteryInstances.move†L20-L441】【F:SupraLottery/supra/move_workspace/lottery/sources/LotteryInstances.move†L443-L566】, `instances_tests.move` 【F:SupraLottery/supra/move_workspace/lottery/tests/instances_tests.move†L1-L119】 |
| VRF hub агрегатор | Официальные шаблоны Supra требуют наблюдаемости whitelisted агрегатора VRF hub, однако ранее `set_callback_sender` не публиковал событие и не предоставлял агрегированный view — операторам приходилось опрашивать `callback_sender()` и отслеживать изменения вручную. | ✅ `set_callback_sender` теперь эмитит `CallbackSenderUpdatedEvent` с предыдущим и текущим адресом, а view `get_callback_sender_status` возвращает `CallbackSenderStatus` с `option<address>`. Юнит-тесты `hub_tests` проверяют снапшот и событие. | `VRFHub.move` 【F:SupraLottery/supra/move_workspace/vrf_hub/sources/VRFHub.move†L49-L69】【F:SupraLottery/supra/move_workspace/vrf_hub/sources/VRFHub.move†L281-L303】【F:SupraLottery/supra/move_workspace/vrf_hub/tests/hub_tests.move†L57-L88】 |
| Порог подтверждений VRF | Документация Supra ограничивает `numConfirmations` значением `≤ 20`, но контракт не проверял верхний предел. | ✅ `configure_vrf_request` вводит проверку `num_confirmations ≤ 20`, а CLI `configure_vrf_request` блокирует некорректные аргументы до вызова Supra CLI. | `Lottery.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Lottery.move†L664-L694】, `configure_vrf_request.py` 【F:SupraLottery/supra/scripts/configure_vrf_request.py†L12-L49】, `test_configure_vrf.py` 【F:SupraLottery/tests/test_configure_vrf.py†L60-L76】 |
| Казначейство / Fungible Asset | Казначейство использовало собственную таблицу `StoreInfo` и числовые балансы, не применяя `supra_framework::fungible_asset` и primary store, что расходилось с официальными гайдами Supra. | ✅ `treasury_v1` мигрирован на Supra FA: `TokenState` хранит `metadata`, mint/burn/transfer ref, операции используют `primary_fungible_store`, freeze-проверки распространяются и на `set_recipients`, а view-функции `get_recipient_statuses`/`recipient_status_fields_for_test` возвращают адреса store, регистрацию, freeze-статус и балансы. Событие `RecipientsUpdatedEvent` публикует пары снимков (предыдущие и текущие статусы направлений) при инициализации и каждом обновлении, что соответствует требованиям Supra по наблюдаемости и трассировке. | `Treasury.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Treasury.move†L1-L642】【F:SupraLottery/supra/move_workspace/lottery/sources/Treasury.move†L520-L606】, `README.md` 【F:SupraLottery/README.md†L152-L206】 |
| Регистрация пулов `treasury_multi` | Ранее модуль `treasury_multi` не проверял, что адреса джекпота и операционного пула зарегистрировали primary store Supra FA, из-за чего возможны abort при первой выплате. | ✅ `treasury_multi::init` и `set_recipients` теперь валидируют готовность `treasury_v1`, регистрацию и отсутствие freeze (`E_TREASURY_NOT_READY`, `E_JACKPOT_RECIPIENT_UNREGISTERED`, `E_OPERATIONS_RECIPIENT_UNREGISTERED`, `E_JACKPOT_RECIPIENT_FROZEN`, `E_OPERATIONS_RECIPIENT_FROZEN`); `withdraw_operations`, `pay_operations_bonus_internal` и `distribute_jackpot` проверяют готовность получателей и победителей (`E_OPERATIONS_RECIPIENT_FROZEN`, `E_BONUS_RECIPIENT_UNREGISTERED`, `E_BONUS_RECIPIENT_FROZEN`, `E_JACKPOT_WINNER_UNREGISTERED`, `E_JACKPOT_WINNER_FROZEN`), а view `get_recipient_statuses` публикует признак регистрации, freeze-статус и баланс Supra FA для обоих пулов. | `TreasuryMulti.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/TreasuryMulti.move†L23-L92】【F:SupraLottery/supra/move_workspace/lottery/sources/TreasuryMulti.move†L409-L424】【F:SupraLottery/supra/move_workspace/lottery/sources/TreasuryMulti.move†L522-L612】, `README.md` 【F:SupraLottery/README.md†L258-L266】 |
| Наблюдаемость пулов `treasury_multi` | Официальные рекомендации Supra требуют журналировать статусы получателей (регистрация, freeze, balances) при каждой смене адресов. Ранее `RecipientsUpdatedEvent` содержал только прошлый/новый адрес и не эмитился при `init`. | ✅ Событие `treasury_multi::RecipientsUpdatedEvent` теперь публикует `RecipientStatus` для предыдущих и новых адресов, вызывается в `init` и `set_recipients`, а Move-тесты проверяют наличие снапшотов и корректность статусов. | `TreasuryMulti.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/TreasuryMulti.move†L96-L119】【F:SupraLottery/supra/move_workspace/lottery/sources/TreasuryMulti.move†L212-L248】【F:SupraLottery/supra/move_workspace/lottery/sources/TreasuryMulti.move†L700-L734】, `treasury_multi_tests.move` 【F:SupraLottery/supra/move_workspace/lottery/tests/treasury_multi_tests.move†L1-L223】 |
| Управление операторами | Supra требует прозрачного whitelisting/blacklisting операторов: нужны события со снапшотами и view с агрегированным списком делегатов, иначе аудит приходится собирать историю по отдельным событиям `grant`/`revoke`. | ✅ Добавлено событие `OperatorSnapshotUpdatedEvent`, которое публикует владельца и полный список операторов после `set_owner`, `grant_operator` и `revoke_operator`, а view `get_operator_snapshot` возвращает те же данные одним вызовом. Move-тесты проверяют снапшоты и историю событий. | `Operators.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Operators.move†L20-L46】【F:SupraLottery/supra/move_workspace/lottery/sources/Operators.move†L104-L182】【F:SupraLottery/supra/move_workspace/lottery/sources/Operators.move†L214-L259】, `operators_tests.move` 【F:SupraLottery/supra/move_workspace/lottery/tests/operators_tests.move†L1-L102】 |
| Метаданные лотерей | Руководства Supra по витринам советуют публиковать агрегированный снапшот описаний после каждой правки, иначе оффчейн-сервисы должны сканировать всю историю `LotteryMetadataUpsertedEvent`. | ✅ `MetadataSnapshotUpdatedEvent` фиксирует администратора и полный список описаний при `init`, `set_admin`, `upsert_metadata` и `remove_metadata`, а view `get_metadata_snapshot` возвращает те же данные для Supra CLI. Move-тесты проверяют события и снапшоты. | `Metadata.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Metadata.move†L36-L118】【F:SupraLottery/supra/move_workspace/lottery/sources/Metadata.move†L214-L266】, `metadata_tests.move` 【F:SupraLottery/supra/move_workspace/lottery/tests/metadata_tests.move†L1-L108】 |
| Реферальные бонусы | Официальные рекомендации Supra по мониторингу бонусных программ требуют агрегированного снимка конфигураций и статистики, иначе операторам приходится собирать данные из отдельных событий и таблиц. Ранее `lottery::referrals` не публиковал снапшоты и не предоставлял view. | ✅ Добавлено событие `ReferralSnapshotUpdatedEvent`, которое фиксирует администратора, общее число зарегистрированных рефералов и параметры по каждой настроенной лотерее при `init`, `set_lottery_config`, `register_referrer`, `admin_set_referrer`, `admin_clear_referrer` и начислении бонусов; view `get_referral_snapshot` возвращает тот же агрегированный снимок. Move-тесты `referrals_tests` проверяют событие и содержимое view. | `Referrals.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Referrals.move†L28-L73】【F:SupraLottery/supra/move_workspace/lottery/sources/Referrals.move†L414-L522】, `referrals_tests.move` 【F:SupraLottery/supra/move_workspace/lottery/tests/referrals_tests.move†L1-L120】 |
| Автопокупка билетов | Supra требует агрегированного состояния автопокупки (администратор, баланс, активные планы, список игроков) в одном событии/view, чтобы мониторинг не реконструировал данные по `AutopurchaseDepositEvent`/`AutopurchaseExecutedEvent`. | ✅ Добавлены структуры `AutopurchaseSnapshot`, `AutopurchaseLotterySnapshot`, `AutopurchasePlayerSnapshot`, view-функции `get_lottery_snapshot` и `get_autopurchase_snapshot`, а также событие `AutopurchaseSnapshotUpdatedEvent`, которое публикуется после `configure_plan`, `deposit`, `execute`, `refund` и `set_admin`. Move-тесты `autopurchase_tests` проверяют содержимое view и поток снапшотов. | `Autopurchase.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Autopurchase.move†L43-L201】【F:SupraLottery/supra/move_workspace/lottery/sources/Autopurchase.move†L247-L396】【F:SupraLottery/supra/move_workspace/lottery/tests/autopurchase_tests.move†L1-L162】 |
| История розыгрышей | Supra запрашивает агрегированный снимок истории draw, чтобы не сканировать все `DrawRecordedEvent` и таблицу вручную. Ранее модуль сохранял только события без снапшота. | ✅ `HistorySnapshotUpdatedEvent` публикует администратора, список лотерей и все `DrawRecord` после `init`, `record_draw` и `clear_history`, а view-функции `get_lottery_snapshot` и `get_history_snapshot` возвращают такой же агрегированный срез для Supra CLI. Move-тесты `history_tests` подтверждают поток событий и содержимое снапшота при записи и очистке истории. | `History.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/History.move†L20-L113】【F:SupraLottery/supra/move_workspace/lottery/sources/History.move†L140-L190】【F:SupraLottery/supra/move_workspace/lottery/sources/History.move†L220-L331】, `history_tests.move` 【F:SupraLottery/supra/move_workspace/lottery/tests/history_tests.move†L1-L178】 |
| NFT-бейджи победителей | Supra рекомендовала публиковать агрегированный снимок наград (администратор, `next_badge_id`, список владельцев и их бейджей), чтобы мониторинг не реконструировал состояние по `BadgeMintedEvent`/`BadgeBurnedEvent`. Ранее модуль не имел ни view, ни событий со снапшотами. | ✅ Добавлены `NftRewardsSnapshotUpdatedEvent`, `list_owner_addresses`, `get_owner_snapshot`, `get_snapshot` и структуры `BadgeSnapshot`/`BadgeOwnerSnapshot`/`NftRewardsSnapshot`, которые фиксируют состояние после `init`, минта и бёрна. Move-тест `nft_rewards_tests` проверяет корректность снапшотов, событий и очистки коллекции. | `NftRewards.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/NftRewards.move†L1-L383】, `nft_rewards_tests.move` 【F:SupraLottery/supra/move_workspace/lottery/tests/nft_rewards_tests.move†L1-L137】 |
| Автоматизация Supra Move CLI | В плане требовался стандартный способ запускать `supra move test`, но разработчики выполняли команды вручную через Docker и разные CLI. | ✅ CLI `python -m supra.scripts.cli move-test` выбирает доступную утилиту (`supra`, `aptos` или `move`), принимает дополнительные аргументы через `--`, умеет перечислять пакеты (`--list-packages`) и последовательно прогонять их (`--all-packages`). Добавлены флаги `--report-json`, `--report-junit` и `--keep-going`, которые сохраняют статус каждого пакета и фиксируют все провалы в отчётах JSON/JUnit для CI-артефактов. README и runbook фиксируют сценарии локального запуска, Docker-команды и отчётность, что формализует регрессионные тесты и подготавливает интеграцию в CI. | `move_tests.py` 【F:SupraLottery/supra/scripts/move_tests.py†L1-L227】, `README.md` 【F:SupraLottery/README.md†L37-L72】, `testnet_runbook.md` 【F:SupraLottery/docs/testnet_runbook.md†L600-L626】 |
| Чек-лист деплоя | Перед релизом отсутствовал единый список адресов, лимитов газа и обязательных команд; инженеры сверялись с разрозненными разделами runbook. | ✅ Добавлен файл `docs/testnet_deployment_checklist.md` с быстрым контролем этапов: предварительные условия, параметры dVRF, настройка подписки, конфигурация лотереи, смоук-тест и пост-деплой мониторинг. Runbook в разделе требований ссылается на чек-лист, чтобы операторы могли быстро пройтись по пунктам. | `testnet_deployment_checklist.md` 【F:SupraLottery/docs/testnet_deployment_checklist.md†L1-L126】, `testnet_runbook.md` 【F:SupraLottery/docs/testnet_runbook.md†L1-L18】 |
| Магазин цифровых товаров | Supra ожидает агрегированный снимок ассортимента и продаж магазина, иначе мониторинг вынужден собирать остатки из `ItemConfiguredEvent`/`ItemPurchasedEvent`. | ✅ Добавлено событие `StoreSnapshotUpdatedEvent`, публикующее администратора и полный список товаров по лотерее, а также view `get_lottery_snapshot` и `get_store_snapshot`. Move-тест `store_tests` проверяет поток снапшотов, обновление админа и содержимое view. | `Store.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Store.move†L1-L431】【F:SupraLottery/supra/move_workspace/lottery/tests/store_tests.move†L1-L126】 |
| VIP-подписки | Официальные гайды Supra требуют агрегированного снапшота подписок (администратор, конфигурации, активные подписчики и выручка), иначе мониторинг должен собирать историю `VipSubscribedEvent`/`VipCancelledEvent`. | ✅ Добавлены структуры `VipLotterySnapshot`/`VipSnapshot`, view `get_lottery_snapshot`/`get_vip_snapshot` и событие `VipSnapshotUpdatedEvent`, публикуемое при инициализации, смене администратора, изменении конфигурации, подписке/отмене и учёте бонусов. Move-тесты `vip_tests` проверяют новые view и поток снапшотов. | `Vip.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Vip.move†L33-L124】【F:SupraLottery/supra/move_workspace/lottery/sources/Vip.move†L214-L347】【F:SupraLottery/supra/move_workspace/lottery/tests/vip_tests.move†L48-L149】 |
| Лотерейные раунды / наблюдаемость | Supra ожидает агрегированный снимок состояния раунда (количество билетов, статус расписания, активная заявка) без чтения storage. Ранее приходилось реконструировать состояние по событиям `TicketPurchasedEvent`, `DrawScheduleUpdatedEvent` и `DrawRequestIssuedEvent`. | ✅ Добавлено событие `RoundSnapshotUpdatedEvent`, которое публикуется после каждой покупки, планирования, сброса, запроса и fulfill; view `get_round_snapshot` возвращает тот же `RoundSnapshot` с `pending_request_id`, что позволяет Supra CLI сверять готовность раунда одним вызовом. | `LotteryRounds.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/LotteryRounds.move†L23-L120】【F:SupraLottery/supra/move_workspace/lottery/sources/LotteryRounds.move†L205-L337】【F:SupraLottery/supra/move_workspace/lottery/tests/rounds_tests.move†L1-L222】 |
| Глобальный джекпот | Supra запрашивает агрегированное состояние глобального джекпота (администратор, `lottery_id`, количество билетов, pending-заявка) одним событием и через view, чтобы аудит не восстанавливал данные по `JackpotScheduleUpdatedEvent`/`JackpotRequestIssuedEvent`. | ✅ Добавлено событие `JackpotSnapshotUpdatedEvent`, которое публикует текущий снимок после `init`, выдачи билетов, планирования, запроса и fulfill; view `get_snapshot` возвращает такую же структуру с `pending_request_id`. Тест `jackpot_full_cycle` проверяет поток снапшотов и переход pending-заявки. | `Jackpot.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Jackpot.move†L23-L115】【F:SupraLottery/supra/move_workspace/lottery/sources/Jackpot.move†L246-L328】, `jackpot_tests.move` 【F:SupraLottery/supra/move_workspace/lottery/tests/jackpot_tests.move†L1-L158】 |
| Миграция legacy-лотерей | После переноса состояния Supra ожидает агрегированный журнал с подтверждением количества билетов, статуса розыгрыша и долей распределения, чтобы аудит мог сверить миграцию без чтения storage. Ранее `migrate_from_legacy` не публиковал событий и не предоставлял view. | ✅ Введены ресурс `MigrationLedger`, событие `MigrationSnapshotUpdatedEvent` и view `list_migrated_lottery_ids`/`get_migration_snapshot`, которые транслируют `MigrationSnapshot` с билетами, `next_ticket_id`, флагами draw, объёмом джекпота и долями распределения. Move-тесты подтверждают содержимое события и view. | `Migration.move` 【F:SupraLottery/supra/move_workspace/lottery/sources/Migration.move†L1-L173】, `migration_tests.move` 【F:SupraLottery/supra/move_workspace/lottery/tests/migration_tests.move†L1-L120】 |
| Внутренний аудит G1 | Динамические проверки (прогон Move-тестов, `python -m unittest`, смоук-тест testnet) ещё не выполнены; 14.02 сформирован dry-run отчёт `docs/audit/move_test_reports/2025-02-14-move-test-dry-run.json`/`...xml` без фактического запуска CLI. | Выполнить команды из чек-листа G1, заменить dry-run на полноценный прогон с Supra CLI и приложить JSON/JUnit отчёты и tx hash смоук-теста в сопроводительные документы. Для пошаговой инструкции добавлен `docs/audit/internal_audit_dynamic_runbook.md`. | `internal_audit_checklist.md` 【F:SupraLottery/docs/audit/internal_audit_checklist.md†L33-L76】, `internal_audit_dynamic_runbook.md` 【F:SupraLottery/docs/audit/internal_audit_dynamic_runbook.md†L1-L74】 |
| Документация | Для фиксации инвентаризации создан файл `docs/module_inventory.md`; требуется дополнить его ссылками на официальные описания после получения материалов. | После получения официальных схем дополнить инвентаризацию ссылками и статусами соответствия. | `module_inventory.md` 【F:SupraLottery/docs/module_inventory.md†L1-L91】 |

> Примечание: список будет расширяться по мере изучения официальных артефактов и результатов сравнения.
